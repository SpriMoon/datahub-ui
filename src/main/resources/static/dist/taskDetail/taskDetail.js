function getUsers(a){a||!globalParam.allUserOption?$.fn.ajaxAPI({url:"job/users",data:{pids:a||""},callback:function(l){var e='<option value="">'+common_js_lang["manage.info.allOwner"]+"</option>";l.model.map(function(a){e+='<option value="'+a.id+'">'+a.userName+"</option>"}),$("#taskUser").html(e),!a&&(globalParam.allUserOption=e)}}):$("#taskUser").html(globalParam.allUserOption)}function list(){var a=+globalParam.listSendData.pageNo||1;a<1&&(a=1),globalParam.listSendData.pageNo=a,$.fn.ajaxAPI({url:"job/log/list",data:globalParam.listSendData,callback:function(l){if(l.model.totalPage&&l.model.totalPage<a)return globalParam.listSendData.pageNo=l.model.totalPage,void list();l.model.data=l.model.data.map(function(a){return a.jobInfoVo.periodStr=common_js_lang[a.jobInfoVo.periodStr],"job.log.project.client"===a.jobInfoVo.projName&&(a.jobInfoVo.projName=common_js_lang["job.log.project.client"]),a}),$(".listCon .list").html(template("template/taskTable",l.model)),$(".listCon .list .pager").bootpag({total:l.model.totalPage,page:l.model.currentPage,maxVisible:10,leaps:!1,firstLastUse:!0,prev:"<i>〈</i>",next:"<i>〉</i>",first:"<i>《</i>",last:"<i>》</i>"}).off().on("page",function(a,l){globalParam.listSendData.pageNo=l,list()})}})}function sliceLog(a){a.length<=0||($(".global-log .detail").append(a.slice(0,1e4)),a=a.slice(1e4),globalParam.logInterval=setTimeout(function(){sliceLog(a)},100))}template.helper("dateFormat",function(a,l){var e={M:(a=new Date(a)).getMonth()+1,d:a.getDate(),h:a.getHours(),m:a.getMinutes(),s:a.getSeconds(),q:Math.floor((a.getMonth()+3)/3),S:a.getMilliseconds()};return l=l.replace(/([yMdhmsqS])+/g,function(l,t){var o=e[t];return void 0!==o?(l.length>1&&(o=(o="0"+o).substr(o.length-2)),o):"y"===t?(a.getFullYear()+"").substr(4-l.length):l})}),template.helper("timeCount",function(a){a=+a||0;var l=parseInt(a/1e3),e=parseInt(l/3600),t=parseInt(l%3600/60),o=parseInt(l%60);return e<10&&(e="0"+e),t<10&&(t="0"+t),o<10&&(o="0"+o),e+":"+t+":"+o});var datepickerLang="zh"==common_i18n_lang?"zh-cn":"en";$("#startDate").on("click",function(){WdatePicker({readOnly:!0,lang:datepickerLang,isShowClear:!1,maxDate:"#F{$dp.$D('endDate')}"})}),$("#endDate").on("click",function(){WdatePicker({readOnly:!0,lang:datepickerLang,isShowClear:!1,minDate:"#F{$dp.$D('startDate')}"})});var tmpParam={listSendData:{pageNo:1,pageSize:10,jobId:"",jobName:"",status:"",startTimeStr:"",endTimeStr:"",userId:"",pids:""},urlObj:{},logInterval:0,allUserOption:""};$.extend(globalParam,tmpParam),getUsers();try{for(var urlParam=location.search.replace(/^\?|\?$/g,"").split("&"),i=0,len=urlParam.length;i<len;i++){var obj=urlParam[i].split("=");globalParam.urlObj[obj[0]]=obj[1]||""}globalParam.urlObj.jobId&&(globalParam.listSendData.jobId=globalParam.urlObj.jobId,$("#taskId").val(globalParam.urlObj.jobId),3==globalParam.urlObj.groups&&(globalParam.listSendData.groups=3,globalParam.listSendData.fromId=globalParam.urlObj.fromId))}catch(a){}list(),$(".act").on("click",".query",function(){var a=$("#taskId").val().trim(),l=$("#taskName").val().trim(),e=$("#taskStatus").val().trim(),t=$("#startDate").val().trim(),o=$("#endDate").val().trim(),n=$("#userApp").val(),i=($("#taskUser").val()||"").trim();if(""==a||a.match(/^[0-9]+$/)){if(""!=a){if((a=+a)<=0)return MsgTip("",common_js_lang["manage.info.taskIdInfo"],"info"),!1;$("#taskId").val(a)}globalParam.listSendData={pageNo:1,pageSize:10,jobIdLike:a,jobName:l,status:e,startTimeStr:t,endTimeStr:o,userId:i,pids:n},n||delete globalParam.listSendData.pids,list()}else MsgTip("",common_js_lang["manage.info.taskIdInfo"],"info")}),$("body").on("change","#userApp",function(){var a=$(this).val();$(".search-form .myTask i").removeClass("checked"),getUsers(a)}),$("body").on("keyup",".search input",function(a){13==a.keyCode&&$(".act .query").click()}),$(".act").on("click",".reset",function(){$(".search-form input, .search-form select").val("").prop("checked",!1),$(".search-form select").change()}),$(".myTask").on("click",function(){var a=$(this).find("i");if(a.hasClass("checked")){a.removeClass("checked");l=""}else var l=a.addClass("checked").data("id");$("#taskUser").val(l)}),$("#taskUser").on("change",function(){$(this).val()==$(".myTask i").data("id")?$(".myTask i").addClass("checked"):$(".myTask i").removeClass("checked")}),$(".list").on("click",".log",function(){var a=$(this).parent().data("id"),l=$(this).parent().data("jobid");$.fn.ajaxAPI({url:"job/log/detail",data:{jobId:l,logId:a},callback:function(e){$(".global-log h4 .title").html(common_js_lang["manage.info.task"]+"["+l+"] "+common_js_lang["manage.info.instance"]+"["+a+"] "+common_js_lang["manage.info.log"]),e.model=e.model||"",e.model=e.model.replace(/(\[ERROR\].*(?=\n))/g,"<span>$1</span>"),e.model=e.model.replace(/\n/g,"<br />"),e.model=e.model.replace(/\t/g,"&emsp;&emsp;"),$(".global-log .detail").html(""),sliceLog(e.model),$.fn.ajaxAPI({url:"hdfs/data/list",data:{jobId:l,logId:a},callback:function(e){e.model&&e.model.length>0?$(".log .download").show().find("a").attr("href","hdfs/data/download?jobId="+l+"&logId="+a):$(".log .download").hide(),$(".global-mask, .global-log").fadeIn(),$(".global-log .detail").scrollTop(0)}})}})}),$(".global-log").on("click",".cancel",function(){$(".global-mask, .global-log").fadeOut(),clearInterval(globalParam.logInterval)}),$(".list").on("click",".disable",function(){var a=$(this).parent().data("jobid");swal({title:"",text:common_js_lang["manage.tip.disableJob"],type:"info",showCancelButton:!0},function(l){l?$.fn.ajaxAPI({url:"job/disable",data:{id:a,once:!0},type:"post",contentType:"application/x-www-form-urlencoded",callback:function(a){MsgTip("success",common_js_lang["manage.info.taskDisable"]),list()}}):swal.close()})});