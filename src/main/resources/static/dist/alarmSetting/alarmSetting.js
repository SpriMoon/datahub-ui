var vm=new Vue({el:".mainCon",data:{isLoading:!0,loading:!1,noData:'<img class="noData" src="resources/dist/images/noData.png">'+common_js_lang["manage.title.noData"],projectList:common_project,pid:"",transColumn:[{title:common_js_lang["manage.title.taskId"],key:"jobId",ellipsis:!0,render:function(t,e){return t("Tooltip",{props:{content:e.row.jobId,placement:"top"}},e.row.jobId)}},{title:common_js_lang["dbManage.text.taskName"],key:"jobName",ellipsis:!0,render:function(t,e){return t("Tooltip",{props:{content:e.row.jobName,placement:"top"}},e.row.jobName)}},{title:common_js_lang["manage.title.inApp"],key:"projectName",ellipsis:!0,render:function(t,e){return t("Tooltip",{props:{content:e.row.projectName,placement:"top"}},e.row.projectName)}},{title:common_js_lang["common.option.alarmSetting"],key:"alarmRule",ellipsis:!0,render:function(t,e){return t("Tooltip",{props:{content:[common_js_lang["rule.option.taskFail"],"",common_js_lang["rule.option.clientOff"]][+e.row.alarmRule],placement:"top"}},[common_js_lang["rule.option.taskFail"],"",common_js_lang["rule.option.clientOff"]][+e.row.alarmRule])}},{title:common_js_lang["rule.option.alarmUser"],key:"notifyUser",ellipsis:!0,render:function(t,e){return t("Tooltip",{props:{content:e.row.notifyUser,placement:"top"}},e.row.notifyUser)}},{title:common_js_lang["rule.option.status"],key:"status",ellipsis:!0,render:function(t,e){return t("Tooltip",{props:{content:[common_js_lang["rule.option.disable"],common_js_lang["rule.option.enable"]][+e.row.status],placement:"top"},class:"s"+e.row.status},[common_js_lang["rule.option.disable"],common_js_lang["rule.option.enable"]][+e.row.status])}},{title:common_js_lang["clientList.option.oper"],key:"act",width:145,className:"act",ellipsis:!0,render:function(t,e){return t("div",[t("Tooltip",{props:{content:common_js_lang["rule.act.alarmRecord"],placement:"top"}},[t("a",{class:"log",on:{click:function(){vm.record(e.row.id)}}})]),t("Tooltip",{props:{content:common_js_lang["rule.act.editRule"],placement:"top"}},[t("a",{class:"edit",on:{click:function(){vm.edit(e.row)}}})]),t("Tooltip",{props:{content:1==e.row.status?common_js_lang["rule.option.disable"]:common_js_lang["rule.option.enable"],placement:"top"}},[t("a",{class:1==e.row.status?"disable":"enable",on:{click:function(){vm.toggleStatus(e.row)}}})]),t("Tooltip",{props:{content:common_js_lang["clientList.option.del"],placement:"top"}},[t("a",{class:"del",on:{click:function(){vm.delete(e.row.id)}}})])])}}],clientColumn:[{title:common_js_lang["rule.option.ruleType"],key:"alarmType",ellipsis:!0,render:function(t,e){return t("Tooltip",{props:{content:[common_js_lang["alarm.option.clientTask"],common_js_lang["alarm.option.clientStatus"]][+e.row.alarmType],placement:"top"}},[common_js_lang["alarm.option.clientTask"],common_js_lang["alarm.option.clientStatus"]][+e.row.alarmType])}},{title:common_js_lang["clientList.option.clientName"],key:"clientName",ellipsis:!0,width:120,render:function(t,e){return t("Tooltip",{props:{content:vm.getClientNameById(e.row.clientId),placement:"top"}},vm.getClientNameById(e.row.clientId))}},{title:common_js_lang["manage.title.inApp"],key:"projectName",ellipsis:!0,render:function(t,e){return t("Tooltip",{props:{content:e.row.projectName,placement:"top"}},e.row.projectName)}},{title:common_js_lang["manage.title.taskId"],key:"jobId",width:80,ellipsis:!0,render:function(t,e){return t("Tooltip",{props:{content:e.row.jobId,placement:"top"}},e.row.jobId)}},{title:common_js_lang["common.option.alarmSetting"],key:"alarmRule",ellipsis:!0,render:function(t,e){return t("Tooltip",{props:{content:[common_js_lang["rule.option.taskFail"],"",common_js_lang["rule.option.clientOff"]][+e.row.alarmRule],placement:"top"}},[common_js_lang["rule.option.taskFail"],"",common_js_lang["rule.option.clientOff"]][+e.row.alarmRule])}},{title:common_js_lang["rule.option.alarmUser"],key:"notifyUser",ellipsis:!0,render:function(t,e){return t("Tooltip",{props:{content:e.row.notifyUser,placement:"top"}},e.row.notifyUser)}},{title:common_js_lang["rule.option.status"],key:"status",ellipsis:!0,render:function(t,e){return t("Tooltip",{props:{content:[common_js_lang["rule.option.disable"],common_js_lang["rule.option.enable"]][+e.row.status],placement:"top"},class:"s"+e.row.status},[common_js_lang["rule.option.disable"],common_js_lang["rule.option.enable"]][+e.row.status])}},{title:common_js_lang["clientList.option.oper"],key:"act",width:145,className:"act",ellipsis:!0,render:function(t,e){return t("div",[t("Tooltip",{props:{content:common_js_lang["rule.act.alarmRecord"],placement:"top"}},[t("a",{class:"log",on:{click:function(){vm.record(e.row.id)}}})]),t("Tooltip",{props:{content:common_js_lang["rule.act.editRule"],placement:"top"}},[t("a",{class:"edit",on:{click:function(){vm.edit(e.row)}}})]),t("Tooltip",{props:{content:1==e.row.status?common_js_lang["rule.option.disable"]:common_js_lang["rule.option.enable"],placement:"top"}},[t("a",{class:1==e.row.status?"disable":"enable",on:{click:function(){vm.toggleStatus(e.row)}}})]),t("Tooltip",{props:{content:common_js_lang["clientList.option.del"],placement:"top"}},[t("a",{class:"del",on:{click:function(){vm.delete(e.row.id)}}})])])}}],transList:[],clientList:[],transParam:{jobType:0,pageNo:1,pageSize:10},clientParam:{jobType:1,pageNo:1,pageSize:10},transPager:{total:0,current:0},clientPager:{total:0,current:0},transType:"1",transWord:"",clientType:"2",activeName:"0",clientListGot:!1,transListGot:!1,listTab:1,jobCycle:"",alarmCycle:"0",alarmType:"1",clientArr:[],clientId:"",transJob:{},clientJob:{},currentJobObj:{},curJob:"",jobDetail:"",alarmTemplate:"",alarmRule:"0",notifyUser:"",editMode:!1,editId:0,editData:{}},created:function(){var t=this.projectList;for(var e in t){this.pid=e;break}this.getTransList()},methods:{typeChange:function(){this.transWord=""},pidChange:function(){this.editMode||(this.jobDetail="","0"==this.activeName?this.getTransJob():this.getClientJob())},jobChange:function(t){if(!((t=t||0)<=0)){var e="0"==this.activeName?this.transJob[this.pid][t]:this.clientJob[this.pid][t];this.jobDetail=common_js_lang["dbManage.text.taskName"]+": "+e.jobName+"\n"+common_js_lang["rule.text.taskDes"]+": "+(e.note||""),this.getAlarmDesc()}},getJob:function(t,e){e=e||"";var i=this;i.loading=!0,$.get("job/list?pid="+this.pid).then(function(n){200==n.code?(i.transJob[i.pid]={},i.clientJob[i.pid]={},n.model.data.map(function(t){3==t.groupNo?i.clientJob[i.pid][t.id]=t:i.transJob[i.pid][t.id]=t}),i.currentJobObj=2!=t?i.transJob[i.pid]:i.clientFilter(i.clientJob[i.pid]),i.editMode?i.$nextTick(function(){i.curJob=e,i.$nextTick(function(){i.editMode=!1})}):(i.curJob=e,i.getAlarmDesc())):ErrTip(n.i18nMsg.title,n.i18nMsg.detail,n.msg)}).always(function(){i.loading=!1})},clientFilter:function(t){var e={};for(var i in t)t[i].fromId==this.clientId&&(e[i]=t[i]);return e},getTransJob:function(t){t=t||"";var e=this;e.transJob[e.pid]?(e.currentJobObj=e.transJob[e.pid],this.editMode?e.$nextTick(function(){e.curJob=t,e.$nextTick(function(){e.editMode=!1})}):(e.curJob=t,e.getAlarmDesc())):e.getJob(1,t)},getClientJob:function(t){t=t||"";var e=this;if(e.transJob[e.pid])return e.currentJobObj=e.clientFilter(e.clientJob[e.pid]),void(this.editMode?e.$nextTick(function(){e.curJob=t,e.$nextTick(function(){e.editMode=!1})}):(e.curJob=t,e.getAlarmDesc()));e.getJob(2,t)},clientChange:function(){var t=this;t.currentJobObj=t.clientFilter(t.clientJob[t.pid]),t.getAlarmDesc()},getRuleList:function(t){return $.get("alarm/rule/list",t)},listChange:function(t){if(this.activeName=t,"1"==t&&!this.clientListGot){var e=this;if(e.clientArr.length>0)return void this.getClientList();$.get("online/client/list").then(function(t){200==t.code?(e.clientArr=t.model.data,e.getClientList()):ErrTip(t.i18nMsg.title,t.i18nMsg.detail,t.msg)})}},getTransList:function(){var t=this;this.isLoading=!0,this.getRuleList(this.transParam).then(function(e){if(200==e.code){if(t.transListGot=!0,e.model.totalCount&&0==e.model.data.length)return t.transParam.pageNo-=1,void t.getTransList();t.transList=e.model.data,t.transPager.total=e.model.totalCount||0,t.transPager.current=e.model.currentPage||0}else ErrTip(e.i18nMsg.title,e.i18nMsg.detail,e.msg)}).always(function(){t.isLoading=!1})},getClientList:function(){var t=this;this.isLoading=!0,this.getRuleList(this.clientParam).then(function(e){if(200==e.code){if(t.clientListGot=!0,e.model.totalCount&&0==e.model.data.length)return t.clientParam.pageNo-=1,void t.getClientList();t.clientList=e.model.data,t.clientPager.total=e.model.totalCount||0,t.clientPager.current=e.model.currentPage||0}else ErrTip(e.i18nMsg.title,e.i18nMsg.detail,e.msg)}).always(function(){t.isLoading=!1})},transSearch:function(){if(""==this.transWord.trim())delete this.transParam.jobName,delete this.transParam.jobId;else if("1"==this.transType){if(!this.transWord.trim().match(/^\d+$/))return void MsgTip("",common_js_lang["manage.info.taskIdInfo"]);delete this.transParam.jobName,this.transWord=+this.transWord.trim(),this.transParam.jobId=this.transWord}else delete this.transParam.jobId,this.transParam.jobName=this.transWord.trim();this.transParam.pageNo=1,this.getTransList()},clientTypeChange:function(){"2"==this.clientType?delete this.clientParam.alarmType:this.clientParam.alarmType=this.clientType,this.clientParam.pageNo=1,this.getClientList()},pagerChange:function(t){"0"==this.activeName?(this.transParam.pageNo=t,this.getTransList()):(this.clientParam.pageNo=t,this.getClientList())},record:function(t){location.href="./alarm.record?id="+t+"&activeName="+this.activeName},edit:function(t){this.editId=t.id,this.editData=t,this.editMode=!0,"1"==this.activeName&&"1"==t.alarmType?this.alarmRule="2":this.alarmRule="0";var e=this;"0"==this.activeName?(this.pid=t.pid+"",this.jobCycle=t.jobCycle,this.alarmCycle=t.alarmCycle+"",this.alarmTemplate=t.alarmTemplate,this.notifyUser=t.notifyUser,e.getTransJob(t.jobId)):(this.jobCycle=t.jobCycle,this.alarmCycle=t.alarmCycle+"",this.alarmTemplate=t.alarmTemplate,this.notifyUser=t.notifyUser,this.clientId=t.clientId,this.alarmType=t.alarmType,"1"==t.alarmType?this.getClientJob():(this.pid=t.pid+"",this.getClientJob(t.jobId))),this.listTab=0},toggleStatus:function(t){var e=this;e.isLoading=!0;var i=t,n=["alarm/rule/enable","alarm/rule/disable"][+t.status],o={id:t.id};$.post(n,o).then(function(t){200==t.code?(MsgTip("success",[common_js_lang["rule.option.enableSuc"],common_js_lang["rule.option.disableSuc"]][+i.status]),"0"==e.activeName?e.getTransList():e.getClientList()):ErrTip(t.i18nMsg.title,t.i18nMsg.detail,t.msg)}).always(function(){e.isLoading=!1})},delete:function(t){var e=this;swal({title:"",text:common_js_lang["rule.tip.deleteRule"],type:"info",showCancelButton:!0},function(){e.isLoading=!0,$.post("alarm/rule/delete",{id:t}).then(function(t){200==t.code?(MsgTip("success",common_js_lang["manage.info.delSucc"]),"0"==e.activeName?e.getTransList():e.getClientList()):ErrTip(t.i18nMsg.title,t.i18nMsg.detail,t.msg)}).always(function(){e.isLoading=!1})})},addRule:function(){this.listTab=0,this.editId=0,this.curJob||this.pidChange(),"1"==this.activeName&&"1"==this.alarmType?this.alarmRule="2":this.alarmRule="0"},addRuleCancel:function(){this.listTab=1,this.clientId="",this.curJob="",this.jobDetail="",this.jobCycle="",this.alarmTemplate="",this.notifyUser=""},saveRule:function(){var t={notifyType:0,status:0};if(this.editId&&(t.id=this.editId,t.status=this.editData.status),"0"==this.activeName){if(t.jobType=0,t.pid=this.pid,t.jobId=this.curJob||"",t.alarmRule=0,t.jobCycle=this.jobCycle,t.alarmCycle=this.alarmCycle,t.alarmTemplate=this.alarmTemplate.trim(),t.notifyUser=this.notifyUser.trim(),(parseInt(t.jobId)||0)<=0)return void MsgTip("info",common_js_lang["rule.tip.jobIdErr"]);if(!t.jobCycle)return void MsgTip("info",common_js_lang["rule.tip.jobCycleErr"])}else{if(t.jobType=1,t.clientId=this.clientId,t.alarmCycle=this.alarmCycle,t.alarmTemplate=this.alarmTemplate.trim(),t.notifyUser=this.notifyUser.trim(),!t.clientId)return void MsgTip("info",common_js_lang["rule.tip.clientIdErr"]);if("1"==this.alarmType)t.pid=0,t.alarmType=1,t.alarmRule=this.alarmRule;else{if(t.pid=this.pid,t.jobId=this.curJob,t.alarmType=0,t.alarmRule=0,t.jobCycle=this.jobCycle,(parseInt(t.jobId)||0)<=0)return void MsgTip("info",common_js_lang["rule.tip.jobIdErr"]);if(!t.jobCycle)return void MsgTip("info",common_js_lang["rule.tip.jobCycleErr"])}}if(t.alarmTemplate){for(var e=t.notifyUser.split(","),i=[],n=0,o=e.length;n<o;n++){if(!e[n].trim().match(/^1\d{10}$/))return void MsgTip("info",common_js_lang["rule.tip.notifyUserErr"]);i.push(e[n].trim())}t.notifyUser=i.join(",");var a=this;a.loading=!0,$.when(a.offlineCheck(t)).then(function(){$.post("alarm/rule/save",t).then(function(e){200==e.code?(MsgTip("success",t.id?common_js_lang["dbManage.info.updateSucc"]:common_js_lang["dbManage.info.addSucc"]),"0"==a.activeName?a.getTransList():a.getClientList(),a.addRuleCancel()):ErrTip(e.i18nMsg.title,e.i18nMsg.detail,e.msg)}).always(function(){a.loading=!1})}).fail(function(t){a.loading=!1})}else MsgTip("info",common_js_lang["rule.tip.alarmTemplateErr"])},offlineCheck:function(t){var e=$.Deferred();if("1"!=t.alarmType)return e.resolve(),e.promise();var i=this;return $.get("alarm/rule/list",{alarmType:t.alarmType,clientId:t.clientId,jobType:1}).then(function(t){if(200!=t.code)return ErrTip(t.i18nMsg.title,t.i18nMsg.detail,t.msg),void e.reject();var n=t.model.data.length;0==n||1==n&&t.model.data[0].id==i.editId?e.resolve():(MsgTip("info",common_js_lang["rule.tip.offlineCheck"]),e.reject())}).fail(function(t){e.reject()}),e.promise()},getAlarmDesc:function(){if(!this.editMode)if("0"==this.activeName){if(!this.curJob||(parseInt(this.jobCycle)||0)<=0)return void(this.alarmTemplate="");var t=parseInt(this.jobCycle),e=this.transJob[this.pid][this.curJob].jobName;this.alarmTemplate=common_js_lang["rule.text.template1"].replace(/\[x\]/,"["+this.projectList[this.pid].name+"]").replace(/\[yz\]/,"["+this.curJob+": "+e+"]").replace(/\[n\]/,"["+t+"]")}else if("1"==this.alarmType){if(!this.clientId)return void(this.alarmTemplate="");i=this.getClientNameById(this.clientId);this.alarmTemplate=common_js_lang["rule.text.template2"].replace(/\[x\]/,i)}else{if(!this.curJob||(parseInt(this.jobCycle)||0)<=0)return void(this.alarmTemplate="");var t=parseInt(this.jobCycle),i=this.getClientNameById(this.clientId),e=this.clientJob[this.pid][this.curJob].jobName;this.alarmTemplate=common_js_lang["rule.text.template3"].replace(/\[c\]/,"["+i+"]").replace(/\[x\]/,"["+this.projectList[this.pid].name+"]").replace(/\[yz\]/,"["+this.curJob+": "+e+"]").replace(/\[n\]/,"["+t+"]")}},getClientNameById:function(t){this.clientArr;for(var e=0,i=this.clientArr.length;e<i;e++)if(this.clientArr[e].id==t)return this.clientArr[e].clientName},alarmCycleFix:function(){this.jobCycle=(parseInt(this.jobCycle)||0)<=0?"":parseInt(this.jobCycle)},alarmTypeChange:function(){"1"==this.alarmType?this.alarmRule="2":this.alarmRule="0",this.getAlarmDesc()}}});