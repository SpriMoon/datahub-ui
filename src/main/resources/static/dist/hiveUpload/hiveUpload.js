function columnType2option(){var a="";return globalParam.columnType.map(function(e){a+="<option>"+e+"</option>"}),a}function getUrlParam(a){var e=a.parents("ul");return{dbType:(e.find('[data-key="dbType"]').val()||"").trim(),host:(e.find('[data-key="host"]').val()||"").trim(),port:(e.find('[data-key="port"]').val()||"").trim(),dbName:(e.find('[data-key="dbName"]').val()||"").trim()}}function getlinkUrl(a){return"jdbc:hive2://"+a.host+":"+a.port+"/"+a.dbName}function checkDbInfo(a){for(key in a)if("id"!==key&&("connName"!==key||""!==a.connName)){if("port"===key&&!a.port.match(/^[0-9]+$/g))return{res:!1,key:key};if(""===a[key])return{res:!1,key:key}}return{res:!0}}function targetTypeChange(a,e){$(".upload-type .target").css({display:"block"}),$(".item1 .target .linkList").prop("disabled",!1),$(".item1 .target li:not(:first-child) input, .item1 .target li:not(:first-child) select").val("");var t='<option value="">'+common_js_lang["db.info.dbLinkErr"]+"</option>";t+=template("template/options",{data:globalParam.urlConnectList,type:a}),$(".item1 .target .linkList").html(t).select2(),e&&$(".item1 .target .linkList").find('[data-id="'+e+'"]').prop("selected",!0).trigger("change")}function getConnect(a,e,t){var l=$("#userApp").val(),i=a||$("#targetType").val(),n="db/list",o="";2==i?n="hdfs/list":o=4,l&&$.fn.ajaxAPI({url:n+"?pid="+l+"&dbType=31&groups="+o,callback:function(a){var l='<option value="" disabled>'+(2==i?" ":common_js_lang["db.info.selectLink"])+"</option>";2==i?adminConfigData.hdfs.id&&(l+='<option value="'+adminConfigData.hdfs.id+'" data-val="'+encodeURIComponent(JSON.stringify(adminConfigData.hdfs))+'">'+adminConfigData.hdfs.connName+"</option>"):adminConfigData.hive.id&&(l+='<option value="'+adminConfigData.hive.id+'" data-val="'+encodeURIComponent(JSON.stringify(adminConfigData.hive))+'">'+adminConfigData.hive.connName+"</option>"),a.model.data.map(function(a){l+='<option value="'+a.id+'" data-val="'+encodeURIComponent(JSON.stringify(a))+'">'+a.connName+"</option>"}),2==i&&$('.item1 [data-key="hid"]').html(l).val(""),2!=i&&$(".source .linkList, .typeCon .connId").html(l).val("").select2(),e&&$(".source .linkList").val(e).change(),t&&$(".typeCon .connId").val(globalParam.editJobModel.toId).change()}})}function testConnect(a,e){var t=setTimeout(function(){0==$("#loadCon").length&&$("body").append("<div id='loadCon' style='position:fixed;z-index:99 ;height:100%;width:100%;top:0;left:0; background:rgba(255,255,255, .3);'><div style='width:20%;margin:20% 40%;text-align:center;height:80px;line-height:80px;'><img src='resources/dist/images/loading.gif'></div></div>")},2e3);$.ajax({url:"db/connect",type:"post",contentType:"application/x-www-form-urlencoded",data:{id:a.id},success:function(a){200==a.code?e.find(".testRes").removeClass("err").addClass("right").html('<i class="suc"></i>'+common_js_lang["db.text.testSuc"]):e.find(".testRes").removeClass("right").addClass("err").html('<i class="fail"></i>'+common_js_lang["db.text.testFail"]+'<a class="showTip" data-info='+encodeURIComponent(JSON.stringify(a))+">"+common_js_lang["db.text.errTip"]+"</a>")},complete:function(a){clearInterval(t),$("#loadCon").remove()}})}function hdfsAuthToggle(a,e){var t=$(".upload-type .column.hdfs");t.find(".radio").removeClass("cur").eq(+a-1).addClass("cur"),t.find(".kerberos, .normal").addClass("hidden"),2==a?t.find(".kerberos").removeClass("hidden"):t.find(".normal").removeClass("hidden"),2==a&&e==adminConfigData.hdfs.id&&t.find(".admin").addClass("hidden")}function resetDestConn(a,e){if(a.authType){hdfsAuthToggle(a.authType);var t=["keytab","principal","connName","coreSiteXml","hdfsSiteXml"];2!=a.authType&&(t=["userName","connName","coreSiteXml","hdfsSiteXml"]);for(k in a)-1!=t.indexOf(k)&&e.find('[data-key="'+k+'"]').val(a[k])}else{for(k in a)["connName","url","host","port","userName","hid"].indexOf(k)>-1&&e.find('[data-key="'+k+'"]').val(a[k]);e.find('[data-key="hid"]').change()}}function editGetParts(){if(!(globalParam.jobId<=0||globalParam.editGotPart)){globalParam.editGotPart=!0,2==jobOtherParams.srcType&&$(".mtype .radio").removeClass("cur").eq(1).addClass("cur"),$(".rightSide .target-item").empty();for(var a=jobOtherParams.fromList.length,e=8==globalParam.editJobModel.toType?jobOtherParams.toHdfsList:9==globalParam.editJobModel.toType?jobOtherParams.toHiveList:jobOtherParams.toDbList,t=0;t<a;t++){var l=jobOtherParams.fromList[t].name,i=jobOtherParams.fromList[t].catalog,n=jobOtherParams.fromList[t].schema;jobOtherParams.fromList[t].whereSql;if(e[t].tarPartHandleType=jobOtherParams.fromList[t].tarPartHandleType,e[t].useSynchronized=jobOtherParams.fromList[t].useSynchronized,e[t].fromIsPart=jobOtherParams.fromList[t].partitionTable,e[t].toIsPart=!!e[t].partition||e[t].useSynchronized,e[t].fromPart=jobOtherParams.fromList[t].partition,e[t].partition){var o=JSON.parse(e[t].partition),r={};if(jobOtherParams.fromList[t].partition){var s=JSON.parse(jobOtherParams.fromList[t].partition),d=[],c=!1;o.map(function(a,e){var t=s[e].replace(/,/g,"/").replace(/\'/g,""),l=a.split(",").map(function(a){return!c&&d.push(a.split("=")[0]),a.split("=")[1].replace(/^\'|\'$/g,"")});r[t]=l,c=!0}),e[t].part=JSON.stringify(d),e[t].partition=JSON.stringify(r)}else o[0].split(",").map(function(a){var e=a.split("=");r[e[0]]=e[1].replace(/^\'|\'$/g,"")}),e[t].partition=JSON.stringify(r)}for(var m=1,p=[{tbl:jobOtherParams.fromList[t].tableName,target:e[t],param:JSON.stringify(e[t])}],g=t+1;g<a&&jobOtherParams.fromList[g].name==l;g++){if(m++,e[g].partition){var o=JSON.parse(e[g].partition),r={};if(jobOtherParams.fromList[g].partition){var s=JSON.parse(jobOtherParams.fromList[g].partition),d=[],c=!1;o.map(function(a,e){var t=s[e].replace(/,/g,"/").replace(/\'/g,""),l=a.split(",").map(function(a){return!c&&d.push(a.split("=")[0]),a.split("=")[1].replace(/^\'|\'$/g,"")});r[t]=l,c=!0}),e[g].part=JSON.stringify(d),e[g].partition=JSON.stringify(r)}else o[0].split(",").map(function(a){var e=a.split("=");r[e[0]]=e[1].replace(/^\'|\'$/g,"")}),e[g].partition=JSON.stringify(r)}e[g].tarPartHandleType=jobOtherParams.fromList[g].tarPartHandleType,e[g].useSynchronized=jobOtherParams.fromList[g].useSynchronized,e[g].fromIsPart=jobOtherParams.fromList[g].partitionTable,e[g].toIsPart=!!e[g].partition||e[g].useSynchronized,e[g].fromPart=jobOtherParams.fromList[g].partition,p.push({tbl:jobOtherParams.fromList[g].tableName,target:e[g],param:JSON.stringify(e[g])})}t=g-1;var f={catalog:i,schema:n,dbName:l,count:m,tbls:p,isDb:0};8!=globalParam.editJobModel.toType&&(f.isDb=1),$(".rightSide .target-item").append(template("template/targetTbl",f))}$(".rightSide h4 b").html("("+e.length+")");for(var b=[],t=0;t<a;t++)jobOtherParams.fromList[t].partitionTable&&b.push({catalog:jobOtherParams.fromList[t].catalog,schema:jobOtherParams.fromList[t].schema,tableName:jobOtherParams.fromList[t].tableName});var h=$.Deferred();if(b.length>0){$("#waitLoading").find("article").html("<p>"+common_js_lang["db.info.searchPart"]+'</p><p class="detail"></p>').end().css({display:"block"});var u="",v="",y="";$.ajax({url:"db/table/partitions/batch",type:"post",data:{dbId:jobOtherParams.fromList[0].id,pid:globalParam.editJobModel.pid,tablesJsonStr:JSON.stringify(b)},success:function(a){if(200!=a.code)return h.reject(),void ErrTip(a.i18nMsg.title,a.i18nMsg.detail,a.msg);a.model.map(function(a,e){if(200!=a.code)return y||(y=a.i18nMsg.title),v||(v=a.i18nMsg.detail),void(u+=a.msg+"\n");var t=$('.target-item [data-catalog="'+a.model.catalog+'"][data-schema="'+a.model.schema+'"][data-tbl="'+a.model.name+'"]');a.model.partitions&&a.model.partitions.length>0&&t.attr("data-partition",JSON.stringify(a.model.partitions)).find("td").eq(1).html(common_js_lang["db.text.yes"])}),h.resolve()},complete:function(){$("#waitLoading").css({display:"none"}),u&&ErrTip(y,v,u,"info")}})}else h.resolve();return h.promise()}}function srcSearch(){var a=($(".leftSide .keyword").val()||"").trim()||"";""===a?$(".leftSide .clear").css({display:"none"}):$(".leftSide .clear").css({display:"block"}),globalParam.batchTblMode=!1,$('.leftSide .tblSelected[data-batch="1"]').attr("data-batch",0),clearInterval(globalParam.searchParam.searchInterval),globalParam.searchParam.searchInterval=setTimeout(function(){$(".leftSide .tblList input, .leftSide .allSelected").prop("checked",!1),globalParam.searchParam.keyword=a,globalParam.searchParam.checkedDbNum=0,globalParam.searchParam.tarNum=0,$(".leftSide .check.cur").removeClass("cur"),$(".leftSide li.cur").removeClass("cur");var e=$(".mtype .radio.cur").attr("data-val");if($('.tblList .getTbl:not(".got")').length<=10)for(var t=$(".tblList .getTbl"),l=0,i=t.length;l<i;l++)t.eq(l).hasClass("got")?matchKeyword(1==e?t.eq(l).siblings(".tbl"):t.eq(l).siblings(".view")):queryAndMatch(t.eq(l));else{if(globalParam.searchParam.isSearch)return;globalParam.searchParam.isSearch=!0,$.fn.ajaxAPI({url:"db/search?pid="+$("#userApp").val()+"&keyword=&mtype=1&dbId="+globalParam.sourceId,callback:function(a){var t=$(".tblList .getTbl");a.model.databases.map(function(a,l){if(!t.eq(l).hasClass("got")){t.eq(l).addClass("got");var i=[],n=[];a.tables.map(function(a){"TABLE"!==a.type?n.push(a):i.push(a)});var o=template("template/sourceTbl",{model:i,isChecked:!1});t.eq(l).siblings(".tbl").html(o);var r=template("template/sourceView",{model:n,isChecked:!1});t.eq(l).siblings(".view").html(r)}matchKeyword(1==e?t.eq(l).siblings(".tbl"):t.eq(l).siblings(".view"))})}})}},300)}function queryAndMatch(a){var e=a.parent(),t=e.data("schema")||"",l=e.data("catalog")||"",i={dbId:globalParam.sourceId};t&&(i.schema=t),l&&(i.catalog=l);$.fn.ajaxAPI({url:"db/table/tbls",data:i,callback:function(t){a.addClass("got").html("-");var l=[],i=[];t.model.map(function(a){"TABLE"!==a.type?i.push(a):l.push(a)});var n=$(".mtype .radio.cur").attr("data-val"),o=template("template/sourceTbl",{model:l,isChecked:!1});e.find(".tbl").html(o);var r=template("template/sourceView",{model:i,isChecked:!1});e.find(".view").html(r),matchKeyword(1==n?e.find(".tbl"):e.find(".view"))}})}function matchKeyword(a){var e=a.find("p"),t=0,l=RegExp("("+globalParam.searchParam.keyword+")","ig"),i=!1;l.test(a.parent().attr("data-dbname"))?(a.siblings("p").html(a.parent().attr("data-dbname").replace(l,'<span class="red">$1</span>')),a.find("li").removeClass("hidden"),i=!0):a.siblings("p").html(a.parent().attr("data-dbname"));for(var n=0,o=e.length;n<o;n++)i?e.eq(n).html(e.eq(n).text().replace(l,'<span class="red">$1</span>')):l.test(e.eq(n).text())?(e.eq(n).parent().removeClass("hidden"),e.eq(n).html(e.eq(n).text().replace(l,'<span class="red">$1</span>')),t++):e.eq(n).parent().addClass("hidden");if(0!=t||i){if(""===globalParam.searchParam.keyword)return a.slideUp().siblings(".getTbl").html("+"),a.parent().removeClass("hidden"),void a.find("li").removeClass("hidden");a.slideDown().siblings(".getTbl").html("-"),a.parent().removeClass("hidden"),globalParam.searchParam.tarNum++}else a.parent().addClass("hidden");globalParam.searchParam.tarNum&&$(".leftSide .tblList > .noData").addClass("hidden"),globalParam.searchParam.checkedDbNum++,globalParam.searchParam.checkedDbNum!=$(".tblList .getTbl").length||globalParam.searchParam.tarNum||$(".leftSide .tblList > .noData").removeClass("hidden")}function resetConfigCon(a,e){$(".global-ConfigCon .configCon .configTab a").eq(0).click(),$(".global-ConfigCon .configCon .configTab a").eq(0).html([common_js_lang["local.option.getDir"],common_js_lang["db.title.scanSql"]][+(2!=globalParam.targetType)]),2==globalParam.targetType?hdfsConfig(a):1==globalParam.targetType&&hiveConfig(a)}function partAllList(a,e){var t=a.length,l=e.length,i='<div class="flex-item"><span class="item row-flex"><span class="item check head"><i class="check cur"></i></span>',n='<span class="item row-flex">',o="",r='<div class="item row-flex">';a.map(function(a,e){i+='<span class="item" title="'+a.name+'">'+a.name+"</span>",r+='<span class="item" title="'+a.name+'">'+a.name+"</span>"}),i+="</span>",r+='</div><div class="item row-flex">';var s="";e.map(function(a){n+='<span class="item" title="'+a+'">'+a+"</span>",s+='<div class="clearfix"><span class="key" title="'+a+'">'+a+'</span><span>=</span><span class="val"><select>'+globalParam.columnValOption+"</select></span></div>",r+='<span class="item" title="'+a+'">'+a+"</span>"}),$(".setPart .batchPartCon .batchList").html(s).find("select").select2({tags:!0}),o=i+(n+="</span>")+"</div>",r+="</div>",$(".setPart .partType_2 .columnShow .content").html(r);var d="",c="";if(t>l)d=common_js_lang["db.info.lostPart"];else if(t<l){d=common_js_lang["db.info.setExpPart"];for(p=t;p<l;p++)c+='<div class="flex-item"><span class="item">'+e[p]+'</span><span class="item"><select>'+globalParam.columnValOption+"</select></span></div>"}$(".setPart .defaultPartVal .content").html(c).find("select").select2({tags:!0}),c?$(".setPart .defaultPartVal").removeClass("hidden"):$(".setPart .defaultPartVal").addClass("hidden"),$(".setPart .partType_2 .tip").html(d);for(var m=a[0].values,p=0,g=m.length;p<g;p++){i='<div class="flex-item"><span class="item row-flex"><span class="item check"><i class="check cur" data-key="'+m[p]+'"></i></span>',n='<span class="item row-flex tar">';for(var f=m[p].split("/"),b=0;b<t;b++){var h=f[b].split("=").slice(1).join("=");i+='<span class="item" title="'+h+'">'+h+"</span>",b<l&&(n+='<span class="item"><select><option>'+h+"</option>"+globalParam.columnValOption+"</select></span>")}for(var u=l-t;u>0;)n+='<span class="item"><select>'+globalParam.columnValOption+"</select></span>",u--;o+=(i+="</span>")+(n+="</span>")+"</div>"}$(".setPart .partCon").html(o).find("select").select2({tags:!0})}function descartes(a){if(1==a.length){var e=[];return a[0].map(function(a){var t=[];t.push(a),e.push(t)}),e}for(var t=a[0],l=a[1],i=[],n=0,o=t.length;n<o;n++)for(var r=l.length;0<r;n++){var s=[t[n]];s.push(l[0]),i.push(s)}return a.splice(0,2),a.splice(0,0,i),descartes(a)}function saveParamSwitch(){switch(globalParam.targetType){case"1":return saveHiveParam();case"2":return saveHdfsParam()}}function getDir(a,e){var t=""!=(a=a||"")?$('.dirDos [data-base="'+a+'"] > .ul'):$(".hdfsTab .dirDos > .ul");$.fn.ajaxAPI({url:e&&"hdfs/dir/home"||"hdfs/dir/list",data:{base:a,hid:globalParam.connId,pid:$("#userApp").val()},loadTime:""==a?0:2e3,callback:function(l){if(!e&&0==l.model.length)return t.siblings("p").find(".show").addClass("out"),!1;e&&(l.model=[l.model]);a.length;var i=template("template/hdfsDir",{dir:l.model,len:a.length});t.html(i)}})}function hdfsConfig(a){if(a.tarName)var e=a.tarDir||"",t=a.tarName||"";else{t="";if(e=a.fileName||""){t=e.split("/").slice(-1).join("/");e=e.split("/").slice(0,-1).join("/")||e.match(/\//g)&&"/"}}if($(".global-ConfigCon .hdfsTab p .check").removeClass("cur"),$(".global-ConfigCon .hdfsTab p .show").removeClass("in"),$(".global-ConfigCon .hdfsTab .ul:not(:first-child)").css({display:"none"}),$(".global-ConfigCon .hdfsTab .selectedDir").val(e),$(".global-ConfigCon .hdfsTab .fileName").val(t),e){var l=$('.global-ConfigCon .hdfsTab [data-base="'+e+'"]');1==l.length&&(l.find(">p .check").addClass("cur"),l.parents(".ul").fadeIn().siblings("p").find(".show").addClass("in"))}}function hiveConfig(a){var e=$(".global-ConfigCon"),t=a.name||"",l=a.tableName||"",i=a.partition||"",n=!1;if(globalParam.partTag&&a.partAll&&""==i&&(n=!0),globalParam.partTag&&a.useSynchronized&&(n=!0),console.log(a),e.find(".hive .infoline.last").hide(),e.find("#partitions").empty(),$(".global-ConfigCon .hive .tableType").val(a.tableType||0).prop("disabled",""!=a.ddl),$(".global-ConfigCon .dbTab").removeClass("hidden"),$(".global-ConfigCon .newPart").css({display:"none"}),$(".global-ConfigCon .setPart").addClass("hidden"),$(".global-ConfigCon .btn-item").attr("data-part","").removeClass("next").html(common_js_lang["db.text.save"]),$(".global-ConfigCon .prev").addClass("hidden"),$(".global-ConfigCon .partType label").eq(a.useSynchronized?1:0).click(),$(".global-ConfigCon .useSynch .radio").eq(0).click(),$(".global-ConfigCon .setPart .batchPartCon").addClass("hidden"),a.tarPartHandleType&&($(".global-ConfigCon .useSynch .pop .radio.cur").removeClass("cur"),$('.global-ConfigCon .useSynch .pop[data-val="'+a.tarPartHandleType+'"] .radio').addClass("cur")),t){if(e.find("#dbName").val()!=t||!a.ddl&&!a.createSql)$("#dbName").val(t).select2(),hiveModule.getTables(a);else if(e.find("#tableName").val(l).select2({tags:!0}),e.find("#tableName").val()!=l&&e.find("#tableName").append('<option value="'+l+'">'+l+"</option>").val(l).select2({tags:!0}),a.createSql)if(i||n)if(globalParam.partTag){var o=JSON.parse(a.newPart),r=partFormat(2);$(".global-ConfigCon .newPart").css({display:"none"}),$("#partitions").html(r.head).parent().css({display:"block"});var s=JSON.parse($(".config.active").parent().attr("data-partition")),d=[];for(var c in o){d.push(c);var m=o[c],p=$("#partitions").append(r.item).find(".flex-item.new:last-child");p.find(".type select").val(m.type),p.find(".key input").val(c)}var g=a.partition||"";globalParam.partTag&&a.partAll&&""==g&&(g=!0),globalParam.partTag&&a.useSynchronized&&(g=!0),partitionReshow(g,a,s,d)}else{var f=(r=partFormat(1)).head;$(".global-ConfigCon .newPart").css({display:"none"}),$("#partitions").html(f).parent().css({display:"block"});var b=JSON.parse(i);for(var c in b){m=b[c];(p=$("#partitions").append(r.item).find(".flex-item.new:last-child")).find(".type select").val(m.type),p.find(".key input").val(c);var h=p.find(".val select");h.val(m.value),h.val()!=m.value&&h.prepend('<option value="'+m.value+'">'+m.value+"</option>"),h.select2({tags:!0})}}else $(".global-ConfigCon .newPart").css({display:"block"});a.ddl&&(hiveModule.getPart(a.tableName,a.catalog,a.schema,a.partition,a),editor.doc.cm.setOption("readOnly",!0),$(".new-sql .CodeMirror").addClass("disabled"),editor.doc.setValue(a.ddl)),a.createSql&&(editor.doc.cm.setOption("readOnly",!1),$(".new-sql .CodeMirror").removeClass("disabled"),editor.doc.setValue(a.createSql))}else $("#dbName").val("").select2(),$("#tableName").html('<option value="" disabled>'+common_js_lang["local.option.setTbl"]+"</option><option>"+l+"</option>").val(l).select2({tags:!0}),editor.doc.cm.setOption("readOnly",!0),$(".new-sql .CodeMirror").addClass("disabled"),editor.doc.setValue(""),$(".hive .infoline.last").css({display:"none"})}function partitionReshow(a,e,t,l){if(partAllList(t,l),$(".global-ConfigCon .btn-item").attr("data-part",JSON.stringify(l)).addClass("next").html(common_js_lang["db.text.next"]),e.useSynchronized&&e.partitionExpDefault){var i=JSON.parse(e.partitionExpDefault);$(".defaultPartVal .content select").map(function(a,e){$(e).val(i[a].value)!=i[a].value&&$(e).prepend('<option value="'+i[a].value+'">'+i[a].value+"</option>"),$(e).select2({tasg:!0})})}if(!0!==a){var n=$('.setPart .partCon .item.check:not(".head")');$(".setPart .partCon .check.cur").removeClass("cur");var o=JSON.parse(a);for(var r in o){var s=n.find('.check[data-key="'+r+'"]');s.click(),s.parents(".flex-item").find(".row-flex.tar .item").map(function(a,e){var t=$(e).find("select");t.val(o[r][a]),t.val()!==o[r][a]&&t.prepend('<option value="'+o[r][a]+'">'+o[r][a]+"</option>"),t.select2({tags:!0})})}}}function hiveConfigModule(a){this.container=a.container,this.newType=a.newType||0,this.editor=4!=this.newType?editor:SQLeditor,this.event()}function partFormat(a){var e="",t="";return 1==(a=a||globalParam.partTag)?(e='<span class="type item">'+common_js_lang["db.text.type"]+'</span><span class="key item">'+common_js_lang["db.text.column"]+'</span><span class="val item">'+common_js_lang["dbManage.title.val"]+'</span><span class="act item">'+common_js_lang["clientList.option.oper"]+"</span>",t='<div class="flex-item new"><span class="type item"><select>'+globalParam.columnTypeOption+'</select></span><span class="key item"><input type="text" placeholder="'+common_js_lang["db.info.enterColumn"]+'"></span><span class="val item"><select>'+globalParam.columnValOption+'</select></span><span class="act item"><a class="add"></a><a class="del"></a></span></div>'):2==a?(e='<span class="type item">'+common_js_lang["db.text.type"]+'</span><span class="key item">'+common_js_lang["db.text.column"]+'</span><span class="act item">'+common_js_lang["clientList.option.oper"]+"</span>",t='<div class="flex-item new"><span class="type item"><select>'+globalParam.columnTypeOption+'</select></span><span class="key item"><input type="text" placeholder="'+common_js_lang["db.info.enterColumn"]+'"></span><span class="act item"><a class="add"></a><a class="del"></a></span></div>'):3==a?(e='<span class="type item">'+common_js_lang["db.text.type"]+'</span><span class="key item">'+common_js_lang["db.text.column"]+"</span>",t='<div class="flex-item"><span class="type item"><select>'+globalParam.columnTypeOption+'</select></span><span class="key item"><input type="text" placeholder="'+common_js_lang["db.info.enterColumn"]+'"></span></div>'):4==a&&(e='<span class="type item">'+common_js_lang["db.text.type"]+'</span><span class="key item">'+common_js_lang["db.text.column"]+'</span><span class="val item">'+common_js_lang["dbManage.title.val"]+"</span>",t='<div class="flex-item"><span class="type item"><select>'+globalParam.columnTypeOption+'</select></span><span class="key item"><input type="text" placeholder="'+common_js_lang["db.info.enterColumn"]+'"></span><span class="val item"><select>'+globalParam.columnValOption+"</select></span></div>"),e='<div class="flex-item head">'+e+"</div>",{head:e,item:t}}function partDdl(){for(var a=editor.doc.getValue().trim(),e=$("#partitions .flex-item.new"),t=[],l=0,i=e.length;l<i;l++){var n=e.eq(l).find(".type select").val(),o=e.eq(l).find(".key input").val().trim();if(o){if(["varchar","char"].indexOf(n)>-1){var r=e.eq(l).find(".type select option:selected").attr("data-len");(!r||r<=0)&&(r=255);var s="("+r+")"}else s="";t.push("`"+o+"` "+n+s)}}var d=t.length>0?"PARTITIONED BY (\n"+t.join(",\n")+"\n) \n":"",c=a.indexOf("PARTITIONED BY"),m=a.indexOf("ROW FORMAT"),p=a.indexOf("STORED AS");-1==m&&p>-1&&(m=p),-1==c&&(c=m),-1==m&&-1==p&&(m=c=1);var g=a.substring(0,c),f=a.substring(m);editor.doc.setValue(g+d+f)}function saveHiveParam(){var a=($("#dbName").val()||"").trim(),e={},t=$("#dbName option:selected"),l=t.attr("data-catalog")||"",i=t.attr("data-schema")||"",n=$("#tableName").val(),o=editor.doc.getValue()||"";if([a,n,o].indexOf("")>-1)return MsgTip("",common_js_lang["local.info.tblErr"]+"!","info"),!1;var r={},s=[];if(globalParam.partTag){e.fromIsPart=!0;var d=$('#partitions .flex-item:not(".head")');if(d.length<=0)e.noPart=!0,e.toIsPart=!1;else{if(e.toIsPart=!0,d.eq(0).hasClass("new")){c={};d.map(function(a,e){var t=$(e).find(".key input").val().trim(),l=$(e).find(".type select").val();c[t]={type:l}}),e.newPart=JSON.stringify(c)}else{var c=[];d.map(function(a,e){c.push($(e).find(".key").text())}),e.part=JSON.stringify(c)}if(2==$(".partType .radio.cur").attr("data-val")){e.useSynchronized=!0,e.tarPartHandleType=$(".useSynch .radio.cur").parent().attr("data-val");for(var m=[],p=$(".defaultPartVal .content .flex-item"),g=0,f=p.length;g<f;g++){var b=p.eq(g).find(".item"),h=b.eq(0).text(),u=b.eq(1).find("select").val().trim();if(!u.match(/^(\w|_|-|\(|\))+$/g))return MsgTip("",common_js_lang["db.info.partChars"],"info"),!1;m.push({name:h,value:u})}m.length>0&&(e.partitionExpDefault=JSON.stringify(m))}else{e.useSynchronized=!1,e.tarPartHandleType=$(".useSynch .radio.cur").parent().attr("data-val"),e.partAll=1==$(".setPart .partCon .item.head .check.cur").length;var v=!0,y=$('.setPart .partCon .item.check:not(".head") .check.cur'),C=JSON.parse($(".rightSide .config.active").parent().attr("data-partition"));if(y.map(function(a,e){var t=[],l=[];$(e).parent().siblings().map(function(a,e){t.push(C[a].name+"="+$(e).text())}),l=t.join("/"),s.push(l),r[l]=[],$(e).parents(".flex-item").find(".row-flex.tar .item").map(function(a,e){var t=$(e).find("select").val().trim();t.match(/^(\w|_|-|\(|\))+$/g)||(v=!1),r[l].push(t)})}),y.length<=0)return MsgTip("",common_js_lang["db.info.alertPart"],"info"),!1;if(!v)return MsgTip("",common_js_lang["db.info.partChars"],"info"),!1}}}else{e.fromIsPart=!1;for(var g=0,P=(d=$('#partitions .flex-item:not(".head")')).length;g<P;g++)if(d.eq(g).hasClass("new")){var T=d.eq(g).find(".key input").val().trim();if(!T.match(/^(\w|_|-|\(|\))+$/g))return d.eq(g).find(".key input").addClass("error"),!1;d.eq(g).find(".key input").removeClass("error"),r[T]={value:d.eq(g).find(".val select").val().trim(),type:d.eq(g).find(".type select").val()}}else r[d.eq(g).find(".key").text().trim()]=d.eq(g).find(".val select").val().trim();d.length>0?e.toIsPart=!0:e.toIsPart=!1}var S="",k="";if(editor.doc.cm.isReadOnly()){if((k=o).indexOf("CLUSTERED BY")>-1&&k.indexOf("org.apache.hadoop.hive.ql.io.orc.OrcSerde")>-1&&k.indexOf("'transactional'='true'")>-1)return MsgTip("info",common_js_lang["db.tip.hivexspark"]),!1}else{S=o,o=(o=o.substring(o.indexOf("TABLE")+"TABLE".length,o.indexOf("(")).trim()).replace(/\"|\'|`|\[|\]/g,"");try{var N=o.split(".");if(N[0]!=a||N[1]!=n)return MsgTip("",common_js_lang["db.info.sqlErr"],"info"),!1}catch(a){return MsgTip("",common_js_lang["db.info.sqlErr"],"info"),!1}}if(e.dbId=globalParam.targetId,e.tableType=$(".global-ConfigCon .hive .tableType").val(),e.createSql=S,e.ddl=k,s.length>0&&(e.fromPart=JSON.stringify(s)),"{}"!=JSON.stringify(r)&&(e.partition=JSON.stringify(r)),e.tableName=n,e.catalog=l,e.schema=i,e.name=a,S&&!globalParam.partTag){if(!checkPartDdl(S,e.partition))return!1}else if(S&&globalParam.partTag&&!checkPartDdl(S,e.newPart))return!1;return e}function checkPartDdl(a,e){var t=a,l=e?JSON.parse(e):"";console.log(a,e);var i=t.indexOf("PARTITIONED BY"),n=t.indexOf("ROW FORMAT"),o=t.indexOf("STORED AS");if(-1==n&&o>-1&&(n=o),i>-1&&!e||-1==i&&e)return MsgTip("",common_js_lang["db.info.alertDdl"],"info"),!1;if(-1==i&&!e)return!0;try{var r=[];t.substring(i+"PARTITIONED BY".length,n).trim().replace(/^\(|\)$/g,"").trim().replace(/\s+/g," ").split(",").map(function(a,e){var t=a.trim().split(" ");r.push(t[0].replace(/^`|`$/g,""))});var s=r.length;for(var d in l){if(-1==r.indexOf(d))return MsgTip("",common_js_lang["db.info.alertDdl"],"info"),!1;s--}return 0==s||(MsgTip("",common_js_lang["db.info.alertDdl"],"info"),!1)}catch(a){return MsgTip("",common_js_lang["db.info.alertDdl"],"info"),!1}}function saveHdfsParam(){var a=$(".global-ConfigCon .hdfsTab .selectedDir").val().trim(),e=$(".global-ConfigCon .hdfsTab .fileName").val().trim();if(!a||!e)return MsgTip("",common_js_lang["local.info.fileDir"],"info"),!1;if(e.match(/\s+|\\+/g))return MsgTip("",common_js_lang["local.info.fileName"],"info"),!1;var t=!!e.match(/^\//);return t&&(e="/"+e.replace(/^\/+/g,"")),{fileName:a+(t?"":"/")+e,tarDir:a,tarName:e}}function checkHdfs(a){var e=a.fileName||"";return!(!e||e.split("/").length<=1)}function checkTableExist(a){var e=$.Deferred();return $.ajax({url:"db/table/exist2",data:a,success:function(a){200==a.code?a.model&&e.resolve(a.model):e.reject()},error:function(){e.reject()}}),e.promise()}var editor=CodeMirror.fromTextArea($(".new-sql textarea")[0],{lineNumbers:!0}),tmpParam={jobId:0,editJobModel:{},dbConfigParam:{},dbConfigParamOption:"",dbParamObj:{},sourceId:"",targetId:"",sourceDb:{},targetType:0,groupNo:0,urlConnectList:{},curTableList:[],curHiveParam:{},columnsOption:"",filtersOption:"",fromJson:[],toHdfsJson:[],toHiveJson:[],toDbJson:[],linkSource2type:{1:[38,4,40,44,24],2:[52,53,55,54],3:[56,57,60,58]},urlObj:{},tmpAppId:0,type1Val:"",connId:0,tmpDbParam:{},editTmpDbParam:{},searchParam:{searchInterval:"",keyword:"",checkedDbNum:0,tarNum:0,isSearch:!1},batchTblMode:!1,columnType:["bigint","boolean","char","date","decimal","double","float","int","smallint","string","timestamp","tinyint","varchar"],columnTypeOption:"",partTag:0,editGotPart:!1};$.extend(globalParam,tmpParam),globalParam.columnTypeOption=columnType2option();try{for(var urlParam=location.search.replace(/^\?|\?$/g,"").split("&"),i=0,len=urlParam.length;i<len;i++){var obj=urlParam[i].split("=");globalParam.urlObj[obj[0]]=obj[1]||""}var id=globalParam.urlObj.id||0;if(id<=0)throw"";$.fn.ajaxAPI({url:"job/detail?jobId="+id,async:!1,callback:function(a){if(globalParam.urlObj.copy&&(a.model.jobName=(a.model.jobName+"_copy").slice(0,60)),$(".configTask .taskName").val(a.model.jobName),$(".configTask .taskDes").val(a.model.note),a.model.pid&&$("#userApp").val(a.model.pid).select2(),JSON.parse(a.model.otherParams).fromList){if(globalParam.jobId=id,globalParam.editJobModel=a.model,!a.model.fromId)return;a.model.fromObject&&(-1==a.model.fromObject.delFlg&&$.extend(globalParam.editTmpDbParam,a.model.fromObject),1==globalParam.urlObj.type&&(globalParam.urlObj.dbtype=a.model.fromObject.dbType))}var e="";a.model.fromObject||(e+=common_js_lang["conf.info.srcNull"]),a.model.toObject||(e+=(e?"<br>":"")+common_js_lang["conf.info.tarNull"]),e&&MsgTip("info",e,5e3)}})}catch(a){}$(".item1").on("change",".connType",function(){1==$(this).val()?($(".item1 .source .type1show").show(),$(".item1 .source input").prop("disabled",!0).val("").removeClass("error"),$('.source [data-key="hid"]').val("").select2().prop("disabled",!0),$(".source .linkList").select2()):($(".item1 .source .linkList").val("").select2(),$(".item1 .source .type1show").hide(),$(".item1 .source input").prop("disabled",!1).val("").removeClass("error"),$('.source [data-key="hid"]').val("").select2().prop("disabled",!1))});var jobOtherParams="";globalParam.jobId>0?(jobOtherParams=JSON.parse(globalParam.editJobModel.otherParams),getConnect(1,-1==globalParam.editTmpDbParam.delFlg?0:jobOtherParams.fromList[0].id,globalParam.editJobModel.toId),getConnect(2,-1==globalParam.editTmpDbParam.delFlg?0:jobOtherParams.fromList[0].id,globalParam.editJobModel.toId)):(getConnect(1),getConnect(2)),$("body").on("click","button.index",function(){window.location.href="./"}),$("#userApp").change(function(){getConnect(1),getConnect(2),["connName","url","host","port","dbName","userName","hid"].map(function(a){$(".item1").find('[data-key="'+a+'"]').val("")})}),$(".url-info").on("change",".linkList",function(){try{var a=JSON.parse(decodeURIComponent($(this).find("option:selected").attr("data-val")))}catch(a){return}if(!a.id)return!1;resetDestConn(a,$(".item1 .source"))}),$(".item1 .source").on("blur","input",function(){var a=$(this).attr("data-key"),e=($(this).val()||"").trim(),t={};if(t[a]=e,"url"===a&&""===e){l=getUrlParam($(this));return $(this).val(getlinkUrl(l)).removeClass("error"),!1}if(!0!==checkDbInfo(t).res)return $(this).addClass("error"),!1;if($(this).removeClass("error"),["host","port","dbName"].indexOf(a)>-1){var l=getUrlParam($(this));$(this).parents("ul").find('[data-key="url"]').val(getlinkUrl(l))}}),$(".upload-type").on("change",".typeCon #targetType",function(){var a=+$(this).val();if(-1!=a&&a)if(getConnect(),[1,2].indexOf(a)>-1){$(".upload-type .target").css({display:"none"});var e=$(this).parents(".upload-type").find(".column").addClass("hidden");1==a?e.eq(1).find("input").val(""):e.eq(0).find("input,select").val(""),1==a?e.eq(1).removeClass("hidden"):e.eq(0).removeClass("hidden")}else targetTypeChange(a)}),$(".upload-type").on("change",".connId",function(){try{var a=JSON.parse(decodeURIComponent($(this).find("option:selected").attr("data-val")))}catch(a){return}if(!a.id)return!1;resetDestConn(a,1==+$(".upload-type #targetType").val()?$(".upload-type .column.hive"):$(".upload-type .column.hdfs"))}),$(".testConnect").on("click",function(){if($(this).parent().find(".testRes").empty(),1==$(this).parents(".source").length)if(1==$(".source .connType").val()){if((t=$(".linkList").val()||0)<=0)return void MsgTip("",common_js_lang["db.info.selectSavedLink"],"info");testConnect({pid:$("#userApp").val(),id:t},$(this).parent())}else{var a={};if(["connName","host","port","dbName","userName","url","hid"].map(function(e){a[e]=($('.source [data-key="'+e+'"]').val()||"").trim()}),!checkDbInfo(a).res)return MsgTip("",common_js_lang["db.info.completeParam"],"info"),!1;a.connName=a.connName||a.host+"_"+a.port+"_"+a.dbName,$('.source [data-key="connName"]').val(a.connName),a.pid=$("#userApp").val(),a.delFlg=-1,a.password="",a.dbType=31,testConnect(a,$(this).parent())}else{var e=$("#targetType").val(),t=$(".typeCon .connId").val();if(t<=0)return void MsgTip("",common_js_lang["db.info.selectSavedLink"],"info");1==e&&testConnect({pid:$("#userApp").val(),id:t},$(this).parent())}}),$(".connType, .linkList, .target-type, .connId").change(function(){var a=$(this).parents(".source");0==a.length&&(a=$(this).parents(".upload-type")),a.find(".testRes").empty()}),$(".testRes").on("click",".showTip",function(){var a=JSON.parse(decodeURIComponent($(this).attr("data-info")));ErrTip(a.i18nMsg.title,a.i18nMsg.detail,a.msg)}),globalParam.jobId<=0||(-1==globalParam.editTmpDbParam.delFlg&&($(".source .connType").val("2").change(),["connName","url","host","port","dbName","userName","password","hid"].map(function(a){$('.source [data-key="'+a+'"]').val(globalParam.editTmpDbParam[a])}),$('.source [data-key="hid"]').select2()),8==globalParam.editJobModel.toType?globalParam.targetType="2":9==globalParam.editJobModel.toType&&(globalParam.targetType="1"),$("#userApp, .item1 .linkList, .item1 #targetType, .item1 .connId").prop("disabled",!0)),$(".url-info").on("click",".connect",function(){var a=($(".item1 .taskName").val()||"").trim();($(".item1 .taskDes").val()||"").trim();if(a){var e=$("#userApp").val()||0;if(e){var t=$(".typeCon .connId").val(),l=$(".typeCon #targetType").val();if(t<=0)return MsgTip("",common_js_lang["db.info.tarConn"],"info"),!1;var i=l!=globalParam.targetType,n=t!=globalParam.connId,o=e!=globalParam.tmpAppId,r=$(".source .connType").val();if(1==r){if(!$(".source .linkList").val())return MsgTip("",common_js_lang["db.info.sourceLink"],"info"),!1;var s=JSON.parse(decodeURIComponent($(".source .linkList").find("option:selected").attr("data-val"))),d=s.id!=globalParam.sourceId}else{var c={},d=!1;["connName","url","host","port","dbName","userName","hid"].map(function(a){c[a]=($('.source [data-key="'+a+'"]').val()||"").trim(),globalParam.tmpDbParam[a]==c[a]||(d=!0)}),c.connName=c.connName||c.host+"_"+c.port+"_"+c.dbName,$('.source [data-key="connName"]').val(c.connName),c.pid=$("#userApp").val(),c.delFlg=-1,c.password="",c.dbType=31,globalParam.tmpDbParam.pid==c.pid||(d=!0),$.extend(globalParam.tmpDbParam,c)}$("#globalLoadCon").css({display:"block"}),$(".global-ConfigCon .hdfsTab").addClass("hidden"),$(".global-ConfigCon .dbTab").removeClass("hidden"),$(".global-batch .hdfsTab").addClass("hidden"),$(".global-batch .dbTab").removeClass("hidden"),2==l&&($(".global-ConfigCon .dbTab").addClass("hidden"),$(".global-ConfigCon .hdfsTab").removeClass("hidden"),$(".global-batch .dbTab").addClass("hidden"),$(".global-batch .hdfsTab").removeClass("hidden"));var m=$.Deferred(),p=$.Deferred();if(i||n||o)if(1==l)$.ajax({url:"db/dbs?id="+t+"&pid="+$("#userApp").val(),success:function(a){if(200!=a.code)return p.reject(),ErrTip(a.i18nMsg.title,a.i18nMsg.detail,a.msg),!1;var i='<option value="" disabled>'+common_js_lang["local.option.getDb"]+"</option>";a.model.databases.map(function(a){i+='<option data-catalog="'+a.catalog+'" data-schema="'+a.schema+'">'+a.name+"</option>"}),$("#dbName, #batch-dbName").html(i).val("").removeClass("error").select2(),a.model.databases&&a.model.databases.length<=0&&MsgTip("info",common_js_lang["dump.info.dbNone"]),globalParam.targetType=l,globalParam.connId=t,globalParam.targetId=globalParam.connId,globalParam.tmpAppId=e,p.resolve()},error:function(){p.reject()}});else{var g=$(".hdfsTab .dirDos > .ul");$.ajax({url:"hdfs/dir/home",data:{hid:t,pid:$("#userApp").val(),pid:$("#userApp").val()},success:function(a){if(200!=a.code)return p.reject(),ErrTip(a.i18nMsg.title,a.i18nMsg.detail,a.msg),!1;a.model=[a.model];var i=template("template/hdfsDir",{dir:a.model,len:0});g.html(i),globalParam.targetType=l,globalParam.connId=t,globalParam.targetId=globalParam.connId,globalParam.tmpAppId=e,p.resolve()},error:function(){p.reject()}})}else p.resolve();!function(){function a(){$.ajax({url:"db/dbs?id="+e+"&pid="+$("#userApp").val(),success:function(a){if(200!=a.code)return globalParam.sourceId=0,m.reject(),void ErrTip(a.i18nMsg.title,a.i18nMsg.detail,a.msg);globalParam.sourceId=e,globalParam.searchParam.isSearch=!1;var t=template("template/sourceDb",a.model);$(".item2 .leftSide .tblList > .ul").html(t),m.resolve()},error:function(){m.reject()}})}if(d||!globalParam.sourceId||o){var e=0;1!=r?$.when(function(){var a=$.Deferred();return $.ajax({url:"db/tmp/save",contentType:"application/x-www-form-urlencoded",type:"post",data:c,success:function(t){if(200!=t.code)return a.reject(),void ErrTip(t.i18nMsg.title,t.i18nMsg.detail,t.msg);e=t.model.id,a.resolve()},error:function(){a.reject()}}),a.promise()}()).done(function(){a()}).fail(function(){m.reject()}):(e=s.id,a())}else m.resolve()}(),$.when(m,p).done(function(){$(".leftSide .allSelected").removeClass("cur");var a=$(".mtype .radio.cur").attr("data-val");$(".rightSide thead").html(template("template/thead",{isDb:2!=l,type:a})),$.when(editGetParts()).then(function(){(i||globalParam.jobId<=0&&(n||d))&&$(".rightSide .target-item").html('<tr class="noDataTr"><td colspan="4" class="tableNoData"><img src="resources/dist/images/noData.png">'+common_js_lang["manage.title.noData"]+"</td></tr>"),$(".stepCon").animate({"margin-left":"-100%"},250),$(".processCon .itemCon").removeClass("cur").eq(1).addClass("cur"),$("html, body").animate({scrollTop:0},200)})}).always(function(){$("#globalLoadCon").css({display:"none"})})}else MsgTip("",common_js_lang["dbManage.title.setApp"],"info")}else MsgTip("",common_js_lang["local.info.taskNameNone"],"info")}),$(".item2.item").on("click",".mtype label",function(){if(!$(this).find(".radio").hasClass("cur")){var a=$(this),e=1==$(".mtype .radio.cur").attr("data-val")?2:1;$(".rightSide .target-item .config").length<=0?($(this).parent().find(".radio").removeClass("cur"),$(this).find(".radio").addClass("cur"),$(".leftSide .tbl, .leftSide .view").css({display:"none"}),$(".leftSide .clear").click(),$(".rightSide thead").html(template("template/thead",{type:e,isDb:2!=globalParam.targetType})),$(".rightSide .target-item").empty(),$(".rightSide .target-item").append('<tr class="noDataTr"><td colspan="4" class="tableNoData"><img src="resources/dist/images/noData.png">'+common_js_lang["manage.title.noData"]+"</td></tr>")):swal({title:"",text:common_js_lang["db.option.mtype"],type:"info",showCancelButton:!0},function(t){t&&(a.parent().find(".radio").removeClass("cur"),a.find(".radio").addClass("cur"),$(".leftSide .tbl, .leftSide .view").css({display:"none"}),$(".leftSide .clear").click(),$(".rightSide thead").html(template("template/thead",{type:e,isDb:2!=globalParam.targetType})),$(".rightSide .target-item").empty(),$(".rightSide .target-item").append('<tr class="noDataTr"><td colspan="4" class="tableNoData"><img src="resources/dist/images/noData.png">'+common_js_lang["manage.title.noData"]+"</td></tr>"))})}}),$(".leftSide").on("click",".tblList .getTbl",function(){var a=$(this).parent(),e=a.data("schema")||"",t=a.data("catalog")||"",l=$(".mtype .radio.cur").attr("data-val");if($(this).hasClass("got")){var i=1==l?a.find(".tbl"):a.find(".view");"none"==i.css("display")?(i.slideDown(),$(this).html("-")):(i.slideUp(),$(this).html("+"))}else{var n={dbId:globalParam.sourceId};e&&(n.schema=e),t&&(n.catalog=t);var o=$(this).siblings(".dbSelected").hasClass("cur");$.fn.ajaxAPI({url:"db/table/tbls",data:n,callback:function(e){a.find(".getTbl").addClass("got").html("-");var t=[],l=[];e.model.map(function(a){"TABLE"!==a.type?l.push(a):t.push(a)});var i=$(".mtype .radio.cur").attr("data-val"),n=template("template/sourceTbl",{model:t,isChecked:o});a.find(".tbl").html(n);var r=template("template/sourceView",{model:l,isChecked:o});a.find(".view").html(r),1==i?a.find(".tbl").slideDown():a.find(".view").slideDown()}})}}),$(".leftSide").on("click",".dbSelected",function(){$(this).toggleClass("cur");var a=$(".mtype .radio.cur").attr("data-val"),e=$(this).siblings(".getTbl").hasClass("got"),t=1==a?$(this).siblings(".tbl"):$(this).siblings(".view"),l=$(this).hasClass("cur");e?(t.find('li:not(".hidden")').toggleClass("cur",l),t.find('li:not(".hidden") .check').toggleClass("cur",l)):$(this).siblings(".getTbl").click();var i=$('.tblList li:not(".hidden") .dbSelected').length==$('.tblList li:not(".hidden") .dbSelected.cur').length;return $(".leftSide .allSelected").toggleClass("cur",i),!1}),$(".leftSide").on("click",".db-item > p",function(){$(this).siblings(".check").click()}),$(".leftSide").on("click",".tblSelected",function(a,e){var t=$(".mtype .radio.cur").attr("data-val");if(a.ctrlKey||e){if(!globalParam.batchTblMode)return globalParam.batchTblMode=!0,$(this).attr("data-batch",1),!1;var l=$('.leftSide .tblSelected[data-batch="1"]');if(l.parents(".db-item").attr("data-dbname")!==$(this).parents(".db-item").attr("data-dbname"))return globalParam.batchTblMode=!1,$('.leftSide .tblSelected[data-batch="1"]').attr("data-batch",0),!1;for(var i=+l.siblings("b").text(),n=+$(this).siblings("b").text(),o=1==t?$(this).parents(".tbl").find("li"):$(this).parents(".view").find("li"),r=i>n?n:i,s=i>n?i:n,d=r;d<=s;d++)o.eq(d-1).hasClass("hidden")||(o.eq(d-1).addClass("cur"),o.eq(d-1).find(".check").addClass("cur"));globalParam.batchTblMode=!1,$('.leftSide .tblSelected[data-batch="1"]').attr("data-batch",0);m=(o=1==t?$(this).parents(".tbl"):$(this).parents(".view")).find('li:not(".hidden")').length;o.find(".check.cur").length==m?o.siblings(".dbSelected").addClass("cur"):o.siblings(".dbSelected").removeClass("cur");p=(m=$('.tblList li:not(".hidden") .dbSelected').length)==$('.tblList li:not(".hidden") .dbSelected.cur').length;return $(".leftSide .allSelected").toggleClass("cur",p),!1}globalParam.batchTblMode=!1,$('.leftSide .tblSelected[data-batch="1"]').attr("data-batch",0),$(this).toggleClass("cur");var c=$(this).hasClass("cur");$(this).parent().toggleClass("cur",c);var m=(o=1==t?$(this).parents(".tbl"):$(this).parents(".view")).find('li:not(".hidden")').length;o.find(".check.cur").length==m?o.siblings(".dbSelected").addClass("cur"):o.siblings(".dbSelected").removeClass("cur");var p=(m=$('.tblList li:not(".hidden") .dbSelected').length)==$('.tblList li:not(".hidden") .dbSelected.cur').length;return $(".leftSide .allSelected").toggleClass("cur",p),!1}),$(".leftSide").on("click",".tbl li, .view li",function(a){$(this).find(".check").trigger("click",a.ctrlKey)}),$(".leftSide").on("click",".allSelected",function(){$(this).toggleClass("cur");var a=$(this).hasClass("cur");return $('.tblList li:not(".hidden") .dbSelected').toggleClass("cur",!a),$('.tblList li:not(".hidden") .getTbl:not(".got")').length<=10?$('.tblList li:not(".hidden") .dbSelected').click():$.fn.ajaxAPI({url:"db/search?pid="+$("#userApp").val()+"&keyword=&mtype=1&dbId="+globalParam.sourceId,callback:function(a){var e=$('.tblList li:not(".hidden") .getTbl:not(".got")');a.model.databases.map(function(a,t){if(!e.eq(t).hasClass("got")){e.eq(t).addClass("got");var l=[],i=[];a.tables.map(function(a){"TABLE"!==a.type?i.push(a):l.push(a)});var n=template("template/sourceTbl",{model:l,isChecked:!1});e.eq(t).siblings(".tbl").css({display:"none"}).html(n);var o=template("template/sourceView",{model:i,isChecked:!1});e.eq(t).siblings(".view").css({display:"none"}).html(o)}}),$('.tblList li:not(".hidden") .dbSelected').click()}}),!1}),$(".leftSide").on("input",".keyword",srcSearch),$(".leftSide").on("click",".clear",function(){$(".leftSide .keyword").val(""),srcSearch()}),$(".leftSide").on("keyup",".keyword",function(a){13!=a.which||srcSearch()}),$(".leftSide").on("click",".query",srcSearch),$(".transfer").on("click",".move-right",function(){var a=$(".mtype").find(".radio.cur").attr("data-val"),e=1==a?"tbl":"view";if(!($('.leftSide .tblList li:not(".hidden") .'+e+" .tblSelected.cur").length<=0)){var t=$('.leftSide .tblList .db-item:not(".hidden")'),l=$(".rightSide .target-item");l.parent().find(".check").removeClass("cur"),1==a&&$("#waitLoading").find("article").html("<p>"+common_js_lang["db.info.searchPart"]+'</p><p class="detail"></p>').end().css({display:"block"});for(var i=[],n="",o="",r="",s=0,d=t.length;s<d;s++){var c=t.eq(s),m=c.find("."+e+' li:not(".hidden") .tblSelected.cur'),p=m.length;0!=p&&(i[s]=$.Deferred(),function(e,t,i,s){var d=e.data("catalog"),c=e.data("schema"),m=e.data("dbname"),p={catalog:d,schema:c,dbName:m,count:i,type:a,tbls:[]},g={dbId:globalParam.sourceId,pid:$("#userApp").val(),tablesJsonStr:[]},f=l.find('.target-path[data-name="'+m+'"]');if(f.length>0){for(var b=0,h=0;h<i;h++){var u=t.eq(h).siblings("p").text();0==l.find('[data-name="'+m+'"][data-tbl="'+u+'"]').length&&((y={}).tbl=u,y.param=2!=globalParam.targetType?JSON.stringify({tableName:y.tbl}):JSON.stringify({fileName:y.tbl+".txt",tarName:y.tbl+".txt"}),p.tbls.push(y),b++,g.tablesJsonStr.push($.extend({tableName:u},{catalog:d,schema:c})))}if(b<=0)return void s.resolve();if(1==a)g.tablesJsonStr=JSON.stringify(g.tablesJsonStr),$.ajax({url:"db/table/partitions/batch",type:"post",data:g,success:function(a){if(200!=a.code)return s.reject(),void ErrTip(a.i18nMsg.title,a.i18nMsg.detail,a.msg);a.model.map(function(a,e){if(200!=a.code)return p.tbls.splice(e,1),b--,void(n+=a.msg);p.tbls[e].partition=0==a.model.partitions.length?"":JSON.stringify(a.model.partitions)}),p.isDb=2!=globalParam.targetType;var e=$(template("template/targetTbl",p)).siblings('tr:not(".target-path")');l.find('[data-name="'+m+'"]').slice(-1).after(e),f.find("b").html(+f.find("b").html()+b),s.resolve()}});else{p.isDb=2!=globalParam.targetType;var v=$(template("template/targetTbl",p)).siblings('tr:not(".target-path")');l.find('[data-name="'+m+'"]').slice(-1).after(v),f.find("b").html(+f.find("b").html()+b),s.resolve()}}else{for(h=0;h<i;h++){var y={};y.tbl=t.eq(h).siblings("p").text(),y.param=2!=globalParam.targetType?JSON.stringify({tableName:y.tbl}):JSON.stringify({fileName:y.tbl+".txt",tarName:y.tbl+".txt"}),p.tbls.push(y),g.tablesJsonStr.push($.extend({tableName:y.tbl},{catalog:d,schema:c}))}1==a?(g.tablesJsonStr=JSON.stringify(g.tablesJsonStr),$.ajax({url:"db/table/partitions/batch",type:"post",data:g,success:function(a){if(200!=a.code)return s.reject(),void ErrTip(a.i18nMsg.title,a.i18nMsg.detail,a.msg);a.model.map(function(a,e){if(200!=a.code)return p.tbls.splice(e,1),i--,o||(o=a.i18nMsg.title),r||(r=a.i18nMsg.detail),void(n+=a.msg);p.tbls[e].partition=0==a.model.partitions.length?"":JSON.stringify(a.model.partitions)}),p.isDb=2!=globalParam.targetType,$(".rightSide .target-item").append(template("template/targetTbl",p)),s.resolve()}})):(p.isDb=2!=globalParam.targetType,$(".rightSide .target-item").append(template("template/targetTbl",p)),s.resolve())}}(c,m,p,i[s]))}$.when.apply($,i).done(function(){$(".leftSide .tbl li, .leftSide i.check.cur").removeClass("cur"),1==a&&$("#waitLoading").css({display:"none"}),$(".rightSide h4 b").html("("+$(".target-item .target-name").length+")"),n&&ErrTip(o,r,n,"info"),$('.rightSide .target-item tr:not(".noDataTr")').length>0&&$(".rightSide .target-item .noDataTr").remove()}).fail(function(){1==a&&$("#waitLoading").css({display:"none"})})}}),$(".transfer").on("click",".move-left",function(){$(".rightSide .target-item .check.cur").parents("tr").remove(),$(".rightSide .allSelected").removeClass("cur");for(var a=$(".rightSide .target-item .target-path"),e=0,t=0,l=a.length;t<l;t++){var i=a.eq(t).data("name"),n=$('.rightSide .target-item [data-name="'+i+'"]:not(".target-path")').length;a.eq(t).find("td b").html(n),e+=n}$(".rightSide h4 b").html("("+e+")"),0==$(".rightSide .target-item tr").length&&$(".rightSide .target-item").append('<tr class="noDataTr"><td colspan="4" class="tableNoData"><img src="resources/dist/images/noData.png">'+common_js_lang["manage.title.noData"]+"</td></tr>")});var hoverInterval=0;$(".global-batch .dbTab strong, .global-ConfigCon .dbTab strong").hover(function(){var a=$(this);hoverInterval=setTimeout(function(){a.find(".tip").css({display:"block"})},300)},function(){clearInterval(hoverInterval),$(this).find(".tip").css({display:"none"})}),$(".rightSide").on("click",".batch",function(){$(".rightSide .target-item .target-tbl.cur").length<=0?MsgTip("",common_js_lang["db.info.tarEmpty"],"info"):(2==globalParam.targetType?($(".global-batch").removeClass("fixed"),$(".global-batch .hdfsTab p .check").removeClass("cur"),$(".global-batch .hdfsTab p .show").removeClass("in"),$(".global-batch .hdfsTab .ul:not(:first-child)").css({display:"none"}),$(".global-batch .hdfsTab .selectedDir").val(""),$(".global-batch .hdfsTab").removeClass("hidden"),$(".global-batch .dbTab").addClass("hidden")):($(".global-batch").addClass("fixed"),$(".global-batch .hdfsTab").addClass("hidden"),$(".global-batch .dbTab").removeClass("hidden"),$(".global-batch #batch-dbName").val("").select2()),$(".global-mask, .global-batch").fadeIn())}),$(".global-batch").on("click",".btn-item",function(){function a(){if(C>=t)return $("#waitLoading").css({display:"none"}),b?void ErrTip(h,u,common_js_lang["loading.info.confInfo"].replace(/\[x\]/,v).replace(/\[y\]/,y)+"\n"+b,"info"):void $(".global-batch, .global-mask").fadeOut();var e=JSON.stringify(m.slice(C,C+100)),l=C+100<=t?100:t-C,i=JSON.stringify(p.slice(C,C+100));$.ajax({url:"db/table/ddl/batch",type:"post",contentType:"application/x-www-form-urlencoded",data:{fromId:globalParam.sourceId,toId:globalParam.targetId,pid:$("#userApp").val(),fromTablesJson:e,toTablesJson:i},success:function(e){if(200!=e.code)y+=l,h||(h=e.i18nMsg.title),u||(u=e.i18nMsg.detail),b+=e.msg+"\n";else{var t={text:"0",orc:"1",parquet:"2",rcfile:"3",sequencefile:"4"};e.model.map(function(a,e){var l=m[e+C].index;if(200!=a.code)return y++,h||(h=a.i18nMsg.title),u||(u=a.i18nMsg.detail),void(b+="["+m[e+C].tableName+"]:"+a.msg+".\n ");v++;var i=t[a.model.format]||0,n=d.eq(l).parent();n.attr("data-param",JSON.stringify({createSql:"new"==a.msg?a.model.ddl:"",ddl:"show"==a.msg?a.model.ddl:"",name:o,tableName:m[e+C].tableName,catalog:s,schema:r,dbId:globalParam.targetId,tableType:i})),n.siblings(".db").html(o),n.find(".check").click()})}$("#waitLoading").find("article .detail").html(common_js_lang["loading.info.confInfo"].replace(/\[x\]/,v).replace(/\[y\]/,y)),C+=100,a()}})}if(2==globalParam.targetType){var e=$(".global-batch .hdfsTab .selectedDir").val().trim();if(!e)return void MsgTip("",common_js_lang["db.info.batchDir"],"info");for(var t=(d=$(".rightSide .target-item .target-tbl.cur")).length,l=0;l<t;l++){var i=d.eq(l).parent().text()+".txt";i.match(/\s+|\\+/g)?d.eq(l).parent().siblings(".fileName").html(""):(d.eq(l).parent().attr("data-param",JSON.stringify({fileName:e+("/"!=e?"/":"")+i})),d.eq(l).parent().siblings(".fileName").html(e+("/"!=e?"/":"")+i))}$(".global-mask, .global-batch").fadeOut()}else{var n=$("#batch-dbName option:selected"),o=n.val(),r=n.data("schema"),s=n.data("catalog");if(!o)return void MsgTip("",common_js_lang["db.info.dbEmpty"],"info");for(var d=$(".rightSide .target-item .target-tbl.cur"),c=d.length,m=[],p=[],l=0;l<c;l++){var g=d.eq(l).parent().text();if(g.match(/^[0-9A-Za-z]\w*$/g)){var f=d.eq(l).parents("tr");m.push({catalog:f.data("catalog"),schema:f.data("schema"),tableName:g,index:l}),p.push({catalog:s,schema:r,tableName:g,tableType:1==globalParam.targetType?0:1})}else d.eq(l).parent().attr("data-param",JSON.stringify({name:o,catalog:s,schema:r,id:globalParam.targetId})),d.eq(l).parent().siblings(".db").html(o),d.eq(l).parent().siblings(".tbl").html("")}if(m.length<=0)return $(".global-mask, .global-batch").fadeOut(),void $("#waitLoading").css({display:"none"});$("#waitLoading").find("article").html("<p>"+common_js_lang["loading.info.batchConf"].replace(/\[x\]/,m.length)+'</p><p class="detail"></p>').end().css({display:"block"});var b="",h="",u="",v=0,y=0,C=0,t=m.length;a()}}),$(".global-batch").on("click",".btn-cancel, h4 .cancel",function(){$(".global-mask, .global-batch").fadeOut()}),$(".rightSide").on("click",".target-item .config",function(){$(this).addClass("active"),$(this).parent().attr("data-partition")?globalParam.partTag=!0:globalParam.partTag=!1;var a=$.Deferred(),e=setTimeout(function(){$("#globalLoadCon").css({display:"block"})},200),t=$(this).siblings(".target-name"),l=t.attr("data-param")?JSON.parse(t.attr("data-param")):{},i=t.attr("data-filter")?JSON.parse(t.attr("data-filter")):{};$.when(a).then(function(){window.clearInterval(e),$("#globalLoadCon").css({display:"none"}),resetConfigCon(l,i)}),a.resolve(),$(".global-mask, .global-ConfigCon").fadeIn(),editor.refresh()}),$(".rightSide").on("click",".allSelected",function(){$(this).toggleClass("cur");var a=$(this).hasClass("cur");$(".rightSide .target-db, .rightSide .target-tbl").toggleClass("cur",a)}),$(".rightSide").on("click",".target-db",function(){$(this).toggleClass("cur");var a=$(this).hasClass("cur"),e=$(this).parents(".target-path").data("name");$('.rightSide [data-name="'+e+'"] .check').toggleClass("cur",a),$(".rightSide .target-db").length==$(".rightSide .target-db.cur").length?$(".rightSide .allSelected").addClass("cur"):$(".rightSide .allSelected").removeClass("cur")}),$(".rightSide").on("click",".target-tbl",function(){$(this).toggleClass("cur");var a=$(this).parents("tr").data("name"),e=$('.rightSide [data-name="'+a+'"] .target-tbl').length==$('.rightSide [data-name="'+a+'"] .target-tbl.cur').length;$('.rightSide [data-name="'+a+'"] .target-db').toggleClass("cur",e);var t=$(".rightSide .target-tbl").length==$(".rightSide .target-tbl.cur").length;$(".rightSide .allSelected").toggleClass("cur",t)}),$(".global-ConfigCon").on("click",".btn-item",function(){function a(){var a=$(".rightSide .target-item .config.active").removeClass("active");a.siblings(".target-name").attr("data-param",JSON.stringify(l)),2==globalParam.targetType?a.siblings(".fileName").html(l.fileName):(a.siblings(".db").html(l.name),a.siblings(".tbl").html(l.tableName)),$(".global-mask, .global-ConfigCon").fadeOut()}if($(this).hasClass("next")){var e=[],t=!1;return $('#partitions .flex-item:not(".head") .key').map(function(a,l){if($(l).parent().hasClass("new")){var i=$(l).find("input").val().trim();if(!i.match(/^(\w|_|-|\(|\))+$/g))return t=!0,void $(l).find("input").addClass("error");$(l).find("input").removeClass("error"),e.push(i)}else e.push($(l).text())}),t?void MsgTip("",common_js_lang["db.info.partChars"],"info"):($(".global-ConfigCon .dbTab").addClass("hidden"),$(".global-ConfigCon .setPart").removeClass("hidden"),JSON.stringify(e)!==$(this).attr("data-part")?(partAllList(JSON.parse($(".config.active").parent().attr("data-partition")),e),$(this).attr("data-part",JSON.stringify(e)),$(this).html(common_js_lang["db.text.save"]).removeClass("next"),void $(this).siblings(".prev").removeClass("hidden")):($(this).html(common_js_lang["db.text.save"]).removeClass("next"),void $(this).siblings(".prev").removeClass("hidden")))}var l=saveParamSwitch();if(!l)return!1;globalParam.partTag&&l.noPart?swal({title:"",text:common_js_lang["db.text.lostPartSure"],type:"info",showCancelButton:!0,confirmButtonText:common_js_lang["db.text.returnCheck"],cancelButtonText:common_js_lang["db.text.confirm"]},function(e){e||a()}):!globalParam.partTag||l.partAll||l.useSynchronized?a():swal({title:"",text:common_js_lang["db.text.transPart"],type:"info",showCancelButton:!0,confirmButtonText:common_js_lang["db.text.allTrans"],cancelButtonText:common_js_lang["db.text.yes"]},function(e){e?$(".setPart .partCon .item.head .check").click():a()})}),$(".global-ConfigCon").on("click",".btn-cancel, .cancel",function(){$(".global-mask, .global-ConfigCon").fadeOut(),$(".rightSide .target-item .config.active").removeClass("active")}),$(".setPart").on("click",".useSynch .pop",function(){if(1==$(this).find(".check").length){var a=$(this).find(".check");a.toggleClass("cur"),a.hasClass("cur")?$(".setPart .head, .setPart .main").addClass("hidden"):$(".setPart .head, .setPart .main").removeClass("hidden")}else 1==$(this).find(".radio").length&&($(this).parent().find(".radio").removeClass("cur"),$(this).find(".radio").addClass("cur"))}),$(".global-ConfigCon").on("click",".prev",function(){$(".global-ConfigCon .setPart").addClass("hidden"),$(".global-ConfigCon .dbTab").removeClass("hidden"),$(this).siblings(".btn-item").html(common_js_lang["db.text.next"]).addClass("next"),$(this).addClass("hidden")}),$(".setPart").on("click",".item.check",function(){var a=$(this).find("i.check");$(this).hasClass("head")?a.hasClass("cur")?$(".setPart .main i.check.cur").removeClass("cur"):$(".setPart .main i.check").addClass("cur"):a.hasClass("cur")?(a.removeClass("cur"),$(".setPart .main .item.head i.check").removeClass("cur")):(a.addClass("cur"),$('.setPart .main .item:not(".head") i.check').length===$('.setPart .main .item:not(".head") i.check.cur').length&&$(".setPart .main .item.head i.check").addClass("cur"))}),$(".setPart").on("click",".batchPart",function(){$(".setPart .partCon .check.cur").length>0&&$(".batchPartCon").removeClass("hidden")}),$(".setPart").on("click",".batchCancel",function(){$(".batchPartCon").addClass("hidden")}),$(".setPart").on("click",".batchSave",function(){for(var a=$(".setPart .batchList > div"),e=[],t=0,l=a.length;t<l;t++){var i=a.eq(t).find(".val select").val().trim();if(""===i||!i.match(/^(\w|_|-|\(|\))+$/g))return void MsgTip("",common_js_lang["db.info.partChars"],"info");e.push(i)}for(var n=$('.setPart .partCon .item:not(".head") .check.cur'),t=($(".setPart .partCon .row-flex.tar"),0),l=n.length;t<l;t++)n.eq(t).parents(".flex-item").find(".row-flex.tar select").map(function(a,t){$(t).val(e[a])!==e[a]&&$(t).prepend('<option value="'+e[a]+'">'+e[a]+"</option>"),$(t).select2({tags:!0})});$(".batchPartCon").addClass("hidden")}),$(".setPart").on("click",".partType label",function(){if(!$(this).find(".radio.cur").length){$(this).parent().find(".radio.cur").removeClass("cur"),$(this).find(".radio").addClass("cur");var a=$(this).find(".radio").data("val");$(".setPart .partTypeTab").addClass("hidden"),$(".setPart .partType_"+a).removeClass("hidden")}}),$(".hdfsTab").on("click","li p .show",function(){0==$(this).parent().siblings("ul").find("li").length?(getDir($(this).parents("li").data("base")),$(this).toggleClass("in"),$(this).parent().siblings(".ul").fadeIn()):($(this).toggleClass("in"),$(this).parent().siblings("ul").toggle())}),$(".hdfsTab").on("click","li p .check",function(){if(!$(this).hasClass("cur")){$(".hdfsTab li p .check").removeClass("cur"),$(this).addClass("cur");var a=$(this).parents("li").data("base");$(".hdfsTab .selectedDir").val(a)}}),hiveConfigModule.prototype={event:function(){var a=this;a.container.on("change","#dbName",function(){var e=a.getParam();e.name&&a.getTables(e)}),a.container.on("change","#tableName",function(){var e=a.getParam();if(e.name&&e.tableName)return e.tableName.match(/^[0-9A-Za-z]\w*$/g)?void a.getDdlAct(e,a.newType):(MsgTip("",common_js_lang["db.info.tableName"],"info"),a.container.find("#tableName").val("").select2({tags:!0}),!1)}),a.container.on("change",".tableType",function(){var e=a.getParam();if(e.name&&e.tableName){if(!e.tableName.match(/^[0-9A-Za-z]\w*$/g))return MsgTip("",common_js_lang["db.info.tableName"],"info"),a.container.find("#tableName").val("").select2({tags:!0}),!1;$("#globalLoadCon").show(),$.when(globalParam.promiseFunc.newDbDdl(e)).then(function(e){a.editor.doc.setValue(e.ddl);var t={text:"0",orc:"1",parquet:"2",rcfile:"3",sequencefile:"4"};a.container.find(".tableType").val(t[e.format]||0).prop("disabled",!1),partDdl()}).always(function(){$("#globalLoadCon").hide()})}})},getParam:function(){var a=this,e=a.container.find("#dbName option:selected"),t={dbId:globalParam.targetId,name:e.val(),catalog:e.attr("data-catalog")||"",schema:e.attr("data-schema")||"",tableName:a.container.find("#tableName").val(),tableType:a.container.find(".tableType").val(),pid:$("#userApp").val(),fromId:globalParam.sourceId,toId:globalParam.targetId};if(0==a.newType){t.toTablesJson=JSON.stringify([{catalog:t.catalog,schema:t.schema,tableName:t.tableName,tableType:t.tableType}]);var l=$(".rightSide .target-item .config.active").parent(),i=l.data("catalog"),n=l.data("schema"),o=$(".rightSide .target-item .config.active").siblings(".target-name").text();return t.fromTablesJson=JSON.stringify([{catalog:i,schema:n,tableName:o}]),t}var r=SQLEditor.getValue().replace(/\n+/g," ").trim();return t.sql=r,t.format=a.container.find(".tableType option:selected").text(),t},getTables:function(a){var e=this;$("#globalLoadCon").show(),$.when(globalParam.promiseFunc.getTables(a)).then(function(){e.container.find(".hive .infoline.last").hide(),e.container.find("#partitions").empty();var t=globalParam.tblModel["tbl_"+a.dbId+"_"+a.catalog+"_"+a.schema],l='<option value="" disabled>'+common_js_lang["local.option.setTbl"]+"</option>";if(t.map(function(a){l+='<option data-name="'+a.name+'">'+a.name+"</option>"}),e.container.find("#tableName").html(l),!a.tableName||!a.tableName.match(/^[0-9A-Za-z]\w*$/g))return e.container.find("#tableName").val("").select2({tags:!0}),MsgTip("",common_js_lang["db.info.tableName"],"info"),$("#globalLoadCon").hide(),!1;if(e.container.find("#tableName").val(a.tableName).select2({tags:!0}),e.container.find("#tableName").val()!=a.tableName&&e.container.find("#tableName").append("<option>"+a.tableName+"</option>").val(a.tableName).select2({tags:!0}),$(".global-ConfigCon .text-right .btn-item").removeClass("next").html(common_js_lang["db.text.save"]),a.tableName){if(a.ddl)return e.getPart(a.tableName,a.catalog,a.schema,a.partition,a),void $("#globalLoadCon").hide();if(a.createSql){if(globalParam.partTag)if(globalParam.partTag&&a.newPart){var i=JSON.parse(a.newPart),n=partFormat(2);$(".global-ConfigCon .newPart").css({display:"none"}),$("#partitions").html(n.head).parent().css({display:"block"});var o=JSON.parse($(".config.active").parent().attr("data-partition")),r=[];for(var s in i){r.push(s);var d=i[s],c=$("#partitions").append(n.item).find(".flex-item.new:last-child");c.find(".type select").val(d.type),c.find(".key input").val(s)}var m=a.partition||"";globalParam.partTag&&a.partAll&&""==m&&(m=!0),globalParam.partTag&&a.useSynchronized&&(m=!0),partitionReshow(m,a,o,r)}else $(".hive .newPart").css({display:"block"});else{var p=(n=partFormat(1)).head;$(".global-ConfigCon .newPart").css({display:"none"}),$("#partitions").html(p).parent().css({display:"block"});var g=JSON.parse(a.partition);for(var s in g){d=g[s];(c=$("#partitions").append(n.item).find(".flex-item.new:last-child")).find(".type select").val(d.type),c.find(".key input").val(s);var f=c.find(".val select");f.val(d.value),f.val()!=d.value&&f.prepend('<option value="'+d.value+'">'+d.value+"</option>"),f.select2({tags:!0})}}return void $("#globalLoadCon").hide()}a.ddl||a.createSql?$("#globalLoadCon").hide():e.getDdlAct(a,e.newType)}else e.editor.doc.cm.setOption("readOnly","nocursor"),e.editor.doc.setValue(""),e.container.find(".new-sql .CodeMirror").addClass("disabled"),e.container.find("#tableName").val("").select2({tags:!0}),$("#globalLoadCon").hide()}).fail(function(){$("#globalLoadCon").hide()})},getDdlAct:function(a,e){var t=this;$("#globalLoadCon").show();var l=$.Deferred();$.when(globalParam.promiseFunc.getDdl(a,e)).then(function(e){if(t.editor.doc.setValue(e.ddl),e.isShow){t.editor.doc.cm.setOption("readOnly","nocursor"),t.container.find(".CodeMirror").addClass("disabled");i={text:"0",orc:"1",parquet:"2",rcfile:"3",sequencefile:"4"};t.container.find(".tableType").val(i[e.format]||0).prop("disabled",!0),t.getPart(a.tableName,a.catalog,a.schema,a.partition,a||"",l),$(".hive .newPart").css({display:"none"})}else{t.editor.doc.cm.setOption("readOnly",!1),t.container.find(".CodeMirror").removeClass("disabled");var i={text:"0",orc:"1",parquet:"2",rcfile:"3",sequencefile:"4"};if(t.container.find(".tableType").val(i[e.format]||0).prop("disabled",!1),t.container.find("#partitions").empty(),t.container.find(".hive .infoline.last").hide(),$(".hive .newPart").css({display:"block"}),globalParam.partTag){var n=JSON.parse($(".rightSide .config.active").parent().attr("data-partition")),o=partFormat(2);$(".hive .newPart").css({display:"none"}),$(".hive .infoline.last").css({display:"block"}),$("#partitions").html(o.head),n.map(function(a,e){$("#partitions").append(o.item),$("#partitions .flex-item:last-child").find(".type select").val(a.column.typeName.toLowerCase()).end().find(".key input").val(a.name),["varchar","char"].indexOf(a.column.typeName.toLowerCase())>-1&&$("#partitions .flex-item:last-child").find(".type select option:selected").attr("data-len",a.column.columnSize)}),$(".global-ConfigCon .text-right .btn-item").addClass("next").html(common_js_lang["db.text.next"])}l.resolve()}}).fail(function(){t.container.find("#tableName").val("").select2({tags:!0}),t.editor.doc.setValue(""),t.editor.doc.cm.setOption("readOnly","nocursor"),t.container.find(".CodeMirror").addClass("disabled"),t.container.find(".tableType").val(0).prop("disabled",!0),l.reject()}),$.when(l).always(function(){$("#globalLoadCon").hide()})},getPart:function(a,e,t,l,i,n){var o=this;$.when(globalParam.promiseFunc.getPart({dbId:globalParam.targetId,tableName:a,catalog:e,schema:t})).then(function(a){o.partitionShow(a,l,i),n&&n.resolve()}).fail(function(){n&&n.reject()})},partitionShow:function(a,e,t){if($("#partitions").empty(),a&&0!=a.length){$(".hive .infoline.last").css({display:"block"}),globalParam.partTag&&$(".global-ConfigCon .text-right .btn-item").addClass("next").html(common_js_lang["db.text.next"]);var l=partFormat(globalParam.partTag?3:4).head;if($("#partitions").append(l),a.map(function(a,e){l="",globalParam.partTag?l+='<div class="flex-item"><span class="type item">'+a.column.typeName+'</span><span class="key item">'+a.name+"</span></div>":(l+='<div class="flex-item"><span class="type item">'+a.column.typeName+'</span><span class="key item">'+a.name+'</span><span class="item val"><select class="select2 filedVal selVal" id="Part_level_'+e+'" data-key="'+a.name+'">',a.parts.map(function(a){l+='<option value="'+a.value+'" title="'+a.name+'">'+a.value+"</option>"}),l+=globalParam.columnValOption+"</select></span></div>"),$("#partitions").append(l),$("#partitions #Part_level_"+e).select2({tags:!0})}),globalParam.partTag&&t.partAll&&""==e&&(e=!0),globalParam.partTag&&t.useSynchronized&&(e=!0),e)if(globalParam.partTag){var i=JSON.parse($(".config.active").parent().attr("data-partition")),n=[];a.map(function(a,e){n.push(a.name)}),partitionReshow(e,t,i,n)}else{var o=JSON.parse(e);for(var r in o)1==$("#partitions").find('[data-key="'+r+'"]').find('[value="'+o[r]+'"]').length?$("#partitions").find('[data-key="'+r+'"]').val(o[r]).trigger("change"):$("#partitions").find('[data-key="'+r+'"]').prepend('<option value="'+o[r]+'">'+o[r]+"</option>").val(o[r]).change()}}else $(".hive .infoline.last").css({display:"none"}),globalParam.partTag&&$(".global-ConfigCon .text-right .btn-item").removeClass("next").html(common_js_lang["db.text.save"])}};var hiveModule=new hiveConfigModule({container:$(".global-ConfigCon")});$(".hive").on("click",".newPart",function(){$(this).css({display:"none"}),$(".infoline.last").css({display:"block"});var a=partFormat(globalParam.partTag?2:1),e=a.head;$("#partitions").append(e),e=a.item,$("#partitions").append(e).find(".flex-item.new:last-child .val select").select2({tags:!0}),globalParam.partTag&&$(".global-ConfigCon .btn-item").addClass("next").html(common_js_lang["db.text.next"])}),$(".hive").on("click","a.add",function(){var a=partFormat(globalParam.partTag?2:1).item;$(a).find(".val select").select2({tags:!0}),$("#partitions").append(a).find(".flex-item.new:last-child .val select").select2({tags:!0})}),$(".hive").on("click","a.del",function(){$(this).parents(".flex-item").remove(),0==$('#partitions .flex-item:not(".head")').length&&($(".infoline.last").css({display:"none"}),$("#partitions").empty(),$(".hive .newPart").css({display:"block"}),globalParam.partTag&&$(".global-ConfigCon .btn-item").removeClass("next").html(common_js_lang["db.text.save"])),partDdl()}),$(".hive").on("change",".flex-item.new select",function(){partDdl()}),$(".hive").on("blur",".flex-item.new input",function(){partDdl()}),$(".item2").on("click",".act .btn-cancel",function(){$(".stepCon").animate({"margin-left":0},250),$(".processCon .itemCon").removeClass("cur").eq(0).addClass("cur"),$("html, body").animate({scrollTop:0},200)}),$(".item2").on("click",".act .btn-item",function(){var a=$(".rightSide .target-item .target-name"),e=a.length;if(e<=0)return MsgTip("",common_js_lang["db.info.confTar"],"info"),!1;var t=[],l=[],i=[],n=[],o=[],r=[],s=$.Deferred();$("#globalLoadCon").css({display:"block"});for(var d=0;d<e;d++){var c=a.eq(d).attr("data-param")?JSON.parse(a.eq(d).attr("data-param")):{},m=a.eq(d).attr("data-filter")?JSON.parse(a.eq(d).attr("data-filter")):{},p=a.eq(d).parent().data("name"),g=a.eq(d).text(),f=a.eq(d).parent().data("catalog"),b=a.eq(d).parent().data("schema"),h=c.ddl||"";if(h&&h.indexOf("CLUSTERED BY")>-1&&h.indexOf("org.apache.hadoop.hive.ql.io.orc.OrcSerde")>-1&&h.indexOf("'transactional'='true'")>-1)return MsgTip("info",common_js_lang["db.text.db"]+"["+p+"] "+common_js_lang["db.text.tbl"]+"["+g+"] "+common_js_lang["db.tip.hivexspark"]),!1;if(c.ddl&&!c.partition&&!c.useSynchronized&&!c.partAll){var u=globalParam.partitionsData["catalog"+c.catalog+"_schema"+c.schema+"_"+c.tableName];if(u&&u.length>0)return MsgTip("",common_js_lang["db.text.tbl"]+"["+c.tableName+"] "+common_js_lang["local.info.hiveParam"]+"\n","info"),!1;u||r.push(c)}!function(a,e,n,r,s,d,c){function m(){if(2==globalParam.targetType){if(!checkHdfs(a))return o[c].reject(),MsgTip("",common_js_lang["db.text.db"]+"["+n+"] "+common_js_lang["db.text.tbl"]+"["+r+"] "+common_js_lang["dbManage.info.hdfsParamErr"],"info"),!1;t[c]={id:globalParam.sourceId,name:n,catalog:s,schema:d,tableName:r,whereSql:e.whereSql||""},l[c]=a,o[c].resolve()}else{if(!a.name||!a.tableName||!a.createSql&&!a.catalog&&!a.schema)return o[c].reject(),MsgTip("",common_js_lang["db.text.db"]+"["+n+"] "+common_js_lang["db.text.tbl"]+"["+r+"] "+common_js_lang["local.info.hiveParam"],"info"),!1;if(t[c]={id:globalParam.sourceId,name:n,catalog:s,schema:d,tableName:r,partition:a.fromPart||"",partitionTable:a.fromIsPart,useSynchronized:a.useSynchronized||!1,tarPartHandleType:a.tarPartHandleType},i[c]=a,i[c].partitionTable=a.toIsPart,a.fromPart){if(a.newPart){var m=JSON.parse(a.newPart),p=[];for(var g in m)p.push(g);var f=JSON.parse(a.partition),b=[];for(var g in f)u=[],f[g].map(function(a,e){u.push(p[e]+"="+a)}),b.push(u.join("/"))}else if(a.part){var h=JSON.parse(a.part),f=JSON.parse(a.partition),b=[];for(var g in f){var u=[];f[g].map(function(a,e){u.push(h[e]+"="+a)}),b.push(u.join("/"))}}i[c].partition=JSON.stringify(b)}else if(a.partition){var v=JSON.parse(a.partition),f=[];for(var g in v){var $=v[g];$.value&&($=$.value),f.push(g+"="+$)}i[c].partition=JSON.stringify([f.join("/")])}o[c].resolve()}}o[c]=$.Deferred(),globalParam.jobId>0?$.ajax({url:"db/table/exist2",data:{dbId:globalParam.sourceId,catalog:s,schema:d,tableName:r},success:function(a){return 200!=a.code?(o[c].reject(),ErrTip(a.i18nMsg.title,a.i18nMsg.detail,a.msg),!1):a.model?void m():(o[c].reject(),MsgTip("",common_js_lang["db.text.db"]+"["+n+"] "+common_js_lang["db.text.tbl"]+"["+r+"] "+common_js_lang["db.text.notInSrc"],"info"),!1)},error:function(){o[c].reject()}}):m()}(c,m,p,g,f,b,d)}o[e]=s,r.length>0?$.ajax({url:"db/table/partitions/batch",data:{dbId:globalParam.targetId,pid:$("#userApp").val(),tablesJsonStr:JSON.stringify(r)},type:"post",success:function(a){var e="",t="",l="";return 200!=a.code?(ErrTip(a.i18nMsg.title,a.i18nMsg.detail,a.msg),void s.reject()):(a.model.map(function(a){if(200!=a.code)return t||(t=a.i18nMsg.title),l||(l=a.i18nMsg.detail),void(e+=a.msg+".\n");a.model&&a.model.partitions.length>0&&(e+=common_js_lang["db.text.tbl"]+"["+a.model.name+"] "+common_js_lang["local.info.hiveParam"]+"\n")}),e?(ErrTip(t,l,e,"info"),void s.reject()):void s.resolve())},error:function(){s.reject()}}):s.resolve(),$.when.apply($,o).done(function(){var a=[];Array.prototype.push.call(a,t,l,i,n),globalParam.fromJson=t,globalParam.toHdfsJson=l,globalParam.toHiveJson=i,globalParam.toDbJson=n,$(".stepCon").animate({"margin-left":"-200%"},250),$(".processCon .itemCon").removeClass("cur").eq(2).addClass("cur"),$("html, body").animate({scrollTop:0},200)}).always(function(){$("#globalLoadCon").css({display:"none"})})}),$(".item3").on("click",".act .btn-cancel",function(){$(".processCon .itemCon").removeClass("cur").eq(1).addClass("cur"),$(".stepCon").animate({"margin-left":"-100%"},250),$("html, body").animate({scrollTop:0},200)}),$(".item3").on("click",".act .btn-item",function(){function a(){if(v>=p)return $("#waitLoading").css({display:"none"}),g?(d.reject(),void ErrTip(f,b,common_js_lang["loading.info.newInfo"].replace(/\[x\]/,h).replace(/\[y\]/,u)+"\n"+g,"info")):(MsgTip({type:"success",text:common_js_lang["loading.info.allNew"]}),void d.resolve());var e=c.slice(v,v+100),t=v+100<=p?100:p-v;$.ajax({url:"db/table/create/batch",type:"post",data:{dbId:globalParam.targetId,pid:i,tablesJsonStr:JSON.stringify(e)},success:function(e){200!=e.code?(f||(f=e.i18nMsg.title),b||(b=e.i18nMsg.detail),g+=e.msg+"\n",u+=t):e.model.map(function(a,e){var t=c[e+v].index;if(200!=a.code)return u++,f||(f=a.i18nMsg.title),b||(b=a.i18nMsg.detail),void(g+="["+globalParam.toHiveJson[t].tableName+"]:"+a.msg+".\n");h++,globalParam.toHiveJson[t].ddl="",globalParam.toHiveJson[t].createSql="",globalParam.toHiveJson[t].tableName=a.model.tableName,globalParam.toHiveJson[t].catalog=a.model.catalog,globalParam.toHiveJson[t].schema=a.model.schema}),v+=100,$("#waitLoading").find("article .detail").html(common_js_lang["loading.info.newInfo"].replace(/\[x\]/,h).replace(/\[y\]/,u)),a()}})}function e(){$.fn.ajaxAPI({url:"job/hive/save",type:"post",data:s,contentType:"application/x-www-form-urlencoded",callback:function(a){window.onbeforeunload=function(){},location.href="./success"},complete:function(){$(".item3 .act .btn-item").prop("disabled",!1)}})}$(this).prop("disabled",!0);var t=($(".item1 .taskName").val()||"").trim(),l=($(".item1 .taskDes").val()||"").trim();if(!t)return $(this).prop("disabled",!1),void MsgTip("",common_js_lang["client.info.taskNameErr"],"info");var i=$("#userApp").val()||0;if(!i)return $(this).prop("disabled",!1),void MsgTip("",common_js_lang["dbManage.title.setApp"],"info");var n=cronExport.cronExec($(".group-type .cur").index(),!0);if(!n.cronParam||-1==[0,1,2].indexOf(+n.periodType))return $(this).prop("disabled",!1),$("#globalLoadCon").css({display:"none"}),!1;var o=$(this),r=n,s={pid:i,jobName:t,note:l,mtype:$(".mtype .radio.cur").attr("data-val"),fromJson:JSON.stringify(globalParam.fromJson),periodType:r.periodType,fromId:globalParam.sourceId,toId:globalParam.targetId,cronExpression:r.cronParam,startTimeStr:r.startTimeStr||"",endTimeStr:r.endTimeStr||"",groupNo:globalParam.groupNo,toType:2==globalParam.targetType?8:9};if(globalParam.linkSource2type[1].indexOf(+globalParam.targetType)>-1&&(s.toType=2),globalParam.linkSource2type[2].indexOf(+globalParam.targetType)>-1&&(s.toType=6),globalParam.linkSource2type[3].indexOf(+globalParam.targetType)>-1&&(s.toType=7),globalParam.jobId>0&&!globalParam.urlObj.copy&&(s.id=globalParam.jobId),2==globalParam.targetType)s.toHdfsJson=JSON.stringify(globalParam.toHdfsJson);else if(1==globalParam.targetType){for(var d=$.Deferred(),c=[],m=0,p=globalParam.toHiveJson.length;m<p;m++)globalParam.toHiveJson[m].createSql&&(globalParam.toHiveJson[m].ddl=globalParam.toHiveJson[m].createSql,globalParam.toHiveJson[m].index=m,c.push(globalParam.toHiveJson[m]));if(c.length>=1){var g="",f="",b="",h=0,u=0,v=0,p=c.length;$("#waitLoading").find("article").html("<p>"+common_js_lang["loading.info.batchNew"].replace(/\[x\]/,p)+'</p><p class="detail"></p>').end().css({display:"block"}),a()}else d.resolve()}1==globalParam.targetType?$.when(d).then(function(){s.toHiveJson=JSON.stringify(globalParam.toHiveJson),e()},function(){o.prop("disabled",!1)}):e()}),function(){if(!(globalParam.jobId<=0)){var a={cronParam:globalParam.editJobModel.cronExpression,startTime:globalParam.editJobModel.startTime,endTime:globalParam.editJobModel.endTime};cronExport.resetCron(a)}}(),window.onbeforeunload=function(){if($(".taskName").val().trim()||$(".taskDes").val().trim())return common_js_lang["common.info.leavePage"]};