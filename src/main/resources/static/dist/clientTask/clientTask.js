$(function(){function e(){var e=location.search,t=new Object;if(-1!=e.indexOf("?"))for(var a=e.substr(1).split("&"),i=0;i<a.length;i++)t[a[i].split("=")[0]]=unescape(a[i].split("=")[1]);return t}function t(){for(var e=$("#partitions .item .filedVal")||$("#partitions .item select"),t=[],a=0,i=e.length;a<i;a++){var n={};n.field=e.eq(a).attr("data-type"),n.value=e.eq(a).val().trim(),t.push(n)}return t=JSON.stringify(t)}function a(){if(k.taskName=$("#taskName").val(),k.taskDes=$(".tastDes").val(),k.myClientId=e().clientId,k.autoCompressToGz=!1,k.srcPath=$("#fileRouteMsg").val(),k.bakDump=!1,k.dumpBakName="",k.srcColumnSep=$(".columnSep .val").attr("data-val"),1==$(".configTask .bCheckType.boxCheck").length?k.isSubdirSupport=!0:k.isSubdirSupport=!1,1==$(".fileFilterType .radio.cur").attr("data-val")){var a=$(".multipleSelect").val()||[];if($(".addFileFilter").val().trim()&&a.push($(".addFileFilter").val().trim()),!(a=a.join(",")))return void MsgTip("info",common_js_lang["client.info.filterType"]);var i=$("#fileTypeChoice").val();k.ignorePattern=1==i?a:"",k.matchPattern=0==i?a:""}else k.matchPattern="",k.ignorePattern="";var n=$(".configTask .line .radio.cur").attr("data-val");return 0==n?(k.finishActionType=0,k.finishActionParam=""):1==n?(k.finishActionType=1,k.finishActionParam=$("#suffixContent").val()):2==n&&(k.finishActionType=2,k.finishActionParam=$("#moveSite").val()),$(".fileRouteChoice").val()==globalParam.commonLinkType.hdfs?(k.hdfsDir=$(".desDirHdfs").val(),k.dbName="",k.tblName="",k.partitions=""):(k.hdfsDir="",k.dbName=$("#dbName option:selected").text(),k.tblName=$("#tableName option:selected").text(),k.tableType=globalParam.tableType,k.partitions=t()),k.overwrite=!1,k.periodType=globalParam.cronGlobalParam.periodType,k.cronExpression=globalParam.cronGlobalParam.cronParam,k.startTimeStr=globalParam.cronGlobalParam.startTimeStr||"",k.endTimeStr=globalParam.cronGlobalParam.endTimeStr||"",k}function i(){a(),$.ajax({url:"online/client/job/save",type:"post",data:{hid:$(".connId").val(),toType:8,pid:$("#userApp").val(),startTimeStr:k.startTimeStr,endTimeStr:k.endTimeStr,myClientId:k.myClientId,srcPath:k.srcPath,subdirSupport:k.isSubdirSupport,autoCompressToGz:k.autoCompressToGz,matchPattern:k.matchPattern,ignorePattern:k.ignorePattern,hdfsDir:k.hdfsDir,dbName:k.dbName,tblName:k.tblName,overwrite:k.overwrite,partitions:k.partitions,cronExpression:k.cronExpression,periodType:k.periodType,bakDump:k.bakDump,dumpBakName:k.dumpBakName,finishActionType:k.finishActionType,finishActionParam:k.finishActionParam,taskName:k.taskName,note:k.taskDes,tableType:k.tableType},beforeSend:function(){$(".delayTip").show()},success:function(e){-1==e.code?y.ajaxFail():200==e.code?(window.onbeforeunload=function(){},$(".maskCell").show(),$(".contentBox").show()):ErrTip(e.i18nMsg.title,e.i18nMsg.detail,e.msg)},complete:function(){$(".delayTip").hide()}})}function n(){a(),$.ajax({url:"online/client/job/save",type:"post",data:{dbId:$(".connId").val(),srcColumnSep:k.srcColumnSep,toType:$(".fileRouteChoice").val()==globalParam.commonLinkType.hive?9:13,pid:$("#userApp").val(),startTimeStr:k.startTimeStr,endTimeStr:k.endTimeStr,myClientId:k.myClientId,srcPath:k.srcPath,subdirSupport:k.isSubdirSupport,autoCompressToGz:k.autoCompressToGz,matchPattern:k.matchPattern,ignorePattern:k.ignorePattern,hdfsDir:k.hdfsDir,dbName:k.dbName,tblName:k.tblName,overwrite:k.overwrite,partitions:k.partitions,cronExpression:k.cronExpression,periodType:k.periodType,bakDump:k.bakDump,dumpBakName:k.dumpBakName,finishActionType:k.finishActionType,finishActionParam:k.finishActionParam,taskName:k.taskName,note:k.taskDes,tableType:k.tableType},beforeSend:function(){$(".delayTip").show()},success:function(e){-1==e.code?y.ajaxFail():200==e.code?(window.onbeforeunload=function(){},$(".maskCell").show(),$(".contentBox").show()):ErrTip(e.i18nMsg.title,e.i18nMsg.detail,e.msg)},complete:function(){$(".delayTip").hide()}})}function o(){a();var t=e().jobId;$.ajax({url:"online/client/job/save",type:"post",data:{jobId:t,hid:$(".connId").val(),pid:$("#userApp").val(),toType:8,startTimeStr:k.startTimeStr,endTimeStr:k.endTimeStr,myClientId:k.myClientId,srcPath:k.srcPath,subdirSupport:k.isSubdirSupport,autoCompressToGz:k.autoCompressToGz,matchPattern:k.matchPattern,ignorePattern:k.ignorePattern,hdfsDir:k.hdfsDir,dbName:k.dbName,tblName:k.tblName,overwrite:k.overwrite,partitions:k.partitions,cronExpression:k.cronExpression,periodType:k.periodType,bakDump:k.bakDump,dumpBakName:k.dumpBakName,finishActionType:k.finishActionType,finishActionParam:k.finishActionParam,taskName:k.taskName,note:k.taskDes,tableType:k.tableType},success:function(e){-1==e.code?y.ajaxFail():200==e.code?(window.onbeforeunload=function(){},$(".maskCell").show(),$(".contentBox").show()):ErrTip(e.i18nMsg.title,e.i18nMsg.detail,e.msg)}})}function l(){a();var t=e().jobId;$.ajax({url:"online/client/job/save",type:"post",data:{jobId:t,dbId:$(".connId").val(),srcColumnSep:k.srcColumnSep,pid:$("#userApp").val(),toType:$(".fileRouteChoice").val()==globalParam.commonLinkType.hive?9:13,startTimeStr:k.startTimeStr,endTimeStr:k.endTimeStr,myClientId:k.myClientId,srcPath:k.srcPath,subdirSupport:k.isSubdirSupport,autoCompressToGz:k.autoCompressToGz,matchPattern:k.matchPattern,ignorePattern:k.ignorePattern,hdfsDir:k.hdfsDir,dbName:k.dbName,tblName:k.tblName,overwrite:k.overwrite,partitions:k.partitions,cronExpression:k.cronExpression,periodType:k.periodType,bakDump:k.bakDump,dumpBakName:k.dumpBakName,finishActionType:k.finishActionType,finishActionParam:k.finishActionParam,taskName:k.taskName,note:k.taskDes,tableType:k.tableType},success:function(e){-1==e.code?y.ajaxFail():200==e.code?(window.onbeforeunload=function(){},$(".maskCell").show(),$(".contentBox").show()):ErrTip(e.i18nMsg.title,e.i18nMsg.detail,e.msg)}})}function s(t){$.ajax({url:"online/client/job/detail",data:{jobId:t},async:!1,success:function(t){if(-1==t.code)y.ajaxFail();else if(200!==t.code)MsgTip("",common_js_lang["client.info.getDataErr"],"info");else{if($("#userApp").val(t.model.pid).select2(),e().copy&&(t.model.jobName=(t.model.jobName+"_copy").slice(0,60)),$("#taskName").val(t.model.jobName).attr("title",1==e().detail?t.model.jobName:""),$(".tastDes").val(t.model.note||""),$("#fileRouteMsg").val(t.model.clientParams.srcPath),t.model.clientParams.isSubdirSupport&&$(".configTask .bCheckType").addClass("boxCheck"),t.model.clientParams.matchPattern||t.model.clientParams.ignorePattern){$(".fileFilterType .radio").removeClass("cur").eq(1).addClass("cur"),$(".configTask .filter").show(),$(".multipleSelect").select2({tags:!0,placeholder:common_js_lang["client.info.fileType"]});var a=[],i=[".+\\.txt",".+\\.csv",".+\\.sql",".+\\.xls",".+\\.xlsx"];t.model.clientParams.matchPattern?(a=t.model.clientParams.matchPattern.split(","),$("#fileTypeChoice").val(0)):(a=t.model.clientParams.ignorePattern.split(","),$("#fileTypeChoice").val(1));for(var n=[],o=[],l=0;l<a.length;l++)i.indexOf(a[l])>-1?n.push(a[l]):o.push(a[l]);o.length>0&&$(".addFileFilter").val(o.join("|")),n.length>0&&$(".multipleSelect").val(n).change()}if(0==t.model.clientParams.finishActionType||(1==t.model.clientParams.finishActionType?($(".choiceTypeTip .line .radio").removeClass("cur").eq(0).addClass("cur"),$("#suffixContent").prop("disabled",!1).val(t.model.clientParams.finishActionParam)):($(".choiceTypeTip .line .radio").removeClass("cur").eq(1).addClass("cur"),$("#moveSite").prop("disabled",!1).val(t.model.clientParams.finishActionParam))),t.model.clientParams.hdfsDir)$(".fileRouteChoice").val(globalParam.commonLinkType.hdfs),h(t.model.clientParams.hid),u(t.model.clientParams.hid),$(".desDirHdfs").val(t.model.clientParams.hdfsDir);else{if(9==t.model.toType?$(".fileRouteChoice").val(globalParam.commonLinkType.hive):$(".fileRouteChoice").val(globalParam.commonLinkType.spark),$(".hdfsChoice").hide(),$(".dbChoice, .colSepRow").show(),$(".dataTab, .new-sql").show(),$(".sameNameZone, .formatType").show(),T.hiveTable=t.model.clientParams.tblName,T.partitions=t.model.clientParams.partitions,T.partitions){var s={};T.partitions.split(",").map(function(e){var t=e.split("=");s[t[0]]=t[1].replace(/^\'|\'$/g,"")}),T.partitions=JSON.stringify(s)}h(t.model.clientParams.dbId),C=t.model.clientParams.dbId,r(t.model.clientParams.dbName);for(var c=t.model.clientParams.srcColumnSep||"",d=$(".replacementCon"),m=d.find(".item").removeClass("cur"),p=c,f=!1,g=0,b=m.length;g<b;g++)if(m.eq(g).attr("data-val")==c){p=m.eq(g).text(),f=!0;break}f||(p=""===p.trim()?p.match(/\s/g).length+common_js_lang["db.text.space"]:p),d.find(".val").text(p).attr({"data-val":c,title:c})}var v={cronParam:t.model.cronExpression,startTime:t.model.startTime,endTime:t.model.endTime};cronExport.resetCron(v)}}})}function r(e){var t=setTimeout(function(){$(".delayTip").show()},2e3);$.ajax({url:"db/dbs",data:{id:C,pid:$("#userApp").val()},success:function(t){if(200==t.code){var a="";t.model.databases.map(function(e,t){a+='<option catalog="'+e.catalog+'" schema="'+e.schema+'" value="'+e.dbName+'">'+e.dbName+"</option>"}),$("#dbName").html(a),t.model.databases&&t.model.databases.length<=0&&MsgTip("info",common_js_lang["dump.info.dbNone"]),e?($("#dbName").val(e).select2(),c(e,T.hiveTable)):($("#dbName").select2(),t.model.databases.length&&c(t.model.databases[0].dbName))}else{if(-1==t.code)return swal({title:"",text:common_js_lang["manage.info.timeout"],type:"info",showCancelButton:!0,confirmButtonText:common_js_lang["manage.info.newdow"],cancelButtonText:common_js_lang["manage.info.tologin"]},function(e){e?window.open("./","_blank"):location.href="./"}),!1;ErrTip(t.i18nMsg.title,t.i18nMsg.detail,t.msg)}},complete:function(){clearTimeout(t),$(".delayTip").hide()}})}function c(e,t){$.ajax({url:"db/table/tbls",data:{pid:$("#userApp").val(),dbId:C,schema:$("#dbName option:selected").attr("schema"),catalog:$("#dbName option:selected").attr("catalog")},beforeSend:function(){$(".delayTip").show()},success:function(e){if(200==e.code)if($("#tableName").html(""),e.model.length>0){var a="";e.model.map(function(e){a+='<option schema="'+e.schema+'" catalog="'+e.catalog+'">'+e.name+"</option>"}),$("#tableName").html(a);var i=$("#tableName option:selected").attr("catalog"),n=$("#tableName option:selected").attr("schema");t?($("#tableName").val(t).select2(),d(i,n,t,T.partitions)):($("#tableName").select2(),d(i,n,e.model[0].name)),m({catalog:i,schema:n,tableName:$("#tableName").val(),pid:$("#userApp").val()})}else MsgTip("info",common_js_lang["dump.info.dbNone"]);else-1==e.code?y.ajaxFail():ErrTip(e.i18nMsg.title,e.i18nMsg.detail,e.msg)},complete:function(){$(".delayTip").hide()}})}function d(e,t,a,i){$.ajax({url:"db/table/partitions",data:{dbId:C,catalog:e,schema:t,tableName:a},beforeSend:function(){$(".delayTip").show()},success:function(e){if($("#partitions").html(""),200==e.code)if(e.model&&0!=e.model.length){if($(".partitionZone").show(),e.model.map(function(e,t){var a="";a+='<div class="item"><input type="text" class="filedName" value="'+e.name+'" disabled><label>=</label><select class="select2 filedVal selVal" data-type="'+e.name+'" id="Part_level_'+t+'">',e.parts.map(function(e){a+='<option value="'+e.value+'" title="'+e.name+'">'+e.value+"</option>"}),a+=globalParam.columnValOption+"</select></div>",$("#partitions").append(a),$("#partitions #Part_level_"+t).select2({placeholder:"value",tags:!0})}),i){var t=JSON.parse(i);for(var a in t)1==$("#partitions").find('[data-type="'+a+'"]').find('[value="'+t[a]+'"]').length?$("#partitions").find('[data-type="'+a+'"]').val(t[a]).trigger("change"):$("#partitions").find('[data-type="'+a+'"]').prepend('<option value="'+t[a]+'">'+t[a]+"</option>").val(t[a]).trigger("change");P&&$("#partitions select").prop("disabled",!0)}}else $(".partitionZone").hide();else ErrTip(e.i18nMsg.title,e.i18nMsg.detail,e.msg)},complete:function(e){if($(".delayTip").hide(),-1==e.responseJSON.code)return swal({title:"",text:common_js_lang["manage.info.timeout"],type:"info",showCancelButton:!0,confirmButtonText:common_js_lang["manage.info.newdow"],cancelButtonText:common_js_lang["manage.info.tologin"]},function(e){e?window.open("./","_blank"):location.href="./"}),!1}})}function m(e){e.dbId=C,$.ajax({url:"db/table/ddl/show",data:e,success:function(e){if(200==e.code){if(e.mppTable&&globalParam.targetType==globalParam.commonLinkType.hive)return b.doc.setValue(""),void MsgTip("info",common_js_lang["db.tip.hivexspark"]);if(!e.mppTable&&globalParam.targetType==globalParam.commonLinkType.spark)return b.doc.setValue(""),void MsgTip("info",common_js_lang["db.tip.sparkxhive"]);var t={text:"0",orc:"1",parquet:"2",rcfile:"3",sequencefile:"4"};globalParam.tableType=t[e.model.format],$(".mapRouteMsg .tableType").val(globalParam.tableType),b.doc.setValue(e.model.ddl),b.doc.cm.setOption("readOnly","nocursor"),$(".new-sql .CodeMirror").addClass("disabled")}else ErrTip(e.i18nMsg.title,e.i18nMsg.detail,e.msg)}})}function p(){function t(){this.container=$(".upload-tab.mapData"),this.init(),1==e().detail||this.event()}function a(t){t=t||{},this.container=t.container||$("body"),1==e().detail?this.container.find(".replacementCon").addClass("disabled"):this.event()}function i(e){0==e?($(".desDirHdfs, .defaultRoute").val("").attr("title",""),$(".thisRoute.startThis").parent().find(".turnOff").show(),$(".thisRoute.startThis").parent().find(".turnOn").hide(),$(".hdfsRouteBox .startLi .routeLabel.rCheckIcon").removeClass("rCheckIcon"),$(".hdfsRouteBox .startLi > .allMeun").remove()):(b.doc.setValue(""),$("#dbName, #tableName").html("").select2())}function n(e){var t=e.parent().parent();t.show(),t.siblings(".oneRoute").children(".turnOn").show(),t.siblings(".oneRoute").children(".turnOff").hide(),t.hasClass("firstM")||n(t)}t.prototype={init:function(){var t=this;t.container.find(".cancel").click(function(){location.href="./client.taskm?id="+e().clientId});var a=[".+\\.txt",".+\\.csv",".+\\.sql",".+\\.xls",".+\\.xlsx"];t.container.find(".multipleSelect").select2({placeholder:common_js_lang["client.info.fileType"],data:a,tags:!0}),t.container.find(".tooltip").tipsy({fade:!0,gravity:"s"}),t.container.find(".dataNextStep").click(function(){if(""!=$("#taskName").val().trim())if($("#fileRouteMsg").val()){if(1==$(".fileFilterType .radio.cur").attr("data-val")){var e=t.container.find(".addFileFilter").val().trim();if(!$(".multipleSelect").val()&&!e)return void MsgTip("",common_js_lang["client.info.filterType"],"info");if(e)try{new RegExp(e)}catch(e){return void MsgTip("",common_js_lang["client.info.regularErr"],"info")}}var a=t.container.find(".line .radio.cur");0!=a.length&&(1!=a.find("input").length||a.find("input").val().trim())?($(".mapData").hide().siblings(".mapRoute").show(),b.refresh()):MsgTip("",common_js_lang["client.info.upedDealType"],"info")}else MsgTip("",common_js_lang["client.info.fileSrc"],"info");else MsgTip("",common_js_lang["local.info.taskNameNone"],"info")})},event:function(){var e=this;e.container.find(".bCheckType").on("click",function(){$(this).toggleClass("boxCheck")}),e.container.find(".fileFilterType").on("click",".radio",function(){$(this).hasClass("cur")||($(this).addClass("cur").siblings(".radio").removeClass("cur"),1==$(this).attr("data-val")?(e.container.find(".filter").show(),$(".multipleSelect").select2({tags:!0,placeholder:common_js_lang["client.info.fileType"]})):e.container.find(".filter").hide())}),e.container.find(".choiceTypeTip").on("click",".line",function(){if(1==$(this).find(".radio.cur").length)return!1;e.container.find(".line .radio.cur").removeClass("cur").find("input").prop("disabled",!0),$(this).find(".radio").addClass("cur").find("input").prop("disabled",!1)})}},new t,a.prototype={event:function(){var e=this;e.container.on("click",".replacementCon .val",function(){var e=$(this).parent();if(1==+e.attr("data-disabled"))return!1;if(e.hasClass("show"))e.removeClass("show");else{for(var t=$(this).attr("data-val")||"",a=e.find(".item").removeClass("cur"),i=!1,n=0,o=a.length;n<o;n++)if(a.eq(n).attr("data-val")==t){a.eq(n).addClass("cur"),i=!0;break}i?e.find(".inputReplacement").val(""):e.find(".inputReplacement").val(t),e.addClass("show")}}),e.container.on("click",".replacementCon .item",function(){var t=$(this).text(),a=$(this).attr("data-val")||"";return e.replacementUpdateVal(t,a),!1}),e.container.on("click",".replacementCon button",function(){var t=$(this).siblings(".inputReplacement").val()||"";if(t.length<=0)return MsgTip("",common_js_lang["csv.text.columnSep"]),!1;var a=""===t?common_js_lang["db.info.emptyString"]:""===t.trim()?t.match(/\s/g).length+common_js_lang["db.text.space"]:t;return e.replacementUpdateVal(a,t),!1}),e.container.on("keyup",".replacementCon .inputReplacement",function(t){if(13==t.which){var a=t.target.value||"";if(a.length<=0)return MsgTip("",common_js_lang["csv.text.columnSep"]),!1;var i=""===a?common_js_lang["db.info.emptyString"]:""===a.trim()?a.match(/\s/g).length+common_js_lang["db.text.space"]:a;return e.replacementUpdateVal(i,a),!1}}),$("body").on("click",function(t){var a=e.container.find(".replacementCon");a.hasClass("show")&&1!=$(t.target).parents(".replacementCon").length&&1!=$(t.target).parent(".replacementCon").length&&$(t.target)!=a[0]&&a.removeClass("show")})},replacementUpdateVal:function(e,t){var a=this.container.find(".replacementCon");a.removeClass("show");for(var i=a.find(".item").removeClass("cur"),n=!1,o=0,l=i.length;o<l;o++)if(i.eq(o).attr("data-val")==t){e=i.eq(o).text(),n=!0;break}n||(e=""===t.trim()?t.match(/\s/g).length+common_js_lang["db.text.space"]:e),a.find(".val").text(e).attr({"data-val":t,title:t})}};new a;$(".tooltip").tipsy({fade:!0,gravity:"s"}),$(".mapRouteNextStep").click(function(){if($(".fileRouteChoice").val()==globalParam.commonLinkType.hdfs)$(".desDirHdfs").val()?e().jobId&&!e().detail?$.ajax({url:"hdfs/dir/access",data:{hdfsId:$(".connId").val(),dir:$(".desDirHdfs").val(),pid:$("#userApp").val()},success:function(e){200==e.code?$(".mapRoute").hide().siblings(".importRule").show():ErrTip(e.i18nMsg.title,e.i18nMsg.detail,e.msg)}}):$(".mapRoute").hide().siblings(".importRule").show():MsgTip("",common_js_lang["client.info.hdfsTarPath"],"info");else{if(!$("#dbName").val())return MsgTip("",common_js_lang["client.info.noDb"],"info"),!1;if(!$("#tableName").val())return MsgTip("",common_js_lang["client.info.noTbl"],"info"),!1;$(".fileRouteChoice").val(),b.doc.getValue();$(".mapRoute").hide().siblings(".importRule").show()}}),$(".mapRoutePreStep").click(function(){$(".mapRoute").hide().siblings(".mapData").show()}),$(".coverBtn").click(function(){$(this).prop("checked")&&($(this).parent("label").removeClass("radioNo").addClass("radioOk"),$(".addLabel").removeClass("radioOk").addClass("radioNo"))}),$(".addBtn").click(function(){$(this).prop("checked")&&($(this).parent("label").removeClass("radioNo").addClass("radioOk"),$(".coverLabel").removeClass("radioOk").addClass("radioNo"))}),$(".fileRouteChoice").change(function(){h(),i($(this).val()),$(this).val()==globalParam.commonLinkType.hdfs?($(".dbChoice, .colSepRow").hide(),$(".hdfsChoice").show(),$(".partitionZone").hide(),$(".dataTab, .new-sql, .formatType").hide()):($(".dbChoice, .colSepRow").show(),$(".hdfsChoice").hide(),$(".dataTab, .new-sql, .formatType").show())}),$(".connId").on("change",function(){C=$(this).val(),$(".fileRouteChoice").val()==globalParam.commonLinkType.hdfs?(i(0),u()):(i(1),r())}),$("#userApp").change(function(){i($(".fileRouteChoice").val()==globalParam.commonLinkType.hdfs?0:1),h()}),$(".cancelSBtn").click(function(){$(".maskCell").hide(),$(".contentBox").hide()}),$(".delSIcon").click(function(){$(".maskCell").hide(),$(".contentBox").hide()}),$("body").on("change","#dbName",function(){var e=$(this).val();e&&c(e)}),$("body").on("change","#tableName",function(){var e=$(this).val(),t=$("#tableName option:selected").attr("catalog"),a=$("#tableName option:selected").attr("schema");e&&(m({catalog:t,schema:a,tableName:e,pid:$("#userApp").val()}),d(t,a,e))}),$(".lastPreStep").click(function(){$(".mapRoute").show().siblings(".importRule").hide()}),$("body").on("click",".routeLabel",function(){$(".routeLabel").each(function(){$(this).removeClass("rCheckIcon")}),$(this).addClass("rCheckIcon");var e=$(this).siblings(".oneRoute").attr("data-base");$(".defaultRoute").val(e).attr("title",e)}),$("body").on("click",".turnOn",function(){var e=$(this);e.hide().siblings(".turnOff").show(),e.parent().siblings(".allMeun").hide()}),$("body").on("click",".turnOff",function(){var e=$(this),t=$(this).parent().attr("data-base"),a=parseInt($(this).parent().parent().css("text-indent"));if(0==$(this).parent().siblings(".allMeun").length){if(e.hasClass("got"))return!1;e.addClass("got"),f($(".connId").val(),e,t,a)}else e.parent().siblings(".allMeun").show(),e.hide().siblings(".turnOn").css({display:"block"})}),$(".closeMap").click(function(){$(".sqlSentence").empty(),$(".maskCell").hide(),$(".hdfsRouteBox").hide()}),$(".desDirHdfs").click(function(){if(!$(".connId").val())return MsgTip("",common_js_lang["db.info.selectLink"],"info"),!1;$(".maskCell").show(),$(".hdfsRouteBox").show();var e=$(this).val();$(this).val()&&($(".defaultRoute").val($(this).val()).attr("title",$(this).val()),$(".routeLabel").each(function(){if($(this).siblings(".oneRoute").attr("data-base")==e){$(this).addClass("rCheckIcon").children("input").prop("checked",!0);$(this)}else $(this).removeClass("rCheckIcon").children("input").prop("checked",!1)}),"undefined"!=typeof $this&&n($this))}),$(".bakRouteOk").click(function(){$(".defaultRoute").val()?$.ajax({url:"hdfs/dir/access",data:{hdfsId:$(".connId").val(),dir:$(".defaultRoute").val(),pid:$("#userApp").val()},success:function(e){-1!=e.code?200==e.code?($(".desDirHdfs").val($(".defaultRoute").val()).attr("title",$(".defaultRoute").val()),$(".maskCell").hide(),$(".hdfsRouteBox").hide()):ErrTip(e.i18nMsg.title,e.i18nMsg.detail,e.msg):y.ajaxFail()}}):MsgTip("",common_js_lang["client.info.tarPath"],"info")})}function u(e){var t=setTimeout(function(){$(".delayTip").show()},2e3);$.ajax({url:"hdfs/dir/home",data:{hid:e||$(".connId").val(),pid:$("#userApp").val()},success:function(e){if(200==e.code&&e.model.length>0){$(".thisRoute.startThis").html(e.model).parent().attr("data-base",e.model),$(".firstM .startLi").children(".allMeun")&&$(".firstM .startLi").children(".allMeun").remove();var t=$(".routeStart .turnOff");if(t)t.siblings(".thisRoute").html(),parseInt(t.parent().parent().css("text-indent"))}else-1==e.code?y.ajaxFail():(ErrTip(e.i18nMsg.title,e.i18nMsg.detail,e.msg),$(".thisRoute.startThis").html(""),$(".firstM .startLi").children(".allMeun")&&$(".firstM .startLi").children(".allMeun").remove())},complete:function(){clearTimeout(t),$(".delayTip").hide()}})}function f(e,t,a,i,n){var o=setTimeout(function(){$(".delayTip").show()},2e3);$.ajax({url:"hdfs/dir/list",data:{hid:e,base:a,pid:$("#userApp").val()},success:function(e){if(200==e.code)if(e.model.length){t.children(".turnOn").css({display:"block"}),t.children(".turnOff").hide();for(var i=e.model,n=$("<ul class='allMeun'></ul>"),o=a.length,l=0;l<i.length;l++){var s=$("<li class='newRoute'><label class='routeLabel'><input type='checkbox' class='routeChoiceBtn' name='route'/></label><h5 class='oneRoute' data-base='"+i[l]+"'><img class='turnOn' src='resources/images/routeOn.png'/><img class='turnOff' src='resources/images/routeOff.png'/><span class='thisRoute' title='"+i[l].slice(o)+"'>"+i[l].slice(o)+"</span></h5></li>");s.css("padding-left","20px"),n.append(s)}s&&s.length>0&&t.parent().siblings().length<=1&&(t.parent().parent().append(n),t.attr("field")?t.hide().siblings(".turnOn").show():t.parent().siblings().length>0?t.hide().siblings(".turnOn").show():t.hide().siblings(".turnOn").hide())}else t.parent().attr("status","ok"),t.hide(),t.siblings(".turnOn").hide(),setTimeout(function(){$(".delayTip").hide()},400),t.parent().hasClass("routeStart")&&$(".defaultRoute").val($(".startThis").html()).attr("title",$(".startThis").html());else-1==e.code?y.ajaxFail():ErrTip(e.i18nMsg.title,e.i18nMsg.detail,e.msg)},complete:function(){t.removeClass("got"),clearTimeout(o),$(".delayTip").hide()}})}function h(e){var t=$("#userApp").val()||"",a=$(".fileRouteChoice").val(),i="db/list",n=31,o="";a==globalParam.commonLinkType.hdfs?i="hdfs/list":o=4,a==globalParam.commonLinkType.spark&&(n=62),$.ajax({url:i+"?pid="+t+"&groups="+o+"&dbType="+n,success:function(t){if(200==t.code){var i='<option value="" disabled>'+common_js_lang["db.info.selectLink"]+"</option>";a==globalParam.commonLinkType.hdfs&&adminConfigData.hdfs.id&&(i+='<option value="'+adminConfigData.hdfs.id+'">'+adminConfigData.hdfs.connName+"</option>"),a==globalParam.commonLinkType.hive&&adminConfigData.hive.id&&(i+='<option value="'+adminConfigData.hive.id+'">'+adminConfigData.hive.connName+"</option>"),t.model.data.map(function(e){i+='<option value="'+e.id+'">'+e.connName+"</option>"}),$(".mapRouteMsg .connId").html(i).val(e||"").select2()}else ErrTip(t.i18nMsg.title,t.i18nMsg.detail,t.msg)}})}function g(){if(e().jobId&&!e().copy)return $(".fileRouteChoice").val()==globalParam.commonLinkType.hdfs?o():l(),!1;$(".fileRouteChoice").val()==globalParam.commonLinkType.hdfs?i():n()}var b=CodeMirror.fromTextArea($(".new-sql textarea")[0],{lineNumbers:!0}),v={tableType:0,cronGlobalParam:{}};$.extend(globalParam,v);var T={};T.hiveTable="",T.partitions="";var y={ajaxFail:function(){return swal({title:"",text:common_js_lang["manage.info.timeout"],type:"info",showCancelButton:!0,confirmButtonText:common_js_lang["manage.info.newdow"],cancelButtonText:common_js_lang["manage.info.tologin"]},function(e){e?window.open("./","_blank"):location.href="./"}),!1}},k={},C=$(".connId").val();p(),$("#autoTipMsg").val(common_js_lang["client.option.Immed"]),e().jobId?s(e().jobId):h(),$(".contentBox .clientM").attr("href","./client.taskm?id="+e().clientId),$(".runToPre").click(function(){location.href="./client.taskm?id="+e().clientId}),$(".goToClient").click(function(){location.href="./client.taskm?id="+e().clientId}),$(".btnCon").on("click",".startImport",function(){var e=cronExport.cronExec($(".group-type .cur").index(),!0);if(!e.cronParam||-1==[0,1,2].indexOf(+e.periodType))return!1;globalParam.cronGlobalParam=e,g()});var P=1==e().detail;P?($("h2.title span").html(common_js_lang["common.option.taskDetail"]),$(".radio").css({cursor:"not-allowed"}),$("input, select, textarea").prop("disabled",!0),$('input[type="button"]').prop("disabled",!1),$(".cronCon").addClass("disabled"),["#fileRouteMsg","#suffixContent","#moveSite",".desDirHdfs","#taskName"].map(function(e){$(e).attr("title",$(e).val())}),$(".startImport").html(common_js_lang["client.act.exit"]),$(".btnCon").off("click").on("click",".startImport",function(){window.location.href="./client.taskm?id="+e().clientId}),$(".mapRouteNextStep").off("click").on("click",function(){$(".mapRoute").hide().siblings(".importRule").show()})):$("h2.title span").html(common_js_lang["index.title.newTask"]),window.onbeforeunload=function(){if(!P)return $("#fileRouteMsg").val().trim()||$(".addFileFilter").val().trim()||$(".multipleSelect").val()?common_js_lang["common.info.leavePage"]:void 0}});