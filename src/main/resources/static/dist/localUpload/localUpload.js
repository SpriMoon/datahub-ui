function getConnect(){var a=$("#userApp").val(),l=globalParam.commonLinkType.hdfs,n="db/list",o="";l==globalParam.commonLinkType.hdfs?n="hdfs/list":o=4,a&&$.fn.ajaxAPI({url:n+"?pid="+a+"&groups="+o,callback:function(a){var n='<option value="" disabled>'+common_js_lang["db.info.selectLink"]+"</option>";l==globalParam.commonLinkType.hdfs?adminConfigData.hdfs.id&&(n+='<option value="'+adminConfigData.hdfs.id+'">'+adminConfigData.hdfs.connName+"</option>"):adminConfigData.hive.id&&(n+='<option value="'+adminConfigData.hive.id+'">'+adminConfigData.hive.connName+"</option>"),a.model.data.map(function(a){n+='<option value="'+a.id+'">'+a.connName+"</option>"}),$(".configTask .connId").html(n).val("").select2(),globalParam.connId=""}})}function getDir(a,l){if(globalParam.connId){var n=""!=(a=a||"")?$('.dirDos [data-base="'+a+'"] > .ul'):$(".hdfsTab .dirDos > .ul");$.fn.ajaxAPI({url:l&&"hdfs/dir/home"||"hdfs/dir/list",data:{base:a,hid:globalParam.connId,pid:$("#userApp").val()},loadTime:""==a?0:2e3,callback:function(o){if(n.parent().find(".show").addClass("in"),n.fadeIn(),!l&&0==o.model.length)return n.siblings("p").find(".show").addClass("out"),!1;l&&(o.model=[o.model]);a.length;var t=template("template/hdfsDir",{dir:o.model,len:a.length});n.html(t)},complete:function(){n.parent().find(".show").removeClass("got")}})}else MsgTip("",common_js_lang["db.info.selectLink"],"info")}function listFile(a){var l="<td> -- </td>",n='<td class="res">'+common_js_lang["local.info.uping"]+"</td>",o='<td class="path"><input type="text" placeholder="'+common_js_lang["local.option.getDir"]+'" disabled><button class="hdfs" >'+common_js_lang["local.option.config"]+'</button><button class="del">'+common_js_lang["clientList.option.del"]+"</button></td>";return a.size>=0&&(l="<td>"+convertFileSize(a.size)+"</td>"),globalParam.fileIndex++,$(".configFilePath .file-list .tableNoData").parent().remove(),$(".configFilePath .file-list tbody").append('<tr class="f'+globalParam.fileIndex+'"><td title="'+a.name+'">'+a.name+"</td>"+l+'<td class="progress"><span class="process-sliderCon"><div class="process-slider" style="width:0;"></div></span><span class="process-res"></span></td>'+n+o+"</tr>"),"f"+globalParam.fileIndex}function convertFileSize(a){return a<1024?(a||0)+" bytes":a/1024<1024?(a/1024).toFixed(2)+" KB":(a/1024/1024).toFixed(2)+" MB"}var tmpParam={fileList:[],curTableList:[],curHiveParam:{},tmpAppId:"",fileIndex:0,connId:0,formDataAjax:{}};$.extend(globalParam,tmpParam),$("body").on("click","button.index",function(){window.location.href="./"}),getConnect(),window.onbeforeunload=function(){if($(".taskName").val().trim()||$(".taskDes").val().trim()||$(".file-list  tr .progress").length>0)return common_js_lang["common.info.leavePage"]},$("#userApp").change(function(){getConnect()}),$(".connId").on("change",function(){globalParam.connId=$(this).val(),$(".dirDos .ul").empty(),getDir("",!0),$(".file-list .path input").val("").attr("data-dir","")}),$(".global-hdfsCon").on("click","li p .show",function(){if(0==$(this).parent().siblings("ul").find("li").length){if($(this).hasClass("got"))return!1;$(this).addClass("got"),getDir($(this).parents("li").data("base"))}else $(this).toggleClass("in"),$(this).parent().siblings("ul").toggle()}),$(".global-hdfsCon").on("click","li p .check",function(){if(!$(this).hasClass("cur")){$(".global-hdfsCon li p .check").removeClass("cur"),$(this).addClass("cur");var a=$(this).parents("li").data("base");$(".global-hdfsCon .selectedDir").val(a).attr("title",a)}}),$(".global-hdfsCon").on("click",".btn-cancel, h4 .cancel",function(){$(".global-mask, .global-hdfsCon").fadeOut(),$(".file-list .hdfs.active").removeClass("active")}),$(".global-hdfsCon").on("click",".btn-item",function(){var a=$(".global-hdfsCon .selectedDir").val().trim(),l=$(".global-hdfsCon .fileName").val().trim();return a&&l?l.match(/\s+|\\+/g)?(MsgTip("",common_js_lang["local.info.fileName"],"info"),!1):(l=l.slice(0,60),void $.fn.ajaxAPI({url:"hdfs/dir/access",data:{hdfsId:globalParam.connId,dir:a,pid:$("#userApp").val()},callback:function(n){$(".file-list .hdfs.active").removeClass("active").siblings("input").val((a+"/"+l).replace(/\/+/g,"/")).attr("title",(a+"/"+l).replace(/\/+/g,"/")).attr("data-dir",a).attr("data-fileName",l),$(".global-mask, .global-hdfsCon").fadeOut()}})):(MsgTip("",common_js_lang["local.info.fileDir"],"info"),!1)}),$(".file-list").on("click",".hdfs",function(){if(globalParam.connId){$(this).addClass("active");var a=$(this).siblings("input").attr("data-dir"),l=$(this).siblings("input").attr("data-fileName");if(l||(l=$(this).parents("tr").find("td").eq(0).text()),$(".global-hdfsCon p .check").removeClass("cur"),$(".global-hdfsCon p .show").removeClass("in"),$(".global-hdfsCon .ul:not(:first-child)").css({display:"none"}),$(".global-hdfsCon .selectedDir").val(a).attr("title",a),$(".global-hdfsCon .fileName").val(l),a){var n=$('.global-hdfsCon [data-base="'+a+'"]');1==n.length&&(n.find("> p .check").addClass("cur"),n.parents(".ul").fadeIn().siblings("p").find(".show").addClass("in"))}$(".global-mask, .global-hdfsCon").fadeIn()}else MsgTip("",common_js_lang["db.info.selectLink"],"info")}),$(".file-btn").on("change","#fileupload",function(a){for(var l=$(this)[0].files?$(this)[0].files:{name:$(this).val().split("\\").slice(-1)[0]},n=0,o=l.length;n<o;n++){if($(".file-list tbody tr").length>=5){MsgTip("",common_js_lang["dump.info.limit5"],"info");break}if(l[n].name&&l[n].name.length>60)swal("",common_js_lang["s3.info.fileName100"],"info");else{globalParam.fileList.push(l[n]);var t=listFile(l[n]),i=new FormData;i.append("file",l[n]),globalParam.formDataAjax[t]=$.ajax({url:"job/local/file/upload",type:"post",data:i,class:t,fileTitle:l[n].name,contentType:!1,processData:!1,xhr:function(){var a=this.class,l=new XMLHttpRequest;return l.upload.addEventListener("progress",function(l){if(l.lengthComputable){var n=parseInt(100*l.loaded/l.total);$(".file-list ."+a+" .process-slider").css({width:n+"%"}),$(".file-list ."+a+" .process-res").html(n+"%"),100==n&&$(".file-list ."+a+" .res").html("<div>"+common_js_lang["local.info.pausing"]+"</div>")}},!1),l},success:function(a){200==a.code?($(".file-list ."+this.class).addClass("uploaded").attr("data-name",a.model.path),$(".file-list ."+this.class+" .res").addClass("ok").html(common_js_lang["local.info.upOver"])):$(".file-list ."+this.class+" .res").html('<div style="color:red" title="'+a.msg+'">'+common_js_lang["local.info.upFail"]+"</div>")},error:function(){$(".file-list ."+this.class+" .process-slider").animate({width:"100%"},5),$(".file-list ."+this.class+" .process-res").html("100%"),$(".file-list ."+this.class+" .res").addClass("error").html(common_js_lang["local.info.upErr"])}})}}var e=$(this).clone().val("");$(this).remove(),$(".file-btn").append(e)}),$(".file-list").on("click",".del",function(){var a=$(this);swal({title:"",text:common_js_lang["local.info.delFile"],type:"info",showCancelButton:!0},function(){var l=a.parents("tr").index(),n=a.parents("tr").attr("class");a.parents("tr").remove(),$(".configFilePath tbody tr").length<=0&&$(".configFilePath tbody").append('<tr class="trNoData"><td colspan="5" class="tableNoData"><img src="resources/dist/images/noData.png">'+common_js_lang["manage.title.noData"]+"</td></tr>"),globalParam.fileList.splice(l,1),-1==n.indexOf("uploaded")&&(swal.close(),globalParam.formDataAjax[n].abort())})}),$("button.upload").on("click",function(){var a=$(".configTask .taskName").val().trim();if(!a)return MsgTip("",common_js_lang["local.info.taskNameNone"],"info"),!1;var l=$(".configTask .taskDes").val().trim(),n=$("#userApp").val()||0;if(n)if($(".connId").val()||""){var o=$('.file-list tbody tr:not(".trNoData")');if(o.length<=0)MsgTip("",common_js_lang["local.info.fileNone"],"info");else{for(var t=0,i=o.length;t<i;t++)if(!o.eq(t).hasClass("uploaded"))return MsgTip("",common_js_lang["local.info.upUncomplete"].replace(/\[x\]/g,"["+(t+1)+"]"),"info"),!1;for(var e=$(".file-list td.path"),i=e.length,s={jobName:a,note:l,pid:n,toId:globalParam.connId,toType:8,fromJson:[],toHdfsJson:[]},t=0;t<i;t++){var d=e.eq(t).find("input").val();if(!d)return void MsgTip("",common_js_lang["local.info.hdfsParam"].replace(/\[x\]/,"["+(t+1)+"]"),"info");s.toHdfsJson.push({fileName:d,hid:globalParam.connId}),s.fromJson.push(e.eq(t).parent().data("name"))}s.fromJson=JSON.stringify(s.fromJson),s.toHdfsJson=JSON.stringify(s.toHdfsJson);var r=$(this);r.prop("disbaled",!0),$.fn.ajaxAPI({url:"job/local/save",type:"post",data:s,contentType:"application/x-www-form-urlencoded",callback:function(a){200==a.code?(window.onbeforeunload=function(){},location.href="./success"):ErrTip(a.i18nMsg.title,a.i18nMsg.detail,a.msg)},complete:function(a){if(r.prop("disbaled",!1),-1==a.responseJSON.code)return swal({title:"",text:common_js_lang["manage.info.timeout"],type:"info",showCancelButton:!0,confirmButtonText:common_js_lang["manage.info.newdow"],cancelButtonText:common_js_lang["manage.info.tologin"]},function(a){a?window.open("./","_blank"):location.href="./"}),!1}})}}else MsgTip("",common_js_lang["db.info.selectLink"],"info");else MsgTip("",common_js_lang["dbManage.title.setApp"],"info")});