function taskFn(){function e(e){var a="<tr field='"+(index-1)+"'><td class='fileName fileName"+(index-1)+"' title='"+e.name+"'>"+e.name+"</td><td class='fileSize fileSize"+(index-1)+"'>"+S.fileSize(e.size)+"</td><td class='uploadParse uploadParse"+(index-1)+"'><div class='fileProgress fileProgress"+(index-1)+"'><p class='fileProgressBar fileProgressBar"+(index-1)+"'></p></div><p class='progressTip progressTip"+(index-1)+"'>"+common_js_lang["dump.info.wait"]+"</p></td><td class='parseStatus parseStatus"+(index-1)+"'><p class='parsfailTip parsfailTip"+(index-1)+"'>"+common_js_lang["local.info.upFail"]+"</p><p class='parsingTip parsingTip"+(index-1)+"'>"+common_js_lang["local.info.pausing"]+"</p><p class='parseTipTwo parseTipTwo"+(index-1)+"'><span class='parseOk'>"+common_js_lang["local.info.upOver"]+"</span></p></td><td class='last'><a title='"+common_js_lang["clientList.option.del"]+"' field='"+(index-1)+"' class='del delTask delTask"+(index-1)+"'><i></i></a></td></tr>";$("#fileuploadTbody").append(a),$("#fileuploadTbody #noData")&&$("#fileuploadTbody #noData").hide()}function a(e,a,t,n,l,i,s,o){for(var c="",r=0;r<e.length;r++)c+='<li class="tabName" name="'+o[r]+'" cols="'+s[r]+'" filePath="'+i[r]+'" srcPath="'+l[r]+'" columnSep="'+t[r]+'" field="'+a+r+'" size="'+n[r]+'"><label class="aLabel"><img src="resources/images/parseDump.png" class="fileIcon"/><input type="checkbox" field='+a+' class="acheck check check'+a+'"/><span class="name" title="'+e[r]+"  "+S.fileSize(n[r])+'">'+e[r]+'</span><span class="size">'+S.fileSize(n[r])+"</span></label></li>";return c}function t(e){for(var t=e,n="",l=0;l<t.length;l++)t[l].tab.length>0&&(n='<div class="dbBox"><p class="dbName" field="'+l+'"><img src="resources/images/oneDump.png" class="cataLogIcon"/><span class="name" title="'+t[l].name+'">'+t[l].name+'</span></p><ul class="tabList tabList'+l+'">',t[l].tab?(n+=a(t[l].tab,l,t[l].columnSep,t[l].size,t[l].srcPath,t[l].filePath,t[l].cols,t[l].tableName),n+='</ul><span class="iconBtn"><span class="closeBtn"><img src="resources/images/toHide.png"/></span><span class="openBtn"><img src="resources/images/toShow.png"/></span></span><label class="fileCheck"><input type="checkbox" class="leftOneCheck leftOneCheck'+l+' check" field="'+l+'"/></label></div>'):n+='</ul><span class="iconBtn"><span class="closeBtn"><img src="resources/images/toHide.png"/></span><span class="openBtn"><img src="resources/images/toShow.png"/></span></span><label class="fileCheck"><input type="checkbox" class="leftOneCheck leftOneCheck'+l+' check" field="'+l+'"/></label></div>',$(".dbZone").append(n))}function n(e,a){for(var t=0;t<e.srcPath.length;t++){var n={};n.index=0,n.name="",n.columnSep=[],n.size=[],n.srcPath=[],n.filePath=[],n.tab=[],n.cols=[],n.tableName=[];for(var l=0;l<a.srcPath.length;l++)e.srcPath[t]==a.srcPath[l]&&(!1,n.index=a.index,n.name=S.reg(a.srcPath[l]),n.columnSep.push(a.columnSep[l]),n.size.push(a.size[l]),n.srcPath.push(a.srcPath[l]),n.filePath.push(a.filePath[l]),n.tab.push(a.tab[l]),n.cols.push(a.cols[l]),n.tableName.push(a.tableName[l]),delete a.columnSep[l],delete a.size[l],delete a.srcPath[l],delete a.filePath[l],delete a.tab[l],delete a.cols[l],delete a.tableName[l]);parseResult.push(n)}}function l(e,a){var t=!0;return a.each(function(){$(this).attr("field")==e&&(t=!1)}),t}function i(e,a){var t=!0;return a.each(function(){$(this).attr("field")==e&&(t=!1)}),t}function s(e,a,t){var n="";if($("#uploadSite").val()!=globalParam.commonLinkType.hdfs)for(l=0;l<a.length;l++)n+='<tr size="'+a[l][7]+'" dbName="'+t+'" class="newTr" tabName="'+a[l][6]+'" cols="'+a[l][5]+'" filePath="'+a[l][4]+'" srcPath="'+a[l][3]+'" columnSep="'+a[l][2]+'" field="'+a[l][1]+'"><td><label class="checkOneLab"><input type="checkbox" field="'+e+'" class="tabCheckOne tabCheckOne'+e+' tabCheck"/></label></td><td class="parse" title="'+a[l][0]+'"><img src="resources/images/parseDump.png"/><span class="parseName">'+a[l][0]+'</span></td><td class="oneDbName"></td><td class="map"title="'+a[l][6]+'"><img src="resources/images/parseDump.png"/><span class="targetTab">'+a[l][6]+'</span></td><td><span class="oneConfigure"><img src="resources/images/mapData.png" class="mapImg"/><b class="mapTip">'+common_js_lang["local.option.config"]+"</b></span></td></tr>";else for(var l=0;l<a.length;l++)n+='<tr size="'+a[l][7]+'" dbName="'+t+'" class="newTr" tabName="'+a[l][6]+'" cols="'+a[l][5]+'" filePath="'+a[l][4]+'" srcPath="'+a[l][3]+'" columnSep="'+a[l][2]+'" field="'+a[l][1]+'"><td><label class="checkOneLab"><input type="checkbox" field="'+e+'" class="tabCheckOne tabCheckOne'+e+' tabCheck"/></label></td><td class="hdfs" type="hdfs" title="'+a[l][0]+'"><img src="resources/images/parseDump.png"/><span class="parseName">'+a[l][0]+'</span></td><td class="map hdfsMap" type="hdfs"></td><td><span class="oneConfigure" field="hdfs"><img src="resources/images/mapData.png" class="mapImg"/><b class="mapTip">'+common_js_lang["local.option.config"]+"</b></span></td></tr>";return n}function o(){$(".fileNum").each(function(){$(this).html($(this).parent().parent().parent().siblings("tbody").children(".newTr").length)})}function c(){$("#globalLoadCon").show(),$.ajax({url:"db/dbs",data:{pid:$("#userApp").val(),id:N.connId},success:function(e){if(200==e.code){C=[],T=[];var a='<option value="" disabled>'+common_js_lang["local.option.getDb"]+"</option>";e.model.databases.map(function(e,t){a+='<option catalog="'+e.catalog+'" schema="'+e.schema+'" value="'+e.dbName+'">'+e.dbName+"</option>",C.push(e.schema),T.push(e.catalog)}),$("#dbName").html(a).val("").select2(),e.model.databases&&e.model.databases.length<=0&&MsgTip("info",common_js_lang["dump.info.dbNone"]),$(".choiceRoute h3.tip i").html(common_js_lang["csv.text.hiveNote"]),$(".dumpFileNext").attr("connId",N.connId),N.type=$("#uploadSite").val(),N.tmpAppId=$("#userApp").val(),$(".addContentZone").empty(),$(".checkAllLab").removeClass("checkStatus").children("input").attr("checked",!1),$(".uploadFile").hide().siblings(".choiceRoute").show(),$(window).scrollTop(0)}else 0==e.code?ErrTip(e.i18nMsg.title,e.i18nMsg.detail,e.msg):-1==e.code&&S.ajaxFail()},complete:function(){$("#globalLoadCon").hide()}})}function r(){var e=!0;return $(".tabCheckOne").each(function(){$(this).prop("checked")&&(e=!1)}),e}function d(){if(r())return MsgTip("",common_js_lang["dump.info.selectTask"],"info"),!1;$(".maskCell,.contentBox,.mathRoute.hiveH,.contentBox .bottomBtn,.fieldMap, .hiveH .batchTitle").show(),$(".mathRoute.hdfsH,.contentBox .bakBtnZ,.tabMsg,.tab,.part,.fieldMap, .formatType").hide(),$(".keep").attr("field","all")}function h(){r()?MsgTip("",common_js_lang["dump.info.selectTask"],"info"):($(".maskCell").show(),$(".contentBox").show(),$(".keep").attr("field","all"),$(".mathRoute.hiveH").hide(),$(".mathRoute.hdfsH").show(),$(".mathRoute.hdfsH .routeTitle").hide(),$(".hdfsH .batchTitle").show(),$(".contentBox .bakBtnZ").hide(),$(".contentBox .bottomBtn").show(),$(".fieldMap").hide(),$(".hdfsRoute").val(""),$(".suffixShow").hide(),$(".routeLabel.rCheckIcon").removeClass("rCheckIcon").children("input").prop("checked",!1),$(".defaultRoute").val("").attr("title",""))}function p(e){var a=e.parent().parent();a.show(),a.siblings(".oneRoute").children(".turnOn").show(),a.siblings(".oneRoute").children(".turnOff").hide(),a.hasClass("firstM")||p(a)}function m(e){this.container=e.container,this.event()}function f(){this.listContainer=$(".rightZone .dbContainer"),this.configContainer=$(".contentBox"),this.event()}function u(e){$("#globalLoadCon").show(),$.ajax({url:"job/dump/save",type:"post",data:e,success:function(e){200==e.code?(window.onbeforeunload=function(){},location.href="./success"):0==e.code?ErrTip(e.i18nMsg.title,e.i18nMsg.detail,e.msg):-1==e.code&&S.ajaxFail()},complete:function(){$("#globalLoadCon").hide()}})}function b(e){$("#globalLoadCon").show(),$.ajax({url:"job/dump/save",type:"post",data:e,success:function(e){200==e.code?(window.onbeforeunload=function(){},location.href="./success"):-1==e.code?S.ajaxFail():ErrTip(e.i18nMsg.title,e.i18nMsg.detail,e.msg)},complete:function(){$("#globalLoadCon").hide()}})}function g(){var e=$("#userApp").val(),a=$("#uploadSite").val(),t="db/list",n=31,l="";a==globalParam.commonLinkType.hdfs?t="hdfs/list":l=4,a==globalParam.commonLinkType.spark&&(n=62),e&&$.ajax({url:t+"?pid="+e+"&groups="+l+"&dbType="+n,success:function(e){var t='<option value="" disabled>'+common_js_lang["db.info.selectLink"]+"</option>";a==globalParam.commonLinkType.hdfs&&adminConfigData.hdfs.id&&(t+='<option value="'+adminConfigData.hdfs.id+'">'+adminConfigData.hdfs.connName+"</option>"),a==globalParam.commonLinkType.hive&&adminConfigData.hive.id&&(t+='<option value="'+adminConfigData.hive.id+'">'+adminConfigData.hive.connName+"</option>"),e.model.data.map(function(e){t+='<option value="'+e.id+'">'+e.connName+"</option>"}),$("#connId").html(t).val("").select2()}}).fail(function(){$("#connId").html("")})}function k(){$("#globalLoadCon").show(),$.ajax({url:"hdfs/dir/home",data:{hid:N.connId,pid:$("#userApp").val()},success:function(e){if(200==e.code&&e.model.length>0){$(".allMeun.firstM").show(),$(".thisRoute.startThis").html(e.model).parent().attr("data-base",e.model),$(".thisRoute.startThis").parent().find(".turnOff").show(),$(".thisRoute.startThis").parent().find(".turnOn").hide(),$(".firstM .startLi").children(".allMeun")&&$(".firstM .startLi").children(".allMeun").remove();var a=$(".routeStart .turnOff");if(a)a.siblings(".thisRoute").html(),parseInt(a.parent().parent().css("text-indent"));$(".choiceRoute h3.tip i").html(common_js_lang["csv.text.hdfsNote"]),$(".dumpFileNext").attr("connId",N.connId),N.type=$("#uploadSite").val(),N.tmpAppId=$("#userApp").val(),$(".addContentZone").empty(),$(".checkAllLab").removeClass("checkStatus").children("input").attr("checked",!1),$(".uploadFile").hide().siblings(".choiceRoute").show(),$(window).scrollTop(0)}else-1==e.code?S.ajaxFail():(ErrTip(e.i18nMsg.title,e.i18nMsg.detail,e.msg),$(".thisRoute.startThis").html(""),$(".firstM .startLi").children(".allMeun").remove(),$(".allMeun.firstM").hide())},complete:function(){$("#globalLoadCon").hide()}})}function v(e,a,t,n){var l=setTimeout(function(){$("#globalLoadCon").show()},2e3);$.ajax({url:"hdfs/dir/list",data:{hid:e,base:t,pid:$("#userApp").val()},success:function(e){if(200==e.code)if(e.model.length){a.children(".turnOn").show(),a.children(".turnOff").hide();for(var n=e.model,l=$("<ul class='allMeun'></ul>"),i=t.length,s=0;s<n.length;s++){var o=$("<li class='newRoute'><label class='routeLabel'><input type='checkbox' class='routeChoiceBtn' name='route'/></label><h5 class='oneRoute' data-base='"+n[s]+"'><img class='turnOn' src='resources/images/routeOn.png'/><img class='turnOff' src='resources/images/routeOff.png'/><span class='thisRoute' title='"+n[s].slice(i)+"'>"+n[s].slice(i)+"</span></h5></li>");o.css("padding-left","20px"),l.append(o)}o&&o.length>0&&a.parent().siblings().length<=1&&(a.parent().parent().append(l),a.attr("field")?a.hide().siblings(".turnOn").show():a.parent().siblings().length>0?a.hide().siblings(".turnOn").show():a.hide().siblings(".turnOn").hide())}else a.parent().attr("status","ok"),a.hide(),a.siblings(".turnOn").hide();else-1==e.code?S.ajaxFail():ErrTip(e.i18nMsg.title,e.i18nMsg.detail,e.msg)},complete:function(){a.removeClass("got"),clearTimeout(l),$("#globalLoadCon").hide()}})}var C=[],T=[],N=($("#userApp").val(),{});N.newFail=[],N.newSuccess=0,N.tmpAppId=0;var S={fileSize:function(e){return e<1024?(e||0)+"bytes":e<1048576?(e/1024).toFixed(2)+"KB":e?(e/1024/1024).toFixed(2)+"MB":"--"},reg:function(e){var a=/([^\/]+)$/g;return e=(e=e.replace(/\\/g,"/")).replace(a,"d$1"),RegExp.$1},ajaxFail:function(){return swal({title:"",text:common_js_lang["manage.info.timeout"],type:"info",showCancelButton:!0,confirmButtonText:common_js_lang["manage.info.newdow"],cancelButtonText:common_js_lang["manage.info.tologin"]},function(e){e?window.open("./","_blank"):location.href="./"}),!1}};$("#fileupload").fileupload({url:"job/dump/file/upload",autoUpload:!1}).on("fileuploadadd",function(a,t){if($("#fileuploadTbody").children().length<6){var n=t.files[0].name;if(n.length>60)return void MsgTip("",common_js_lang["s3.info.fileName100"]);var l=!1;try{["sql","txt","gz","zip"].indexOf(n.split(".").slice(-1)[0].toLowerCase())>-1&&(l=!0)}catch(a){}if(!l)return void MsgTip("",common_js_lang["dump.info.fileType"],"info");index++,e(t.files[0]),t.index=index-1,t.submit()}else MsgTip("",common_js_lang["dump.info.limit5"],"info")}).on("fileuploadprogress",function(e,a){progress[a.index]=parseInt(a.loaded/a.total*100,10),$(".fileProgressBar"+a.index).css("width",progress[a.index]+"%"),progress[a.index]<100?($(".progressTip"+a.index).html(progress[a.index]+"%"),$(".progressTip"+a.index).attr("uploadFinished","no")):($(".progressTip"+a.index).html("100%"),$(".progressTip"+a.index).attr("uploadFinished","ok"),$(".parsingTip"+a.index).show().attr("status","true"))}).on("fileuploaddone",function(e,a){var t=JSON.parse(a.jqXHR.responseText);if(-1==t.code)S.ajaxFail();else if(200!==t.code)$(".parsfailTip"+a.index).show().attr("title",t.msg),$(".parsingTip"+a.index).hide().attr("status","false");else if(200==t.code){$(".parsingTip"+a.index).hide().attr("status","false"),$(".parsfailTip"+a.index).hide(),$(".parseTipTwo"+a.index).show().parent().addClass("success"),$(".delTask"+a.index).attr("status","ok");var l={};l.index=a.index,l.columnSep=[],l.size=[],l.srcPath=[],l.filePath=[],l.tab=[],l.cols=[],l.tableName=[];for(var i=0;i<t.model.length;i++)l.tab.push(S.reg(t.model[i].filePath)),l.columnSep.push(t.model[i].columnSep),l.size.push(t.model[i].size),l.srcPath.push(t.model[i].srcPath),l.filePath.push(t.model[i].filePath),l.cols.push(t.model[i].cols),l.tableName.push(t.model[i].tableName);n(JSON.parse(JSON.stringify(l)),l)}});var x=[];$("body").on("click",".delTask",function(){var e=$(this).attr("field"),a=$(this);swal({title:"",text:common_js_lang["local.info.delFile"],type:"info",showCancelButton:!0},function(){if(a.attr("status")){for(var t=0;t<parseResult.length;t++)parseResult[t].index==e&&parseResult.splice(t--,1);a.parent().parent().remove(),$(".addContentZone").empty(),$(".checkAllLab.checkStatus").removeClass("checkStatus").find("input").prop("checked",!1)}else(a.attr("status")||"no"!=a.parent().siblings(".uploadParse").children(".progressTip").attr("uploadfinished"))&&(a.attr("status")||"ok"!=a.parent().siblings(".uploadParse").children(".progressTip").attr("uploadfinished")||"true"!=a.parent().siblings(".parseStatus").children(".parsingTip").attr("status"))?a.parent().parent().remove():(a.parent().parent().remove(),x.push(e));1==$("#fileuploadTbody tr").length&&$("#fileuploadTbody #noData").show()})}),$(".dumpCancelBtn").click(function(){location.href="./"}),$(".dumpFileNext").click(function(){if(""!=$("#dTaskName").val()){if(!$("#userApp").val())return MsgTip("",common_js_lang["s3.info.noneApp"],"info"),!1;if(!$("#connId").val())return MsgTip("",common_js_lang["db.info.tarConn"],"info"),!1;for(var e=0;e<parseResult.length;e++)for(var a=0;a<x.length;a++)parseResult[e].index==parseInt(x[a])&&parseResult.splice(e--,1);if(parseResult.length<=0)return MsgTip("",common_js_lang["local.info.tblNone"],"info"),!1;for(var n=$(".parsingTip"),l=0,i=n.length;l<i;l++)if("true"==n.eq(l).attr("status")||!n.eq(l).attr("status"))return MsgTip("",common_js_lang["local.info.upUncomplete"].replace(/\[x\]/g,"["+(l+1)+"]"),"info"),!1;return $("#checkAllDb").prop("checked",!1),$("#checkAllDb").parent("label").removeClass("checkStatus"),$(".dbBox").remove(),t(parseResult),N.connId!=$(".dumpFileNext").attr("connId")||void 0===$(".dumpFileNext").attr("connId")||N.type!=$("#uploadSite").val()||N.tmpAppId!=$("#userApp").val()?$("#uploadSite").val()==globalParam.commonLinkType.hdfs?k():c():($(".uploadFile").hide().siblings(".choiceRoute").show(),$(window).scrollTop(0)),!1}MsgTip("",common_js_lang["local.info.taskNameNone"],"info")}),$(".dumpPreStep").click(function(){$(".choiceRoute").hide().siblings(".uploadFile").show()}),$("body").on("click",".iconBtn",function(){$(this).siblings(".tabList").slideToggle(),$(this).children(".closeBtn").toggle().siblings(".openBtn").toggle()}),$("#checkAllDb").click(function(){var e=$(this).prop("checked");$(".check").prop("checked",e),e?($(this).parent(".checkAllDb").addClass("checkStatus"),$(".iconBtn").siblings(".tabList").slideDown(),$(".tabName").addClass("tabcheck"),$(".aLabel").each(function(){$(this).addClass("checkStatus")}),$(".fileCheck").each(function(){$(this).siblings(".dbName").addClass("checkStatus")}),$(".closeBtn").each(function(){$(this).hide()}),$(".openBtn").each(function(){$(this).show()})):($(this).parent(".checkAllDb").removeClass("checkStatus"),$(".iconBtn").siblings(".tabList").slideUp(),$(".tabName").removeClass("tabcheck"),$(".aLabel").each(function(){$(this).removeClass("checkStatus")}),$(".fileCheck").each(function(){$(this).siblings(".dbName").removeClass("checkStatus")}),$(".closeBtn").each(function(){$(this).show()}),$(".openBtn").each(function(){$(this).hide()}))}),$("body").on("click",".check",function(){$(this).prop("checked")?($(this).parent().addClass("tabcheck"),$(this).parent("label").siblings(".dbName").addClass("checkStatus")):($(this).parent().removeClass("tabcheck"),$(this).parent("label").siblings(".dbName").removeClass("checkStatus"));var e=!0;$(".check").each(function(){0==$(this).prop("checked")&&(e=!1),e?($("#checkAllDb").prop("checked",!0),$(".checkAllDb").addClass("checkStatus")):($("#checkAllDb").prop("checked",!1),$(".checkAllDb").removeClass("checkStatus"))})}),$("body").on("click",".leftOneCheck",function(){var e=$(this).attr("field"),a=$(this).prop("checked");$(".check"+e).prop("checked",a),a?($(this).parent(".fileCheck").siblings("dbName").addClass("checkStatus"),$(".check"+e).parent(".aLabel").each(function(){$(this).addClass("checkStatus")}),$(".check"+e).parent(".aLabel").parent(".tabName").each(function(){$(this).addClass("tabcheck")})):($(this).parent(".fileCheck").siblings("dbName").removeClass("checkStatus"),$(".check"+e).parent(".aLabel").each(function(){$(this).removeClass("checkStatus")}),$(".check"+e).parent(".aLabel").parent(".tabName").each(function(){$(this).removeClass("tabcheck")}));var t=!0;$(".leftOneCheck").each(function(){0==$(this).prop("checked")&&(t=!1),t?($("#checkAllDb").prop("checked",!0),$(".checkAllDb").addClass("checkStatus")):($("#checkAllDb").prop("checked",!1),$(".checkAllDb").removeClass("checkStatus"))})}),$("body").on("click",".acheck",function(){$(this).prop("checked")?($(this).parent().parent().addClass("tabcheck"),$(this).parent(".aLabel").addClass("checkStatus")):($(this).parent().parent().removeClass("tabcheck"),$(this).parent(".aLabel").removeClass("checkStatus"));var e=!0,a=!0,t=$(this).attr("field");$(".acheck").each(function(){0==$(this).prop("checked")&&(a=!1),a?($("#checkAllDb").prop("checked",!0),$(".checkAllDb").addClass("checkStatus")):($("#checkAllDb").prop("checked",!1),$(".checkAllDb").removeClass("checkStatus"))}),$(".check"+t).each(function(){0==$(this).prop("checked")&&(e=!1),e?($(".leftOneCheck"+t).prop("checked",!0),$(".leftOneCheck"+t).parent(".fileCheck").siblings(".dbName").addClass("checkStatus")):($(".leftOneCheck"+t).prop("checked",!1),$(".leftOneCheck"+t).parent(".fileCheck").siblings(".dbName").removeClass("checkStatus"))})}),$(".tabCheckAll").click(function(){var e=$(this).prop("checked");0==$(".addContentZone").children().length?MsgTip("",common_js_lang["dbManage.info.confNone"],"info"):($(".tabCheck").prop("checked",e),e?($(this).parent("label").addClass("checkStatus"),$(".tabCheck").parent("label").addClass("checkStatus")):($(this).parent("label").removeClass("checkStatus"),$(".tabCheck").parent("label").removeClass("checkStatus")))}),$("body").on("click",".tabCheck",function(){var e=!0;$(".tabCheck").each(function(){0==$(this).prop("checked")&&(e=!1),e?$(".tabCheckAll").prop("checked",!0):$(".tabCheckAll").prop("checked",!1)})}),$("body").on("click",".fileCheck",function(){var e=$(this).prop("checked"),a=$(this).attr("field");$(".tabCheckOne"+a).prop("checked",e),e?($(this).parent("label").addClass("checkStatus"),$(".tabCheckOne"+a).parent("label").addClass("checkStatus")):($(this).parent("label").removeClass("checkStatus"),$(".tabCheckOne"+a).parent("label").removeClass("checkStatus"))}),$("body").on("click",".tabCheckOne",function(){var e=$(this).attr("field"),a=!0;$(this).prop("checked")?$(this).parent("label").addClass("checkStatus"):$(this).parent("label").removeClass("checkStatus"),$(".tabCheckOne"+e).each(function(){0==$(this).prop("checked")&&(a=!1),a?($(".fileCheck"+e).prop("checked",!0),$(".fileCheck"+e).parent("label").addClass("checkStatus")):($(".fileCheck"+e).prop("checked",!1),$(".fileCheck"+e).parent("label").removeClass("checkStatus"))});var t=!0;$(".tabCheckOne").each(function(){0==$(this).prop("checked")&&(t=!1),t?($(".tabCheckAll").prop("checked",!0),$(".tabCheckAll").parent("label").addClass("checkStatus")):($(".tabCheckAll").prop("checked",!1),$(".tabCheckAll").parent("label").removeClass("checkStatus"))})}),$("body").on("click",".rFileCheck",function(){var e=!0;$(this).prop("checked")?$(this).parent("label").addClass("checkStatus"):$(this).parent("label").removeClass("checkStatus"),$(".fileCheck").each(function(){0==$(this).prop("checked")&&(e=!1),e?($(".tabCheckAll").prop("checked",!0),$(".tabCheckAll").parent("label").addClass("checkStatus")):($(".tabCheckAll").prop("checked",!1),$(".tabCheckAll").parent("label").removeClass("checkStatus"))})}),$("#pointRight").click(function(){$(".checkAllLab.checkStatus").removeClass("checkStatus"),$(".tabCheckAll").prop("checked",!1),$(".dbName").each(function(){var e=!1,a=$(this).attr("field"),t=[],n=$(this).children(".name").html();if($(this).siblings(".tabList").children().each(function(){var s=[],o=$(this).attr("field");if($(this).children(".aLabel").children(".check").prop("checked")&&(e=!0,s.push($(this).children(".aLabel").children(".name").html()),s.push($(this).attr("field")),s.push($(this).attr("columnSep")),s.push($(this).attr("srcPath")),s.push($(this).attr("filePath")),s.push($(this).attr("cols")),$("#uploadSite").val()==globalParam.commonLinkType.hdfs||$(this).attr("name").match(/^[\w_]+$/g)?s.push($(this).attr("name")):s.push(""),s.push($(this).attr("size")),t.push(s),0==i(a,$(".createTab"))&&l(o,$(".newTr")))){if($("#uploadSite").val()!=globalParam.commonLinkType.hdfs)c='<tr class="newTr" size="'+$(this).attr("size")+'" dbName="'+n+'" tabName="'+$(this).attr("name")+'" filePath="'+$(this).attr("filePath")+'" srcPath="'+$(this).attr("srcPath")+'" columnSep="'+$(this).attr("columnSep")+'" field="'+$(this).attr("field")+'"><td><label class="checkOneLab"><input type="checkbox" field="'+a+'" class="tabCheckOne tabCheckOne'+a+' tabCheck"/></label></td><td class="parse" title="'+$(this).children(".aLabel").children(".name").html()+'"><img src="resources/images/parseDump.png"/><span class="parseName">'+$(this).children(".aLabel").children(".name").html()+'</span></td><td class="oneDbName"></td><td class="map" title="'+$(this).attr("name")+'"><img src="resources/images/parseDump.png"/><span class="targetTab">'+$(this).attr("name")+'</span></td><td><span class="oneConfigure"><img src="resources/images/mapData.png" class="mapImg"/><b class="mapTip">'+common_js_lang["local.option.config"]+"</b></span></td></tr>";else var c='<tr class="newTr" size="'+$(this).attr("size")+'" dbName="'+n+'" tabName="'+$(this).attr("name")+'" filePath="'+$(this).attr("filePath")+'" srcPath="'+$(this).attr("srcPath")+'" columnSep="'+$(this).attr("columnSep")+'" field="'+$(this).attr("field")+'"><td><label class="checkOneLab"><input type="checkbox" field="'+a+'" class="tabCheckOne tabCheckOne'+a+' tabCheck"/></label></td><td class="hdfs" type="hdfs" title="'+$(this).children(".aLabel").children(".name").html()+'"><img src="resources/images/parseDump.png"/><span class="parseName">'+$(this).children(".aLabel").children(".name").html()+'</span></td><td class="map hdfsMap" type="hdfs"></td><td><span class="oneConfigure" field="hdfs"><img src="resources/images/mapData.png" class="mapImg"/><b class="mapTip">'+common_js_lang["local.option.config"]+"</b></span></td></tr>";$(".createTab"+a).append(c),$(".createTab"+a).siblings("thead").children().eq(0).children().eq(0).children("label").removeClass("checkStatus"),$(".createTab"+a).siblings("thead").children().eq(0).children().eq(0).children("label").children(".fileCheck").prop("checked",!1),$(".checkAllLab").removeClass("checkStatus").children(".tabCheckAll").prop("checked",!1)}}),0==$(".addContentZone").children().length&&e){d=(o="<table class='newTable'><thead><tr><th><label class='fileCheckLab'><input type='checkbox' field='"+a+"' class='tabCheck rFileCheck fileCheck fileCheck"+a+"'/></label></th><th colspan='2'><img src='resources/images/oneDump.png'/><span class='dbFile'>"+n+"</span> "+common_js_lang["dbManage.text.have"]+" <span class='fileNum'></span> "+common_js_lang["db.text.tblNum"]+"</th><th class='noLine'></th><th></th></tr></thead><tbody class='createTab createTab"+a+"' field='"+a+"'>")+(c=s(a,t,n))+(r="</tbody></table>");$(".addContentZone").append(d)}if(i(a,$(".createTab"))&&e){var o="<table class='newTable'><thead><tr><th><label class='fileCheckLab'><input type='checkbox' field='"+a+"' class='tabCheck rFileCheck fileCheck fileCheck"+a+"'/></label></th><th colspan='2'><img src='resources/images/oneDump.png'/><span class='dbFile'>"+n+"</span> "+common_js_lang["dbManage.text.have"]+" <span class='fileNum'></span> "+common_js_lang["db.text.tblNum"]+"</th><th class='noLine'></th><th></th></tr></thead><tbody class='createTab createTab"+a+"' field='"+a+"'>",c=s(a,t,n),r="</tbody></table>",d=o+c+r;$(".addContentZone").append(d)}}),$(".leftZone .tabName.tabcheck .check").click(),o()}),$("#pointLeft").click(function(){$(".tabCheckOne").each(function(){$(this).prop("checked")&&(1==$(this).parent().parent().parent().parent().children().length?$(this).parent().parent().parent().parent().parent().remove():$(this).parent().parent().parent().remove(),0==$(".newTable").length&&($(".tabCheckAll").prop("checked",!1),$(".tabCheckAll").parent("label").removeClass("checkStatus")))}),o()}),$(".allConfigure").click(function(){0==$(".addContentZone").children().length?MsgTip("",common_js_lang["dump.info.addConfig"],"info"):$("#uploadSite").val()!=globalParam.commonLinkType.hdfs?d():h()});var y=0;$(".contentBox strong").hover(function(){var e=$(this);y=setTimeout(function(){e.find(".tip").css({display:"block"})},300)},function(){clearInterval(y),$(this).find(".tip").css({display:"none"})}),$("body").on("click",".oneConfigure",function(){var e=$(this).parents("tr").attr("data-param")||"",a=e?JSON.parse(e):"";$(".maskCell, .contentBox").show(),$(".contentBox .bakBtnZ").hide(),$(".contentBox .bottomBtn").show();var t=$(this).parents(".newTr").attr("field");if($(".keep").attr({num:t,field:"one"}),$(".mathRoute .titleBatch").hide(),$("#uploadSite").val()!=globalParam.commonLinkType.hdfs){$(".mathRoute.hiveH").show(),$(".mathRoute.hdfsH, .hiveH .batchTitle").hide(),$(".fieldMap, .tabMsg, .tab, .fieldMap, .formatType").show(),$(".part").hide(),$(".partition").empty(),$(".contentBox .hiveH .tableType").val(a.tableType||($("#uploadSite").val()==globalParam.commonLinkType.hive?0:1)).prop("disabled",!($("#uploadSite").val()!=globalParam.commonLinkType.spark&&!a.ddl));var n=a.name||"",l=a.tableName||$(this).parents(".newTr").attr("tabname");n?($("#dbName").val()!=n?($("#dbName").val(n).select2(),w.getTables(a)):($("#tableName").val(l).select2({tags:!0}),$("#tableName").val()!=l&&$("#tableName").append('<option value="'+l+'">'+l+"</option>").val(l).select2({tags:!0})),a.ddl&&(w.getPart(a.tableName,a.catalog,a.schema,a.partition),editor.doc.cm.setOption("readOnly",!0),editor.doc.setValue(a.ddl),$(".fieldMap .CodeMirror").addClass("disabled")),a.createSql&&(editor.doc.cm.setOption("readOnly",!1),editor.doc.setValue(a.createSql),$(".fieldMap .CodeMirror").removeClass("disabled"))):($("#dbName").val("").select2(),$("#tableName").html('<option value="" disabled>'+common_js_lang["local.option.setTbl"]+"</option><option>"+l+"</option>").val(l).select2({tags:!0}),$(".contentBox .hiveH .tableType").val($("#uploadSite").val()==globalParam.commonLinkType.hive?0:1).prop("disabled",!0),editor.doc.cm.setOption("readOnly",!0),editor.doc.setValue(""),$(".fieldMap .CodeMirror").addClass("disabled"))}else{$(".mathRoute.hiveH, .fieldMap, .hdfsH .batchTitle").hide(),$(".mathRoute.hdfsH, .suffixShow, .mathRoute.hdfsH .routeTitle").show();var i=a.curPath||"",s=a.name||"";i?($(".defaultRoute").val(i).attr("title",i),$(".routeLabel").each(function(){$(this).siblings(".oneRoute").attr("data-base")==i?($(this).addClass("rCheckIcon").children("input").prop("checked",!0),$this=$(this)):$(this).removeClass("rCheckIcon").children("input").prop("checked",!1)}),p($this)):($(".routeLabel.rCheckIcon").removeClass("rCheckIcon").children("input").prop("checked",!1),$(".defaultRoute").val("").attr("title","")),s?$(".suffixRoute").val(s):$(".suffixRoute").val($(this).parent().siblings(".hdfs").children(".parseName").html().substr(0,99))}}),m.prototype={event:function(){var e=this;e.container.on("change","#dbName",function(){if("one"==$(".keep").attr("field")){var a=e.getParam();if(!a.name)return;e.getTables(a)}}),e.container.on("change","#tableName",function(){var a=e.getParam();if(a.name&&a.tableName)return a.tableName.match(/^[0-9A-Za-z]\w*$/g)?void e.getDdlAct(a,3,e.container,editor):(MsgTip("",common_js_lang["db.info.tableName"],"info"),e.container.find("#tableName").val("").select2({tags:!0}),!1)}),e.container.on("change",".tableType",function(){var a=e.getParam();if(a.name&&a.tableName)return a.tableName.match(/^[0-9A-Za-z]\w*$/g)?void e.getDdlAct(a,3,e.container,editor):(MsgTip("",common_js_lang["db.info.tableName"],"info"),e.container.find("#tableName").val("").select2({tags:!0}),!1)})},getParam:function(){var e=$(".keep").attr("num"),a=$('.newTr[field="'+e+'"]'),t=a.attr("cols"),n=a.attr("columnsep"),l=this,i=l.container.find("#dbName option:selected");return{dbId:N.connId,name:i.val(),pid:$("#userApp").val(),catalog:i.attr("catalog")||"",schema:i.attr("schema")||"",tableName:l.container.find("#tableName").val(),tableType:l.container.find(".tableType").val(),format:l.container.find(".tableType option:selected").text(),cols:t,colSep:n}},getTables:function(e){var a=this;$("#globalLoadCon").show(),$.when(globalParam.promiseFunc.getTables(e)).then(function(){$("#part .partition").html(""),$("#part").css({display:"none"});var t=globalParam.tblModel["tbl_"+e.dbId+"_"+e.catalog+"_"+e.schema],n='<option value="" disabled>'+common_js_lang["local.option.setTbl"]+"</option>";if(t.map(function(e){n+='<option data-name="'+e.name+'">'+e.name+"</option>"}),$("#tableName").html(n),!e.tableName||!e.tableName.match(/^[0-9A-Za-z]\w*$/g))return $("#tableName").val("").select2({tags:!0}),MsgTip("",common_js_lang["db.info.tableName"],"info"),$("#globalLoadCon").hide(),!1;$("#tableName").val(e.tableName).select2({tags:!0}),$("#tableName").val()!=e.tableName&&$("#tableName").append("<option>"+e.tableName+"</option>").val(e.tableName).select2({tags:!0}),e.tableName?e.ddl||e.createSql?$("#globalLoadCon").hide():w.getDdlAct(e,3,a.container,editor):(editor.doc.cm.setOption("readOnly","nocursor"),editor.doc.setValue(""),$(".fieldMap .CodeMirror").addClass("disabled"),$("#tableName").val("").select2({tags:!0}),$("#globalLoadCon").hide())}).fail(function(){$("#globalLoadCon").hide()})},getDdlAct:function(e,a,t,n){t=t||this.container;var l=this;$("#globalLoadCon").show();var i=$.Deferred();$.when(globalParam.promiseFunc.getDdl(e,a)).then(function(a){if(a.mppTable&&$("#uploadSite").val()==globalParam.commonLinkType.hive)return n.doc.setValue(""),i.reject(),void MsgTip("info",common_js_lang["db.tip.hivexspark"]);if(!a.mppTable&&$("#uploadSite").val()==globalParam.commonLinkType.spark)return n.doc.setValue(""),i.reject(),void MsgTip("info",common_js_lang["db.tip.sparkxhive"]);if(n.doc.setValue(a.ddl),a.isShow){n.doc.cm.setOption("readOnly","nocursor"),t.find(".CodeMirror").addClass("disabled");s={text:"0",orc:"1",parquet:"2",rcfile:"3",sequencefile:"4"};t.find(".tableType").val(s[a.format]||0).prop("disabled",!0),l.getPart(e.tableName,e.catalog,e.schema,e.partition||"",i)}else{n.doc.cm.setOption("readOnly",!1),t.find(".CodeMirror").removeClass("disabled");var s={text:"0",orc:"1",parquet:"2",rcfile:"3",sequencefile:"4"};t.find(".tableType").val(s[a.format]||($("#uploadSite").val()==globalParam.commonLinkType.hive?0:1)).prop("disabled",$("#uploadSite").val()==globalParam.commonLinkType.spark||!1),$("#part .partition").html(""),$("#part").css({display:"none"}),i.resolve()}}).fail(function(){t.find("#tableName").val("").select2({tags:!0}),n.doc.setValue(""),n.doc.cm.setOption("readOnly","nocursor"),t.find(".CodeMirror").addClass("disabled"),t.find(".tableType").val(0).prop("disabled",!0),i.reject()}),$.when(i).always(function(){$("#globalLoadCon").hide()})},getPart:function(e,a,t,n,l){var i=this;$.when(globalParam.promiseFunc.getPart({dbId:N.connId,tableName:e,catalog:a,schema:t})).then(function(e){i.partitionShow(e,n),l&&l.resolve()}).fail(function(){l&&l.reject()})},partitionShow:function(e,a){if($("#partitions").empty(),$(".partition").html(""),e&&0!=e.length){if($("#part").show(),e.map(function(e,a){var t="";t+='<div class="item"><input type="text" class="filedName" value="'+e.name+'" disabled><label>=</label><select class="select2 filedVal selVal" data-type="'+e.name+'" id="Part_level_'+a+'">',e.parts.map(function(e){t+='<option value="'+e.value+'" title="'+e.name+'">'+e.value+"</option>"}),t+=globalParam.columnValOption+"</select></div>",$(".partition").append(t),$(".partition #Part_level_"+a).select2({placeholder:"value",tags:!0})}),a){var t=JSON.parse(a);for(var n in t)1==$(".partition").find('[data-type="'+n+'"]').find('[value="'+t[n]+'"]').length?$(".partition").find('[data-type="'+n+'"]').val(t[n]).trigger("change"):$(".partition").find('[data-type="'+n+'"]').prepend('<option value="'+t[n]+'">'+t[n]+"</option>").val(t[n]).change()}}else $("#part").hide()}};var w=new m({container:$(".contentBox")});f.prototype={event:function(){var e=this;e.configContainer.on("click",".keep",function(){"all"==$(this).attr("field")?$("#uploadSite").val()!=globalParam.commonLinkType.hdfs?e.hiveBatchAct():e.hdfsBatchAct():$("#uploadSite").val()!=globalParam.commonLinkType.hdfs?e.hiveSingleAct():e.hdfsSingleAct()})},hdfsBatchAct:function(){var e=$(".defaultRoute").val()||"";""!=e?$.ajax({url:"hdfs/dir/access",data:{hdfsId:$("#connId").val(),dir:e,pid:$("#userApp").val()},success:function(a){-1!=a.code?200==a.code?($(".newTable .checkOneLab.checkStatus").each(function(){var a=$(this).parents(".newTr"),t=a.find(".hdfs").attr("title");t=t.slice(0,60);var n=(e+"/"+t).replace(/\/+/g,"/");a.attr("data-param",JSON.stringify({fileName:n,curPath:e,name:t,hid:N.connId})).find(".hdfsMap").html(n).attr("title",n),$(this).find(".tabCheckOne").click()}),$(".maskCell").hide(),$(".contentBox").hide(),$(".defaultRoute").val("").attr("title","")):ErrTip(a.i18nMsg.title,a.i18nMsg.detail,a.msg):S.ajaxFail()}}):MsgTip("",common_js_lang["db.info.batchDir"],"info")},hdfsSingleAct:function(){var e=$(".suffixRoute").val().trim()||"",a=$(".defaultRoute").val().trim()||"";if(!a||!e)return MsgTip("",common_js_lang["local.info.fileDir"],"info"),!1;if(e.match(/\s+|\\+/g))return MsgTip("",common_js_lang["local.info.fileName"],"info"),!1;e=e.slice(0,60);var t=this;$.ajax({url:"hdfs/dir/access",data:{hdfsId:$("#connId").val(),dir:a,pid:$("#userApp").val()},success:function(n){if(-1!=n.code)if(200==n.code){var l=t.configContainer.find(".keep").attr("num"),i=a+"/"+e;i=i.replace(/\/+/g,"/");var s=$('.newTr[field="'+l+'"]');s.find(".hdfsMap").html(i).attr("title",i),s.attr("data-param",JSON.stringify({fileName:i,curPath:a,name:e,hid:N.connId})),$(".maskCell").hide(),$(".contentBox").hide(),$(".defaultRoute").val("").attr("title",""),$(".suffixRoute").val("")}else ErrTip(n.i18nMsg.title,n.i18nMsg.detail,n.msg);else S.ajaxFail()}})},hiveBatchAct:function(){var e=$("#dbName option:selected"),a=e.val(),t=e.attr("catalog")||"",n=e.attr("schema")||"";if(!a)return MsgTip("info",common_js_lang["client.info.noDb"]),!1;var l=$(".newTable .checkOneLab.checkStatus"),i=l.length,s=[];$("#waitLoading").find("article").html("<p>"+common_js_lang["loading.info.batchConf"].replace(/\[x\]/,i)+'</p><p class="detail"></p>').end().css({display:"block"});var o=$.Deferred(),c={dbId:N.connId,catalog:t,schema:n};$.when(globalParam.promiseFunc.getTables(c)).then(function(){var e=globalParam.tblModel["tbl_"+N.connId+"_"+t+"_"+n],a='<option value="" disabled>'+common_js_lang["local.option.setTbl"]+"</option>";e.map(function(e){a+='<option data-name="'+e.name+'">'+e.name+"</option>"}),$("#tableName").html(a).val("").select2({tags:!0}),o.resolve()}).fail(function(){o.reject(),$("#waitLoading").hide()}),$.when(o).then(function(){for(var e=0;e<i;e++){var o=l.eq(e).parents(".newTr"),c=o.attr("cols"),r=o.attr("columnsep"),d=o.attr("tabname");s[e]=$.Deferred(),d.match(/^[0-9A-Za-z]\w*$/g)?function(e,a,t){$.when(globalParam.promiseFunc.getDdl(e,3)).then(function(n){if(n.mppTable&&$("#uploadSite").val()==globalParam.commonLinkType.hive)return a.reject(),void MsgTip("info",common_js_lang["db.tip.hivexspark"]);if(!n.mppTable&&$("#uploadSite").val()==globalParam.commonLinkType.spark)return a.reject(),void MsgTip("info",common_js_lang["db.tip.sparkxhive"]);var l={text:"0",orc:"1",parquet:"2",rcfile:"3",sequencefile:"4"}[n.format]||0;e.tableType=l,n.isShow?e.ddl=n.ddl:e.createSql=n.ddl,t.attr("data-param",JSON.stringify(e)),t.find(".oneDbName").html(e.name),t.find(".map").attr("title",e.tableName).find(".targetTab").html(e.tableName),t.find(".tabCheckOne").click(),a.resolve()}).fail(function(){a.reject()})}({dbId:N.connId,name:a,catalog:t,schema:n,tableName:d,cols:c,colSep:r,tableType:$("#uploadSite").val()==globalParam.commonLinkType.hive?0:1,format:$("#uploadSite").val()==globalParam.commonLinkType.hive?"text":"orc"},s[e],o):(o.attr("data-param",JSON.stringify({dbId:N.connId,name:a,catalog:t,schema:n})),o.find(".map").attr("title","").find(".targetTab").html(""),s[e].resolve())}$.when.apply($,s).then(function(){$(".maskCell, .contentBox, #waitLoading").hide()}).fail(function(){$("#waitLoading").hide()})})},hiveSingleAct:function(){var e=this.saveHiveParam();if(e){var a=this.configContainer.find(".keep").attr("num"),t=this.listContainer.find('.newTr[field="'+a+'"]');t.children(".oneDbName").html(e.name).attr("title",e.name),t.children(".map").children(".targetTab").html(e.tableName).attr("title",e.tableName),t.attr("data-param",JSON.stringify(e)),$(".maskCell").hide(),$(".contentBox").hide()}},saveHiveParam:function(){var e=this.configContainer.find("#dbName option:selected"),a=e.val(),t=e.attr("catalog")||"",n=e.attr("schema")||"",l=this.configContainer.find("#tableName").val(),i=this.configContainer.find(".tableType").val(),s=this.savePart(),o=editor.doc.getValue(),c=$(".keep").attr("num"),r=$('.newTr[field="'+c+'"]'),d=r.attr("cols"),h=r.attr("columnsep");if([a,l,o].indexOf("")>-1)return MsgTip("",common_js_lang["local.info.tblErr"],"info"),!1;var p="",m="";if(editor.doc.cm.isReadOnly())p=o;else{m=o,o=(o=o.substring(o.indexOf("TABLE")+"TABLE".length,o.indexOf("(")).trim()).replace(/\"|\'|`|\[|\]/g,"");try{var f=o.split(".");if(f[0]!=a||f[1]!=l)return MsgTip("",common_js_lang["db.info.sqlErr"],"info"),!1}catch(e){return MsgTip("",common_js_lang["db.info.sqlErr"],"info"),!1}}var u={dbId:N.connId,name:a,catalog:t,schema:n,tableName:l,tableType:i,ddl:p,createSql:m,cols:d,colSep:h};return s&&(u.partition=JSON.stringify(s)),u},savePart:function(){var e=this.configContainer.find("#part .filedVal"),a={};if(e.length<=0)return"";for(var t=0,n=e.length;t<n;t++)a[e.eq(t).attr("data-type")]=e.eq(t).val().trim();return a}};new f;$(".startImport").click(function(){if($(".tabCheckOne").length<=0)return MsgTip("",common_js_lang["db.info.confTar"],"info"),!1;if($("#uploadSite").val()==globalParam.commonLinkType.hdfs){for(var e=[],a=[],t=0,n=(i=$(".newTable .newTr")).length;t<n;t++){var l=i.eq(t).attr("data-param")||"";if(!l)return MsgTip("info",common_js_lang["dbManage.info.hdfsParamErr"]),!1;h={tableName:i.eq(t).attr("tabname"),srcPath:i.eq(t).attr("srcpath"),filePath:i.eq(t).attr("filepath"),columnSep:i.eq(t).attr("columnsep"),size:i.eq(t).attr("size")};e.push(h),a.push(JSON.parse(l))}return b({pid:$("#userApp").val(),jobName:$("#dTaskName").val().trim(),note:$(".taskDescribe").val(),toType:8,toId:N.connId,fromJson:JSON.stringify(e),toHdfsJson:JSON.stringify(a)}),!1}for(var i=$(".newTable .newTr"),e=[],s=[],o=[],c=[],r=$.Deferred(),d=$.Deferred(),t=0,n=i.length;t<n;t++){if(!(l=i.eq(t).attr("data-param")||""))return MsgTip("info",common_js_lang["local.info.hiveParam"]),!1;var h={tableName:i.eq(t).attr("tabname"),srcPath:i.eq(t).attr("srcpath"),filePath:i.eq(t).attr("filepath"),columnSep:i.eq(t).attr("columnsep"),size:i.eq(t).attr("size")};e.push(h);var p=JSON.parse(l);if(s.push(p),p.createSql&&o.push({catalog:p.catalog,schema:p.schema,tableName:p.tableName,ddl:p.createSql,index:t}),p.ddl&&!p.partition){var m=globalParam.partitionsData["catalog"+p.catalog+"_schema"+p.schema+"_"+p.tableName];if(m&&m.length>0)return MsgTip("",common_js_lang["db.text.tbl"]+"["+p.tableName+"] "+common_js_lang["local.info.hiveParam"]+"\n","info"),!1;m||c.push(p)}}c.length>=1?($("#waitLoading").find("article").html("<p>"+common_js_lang["db.text.checkWait"]+'</p><p class="detail"></p>').end().css({display:"block"}),$.when(globalParam.promiseFunc.batchPartCheck({dbId:N.connId,pid:$("#userApp").val(),tablesJsonStr:JSON.stringify(c)})).then(function(){r.resolve()}).fail(function(){r.reject()})):r.resolve(),$.when(r).then(function(){function e(){if(r>=h)return a?(d.reject(),$("#waitLoading").css({display:"none"}),void ErrTip(t,n,common_js_lang["loading.info.newInfo"].replace(/\[x\]/,l).replace(/\[y\]/,c)+"\n"+a)):void d.resolve();var p=o.slice(r,r+100),m=r+100<=h?100:h-r;$.ajax({url:"db/table/create/batch",type:"post",data:{dbId:N.connId,pid:$("#userApp").val(),tablesJsonStr:JSON.stringify(p)},success:function(d){200!=d.code?(t||(t=d.i18nMsg.title),n||(n=d.i18nMsg.detail),a+=d.msg+"\n",c+=m):d.model.map(function(e,d){var h=o[d+r].index;if(200!=e.code)return c++,t||(t=e.i18nMsg.title),n||(n=e.i18nMsg.detail),void(a+="["+o[d+r].tableName+"]:"+e.msg+".\n");l++,s[h].ddl=e.model.ddl,s[h].createSql="",s[h].tableName=e.model.tableName,s[h].catalog=e.model.catalog,s[h].schema=e.model.schema,i.eq(h).attr("data-param",JSON.stringify(s[h]))}),r+=100,$("#waitLoading").find("article .detail").html(common_js_lang["loading.info.newInfo"].replace(/\[x\]/,l).replace(/\[y\]/,c)),e()}})}if(o.length>=1){var a="",t="",n="",l=0,c=0,r=0,h=o.length;$("#waitLoading").find("article").html("<p>"+common_js_lang["loading.info.batchNew"].replace(/\[x\]/,h)+'</p><p class="detail"></p>').end().css({display:"block"}),e()}else d.resolve()}).fail(function(){d.reject()}),$.when(d).then(function(){return u({pid:$("#userApp").val(),jobName:$("#dTaskName").val().trim(),note:$(".taskDescribe").val(),toType:$("#uploadSite").val()==globalParam.commonLinkType.hive?9:13,toId:N.connId,fromJson:JSON.stringify(e),toHiveJson:JSON.stringify(s)}),!1}).always(function(){return $("#waitLoading").hide(),!1})}),$("body").on("click",".routeLabel",function(){$(".routeLabel").each(function(){$(this).removeClass("rCheckIcon")}),$(this).addClass("rCheckIcon");var e=$(this).siblings(".oneRoute").attr("data-base");$(".defaultRoute").val(e).attr("title",e)}),g(),$("#uploadSite").change(function(e){$(e.target);if(g(),$(this).val()!=globalParam.commonLinkType.hdfs)return $(".headTitle").show(),$(".headTitltTwo").hide(),!1;$(".headTitle").hide(),$(".headTitltTwo").show()}),$("#userApp").change(function(){g()}),$("#connId").change(function(e){$(e.target);N.connId=$(this).val()}),$("body").on("click",".turnOn",function(){var e=$(this);e.hide().siblings(".turnOff").show(),e.parent().siblings(".allMeun").hide()}),$("body").on("click",".turnOff",function(){var e=$(this),a=$(this).parent().attr("data-base");parseInt($(this).parent().parent().css("text-indent"));if(0==$(this).parent().siblings(".allMeun").length){if(e.hasClass("got"))return!1;e.addClass("got"),v(N.connId,e,a)}else e.parent().siblings(".allMeun").show(),e.hide().siblings(".turnOn").show()}),$(".closeMap").click(function(){$(".sqlSentence").empty(),$(".maskCell").hide(),$(".contentBox").hide(),$(".suffixRoute").removeClass("redWord")}),$(".copyNameBtn").click(function(){$(this).prop("checked")?($(this).parent("label").removeClass("copyNoCheck").addClass("copyOk"),$(".routeLabel").each(function(){$(this).removeClass("rCheckIcon")})):$(this).parent("label").addClass("copyNoCheck").removeClass("copyOk")}),$(".cancelKeep").click(function(){$(".sqlSentence").empty(),$(".maskCell").hide(),$(".contentBox").hide(),$(".suffixRoute").removeClass("redWord")}),window.onbeforeunload=function(){if($("#dTaskName").val().trim()||$(".mapTaskMsg .taskDescribe").val().trim()||$("#fileuploadTbody .fileName").length>0)return common_js_lang["common.info.leavePage"]},$("#copyName").click(function(){var e=$(this).val();$(".copyNameBtn").prop("checked")&&($(".maskCell,.contentBox,.mathRoute.hdfsH").show(),$(".keep").attr("field","all"),$(".mathRoute.hiveH,.fieldMap,.suffixShow,.contentBox .bottomBtn").hide(),$(".hdfsWrite,.contentBox .bakBtnZ").show(),$(".hdfsRoute").val(""),e?($(".defaultRoute").val(e).attr("title",e),$(".routeLabel").each(function(){$(this).siblings(".oneRoute").children(".thisRoute").html()==e?($(this).addClass("rCheckIcon").children("input").prop("checked",!0),$this=$(this)):$(this).removeClass("rCheckIcon").children("input").prop("checked",!1)}),p($this)):$(".routeLabel").each(function(){if($(this).hasClass("rCheckIcon")){var e=$(this).siblings(".oneRoute").children(".thisRoute").html();$(".defaultRoute").val(e).attr("title",e)}}))}),$(".bakRouteOk").click(function(){if($(".defaultRoute").val())return $(".maskCell,.contentBox").hide(),$(".contentBox .bakBtnZ").hide(),$(".contentBox .bottomBtn").show(),$("#copyName").val($(".defaultRoute").val()),!1;MsgTip("",common_js_lang["dump.info.bakPath"],"info")}),$(".suffixRoute").blur(function(){var e=$(this).val().trim();e.match(/\s+/g)||e.match(/\\/g)?$(".suffixRoute").addClass("redWord"):$(".suffixRoute").removeClass("redWord")}),$("#pointLeft,#pointRight").on("mouseenter",function(){$(this).children(".lost").hide().siblings(".select").show()}).on("mouseleave",function(){$(this).children(".lost").show().siblings(".select").hide()})}function init(){taskFn()}var progress=[],index=0,parseResult=[],wirteVal=[],editor=CodeMirror.fromTextArea($(".fieldMap .sqlSentence")[0],{lineNumbers:!0});init();