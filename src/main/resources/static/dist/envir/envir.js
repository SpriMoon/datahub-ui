$(function(){function n(n){this.container=n.container,this.event(),this.getHdfsType()}function t(n){this.container=n.container,this.event(),this.getServer()}function i(){this.container=$(".globalCon"),this.event()}function e(n){this.container=n.container,this.event(),this.init()}$(".setUpData .tooltip").tipsy({fade:!0,gravity:"s",html:!0}),n.prototype={event:function(){var n=this;n.container.on("change",".linkType",function(){var t=n.container.find(".linkType option:selected").text();if(n.container.find(".setUpData .data").hide(),n.container.find(".setUpData ."+t).show(),n.container.find(".setUpData .connName").show(),!adminConfigData.ha){var i=n.container.find(".hiveUrl.editB"),e=i.attr("field");"kerberos"==t?i.val(e+";principal=hive/_HOST@LEAP.COM").attr("title",e+";principal=hive/_HOST@LEAP.COM"):i.val(e).attr("title",e)}}),n.container.find(".hiveUrl").on("input propertychange",function(){$(this).attr("title",$(this).val().trim())}),n.container.find(".simple.url .editB").on("input propertychange",function(){$(this).attr("title",$(this).val().trim())}),n.container.find(".sentry.url .editB").on("input propertychange",function(){$(this).attr("title",$(this).val().trim())}),n.container.find("input.editB").on("blur",function(){$(this).val().trim().match(/\s+/g)?$(this).addClass("errorBack"):$(this).removeClass("errorBack")}),n.container.find("input.hiveUrl,input.hiveUser").on("blur",function(){$(this).val().trim().match(/\s+/g)?$(this).addClass("errorBack"):$(this).removeClass("errorBack")}),n.container.find(".editBtn").click(function(){var t=n.container.find(".linkType option:selected").text();n.container.find(".setUpData .editB").attr("readonly",!1),n.container.find(".setUpData .row .editB").removeClass("displayNone"),n.container.find(".setUpData ."+t).children(".editB").eq(0).focus(),n.container.find(".hiveUrl").show().attr("readonly",!1),n.container.find(".hiveUser").show().attr("readonly",!1),n.container.find(".setUpData .row.btnZone").show(),n.container.find(".setUpData .row .show").addClass("displayNone")}),n.container.find(".cancelSet").click(function(){var t=$(this).attr("field");n.container.find(".setUpData .data").hide(),n.container.find(".setUpData .row."+t).show().children(".show").removeClass("displayNone"),n.container.find(".setUpData .connName").show(),n.container.find(".setUpData .row .editB").each(function(){$(this).addClass("displayNone"),$(this).attr("field")?$(this).val($(this).attr("field")):$(this).val("")}),n.container.find(".hiveUrl").attr("title",$(".hiveUrl").attr("field")).hide().siblings(".show").removeClass("displayNone"),n.container.find(".hiveUser").hide().siblings(".show").removeClass("displayNone");var i=0;i="kerberos"==t?2:"sentry"==t?3:1,n.container.find(".setUpData .row.all .linkType").val(i).siblings(".show").removeClass("displayNone"),n.container.find(".setUpData .row.btnZone").hide()}),n.container.find(".keepData").click(function(){if(!n.container.find(".hiveUrl").val().trim())return MsgTip("",common_js_lang["dbManage.info.hiveurlErr"],"info"),!1;if(!n.container.find(".hiveUser").val().trim())return MsgTip("",common_js_lang["dbManage.info.hiveuserErr"],"info"),!1;if(n.container.find(".hiveUrl").val().trim().match(/\s+/g)||n.container.find(".hiveUser").val().trim().match(/\s+/g))return MsgTip("",common_js_lang["dbManage.info.spaceErr"],"info"),!1;var t=n.container.find(".linkType").val(),i=n.container.find(".hiveUrl").val().trim(),e=n.container.find(".hiveUser").val().trim();if(2==t){var a=n.container.find(".keytabPath .editB").val().trim(),r=n.container.find(".krb5Path .editB").val().trim(),o=n.container.find(".kerberos.port .editB").val().trim(),s=n.container.find(".kerberos.url .editB").val().trim(),l=n.container.find(".kerberos.core .editB").val().trim();if(r.match(/\s+/g)||a.match(/\s+/g)||o.match(/\s+/g)||s.match(/\s+/g)||l.match(/\s+/g))return MsgTip("",common_js_lang["dbManage.info.spaceErr"],"info"),!1;if(r&&a&&o&&s&&l){var c={};c.authType=t,c.krb5Conf=r,c.keytab=a,c.principal=o,c.hiveUrl=i,c.proxyUser=e,c.hdfsSiteXml=s,c.coreSiteXml=l,c.password=n.container.find(".pwd.editB").val().trim(),c.oldpwd=n.container.find(".pwd.editB").attr("old-pwd")||"",n.save(c)}else{if(!a)return MsgTip("",common_js_lang["dbManage.info.keytabErr"],"info"),!1;if(!f)return MsgTip("",common_js_lang["dbManage.info.kerberosErr"],"info"),!1;if(!s)return MsgTip("","kerberos "+common_js_lang["dbManage.info.hdfsErr"],"info"),!1;if(!l)return MsgTip("","kerberos "+common_js_lang["dbManage.info.coresiteErr"],"info"),!1}return!1}if(3==t){var s=n.container.find(".sentry.url .editB").val().trim(),l=n.container.find(".sentry.core .editB").val().trim();if(s.match(/\s+/g)||l.match(/\s+/g))return MsgTip("",common_js_lang["dbManage.info.spaceErr"],"info"),!1;if(s&&l){var d={};d.authType=t,d.hiveUrl=i,d.proxyUser=e,d.hdfsSiteXml=s,d.coreSiteXml=l,d.password=n.container.find(".pwd.editB").val().trim(),d.oldpwd=n.container.find(".pwd.editB").attr("old-pwd")||"",n.save(d)}else{if(!s)return MsgTip("","sentry "+common_js_lang["dbManage.info.hdfsErr"],"info"),!1;if(!l)return MsgTip("","sentry "+common_js_lang["dbManage.info.coresiteErr"],"info"),!1}return!1}var s=n.container.find(".simple.url .editB").val().trim(),l=n.container.find(".simple.core .editB").val().trim(),f=n.container.find(".simple.userName .editB").val().trim();if(s.match(/\s+/g)||f.match(/\s+/g)||l.match(/\s+/g))return MsgTip("",common_js_lang["dbManage.info.spaceErr"],"info"),!1;if(s&&l&&f){var p={};p.authType=t,p.userName=f,p.hiveUrl=i,p.proxyUser=e,p.hdfsSiteXml=s,p.coreSiteXml=l,p.password=n.container.find(".pwd.editB").val().trim(),p.oldpwd=n.container.find(".pwd.editB").attr("old-pwd")||"",n.save(p)}else{if(!s)return MsgTip("","simple "+common_js_lang["dbManage.info.hdfsErr"],"info"),!1;if(!l)return MsgTip("","simple "+common_js_lang["dbManage.info.coresiteErr"],"info"),!1;f||MsgTip("","HDFS"+common_js_lang["dbManage.info.userErr"],"info")}})},save:function(n){$.ajax({url:"env/hdfs/system/save",data:n,beforeSend:function(){$(".delayTip").show()},type:"post",success:function(n){if(200==n.code)$(".setUpData .row.btnZone").hide(),location.reload();else{if(-1==n.code)return swal({title:"",text:common_js_lang["manage.info.timeout"],type:"info",showCancelButton:!0,confirmButtonText:common_js_lang["manage.info.newdow"],cancelButtonText:common_js_lang["manage.info.tologin"]},function(n){n?window.open("./","_blank"):location.href="./"}),!1;n.msg.length>0?ErrTip(n.i18nMsg.title,n.i18nMsg.detail,n.msg):MsgTip("",common_js_lang["dbManage.info.saveErr"],"info")}},complete:function(){$(".delayTip").hide()}})},getHdfsType:function(){var n=this;$.ajax({url:"env/hdfs/system/auth/types",success:function(t){if(200!=t.code)return ErrTip(t.i18nMsg.title,t.i18nMsg.detail,t.msg),void n.getMsgH();var i="";t.model.map(function(n,t){var e=JSON.parse(n);i+='<option value="'+e.index+'">'+e.alias+"</option>"}),n.container.find(".setUpData .linkType").html(i),n.getMsgH()}})},getMsgH:function(){adminConfigData?(adminConfigData.hdfs.krb5Conf=adminConfigData.hdfs.krb5Conf||"/etc/krb5.conf",adminConfigData.hdfs.keytab=adminConfigData.hdfs.keytab||"/etc/krb5.conf",adminConfigData.hdfs.principal=adminConfigData.hdfs.principal||"datahub@LEAP.COM",this.hdfsShow(adminConfigData.hdfs),this.hiveShow(adminConfigData.hive)):MsgTip("",common_js_lang["dbManage.info.confNone"],"info")},hdfsShow:function(n){var t=this;t.container.find(".setUpData .row.all").show(),t.container.find(".setUpData .connName").show(),t.container.find(".setUpData .url").children(".editB").val(n.hdfsSiteXml).attr("field",n.hdfsSiteXml).siblings(".show").html(n.hdfsSiteXml).attr("title",n.hdfsSiteXml),t.container.find(".setUpData .core").children(".editB").val(n.coreSiteXml).attr("field",n.coreSiteXml).siblings(".show").html(n.coreSiteXml).attr("title",n.coreSiteXml),t.container.find(".setUpData .kerberos.krb5Path").children(".editB").val(n.krb5Conf).attr("field",n.krb5Conf).siblings(".show").html(n.krb5Conf).attr("title",n.krb5Conf),t.container.find(".setUpData .kerberos.keytabPath").children(".editB").val(n.keytab).attr("field",n.keytab).siblings(".show").html(n.keytab).attr("title",n.keytab),t.container.find(".setUpData .kerberos.port").children(".editB").val(n.principal).attr("field",n.principal).siblings(".show").html(n.principal).attr("title",n.principal),t.container.find(".setUpData .connName").children(".conName").html(n.connName).attr("title",n.connName),2==n.authType?(t.container.find(".setUpData .row.all .linkType").val(2),t.container.find(".setUpData .row.all .show").html("kerberos"),t.container.find(".cancelSet").attr("field","kerberos"),t.container.find(".setUpData .row.kerberos").show()):3==n.authType?(t.container.find(".setUpData .row.all .linkType").val(3),t.container.find(".setUpData .row.all .show").html("sentry"),t.container.find(".cancelSet").attr("field","sentry"),t.container.find(".setUpData .row.sentry").show(),t.container.find(".setUpData .sentry.userName").children(".editB").val(n.userName).attr("field",n.userName).siblings(".show").html(n.userName).attr("title",n.userName)):1==n.authType&&(t.container.find(".setUpData .row.all .linkType").val(1),t.container.find(".setUpData .row.all .show").html("simple"),t.container.find(".cancelSet").attr("field","simple"),t.container.find(".setUpData .row.simple").show(),t.container.find(".setUpData .simple.userName").children(".editB").val(n.userName).attr("field",n.userName).siblings(".show").html(n.userName).attr("title",n.userName)),t.container.find(".setUpData .row .editB").addClass("displayNone")},hiveShow:function(n){var t=this;n.url&&t.container.find(".hUrl .hiveUrl").val(n.url).attr("field",n.url).attr("title",n.url).siblings(".show").html(n.url).attr("title",n.url),n.userName&&t.container.find(".hUser .hiveUser").val(n.userName).attr("field",n.userName).siblings(".show").html(n.userName).attr("title",n.userName),n.password&&t.container.find(".hivePwd .pwd").val(n.password).attr({field:n.password,"old-pwd":n.password}).siblings(".show").html(""),n.connName&&t.container.find(".hconn .hiveConn").html(n.connName).attr("title",n.connName),t.container.find(".setUpData .row.hive").show()}},new n({container:$(".upload-tab.uploadFile")}),$("nav").on("click",".tab",function(){if($(this).hasClass("cur"))return!1;var n=$(this).index();$(this).addClass("cur").siblings(".tab").removeClass("cur"),$(".upload-tab").hide().eq(n).show()}),t.prototype={event:function(){var n=this;n.container.on("click",".example",function(){n.container.find(".exampleCon").show()}),n.container.on("click",".exampleCon .close",function(){n.container.find(".exampleCon").hide()}),n.container.on("click",".editBtn",function(){n.container.find(".content.setUpData .row.btnZone, .addParam").show(),n.container.find(".content.setUpData .row .show").addClass("displayNone"),n.container.find(".content.setUpData .row .editB").show(),n.container.find(".content .params input").prop("disabled",!1)}),n.container.find(".cancelSet").click(function(){n.container.find(".content.setUpData .row .show").removeClass("displayNone"),["url","phoneNumberKey","contentKey"].map(function(t){var i=n.container.find('[data-key="'+t+'"]'),e=i.siblings(".show").attr("field")||"";i.val(e),i.hide()});var t=n.container.find(".params").attr("field");n.setParams(t),n.container.find(".content.setUpData .row.btnZone, .content .addParam").hide()}),n.container.on("click",".addParam",function(){$(this).siblings(".flex").append(n.paramItem())}),n.container.on("click",".keepData",function(){var t=n.getData();t&&n.save(t)}),n.container.on("click",".testConnect",function(){r.testShow()})},getData:function(){var n=this,t={providerType:0};["url","phoneNumberKey","contentKey"].map(function(i){var e=n.container.find('[data-key="'+i+'"]').val().trim()||"";e?t[i]=e:MsgTip("",common_js_lang["envir.tip.keyErr"])});for(var i=n.container.find(".content .params input"),e={},a=0,r=0,o=i.length;r<o;r+=2){var s=i.eq(r).val().trim(),l=i.eq(r+1).val().trim();[s].indexOf("")>-1||(e[s]=l,a++)}if(a)return t.params=JSON.stringify(e),t;MsgTip("",common_js_lang["envir.tip.keyErr"])},save:function(n){$(".delayTip").show(),$.ajax({url:"env/sms/save",data:n,success:function(n){200==n.code?location.reload():ErrTip(n.i18nMsg.title,n.i18nMsg.detail,n.msg)},complete:function(){$(".delayTip").hide()}})},getServer:function(){var n=this;$.ajax({url:"env/sms/server",success:function(t){200==t.code?(["url","phoneNumberKey","contentKey"].map(function(i){var e=t.model[i]||"",a=n.container.find('[data-key="'+i+'"]');a.val(e),a.siblings(".show").html(e).attr("field",e)}),n.container.find(".content .addParam").hide(),n.container.find(".content .params").attr("field",t.model.paramsJson?JSON.stringify(t.model.paramsJson):""),n.setParams(JSON.stringify(t.model.paramsJson))):ErrTip(t.i18nMsg.title,t.i18nMsg.detail,t.msg)}})},setParams:function(n){var t=this;if(n){var n=JSON.parse(n),i=t.paramHead();for(var e in n)i+=t.paramItem(e,n[e]);t.container.find(".content .params .flex").html(i)}else{var a=t.paramHead()+t.paramItem();t.container.find(".content .params .flex").html(a)}t.container.find(".content .params input").prop("disabled",!0)},paramHead:function(){return'<div class="head flex-item"><span class="item">key</span><span class="item">'+common_js_lang["dbManage.title.val"]+"</span></div>"},paramItem:function(n,t){return n=n||"",t=t||"",'<div class="flex-item"><span class="item"><input type="text" value="'+n+'" /></span><span class="item"><input type="text" value="'+t+'" /></span></div>'}};var a=new t({container:$(".upload-tab.smsConfig")});i.prototype={event:function(){var n=this;n.container.on("click",".cancel",function(){n.container.hide(),n.container.find("input").val("")}),n.container.on("click",".btn-item",function(){var t=a.getData();if(t){var i=n.container.find("input").val().trim();i.match(/^1[0-9]{10}$/)?(t.testPhone=i,$(".delayTip").show(),$.ajax({url:"env/sms/save",data:t,success:function(t){200==t.code?(MsgTip("success",common_js_lang["db.text.testSuc"]),n.container.hide(),n.container.find("input").val("")):ErrTip(t.i18nMsg.title,t.i18nMsg.detail,t.msg)},complete:function(){$(".delayTip").hide()}})):MsgTip("info",common_js_lang["rule.tip.notifyUserErr"])}})},testShow:function(){this.container.show()}};var r=new i;e.prototype={event:function(){var n=this;n.container.on("click",".editBtn",function(){n.container.find(".setUpData .row.btnZone").show(),n.container.find(".setUpData .row .show").addClass("displayNone"),n.container.find(".setUpData .row .editB").show(),n.container.find(".params input").prop("disabled",!1)}),n.container.find(".cancelSet").click(function(){n.container.find(".setUpData .row .show").removeClass("displayNone");var t=n.container.find("input.editB"),i=t.siblings(".show").attr("field")||"";t.val(i),t.hide(),n.container.find(".setUpData .row.btnZone").hide()}),n.container.on("click",".keepData",function(){var t=(n.container.find("input.editB").val()||"").trim();t&&n.save({url:t})})},init:function(){var n=this.container.find("input.editB"),t=adminConfigData.sdc;n.val(t),n.siblings(".show").html(t).attr("field",t)},save:function(n){$(".delayTip").show(),$.ajax({url:"env/sdc/save",data:n,type:"post",success:function(n){200==n.code?location.reload():ErrTip(n.i18nMsg.title,n.i18nMsg.detail,n.msg)},complete:function(){$(".delayTip").hide()}})}},new e({container:$(".upload-tab.streamSets")})});