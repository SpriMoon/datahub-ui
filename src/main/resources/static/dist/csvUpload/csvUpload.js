function getConnect(){var a=$("#userApp").val(),e=$("#targetType").val(),t="db/list",l=31,n="";e==globalParam.commonLinkType.hdfs?t="hdfs/list":n=4,e==globalParam.commonLinkType.spark&&(l=62),a&&$.fn.ajaxAPI({url:t+"?pid="+a+"&groups="+n+"&dbType="+l,callback:function(a){var t='<option value="" disabled>'+common_js_lang["db.info.selectLink"]+"</option>";e==globalParam.commonLinkType.hdfs&&adminConfigData.hdfs.id&&(t+='<option value="'+adminConfigData.hdfs.id+'">'+adminConfigData.hdfs.connName+"</option>"),e==globalParam.commonLinkType.hive&&adminConfigData.hive.id&&(t+='<option value="'+adminConfigData.hive.id+'">'+adminConfigData.hive.connName+"</option>"),a.model.data.map(function(a){t+='<option value="'+a.id+'">'+a.connName+"</option>"}),$(".configTask .connId").html(t).val("").select2()}})}function hdfsConfigModule(a){var e={container:$(".global-hdfsCon")};a=a||{},e.container=a.container?a.container:e.container,e.hdfsList=e.container.find(".dirDos"),e.path=e.container.find(".selectedDir"),e.name=e.container.find(".fileName"),$.extend(this,e,a),this.event()}function hiveConfigModule(a){this.container=a.container,this.newType=a.newType||1,this.editor=4!=this.newType?editor:SQLeditor,this.event()}function getDB(){$("#globalLoadCon").show(),$.when(globalParam.promiseFunc.getDb({id:$(".connId").val(),pid:$("#userApp").val()})).then(function(a){var e='<option value="" disabled="disabled">'+common_js_lang["local.option.getDb"]+"</option>";a.databases.map(function(a){e+='<option data-catalog="'+a.catalog+'" data-schema="'+a.schema+'" data-name="'+a.name+'">'+a.name+"</option>"}),$("#dbName").html(e).val("").select2(),a.databases&&a.databases.length<=0&&MsgTip("info",common_js_lang["dump.info.dbNone"]),getDataHandle()}).always(function(){$("#globalLoadCon").hide()})}function listFile(a){var e="<td> -- </td>",t='<td class="res">'+common_js_lang["local.info.uping"]+"</td>";return a.size>=0&&(e="<td>"+convertFileSize(a.size)+"</td>"),globalParam.fileIndex++,$(".configFilePath .file-list .tableNoData").parent().remove(),$(".configFilePath .file-list tbody").append('<tr class="f'+globalParam.fileIndex+'"><td title="'+a.name+'">'+a.name+"</td>"+e+'<td class="progress"><span class="process-sliderCon"><div class="process-slider" style="width:0"></div></span><span class="process-res"></span></td>'+t+'<td><a class="del" title="'+common_js_lang["clientList.option.del"]+'"><i></i></a></td></tr>'),"f"+globalParam.fileIndex}function convertFileSize(a){return a<1024?(a||0)+" bytes":a/1024<1024?(a/1024).toFixed(2)+" KB":(a/1024/1024).toFixed(2)+" MB"}function configList(){var a=!1,e=+$(".configTask #targetType").val()!=globalParam.targetType,t=globalParam.connId!=+$(".configTask .connId").val(),l=globalParam.tmpAppId!=$("#userApp").val();e||t||l?(a=!0,$(".item.item2 h3 i").html([common_js_lang["csv.text.hdfsNote"],common_js_lang["csv.text.hiveNote"],common_js_lang["csv.text.hiveNote"]][+$(".configTask #targetType").val()-1]),+$(".configTask #targetType").val()==globalParam.commonLinkType.hdfs?hdfsModule.getDir(""):getDB()):dataHandle(a)}function dataHandle(a){(a||globalParam.fileTableChange)&&(globalParam.fileTable=globalParam.fileTable.map(function(a){return globalParam.targetType==globalParam.commonLinkType.hdfs?a.param=JSON.stringify({fileName:a.tableName+a.fileType,tarName:a.tableName+a.fileType}):a.param=JSON.stringify({tableName:a.tableName}),a.sourceParam=JSON.stringify({filePath:a.filePath,srcPath:a.srcPath,tableName:a.tableName}),a}),globalParam.fileTableChange=!1,editor.doc.cm.setOption("readOnly",!0),editor.doc.setValue(""),$(".sourceCon").html(template("template/source",{data:globalParam.fileTable,type:globalParam.targetType})),$(".sourceCon li:not(.fileTitle)").eq(0).click()),$(".targetCon .targetType").css({display:"none"}),$(".targetCon ."+["hdfsCon","hiveCon","hiveCon"][globalParam.targetType-1]).fadeIn(),$(".stepCon").animate({"margin-left":"-100%"},250,function(){$(".stepCon .item2").show(),1!=globalParam.targetType&&(editor.refresh(),$(".hiveCon .tableType").val(globalParam.targetType==globalParam.commonLinkType.hive?0:1))}),$(".processCon .itemCon").removeClass("cur").eq(1).addClass("cur")}function getDataHandle(){globalParam.targetType=+$(".configTask #targetType").val(),globalParam.connId=+$(".configTask .connId").val(),globalParam.tmpAppId=$("#userApp").val(),dataHandle(!0)}function updateCreateSql(){$("#globalLoadCon").show();for(var a=[],e=$(".sourceCon li:not(.fileTitle)"),t=0,l=e.length;t<l;t++){var n=JSON.parse(e.eq(t).attr("data-param"));if(n.createSql){var o=JSON.parse(e.eq(t).attr("data-sourceparam"));a.push(updateDdl(o,n,e.eq(t)))}}$.when.apply($,a).then(function(){}).always(function(){$("#globalLoadCon").hide()})}function updateDdl(a,e,t){var l=$.Deferred();return e.dbId=globalParam.connId,e.columnSep=globalParam.columnSep,e.fieldEnClosed=globalParam.fieldEnClosed,e.lineNum=e.dataLineNo,e.cols=0,e.format="text",e.sourceparam=a,globalParam.promiseFunc.newCsvDdl(e).then(function(a){e.createSql=a.ddl,t.attr("data-param",JSON.stringify(e)),t.hasClass("cur")&&editor.doc.setValue(e.createSql),l.resolve()}).fail(function(){l.reject()}),l.promise()}function saveHiveParam(a,e){var t=$(".hiveCon").find("#dbName option:selected"),l=t.val()||"",n=t.attr("data-catalog")||"",o=t.attr("data-schema")||"",i=$(".hiveCon").find("#tableName").val(),s=$(".hiveCon").find(".tableType").val(),r=savePart(),d=$(".lineNum").val(),c=editor.doc.getValue(),m={complete:!0,msg:""};if([l,i,c].indexOf("")>-1&&(m.complete=!1,m.msg=common_js_lang["local.info.tblErr"],e))return a.addClass("error"),MsgTip("",common_js_lang["local.info.tblErr"],"info"),!1;var p="",f="";if(editor.doc.cm.isReadOnly())f=c;else{p=c,c=(c=c.substring(c.indexOf("TABLE")+"TABLE".length,c.indexOf("(")).trim()).replace(/\"|\'|`|\[|\]/g,"");try{var g=c.split(".");if((g[0]!=l||g[1]!=i)&&(m.complete=!1,e))return a.addClass("error"),MsgTip("",common_js_lang["db.info.sqlErr"],"info"),!1}catch(t){if(m.complete=!1,e)return a.addClass("error"),MsgTip("",common_js_lang["db.info.sqlErr"],"info"),!1}}var h={dbId:globalParam.connId,name:l,catalog:n,schema:o,tableName:i,tableType:s,dataLineNo:d,ddl:f,createSql:p,paramRes:m};return r&&(h.partition=JSON.stringify(r)),m.complete?a.removeClass("error"):a.addClass("error"),a.attr("data-param",JSON.stringify(h)),!0}function savePart(){var a=$(".hiveCon").find("#partitions .filedVal"),e={};if(a.length<=0)return"";for(var t=0,l=a.length;t<l;t++)e[a.eq(t).attr("data-type")]=a.eq(t).val().trim();return e}function resetHive(a){var e=JSON.parse(a.attr("data-param"))||"",t=e.name||"",l=e.tableName||"",n=e.lineNum||1;$(".hiveCon .infoline.last").hide(),$(".hiveCon #partitions").empty(),$(".hiveCon .lineNum").val(n).attr("data-val",n),$(".hiveCon .tableType").val(e.tableType||(globalParam.targetType==globalParam.commonLinkType.hive?0:1)).prop("disabled",globalParam.targetType==globalParam.commonLinkType.spark||""!=e.ddl),t?($("#dbName").val()!=t?($("#dbName").val(t).select2(),hiveModule.getTables(e)):($("#tableName").val(l).select2({tags:!0}),$("#tableName").val()!=l&&$("#tableName").append('<option value="'+l+'">'+l+"</option>").val(l).select2({tags:!0})),e.ddl&&(hiveModule.getPart(e.tableName,e.catalog,e.schema,e.partition),editor.doc.cm.setOption("readOnly",!0),editor.doc.setValue(e.ddl),$(".new-sql .CodeMirror").addClass("disabled")),e.createSql&&(editor.doc.cm.setOption("readOnly",!1),editor.doc.setValue(e.createSql),$(".new-sql .CodeMirror").removeClass("disabled"))):($("#dbName").val("").select2(),$("#tableName").html('<option value="" disabled>'+common_js_lang["local.option.setTbl"]+"</option><option>"+l+"</option>").val(l).select2({tags:!0}),$(".hiveCon").find(".tableType").val(globalParam.targetType==globalParam.commonLinkType.hive?0:1).prop("disabled",!0),editor.doc.cm.setOption("readOnly",!0),editor.doc.setValue(""),$(".new-sql .CodeMirror").addClass("disabled"))}function saveHdfsParam(a,e){var t=$(".hdfsCon .path").val()||"",l=$(".hdfsCon .filename").val().trim()||"",n={complete:!0,msg:""};return t&&l||(n.complete=!1,n.msg=common_js_lang["dbManage.info.hdfsParamErr"],!e)?(l=l.slice(0,60),n.complete?a.removeClass("error"):a.addClass("error"),a.attr("data-param",JSON.stringify({hid:globalParam.connId,fileName:(t+"/"+l).replace(/\/+/g,"/"),tarDir:t,tarName:l,paramRes:n})),n.complete):(a.addClass("error"),MsgTip("",n.msg,"info"),!1)}function resetHdfs(a){var e=JSON.parse(a.attr("data-param")).tarDir||"",t=JSON.parse(a.attr("data-param")).tarName||"";$(".hdfsCon .path").val(e).attr("title",e),$(".hdfsCon .filename").val(t)}function createTblBatch(a,e){var t=JSON.parse(a.tablesJsonStr),l="",n="",o="",i=$(".sourceCon li:not(.fileTitle)");$.ajax({url:"db/table/create/batch",type:"post",data:a,success:function(a){return 200!=a.code?(ErrTip(a.i18nMsg.title,a.i18nMsg.detail,a.msg),void e.reject()):(a.model.map(function(a,e){var s=t[e].index;if(200!=a.code)return n||(n=a.i18nMsg.title),o||(o=a.i18nMsg.detail),void(l+="["+globalParam.hiveParam[s].tableName+"]:"+a.msg+".\n");globalParam.hiveParam[s].ddl="",globalParam.hiveParam[s].createSql="",globalParam.hiveParam[s].tableName=a.model.tableName,globalParam.hiveParam[s].catalog=a.model.catalog,globalParam.hiveParam[s].schema=a.model.schema;var r=i.eq(s),d=JSON.parse(r.attr("data-param"));d.catalog=a.model.catalog,d.schema=a.model.schema,d.tableName=a.model.tableName,d.ddl=a.model.ddl,d.createSql="",r.attr("data-param",JSON.stringify(d))}),l?(ErrTip(n,o,l),void e.reject()):void e.resolve())},error:function(){e.reject()}})}var editor=CodeMirror.fromTextArea($(".new-sql textarea")[0],{lineNumbers:!0}),tmpParam={fileIndex:0,curTableList:[],targetType:0,fileTable:[],fileTableChange:!1,fileCurLength:0,columnSep:"",tmpAppId:0,connId:0,hiveParam:[],formDataAjax:{}};$.extend(globalParam,tmpParam),$("body").on("click","button.index",function(){window.location.href="./"}),$(".configTask").on("change","#targetType",function(a,e){getConnect()}),$("#userApp").change(function(){getConnect()}),getConnect(),window.onbeforeunload=function(){if($(".taskName").val().trim()||$(".taskDes").val().trim()||$(".file-list  tr .progress").length>0)return common_js_lang["common.info.leavePage"]},$(".global-hdfsCon").on("click",".btn-cancel, h4 .cancel",function(){$(".global-mask, .global-hdfsCon").fadeOut()}),$(".global-hdfsCon").on("click",".btn-item",function(){var a=hdfsModule.saveHdfs();a&&$.fn.ajaxAPI({url:"hdfs/dir/access",data:{hdfsId:globalParam.connId,dir:a.curPath,pid:$("#userApp").val()},callback:function(e){$(".hdfsCon .path").val(a.curPath).attr("title",a.curPath),$(".hdfsCon .filename").val(a.name),$(".global-mask, .global-hdfsCon").fadeOut()}})}),$(".hdfsCon").on("click",".hdfs",function(){var a=$(".hdfsCon .path").val()||"",e=($(".hdfsCon .filename")||"").val().trim();hdfsModule.reset({curPath:a,name:e}),$(".global-mask, .global-hdfsCon").fadeIn()}),hdfsConfigModule.prototype={event:function(){var a=this;a.hdfsList.on("click","li i.show",function(){if(0==$(this).parent().siblings("ul").find("li").length){if($(this).hasClass("got"))return!1;$(this).addClass("got"),a.getDir($(this).parents("li").data("base"))}else $(this).toggleClass("in"),$(this).parent().siblings("ul").toggle()}),a.hdfsList.on("click","li i.check",function(){if(!$(this).hasClass("cur")){a.hdfsList.find(".check.cur").removeClass("cur"),$(this).addClass("cur");var e=$(this).parents("li").attr("data-base")||"";a.path.val(e).attr("title",e)}})},getDir:function(a){var e=this,t={base:a,hid:this.getHid(),pid:$("#userApp").val()},l=""==a,n=setTimeout(function(){$("#globalLoadCon").show()},l?0:2e3),o=l?e.hdfsList.find("> .ul"):e.hdfsList.find('[data-base="'+a+'"] > .ul');$.when(globalParam.promiseFunc.getDir(t)).then(function(e){if(o.parent().find(".show").addClass("in"),o.fadeIn(),!l&&0==e.length)return o.siblings("p").find(".show").addClass("out"),!1;l&&(e=[e]);var t=template("template/hdfsDir",{dir:e,len:a.length});o.html(t),l&&getDataHandle()}).always(function(){o.parent().find(".show").removeClass("got"),clearTimeout(n),$("#globalLoadCon").hide()})},getHid:function(){return $(".connId").val()},saveHdfs:function(){var a=this,e=a.path.val().trim(),t=a.name.val().trim();return e&&t?t.match(/\s+|\\+/g)?(MsgTip("",common_js_lang["local.info.fileName"],"info"),!1):{curPath:e,name:t}:(MsgTip("",common_js_lang["local.info.fileDir"],"info"),!1)},reset:function(a){var e=a.curPath,t=a.name;if(this.hdfsList.find("i.check").removeClass("cur"),this.hdfsList.find("i.show").removeClass("in"),this.hdfsList.find("> .ul .ul").hide(),this.path.val(e).attr("title",e),this.name.val(t),e){var l=this.hdfsList.find('[data-base="'+e+'"]');1==l.length&&(l.find("> p .check").addClass("cur"),l.parents(".ul").fadeIn().siblings("p").find(".show").addClass("in"))}}};var hdfsModule=new hdfsConfigModule;hiveConfigModule.prototype={event:function(){var a=this;a.container.on("change","#dbName",function(){var e=a.getParam();e.name&&a.getTables(e)}),a.container.on("change","#tableName",function(){var e=a.getParam();if(e.name&&e.tableName)return e.tableName.match(/^[0-9A-Za-z]\w*$/g)?void a.getDdlAct(e,a.newType):(MsgTip("",common_js_lang["db.info.tableName"],"info"),a.container.find("#tableName").val("").select2({tags:!0}),!1)}),a.container.on("change",".tableType",function(){var e=a.getParam();if(e.name&&e.tableName)return e.tableName.match(/^[0-9A-Za-z]\w*$/g)?void a.getDdlAct(e,a.newType):(MsgTip("",common_js_lang["db.info.tableName"],"info"),a.container.find("#tableName").val("").select2({tags:!0}),!1)}),a.container.on("blur",".lineNum",function(){var e=parseInt($(this).val())||1,t=$(this).attr("data-val");if(e<1&&(e=1),$(this).val(e).attr("data-val",e),!editor.doc.cm.isReadOnly()&&t!=e){var l=a.getParam();if(l.name&&l.tableName)return l.tableName.match(/^[0-9A-Za-z]\w*$/g)?void a.getDdlAct(l,a.newType):(MsgTip("",common_js_lang["db.info.tableName"],"info"),a.container.find("#tableName").val("").select2({tags:!0}),!1)}})},getParam:function(){var a=this,e=a.container.find("#dbName option:selected");return{dbId:globalParam.connId,name:e.val(),pid:$("#userApp").val(),catalog:e.attr("data-catalog")||"",schema:e.attr("data-schema")||"",tableName:a.container.find("#tableName").val(),sourceparam:JSON.parse($(".sourceCon li.cur").attr("data-sourceparam")),tableType:a.container.find(".tableType").val(),format:a.container.find(".tableType option:selected").text(),lineNum:a.container.find(".lineNum").val(),columnSep:globalParam.columnSep,fieldEnClosed:globalParam.fieldEnClosed}},getTables:function(a){var e=this;$("#globalLoadCon").show(),$.when(globalParam.promiseFunc.getTables(a)).then(function(){$(".infoline.last").hide(),$("#partitions").empty();var t=globalParam.tblModel["tbl_"+a.dbId+"_"+a.catalog+"_"+a.schema],l='<option value="" disabled>'+common_js_lang["local.option.setTbl"]+"</option>";if(t.map(function(a){l+='<option data-name="'+a.name+'">'+a.name+"</option>"}),$("#tableName").html(l),!a.tableName||!a.tableName.match(/^[0-9A-Za-z]\w*$/g))return $("#tableName").val("").select2({tags:!0}),MsgTip("",common_js_lang["db.info.tableName"],"info"),$("#globalLoadCon").hide(),!1;$("#tableName").val(a.tableName).select2({tags:!0}),$("#tableName").val()!=a.tableName&&$("#tableName").append("<option>"+a.tableName+"</option>").val(a.tableName).select2({tags:!0}),a.tableName?a.ddl||a.createSql?$("#globalLoadCon").hide():e.getDdlAct(a,e.newType):(editor.doc.cm.setOption("readOnly","nocursor"),editor.doc.setValue(""),$(".new-sql .CodeMirror").addClass("disabled"),$("#tableName").val("").select2({tags:!0}),$("#globalLoadCon").hide())}).fail(function(){$("#globalLoadCon").hide()})},getDdlAct:function(a,e){var t=this;$("#globalLoadCon").show();var l=$.Deferred();$.when(globalParam.promiseFunc.getDdl(a,e)).then(function(e){if(e.mppTable&&globalParam.targetType==globalParam.commonLinkType.hive)return t.editor.doc.setValue(""),l.reject(),void MsgTip("info",common_js_lang["db.tip.hivexspark"]);if(!e.mppTable&&globalParam.targetType==globalParam.commonLinkType.spark)return t.editor.doc.setValue(""),l.reject(),void MsgTip("info",common_js_lang["db.tip.sparkxhive"]);if(t.editor.doc.setValue(e.ddl),e.isShow){t.editor.doc.cm.setOption("readOnly","nocursor"),t.container.find(".CodeMirror").addClass("disabled");n={text:"0",orc:"1",parquet:"2",rcfile:"3",sequencefile:"4"};t.container.find(".tableType").val(n[e.format]||0).prop("disabled",!0),t.getPart(a.tableName,a.catalog,a.schema,a.partition||"",l)}else{t.editor.doc.cm.setOption("readOnly",!1),t.container.find(".CodeMirror").removeClass("disabled");var n={text:"0",orc:"1",parquet:"2",rcfile:"3",sequencefile:"4"};t.container.find(".tableType").val(n[e.format]||(globalParam.targetType==globalParam.commonLinkType.hive?0:1)).prop("disabled",globalParam.targetType==globalParam.commonLinkType.spark||!1),t.container.find("#partitions").empty(),t.container.find(".hive .infoline.last").hide(),l.resolve()}}).fail(function(){t.container.find("#tableName").val("").select2({tags:!0}),t.editor.doc.setValue(""),t.editor.doc.cm.setOption("readOnly","nocursor"),t.container.find(".CodeMirror").addClass("disabled"),t.container.find(".tableType").val(0).prop("disabled",!0),l.reject()}),$.when(l).always(function(){$("#globalLoadCon").hide()})},getPart:function(a,e,t,l,n){var o=this;$.when(globalParam.promiseFunc.getPart({dbId:globalParam.connId,tableName:a,catalog:e,schema:t})).then(function(a){o.partitionShow(a,l),n&&n.resolve()}).fail(function(){n&&n.reject()})},partitionShow:function(a,e){if($("#partitions").empty(),a&&0!=a.length){if($(".hive .infoline.last").css({display:"block"}),a.map(function(a,e){var t="";t+='<div class="item"><input type="text" class="filedName" value="'+a.name+'" disabled><label>=</label><select class="select2 filedVal selVal" data-type="'+a.name+'" id="Part_level_'+e+'">',a.parts.map(function(a){t+='<option value="'+a.value+'" title="'+a.name+'">'+a.value+"</option>"}),t+=globalParam.columnValOption+"</select></div>",$("#partitions").append(t),$("#partitions #Part_level_"+e).select2({placeholder:"value",tags:!0})}),e){var t=JSON.parse(e);for(k in t)1==$("#partitions").find('[data-type="'+k+'"]').find('[value="'+t[k]+'"]').length?$("#partitions").find('[data-type="'+k+'"]').val(t[k]).trigger("change"):$("#partitions").find('[data-type="'+k+'"]').prepend('<option value="'+t[k]+'">'+t[k]+"</option>").val(t[k]).change()}}else $(".hive .infoline.last").css({display:"none"})}};var hiveModule=new hiveConfigModule({container:$(".hiveCon")});$(".file-btn").on("change","#fileupload",function(a){for(var e=$(this)[0].files?$(this)[0].files:{name:$(this).val().split("\\").slice(-1)[0]},t=!0,l=0,n=e.length;l<n;l++){if($(".file-list tbody tr").length>=5){MsgTip("",common_js_lang["dump.info.limit5"],"info");break}if(-1!=[".csv",".txt"].indexOf(e[l].name.slice(-4).toLowerCase()))if(e[l].size>838860800)MsgTip("",common_js_lang["local.info.csvSize"],"info");else if(e[l].name&&e[l].name.length>60)MsgTip("",common_js_lang["s3.info.fileName100"]);else{var o=new FormData,i=listFile(e[l]);o.append("file",e[l]),globalParam.formDataAjax[i]=$.ajax({url:"job/csv/file/upload",type:"post",data:o,class:i,fileTitle:e[l].name,contentType:!1,processData:!1,xhr:function(){var a=this.class,e=new XMLHttpRequest;return e.upload.addEventListener("progress",function(e){if(e.lengthComputable){var t=parseInt(100*e.loaded/e.total);$(".file-list ."+a+" .process-slider").css({width:t+"%"}),$(".file-list ."+a+" .process-res").html(t+"%"),100==t&&$(".file-list ."+a+" .res").html("<div>"+common_js_lang["local.info.pausing"]+"</div>")}},!1),e},success:function(a){if(200==a.code){var e=this.class,t=this.fileTitle;a.model=a.model.map(function(a,l){return 0==l&&(a.firstTitle=t),a.indexTag=e,a.fileType=t.slice(-4),a}),Array.prototype.push.apply(globalParam.fileTable,a.model),globalParam.fileTableChange=!0,$(".file-list ."+this.class).addClass("uploaded"),$(".file-list ."+this.class+" .res").addClass("ok").html(common_js_lang["local.info.upOver"])}else $(".file-list ."+this.class+" .res").html('<div style="color:red" title="'+a.msg+'">'+common_js_lang["local.info.upFail"]+"</div>")},error:function(){$(".file-list ."+this.class+" .process-slider").animate({width:"100%"},5),$(".file-list ."+this.class+" .process-res").html("100%"),$(".file-list ."+this.class+" .res").addClass("error").html(common_js_lang["local.info.upErr"])}})}else t&&MsgTip({title:"",text:common_js_lang["local.info.csvType"],type:"info",timer:2e3}),t=!1}var s=$(this).clone().val("");$(this).remove(),$(".file-btn").append(s)}),$(".configFilePath").on("click",".del",function(){var a=$(this);swal({title:"",text:common_js_lang["local.info.delFile"],type:"info",showCancelButton:!0},function(){globalParam.fileTableChange=!0;var e=a.parents("tr").attr("class");a.parents("tr").remove(),$(".configFilePath tbody tr").length<=0&&$(".configFilePath tbody").append('<tr><td colspan="5" class="tableNoData"><img src="resources/dist/images/noData.png">'+common_js_lang["manage.title.noData"]+"</td></tr>"),e.indexOf("uploaded")>-1?globalParam.fileTable=globalParam.fileTable.filter(function(a){return-1==e.indexOf(a.indexTag)}):(swal.close(),globalParam.formDataAjax[e].abort())})}),$(".item1").on("click",".nextStep",function(){var a=$(".configTask .taskName").val().trim();$(".configTask .taskDes").val().trim();if(!a)return MsgTip("",common_js_lang["local.info.taskNameNone"],"info"),!1;if($("#userApp").val()||0)if($(".connId").val()||""){if(globalParam.fileTable.length<=0)return MsgTip("",common_js_lang["local.info.tblNone"],"info"),!1;for(var e=$(".file-list tbody tr"),t=0,l=e.length;t<l;t++)if(!e.eq(t).hasClass("uploaded"))return MsgTip("",common_js_lang["local.info.upUncomplete"].replace(/\[x\]/g,"["+(t+1)+"]"),"info"),!1;+$(".configTask #targetType").val()!=globalParam.commonLinkType.hdfs?$(".global-mask, .global-columnSep").fadeIn():configList()}else MsgTip("",common_js_lang["db.info.selectLink"],"info");else MsgTip("",common_js_lang["db.info.selectApp"],"info")});var hoverInterval=0;$(".hiveCon strong").hover(function(){var a=$(this);hoverInterval=setTimeout(function(){a.find(".tip").css({display:"block"})},300)},function(){clearInterval(hoverInterval),$(this).find(".tip").css({display:"none"})}),$.fn.replaceComponent=function(){function a(a,e){e.removeClass("show");for(var t=a,l=e.find(".item").removeClass("cur"),n=!1,o=0,i=l.length;o<i;o++)if(l.eq(o).attr("data-val")==a){t=l.eq(o).text(),n=!0;break}n||(t=""===a.trim()?a.match(/\s/g).length+common_js_lang["db.text.space"]:t),e.find(".val").text(t).attr({"data-val":a,title:a})}var e=$(this);$("body").on("click",".replacementCon .val",function(){var a=$(this).parent();if(1==+a.attr("data-disabled"))return!1;if(a.hasClass("show"))a.removeClass("show");else{for(var e=$(this).attr("data-val")||"",t=a.find(".item").removeClass("cur"),l=!1,n=0,o=t.length;n<o;n++)if(t.eq(n).attr("data-val")==e){t.eq(n).addClass("cur"),l=!0;break}l?a.find(".inputReplacement").val(""):a.find(".inputReplacement").val(e),a.addClass("show")}}),$("body").on("click",".replacementCon .item",function(){$(this).text();return a($(this).attr("data-val")||"",$(this).parents(".replacementCon")),!1}),$("body").on("click",".replacementCon button",function(){var e=$(this).siblings(".inputReplacement").val();return 1==$(this).parents(".replacementCon.fieldEnClosed").length&&1!=e.length?(MsgTip("",common_js_lang["csv.text.fieldEnClosed"]),!1):1==$(this).parents(".replacementCon.columnSep").length&&e.length<=0?(MsgTip("",common_js_lang["csv.text.columnSep"]),!1):(a(e,$(this).parents(".replacementCon")),!1)}),$("body").on("keyup",".replacementCon .inputReplacement",function(e){if(13==e.which){var t=e.target.value;return 1==$(this).parents(".replacementCon.fieldEnClosed").length&&1!=t.length?(MsgTip("",common_js_lang["csv.text.fieldEnClosed"]),!1):1==$(this).parents(".replacementCon.columnSep").length&&t.length<=0?(MsgTip("",common_js_lang["csv.text.columnSep"]),!1):(a(t,$(this).parents(".replacementCon")),!1)}}),$("body").on("click",function(a){e.hasClass("show")&&1!=$(a.target).parents(".replacementCon").length&&1!=$(a.target).parent(".replacementCon").length&&$(a.target)!=e[0]&&e.removeClass("show")})},$(".replacementCon").replaceComponent(),$(".global-columnSep").on("click",".item label",function(){$(this).find(".radio").hasClass("cur")||($(this).parent().find(".radio").removeClass("cur"),"0"==$(this).find(".radio").addClass("cur").attr("data-val")?$(".global-columnSep .item.last").addClass("hidden"):$(".global-columnSep .item.last").removeClass("hidden"))}),$(".global-columnSep").on("click",".btn-item",function(){var a=$(".global-columnSep .columnSep .val").attr("data-val"),e="0"===$(".global-columnSep .isRemained .radio.cur").attr("data-val"),t=$(".global-columnSep .fieldEnClosed .val").attr("data-val").trim();e&&(t=""),a?(a==globalParam.columnSep&&t==globalParam.fieldEnClosed||(globalParam.columnSep=a,globalParam.fieldEnClosed=t,updateCreateSql()),$(".global-mask, .global-columnSep").css({display:"none"}),configList()):MsgTip("",common_js_lang["local.info.setSeq"],"info")}),$(".global-columnSep").on("click",".btn-cancel, .cancel",function(){$(".global-mask, .global-columnSep").css({display:"none"})}),$(".item2").on("click",".prevStep",function(){$(".stepCon").animate({"margin-left":"0"},250,function(){$(".stepCon .item2").hide()}),$(".processCon .itemCon").removeClass("cur").eq(0).addClass("cur"),$(".sourceCon li.cur").click()}),$(".sourceCon").on("click","li:not(.fileTitle)",function(){var a=$(".sourceCon li.cur");1==a.length&&(globalParam.targetType==globalParam.commonLinkType.hdfs?saveHdfsParam(a):saveHiveParam(a)),!$(this).hasClass("cur")&&(globalParam.targetType==globalParam.commonLinkType.hdfs?resetHdfs($(this)):resetHive($(this))),$(this).addClass("cur").siblings().removeClass("cur")}),$("button.upload").on("click",function(){var a=($(".taskName").val()||"").trim(),e=($(".taskDes").val()||"").trim();if(a){var t=$("#userApp").val()||0;if(t){$(this).prop("disabled",!0),$("#globalLoadCon").css({display:"block"});var l={jobName:a,note:e,pid:t,toId:globalParam.connId,fromJson:[],toHiveJson:[],toHdfsJson:[]};if(l.toType=[8,9,13][+globalParam.targetType-1],!(globalParam.targetType==globalParam.commonLinkType.hdfs?saveHdfsParam($(".sourceCon li.cur"),!0):saveHiveParam($(".sourceCon li.cur"),!0)))return $(".upload.btn-item").prop("disabled",!1),$("#globalLoadCon").css({display:"none"}),!1;for(var n=$(".sourceCon li:not(.fileTitle)"),o=n.length,i=!1,s="0"===$(".global-columnSep .isRemained .radio.cur").attr("data-val"),r=$(".global-columnSep .fieldEnClosed .val").attr("data-val").trim(),d=0;d<o;d++){var c=JSON.parse(n.eq(d).attr("data-param")),m=JSON.parse(n.eq(d).attr("data-sourceParam"));if(c.paramRes&&c.paramRes.complete){n.eq(d).removeClass("error");var p={columnSep:globalParam.columnSep,dataLineNo:c.dataLineNo,isRemained:s};!p.isRemained&&r&&(p.fieldEnClosed=r),l.fromJson.push($.extend({},m,p))}else i=!0,n.eq(d).addClass("error")}if(i)return $(".upload.btn-item").prop("disabled",!1),$("#globalLoadCon").css({display:"none"}),void MsgTip("",common_js_lang["file.info.errorConf"],"info");globalParam.hiveParam=[];for(var f=$.Deferred(),g=[],d=0;d<o;d++){var c=JSON.parse(n.eq(d).attr("data-param")),m=JSON.parse(n.eq(d).attr("data-sourceParam"));globalParam.targetType==globalParam.commonLinkType.hdfs?l.toHdfsJson.push({fileName:c.fileName,hid:globalParam.connId}):(c.createSql&&(c.ddl=c.createSql,c.index=d,g.push(c)),globalParam.hiveParam[d]=$.extend({},c))}g.length>=1?createTblBatch({dbId:globalParam.connId,pid:t,tablesJsonStr:JSON.stringify(g)},f):f.resolve(),$.when(f).then(function(){l.fromJson=JSON.stringify(l.fromJson),globalParam.targetType==globalParam.commonLinkType.hdfs?l.toHdfsJson=JSON.stringify(l.toHdfsJson):l.toHiveJson=JSON.stringify(globalParam.hiveParam),$.fn.ajaxAPI({url:"job/csv/save",type:"post",loadTime:0,data:l,contentType:"application/x-www-form-urlencoded",callback:function(a){window.onbeforeunload=function(){},location.href="./success"},complete:function(){$(".upload.btn-item").prop("disabled",!1),$("#globalLoadCon").css({display:"none"})}})}).always(function(){$(".upload.btn-item").prop("disabled",!1),$("#globalLoadCon").css({display:"none"})})}else MsgTip("",common_js_lang["dbManage.title.setApp"],"info")}else MsgTip("",common_js_lang["client.info.taskNameErr"],"info")});