function businessFn(e){function t(){var e={};if(e.flag=!1,e.msg="",""==$(".taskName").val())return e.flag=!0,e.msg=common_js_lang["local.info.taskNameNone"],e;if(!$("#userApp").val())return e.flag=!0,e.msg=common_js_lang["s3.info.noneApp"],e;if(!$(".linkList").val()&&1==$(".connType").val())return e.flag=!0,e.msg=common_js_lang["ftp.info.srcLink"],e;if(2==$(".connType").val()){var t=$(".choose-link").find('[data-key="host"]').val().trim(),a=$(".choose-link").find('[data-key="port"]').val().trim(),i=($(".choose-link").find('[data-key="protocol"]').val()||"").trim(),n=$(".choose-link").find('[data-key="userName"]').val().trim(),o=$(".choose-link").find('[data-key="password"]').val().trim();if(!t)return e.flag=!0,e.msg=common_js_lang["ftp.info.host"],e;if(!a||!a.match(/^[1-9]\d*$/g))return e.flag=!0,e.msg=common_js_lang["ftp.info.port"],e;if(!i)return e.flag=!0,e.msg=common_js_lang["ftp.info.protocol"],e;if(!n)return e.flag=!0,e.msg=common_js_lang["ftp.info.userName"],e;if(!o)return e.flag=!0,e.msg=common_js_lang["ftp.info.pwd"],e}return $("#connId").val()||(e.flag=!0,e.msg=common_js_lang["db.info.tarConn"]),e}function a(e){var t=$("#userApp").val(),a=globalParam.commonLinkType.hdfs,i="db/list",n="";a==globalParam.commonLinkType.hdfs?i="hdfs/list":n=4,t&&$.ajax({url:i+"?pid="+t+"&groups="+n,success:function(t){var i='<option value="" disabled>'+common_js_lang["db.info.selectLink"]+"</option>";a==globalParam.commonLinkType.hdfs?adminConfigData.hdfs.id&&(i+='<option value="'+adminConfigData.hdfs.id+'">'+adminConfigData.hdfs.connName+"</option>"):adminConfigData.hive.id&&(i+='<option value="'+adminConfigData.hive.id+'">'+adminConfigData.hive.connName+"</option>"),t.model.data.map(function(e){i+='<option value="'+e.id+'">'+e.connName+"</option>"}),$("#connId").html(i).val(e||"").select2()}}).fail(function(){$("#connId").html("")})}function i(e,t,a,i,n,o,s){var r=setTimeout(function(){$(".delayTip").show()},2e3);s.prop("disabled",!0),$.ajax({url:"repo/ftp/files",type:"post",data:{ftpId:e,dir:t},success:function(e){if(-1!=e.code&&200!=e.code)ErrTip(e.i18nMsg.title,e.i18nMsg.detail,e.msg);else if(200==e.code){e.model.sort(function(e,t){return e.directory!=t.directory?e.directory-t.directory:e.name.toLowerCase()>t.name.toLowerCase()?1:-1}),s.parent().attr("response","ok"),s.hide(),o.show();var t={};t.field=a,t.preIndent=n,t.model=e.model;var r=+(s.parent().css("padding-left").slice(0,-2)||0)+18,l=template("template/child",{data:t,pad:r});i.map(function(e,t){$(t).find(".childUl").length>0||$(t).append(l).find(".childUl").hide()}),s.parent().siblings(".childUl").slideDown(),$(".uploadFile").hide(),$(".choiceRoute").show()}else-1==e.code&&k.ajaxFail()},complete:function(){s.prop("disabled",!1),clearTimeout(r),$(".delayTip").hide()}})}function n(e){if(!$("#userApp").val())return!1;$.ajax({url:"repo/ftp/list",data:{pageNo:1,pageSize:1e3,pid:$("#userApp").val()},beforeSend:function(){$(".delayTip").show()},success:function(t){t.model.data=t.model.data.map(function(e){return e.val=JSON.stringify(e),e});var a='<option value="" disabled>'+common_js_lang["db.info.dbLinkErr"]+"</option>";a+=template("template/sourceLink",{data:t.model.data}),$(".source .linkList").html(a).val("").select2();try{-1!=e.fromObject.delFlg?$(".source .linkList").val(e.fromId).change():($(".uploadFile .source .connType").val(2),$(".uploadFile .source .type1show").hide(),$(".uploadFile .source .type2show").show(),["host","port","protocol","userName","password","connName"].map(function(t){$(".uploadFile .source").find('[data-key="'+t+'"]').val(e.fromObject[t]).prop("disabled",!0)}))}catch(e){}},complete:function(){$(".delayTip").hide()}})}function o(){var e=[];return 1==$(".confType .radio.cur").attr("data-val")?$(".mapRange .leftZone .oneDataLi.tabcheck, .oneResult.tabcheck").each(function(){var t=$(this),a=!0;if($('.hdfsTr .hdfsMap[path="'+$(this).find(".aTabName").attr("path")+'"]').length>0&&(a=!1),a){var i={};t.hasClass("oneTabLi")?(i.fileName=t.children(".oneResult").children(".aTabName").html(),i.path=t.children(".oneResult").children(".aTabName").attr("path"),i.size=t.children(".oneResult").children(".tabSize").attr("size"),i.field=t.attr("field"),i.directory=0):(i.fileName=t.find(".aDbName").attr("path"),i.path=t.find(".aDbName").attr("path"),i.size=t.find(".aDbName").attr("size"),i.field=t.parent().attr("field"),i.directory=1),e.push(i)}}):$(".mapRange .leftZone .oneResult.tabcheck").each(function(){var t=$(this),a=!0;if($('.hdfsTr .hdfsMap[path="'+$(this).find(".aDbName").attr("path")+'"]').length>0&&(a=!1),a){var i={},n=t.find(".aDbName");i.fileName=n.text(),i.path=n.attr("path"),i.size=n.attr("size"),i.field=t.parent().attr("field"),e.push(i)}}),$(".mapRange .dbZone .oneResult.tabcheck, .mapRange .dbZone .oneTabLi.tabcheck").removeClass("tabcheck"),e}function s(){var e=!1;return $(".tabCheckOne").each(function(){$(this).prop("checked")&&(e=!0)}),e}function r(){s()?($(".hdfsBox,.maskCell").show(),2==$(".confType .radio.cur").attr("data-val")?($(".matchCon .abView").hide(),$(".matchCon .matchExp").val(""),$(".matchCon .srcPath").hide(),$(".matchCon .srcSet .radio").removeClass("cur").eq(0).addClass("cur"),$(".matchCon .srcSet .moveDir").val("").attr("title",""),$(".matchCon .leftZone").hide(),$(".mathRoute .tarFileName .radio").removeClass("cur").eq(0).addClass("cur"),$(".mathRoute .tarFileName .suffix").val(1),$(".mathRoute .tarRename .radio").removeClass("cur").eq(0).addClass("cur"),$(".hdfsBox .routeShow .suffixShow, .hdfsBox .routeShow .sameNameAct").hide()):($(".hdfsBox .suffixShow").hide(),$(".hdfsBox .routeShow .sameNameAct").show()),$(".keep").attr("field","all"),$(".routeLabel").each(function(){$(this).removeClass("rCheckIcon").children("input").prop("checked",!1)}),$(".defaultRoute").val("").attr("title","")):MsgTip("",common_js_lang["dump.info.selectTask"],"info")}function l(){if(2!=$(".confType .radio.cur").attr("data-val")){var e=$(".defaultRoute").val(),t=$(".sameNameAct .radio.cur").attr("data-val");""!=e?$.ajax({url:"hdfs/dir/access",data:{hdfsId:$("#connId").val(),dir:e,pid:$("#userApp").val()},success:function(a){-1!=a.code?200==a.code?("/"==e&&(e=""),$(".hdfsMap").each(function(){if($(this).parent().children().eq(0).children("label").children(".tabCheckOne").prop("checked")){var a=$(this).siblings(".hdfs").children(".parseName").html(),i="";a=a.slice(0,60),i=(e+"/"+a).replace(/\/+/g,"/"),$(this).html(i).attr("title",i).attr({route:$(".defaultRoute").val(),file:a,tarFileHandleType:t}).parents(".hdfsTr").find(".checkStatus .tabCheckOne").click()}}),$(".maskCell,.hdfsBox").hide(),$(".defaultRoute").val("").attr("title","")):ErrTip(a.i18nMsg.title,a.i18nMsg.detail,a.msg):k.ajaxFail()}}):MsgTip("",common_js_lang["db.info.batchDir"],"info")}else d()}function c(){var e={},t={};if(e.pathPattern=$(".matchCon .matchExp").val().trim(),e.srcFileHandleType=$(".matchCon .srcSet .radio.cur").attr("data-val"),e.srcFileMoveDir=4==e.srcFileHandleType?$(".matchCon .srcSet .moveDir").val().trim():"",""==e.pathPattern)return MsgTip("",common_js_lang["ftp.info.enterPattern"],"info"),!1;try{new RegExp(e.pathPattern)}catch(e){return MsgTip("",common_js_lang["client.info.regularErr"],"info"),!1}if(4==e.srcFileHandleType&&""==e.srcFileMoveDir)return MsgTip("",common_js_lang["ftp.info.moveDir"],"info"),!1;var a=$(".mathRoute .defaultRoute").val();return""===a?(MsgTip("",common_js_lang["ftp.info.tarDir"],"info"),!1):(e.recursive=2==$(".viewMatchType .radio.cur").data("val"),e.tarRenameType=$(".mathRoute .tarFileName .radio.cur").attr("data-val"),e.tarRenameFormat=3==e.tarRenameType?$(".mathRoute .tarFileName .suffix").val():"",t.tarFileHandleType=$(".mathRoute .tarRename .radio.cur").attr("data-val"),{source:e,target:t,route:a})}function d(){var e=c();if(e){var t=e.source,a=e.target,i=e.route;$.ajax({url:"hdfs/dir/access",data:{hdfsId:$("#connId").val(),dir:i,pid:$("#userApp").val()},success:function(e){-1!=e.code?200==e.code?($(".checkOneLab.checkStatus").each(function(e,n){var o=$(this).parents(".hdfsTr"),s=o.find(".matchExp"),r=o.find(".hdfsMap");s.html(t.pathPattern),r.html(i).attr("title",i).attr("route",i).attr("data-source",JSON.stringify(t)).attr("data-target",JSON.stringify(a)),$(n).find(".tabCheckOne").click()}),$(".maskCell,.hdfsBox").hide(),$(".defaultRoute").val("")):ErrTip(e.i18nMsg.title,e.i18nMsg.detail,e.msg):k.ajaxFail()}})}}function h(){var e=c();if(e){var t=e.source,a=e.target,i=e.route;$.ajax({url:"hdfs/dir/access",data:{hdfsId:$("#connId").val(),dir:i,pid:$("#userApp").val()},success:function(e){if(-1!=e.code)if(200==e.code){var n=$(".keep").attr("num"),o=$('.createTab .hdfsTr[field="'+n+'"]');o.find(".hdfsMap").attr("data-source",JSON.stringify(t)).attr("data-target",JSON.stringify(a)).attr({route:i,title:i}).html(i),o.find(".matchExp").html(t.pathPattern),$(".maskCell,.hdfsBox").hide(),$(".suffixRoute").val("")}else ErrTip(e.i18nMsg.title,e.i18nMsg.detail,e.msg);else k.ajaxFail()}})}}function f(){if(2!=$(".confType .radio.cur").attr("data-val"))if($(".defaultRoute").val()&&$(".suffixRoute").val().trim()&&"OK"==$(".suffixRoute").attr("name")){if($(".suffixRoute").val().trim().match(/\s+/g))return MsgTip("",common_js_lang["local.info.fileName"],"info"),!1;if($(".suffixRoute").val().trim().match(/\\/g))return MsgTip("",common_js_lang["local.info.fileName"],"info"),!1;var e=$(".suffixRoute").val().trim();e=e.slice(0,60),$.ajax({url:"hdfs/dir/access",data:{hdfsId:$("#connId").val(),dir:$(".defaultRoute").val(),pid:$("#userApp").val()},success:function(t){if(-1!=t.code)if(200==t.code){var a=$(".keep").attr("num");if("/"!==$(".defaultRoute").val())i=$(".defaultRoute").val()+"/"+e;else var i="/"+e;i=i.replace(/\/+/g,"/");var n=$(".sameNameAct .radio.cur").attr("data-val");$(".newTr").each(function(){$(this).attr("field")==a&&($(this).children(".hdfsMap").html(i).attr("title",i),$(this).children(".hdfsMap").attr({route:$(".defaultRoute").val(),file:e,tarFileHandleType:n}),$(".maskCell,.hdfsBox").hide(),$(".defaultRoute").val("").attr("title",""),$(".suffixRoute").val(""))})}else ErrTip(t.i18nMsg.title,t.i18nMsg.detail,t.msg);else k.ajaxFail()}})}else $(".defaultRoute").val()&&$(".suffixRoute").val().trim()&&"NO"==$(".suffixRoute").attr("name")?MsgTip("",common_js_lang["local.info.fileName"],"info"):""!=$(".defaultRoute").val()&&""!=$(".suffixRoute").val()||MsgTip("",common_js_lang["s3.info.dir"],"info");else h()}function p(e,t,a,i){var n=setTimeout(function(){$(".delayTip").show()},2e3);$.ajax({url:"hdfs/dir/list",data:{hid:e,base:a,pid:$("#userApp").val()},success:function(e){if(-1!=e.code)if(200==e.code)if(t.addClass("got"),e.model.length){t.children(".turnOn").show(),t.children(".turnOff").hide();for(var i=e.model,n=$("<ul class='allMeun'></ul>"),o=a.length,s=0;s<i.length;s++){var r=$("<li class='newRoute'><label class='routeLabel'><input type='checkbox' class='routeChoiceBtn' name='route'/></label><h5 class='oneRoute' data-base='"+i[s]+"'><img class='turnOn' src='resources/images/routeOn.png'/><img class='turnOff' src='resources/images/routeOff.png'/><span class='thisRoute' title='"+i[s].slice(o)+"'>"+i[s].slice(o)+"</span></h5></li>");r.css("padding-left","20px"),n.append(r)}if(r&&r.length>0&&t.parent().siblings().length<=1){$('.menuZone .oneRoute[data-base="'+a+'"]').parent().append(n);var l=$('.menuZone .oneRoute[data-base="'+a+'"]').find(".turnOff");t.attr("field")?l.hide().siblings(".turnOn").show():t.parent().siblings().length>0?l.hide().siblings(".turnOn").show():l.hide().siblings(".turnOn").hide()}}else(l=$('.menuZone .oneRoute[data-base="'+a+'"]').find(".turnOff")).parent().attr("status","ok"),l.hide(),l.siblings(".turnOn").hide();else ErrTip(e.i18nMsg.title,e.i18nMsg.detail,e.msg);else k.ajaxFail()},complete:function(){t.removeClass("got"),clearTimeout(n),$(".delayTip").hide()}})}function u(e){$.ajax({url:"job/ftp/save",type:"post",data:e,beforeSend:function(){$(".delayTip").show()},success:function(e){200==e.code?(window.onbeforeunload=function(){},location.href="./success"):-1==e.code?k.ajaxFail():ErrTip(e.i18nMsg.title,e.i18nMsg.detail,e.msg)},complete:function(){$(".delayTip").hide()}})}if(e){if($(".configTask .taskName").val(e.jobName),$(".configTask .taskDes").val(e.note),$("#userApp").val(e.pid).select2(),e.fromList[0].usePattern){$(".confType .radio").removeClass("cur").eq(1).addClass("cur"),$(".leftZone .dbZone .oneDataLi.tabcheck").removeClass("tabcheck"),$(".dbZone").addClass("dir"),$(".headTitltTwo .type_2").show(),$(".headTitltTwo .type_1").hide(),$(".hdfsBox .matchCon, .hdfsBox .tarDir").show();m=[];e.fromList.map(function(t,a){t.tarRenameFormat=["","_yyyyMMdd","_yyyyMMdd_HHmmss"].indexOf(t.tarRenameFormat),m.push({filePath:t.filePath,size:t.size,fileName:e.toList[a].fileName,pathPattern:t.pathPattern,source:JSON.stringify(t),target:JSON.stringify(e.toList[a])})}),$(".addContentZone .createTab").html(template("template/configList",{data:m,type:2}))}else{var m=[];e.fromList.map(function(t,a){m.push({filePath:t.filePath,size:t.size,fileName:e.toList[a].fileName,directory:1==t.directory?1:0,tarFileHandleType:e.toList[a].tarFileHandleType})}),$(".addContentZone .createTab").html(template("template/configList",{data:m,type:1}))}var v={cronParam:e.cronExpression,startTime:e.startTime,endTime:e.endTime};cronExport.resetCron(v),$("#userApp, .uploadFile .connType, .uploadFile .linkList, .uploadFile .connId").prop("disabled",!0)}var g={},b=!0,k=($("#userApp").val(),{ajaxFail:function(){return swal({title:"",text:common_js_lang["manage.info.timeout"],type:"info",showCancelButton:!0,confirmButtonText:common_js_lang["manage.info.newdow"],cancelButtonText:common_js_lang["manage.info.tologin"]},function(e){e?window.open("./","_blank"):location.href="./"}),!1}});template.helper("fileSize",function(e){return e<1024?(e||0)+"bytes":e<1048576?(e/1024).toFixed(2)+"KB":(e/1024/1024).toFixed(2)+"MB"}),a(e.toId||0),$(".returnRoot").on("click",function(){var e=$(".linkList").val(),t=$(this);$(".delayTip").show(),$.when(function(e){var t=$.Deferred();return $.ajax({url:"repo/ftp/files",type:"post",data:{ftpId:e,dir:"/"},success:function(e){if(200!=e.code)return t.reject(),void ErrTip(e.i18nMsg.title,e.i18nMsg.detail,e.msg);t.resolve(e)},error:function(){t.reject()}}),t.promise()}(e)).then(function(e){e.model.sort(function(e,t){return e.directory!=t.directory?e.directory-t.directory:e.name.toLowerCase()>t.name.toLowerCase()?1:-1}),e.field=0,t.siblings(".dbZone").html(template("template/child",{data:e,pad:0})),t.parents(".mapRange").length&&($(".addContentZone .createTab").empty(),$(".checkAllLab").removeClass("checkStatus").children("input").attr("checked",!1))}).always(function(){$(".delayTip").hide()})}),$("#connId").change(function(){var e=$(this).val();g.connId=e}),$("#userApp").change(function(){a(),n();var e=$(".uploadFile .choose-link");1==e.find(".connType").val()&&["host","port","protocol","userName","password"].map(function(t){e.find('[data-key="'+t+'"]').val("")})}),n(e||0),$(".uploadFile").on("change",".linkList",function(){if(!$(this).val())return!1;var e=JSON.parse($(this).find("option:selected").attr("data-val")),t=$(this).parents(".choose-link");t.find('[data-key="protocol"]').val(e.protocol),t.find('[data-key="host"]').val(e.host),t.find('[data-key="port"]').val(e.port),t.find('[data-key="userName"]').val(e.userName),t.find('[data-key="password"]').val(e.password)}),$(".uploadFile").on("change",".connType",function(){1==$(this).val()?($(".uploadFile .source .type1show").show(),$(".uploadFile .source .type2show").hide(),$('.uploadFile .source input, select[data-key="protocol"]').prop("disabled",!0).val("").removeClass("error"),$(".source .linkList").select2()):($(".uploadFile .source .linkList").val("").select2(),$(".uploadFile .source .type1show").hide(),$('select[data-key="protocol"] .empty').remove(),$('.uploadFile .source input, select[data-key="protocol"]').prop("disabled",!1).val("").removeClass("error"),$(".uploadFile .source .type2show").show().find("input").prop("disabled",!0))}),$(".choose-link").on("blur","input,select",function(){var e=$(this).val().trim();if(""===e||"port"==$(this).attr("data-key")&&!e.match(/^[1-9]\d*$/g))$(this).addClass("error");else if($(this).removeClass("error"),["host","port"].indexOf($(this).attr("data-key"))){var t={};["host","port"].map(function(e){t[e]=$(".choose-link").find('[data-key="'+e+'"]').val().trim()}),$(".choose-link").find('[data-key="connName"]').val("TMP_"+t.host+"_"+t.port)}}),$(".testRes").on("click",".showTip",function(){var e=JSON.parse(decodeURIComponent($(this).attr("data-info")));ErrTip(e.i18nMsg.title,e.i18nMsg.detail,e.msg)}),$(".connType, .linkList").change(function(){var e=$(this).parents(".source");0==e.length&&(e=$(this).parents(".upload-type")),e.find(".testRes").empty()}),$(".testConnect").on("click",function(){var t=$(this).parent();if(t.find(".testRes").empty(),1==$(".connType").val()){if(!$(".linkList").val())return void MsgTip("",common_js_lang["db.info.selectSavedLink"],"info");try{var a=JSON.parse($(".linkList option:selected").attr("data-val"))}catch(e){return}$(".delayTip").show(),$.ajax({url:"repo/ftp/connect",type:"post",data:a,success:function(e){200==e.code?t.find(".testRes").removeClass("err").addClass("right").html('<i class="suc"></i>'+common_js_lang["db.text.testSuc"]):t.find(".testRes").removeClass("right").addClass("err").html('<i class="fail"></i>'+common_js_lang["db.text.testFail"]+'<a class="showTip" data-info='+encodeURIComponent(JSON.stringify(e))+">"+common_js_lang["db.text.errTip"]+"</a>")},complete:function(){$(".delayTip").hide()}})}else{var i=$(".choose-link.source"),n={},o=!0;if(n.pid=$("#userApp").val(),n.delFlg=-1,["host","port","protocol","userName","password","connName"].map(function(e){n[e]=(i.find('[data-key="'+e+'"]').val()||"").trim(),""===n[e]?(i.find('[data-key="'+e+'"]').addClass("error"),o=!1):"port"!==e||n[e].match(/^\d+$/g)?i.find('[data-key="'+e+'"]').removeClass("error"):(i.find('[data-key="'+e+'"]').addClass("error"),o=!1)}),!o)return void MsgTip("",common_js_lang["db.info.completeParam"],"info");e&&(n.oldpwd=n.password),$(".delayTip").show(),$.ajax({url:"repo/ftp/connect",type:"post",data:n,success:function(e){200==e.code?t.find(".testRes").removeClass("err").addClass("right").html('<i class="suc"></i>'+common_js_lang["db.text.testSuc"]):t.find(".testRes").removeClass("right").addClass("err").html('<i class="fail"></i>'+common_js_lang["db.text.testFail"]+'<a class="showTip" data-info='+encodeURIComponent(JSON.stringify(e))+">"+common_js_lang["db.text.errTip"]+"</a>")},complete:function(){$(".delayTip").hide()}})}}),$(".confType").on("click","label",function(){function e(){$(".confType .radio").removeClass("cur"),t.find(".radio").addClass("cur"),$(".createTab").empty(),$(".checkAllLab.checkStatus").removeClass("checkStatus"),1==$(".confType").find(".radio.cur").attr("data-val")?($(".mapRange .leftZone .dbZone .oneResult.tabcheck").removeClass("tabcheck"),$(".dbZone").removeClass("dir"),$(".headTitltTwo .type_1").show(),$(".headTitltTwo .type_2").hide(),$(".hdfsBox .matchCon, .hdfsBox .tarDir").hide(),$(".hdfsBox .routeShow .suffixShow, .hdfsBox .routeShow .sameNameAct").show()):($(".mapRange .leftZone .dbZone .oneDataLi.tabcheck, .mapRange .leftZone .dbZone .oneResult.tabcheck").removeClass("tabcheck"),$(".dbZone").addClass("dir"),$(".headTitltTwo .type_2").show(),$(".headTitltTwo .type_1").hide(),$(".hdfsBox .matchCon, .hdfsBox .tarDir").show(),$(".hdfsBox .routeShow .suffixShow, .hdfsBox .routeShow .sameNameAct").hide())}if(1!=$(this).find(".radio.cur").length){var t=$(this);return $(".createTab tr").length>0?swal({title:"",text:common_js_lang["db.option.mtype"],type:"info",showCancelButton:!0},function(t){t&&e()}):e(),!1}}),$("body").on("click",".oneDataLi",function(){var e=$(".confType .radio.cur").attr("data-val");if(1==e)$(this).hasClass("oneTabLi")?$(this).toggleClass("tabcheck"):$(this).find(">.oneResult").toggleClass("tabcheck");else if(2==e&&!$(this).hasClass("oneTabLi"))if($(this).parents(".dbZone").hasClass("directory"))$(this).parents(".dbZone").find(".oneResult.tabcheck").removeClass("tabcheck"),$(this).find(">.oneResult").addClass("tabcheck"),$(".srcSet .moveDir").val($(this).find(">.oneResult .aDbName").attr("path"));else if($(this).parents(".matchCon").length>0){$(this).parents(".dbZone").find(".oneResult.tabcheck").removeClass("tabcheck"),$(this).find(">.oneResult").addClass("tabcheck");var t=$(this).find(">.oneResult").addClass("tabcheck").find(".aDbName").attr("path");$(this).parents(".matchCon").find(".srcSet .moveDir").val(t).attr("title",t)}else $(this).find(">.oneResult").toggleClass("tabcheck");return!1}),$(".FileNext").click(function(){if(t().flag)MsgTip("",t().msg,"info");else{var a=$.Deferred(),i=$.Deferred();$(".delayTip").show(),function(){function t(t,a){$.ajax({url:"repo/ftp/home",type:"post",data:{ftpId:t},success:function(i){if(200!=i.code)return a.reject(),void ErrTip(i.i18nMsg.title,i.i18nMsg.detail,i.msg);$(".leftZone .dbZone").html(template("template/sMeun",{data:i.model})),g.sourceId=t,a.resolve(),e.toId||$(".addContentZone .createTab").empty(),$(".checkAllLab").removeClass("checkStatus").children("input").attr("checked",!1)},error:function(){a.reject()}})}var i=$(".connType").val();if(g.sourceId!=$(".linkList").val()&&1==i)t($(".linkList").val(),a);else if(2==i){var n=$(".choose-link.source"),o={},s=!0;if(o.pid=$("#userApp").val(),o.delFlg=-1,["host","port","protocol","userName","password","connName"].map(function(e){o[e]=n.find('[data-key="'+e+'"]').val().trim(),""===o[e]?(n.find('[data-key="'+e+'"]').addClass("error"),s=!1):"port"!==e||o[e].match(/^\d+$/g)?n.find('[data-key="'+e+'"]').removeClass("error"):(n.find('[data-key="'+e+'"]').addClass("error"),s=!1)}),!s)return;JSON.stringify(o)!==g.tmpData?$.when(function(e){var t=$.Deferred();return $.ajax({url:"repo/ftp/save",type:"post",data:e,success:function(a){return-1==a.code?(t.reject(),void k.ajaxFail()):200!=a.code?(t.reject(),void ErrTip(a.i18nMsg.title,a.i18nMsg.detail,a.msg)):(t.resolve(a.model.id),void(g.tmpData=JSON.stringify(e)))},error:function(){t.reject()}}),t.promise()}(o)).done(function(e){t(e,a)}).fail(function(){a.reject()}):a.resolve()}else a.resolve()}(),function(){g.targetId!=$(".connId").val()?function(t){$.ajax({url:"hdfs/dir/home",data:{hid:$("#connId").val(),pid:$("#userApp").val()},success:function(a){if(200!=a.code)return t.reject(),void ErrTip(a.i18nMsg.title,a.i18nMsg.detail,a.msg);$(".thisRoute.startThis").html(a.model).attr("title",a.model).parent().attr("data-base",a.model),$(".firstM .startLi").children(".allMeun")&&$(".firstM .startLi").children(".allMeun").remove(),t.resolve(),g.targetId=$(".connId").val(),e.toId||$(".addContentZone .createTab").empty(),$(".checkAllLab").removeClass("checkStatus").children("input").attr("checked",!1)}})}(i):i.resolve()}(),$.when(a,i).done(function(){$(".uploadFile").hide(),$(".choiceRoute").show()}).always(function(){$(".delayTip").hide()})}}),$(".prevBtn").click(function(){var e=$(this).parents(".upload-tab").index();$(this).parents(".upload-tab").hide(),$(".upload-tab").eq(e-1).show(),1==e&&(g.ip=$(".ipSite").val(),g.port=$(".portVal").val(),g.username=$(".userName").val(),g.password=$(".password").val(),b=!0)}),$(".nextStep").on("click",function(){if($(".tabCheckOne").length<=0)return MsgTip("",common_js_lang["db.info.confTar"],"info"),!1;var e=!1;$(".tabCheckOne").each(function(){""==$(this).parents(".hdfsTr").find(".hdfsMap").html()&&(e=!0)}),e?MsgTip("",common_js_lang["s3.info.configParam"],"info"):($(".upload-tab.choiceRoute").hide(),$(".upload-tab.importRule").show())}),$("body").on("click",".slideUp",function(){if($(this).parent(".oneResult").siblings(".childUl").length)$(this).parent(".oneResult").siblings(".childUl").slideDown(),$(this).hide().siblings(".slideDown").show();else{var e=$(".linkList").val(),t=$(this).siblings(".aDbName").attr("path");i(e,t,$(this).parent().parent(".oneDataLi").attr("field"),$('[path="'+t+'"]').parent().parent(),parseInt($(this).parent().parent(".oneDataLi").css("padding-left"))+18,$(this).siblings(".slideDown"),$(this))}return!1}),$("body").on("click",".slideDown",function(){return $(this).hide().siblings(".slideUp").show(),$(this).parent(".oneResult").siblings(".childUl").slideUp(),!1}),$("#pointRight").on("click",function(){var e=$(".confType .radio.cur").attr("data-val"),t=o();if(!(t.length+$(".newTr").length<=1e3)&&$(".newTr"))return MsgTip("",common_js_lang["s3.info.limit1000"].replace(/\[x\]/,"["+t.length+"]").replace(/\[y\]/,"["+$(".newTr").length+"]"),"info"),!1;if(t.length&&($(".hdfsTable .createTab").append(template("template/hdfsTr",{data:t,type:e})),$(".tabCheckAll").prop("checked",!1).parent("label").removeClass("checkStatus")),"Microsoft Internet Explorer"==navigator.appName&&"9."==navigator.appVersion.match(/9./i)){window.screen.width;$(".createTab").each(function(){$(this).children(".newTr").each(function(){$(this).children().eq(0).css("width","6%"),$(this).children().eq(3).css("text-align","center"),$(this).children().eq(1).children(".parseName").css("max-width","100px")})})}}),$("#pointLeft").click(function(){$(".tabCheckOne").each(function(){$(this).prop("checked")&&($(this).parent().parent().parent().parent().children().length,$(this).parent().parent().parent().remove(),0==$(".newTr").length&&($(".tabCheckAll").prop("checked",!1),$(".tabCheckAll").parent("label").removeClass("checkStatus")))})}),$(".allConfigure").click(function(){0==$(".addContentZone").children().length?MsgTip("",common_js_lang["s3.info.noneConfig"],"info"):1==$("#uploadSite").val()||r()}),$("body").on("click",".oneConfigure",function(){$(".keep").attr({num:$(this).parent().parent().attr("field"),field:"one"}),$(".suffixRoute").attr("name","OK");var e=$(this).parent().siblings(".hdfsMap").attr("directory")||"",t=$(this).parent().siblings(".hdfsMap").attr("route")||"";if($(".routeLabel").removeClass("rCheckIcon").find("input").prop("checked",!1),$('.mathRoute .allMeun .oneRoute[data-base="'+t+'"]').siblings(".routeLabel").addClass("rCheckIcon").find("input").prop("checked",!0),$(".defaultRoute").val(t).attr("title",t),$(".suffixShow .optionTitle").hide(),"1"==e?$(".suffixShow .optionTitle.title2").show():$(".suffixShow .optionTitle.title1").show(),1==$(".confType .radio.cur").attr("data-val")){$(".hdfsBox .routeShow .suffixShow, .hdfsBox .routeShow .sameNameAct").show(),$(".hdfsBox,.maskCell").show(),$(".hdfsBox .suffixShow").show();var a=$(this).parent().siblings(".hdfsMap").attr("file"),i=$(this).parent().siblings(".hdfsMap").attr("tarFileHandleType")||4;$('.sameNameAct .radio[data-val="'+i+'"]').click(),a?$(".suffixRoute").val(a):$(".suffixRoute").val($(this).parent().siblings(".hdfs").children(".parseName").html().substr(0,99))}else{$(".hdfsBox .routeShow .suffixShow, .hdfsBox .routeShow .sameNameAct").hide(),$(".matchCon .abView").hide(),$(".hdfsBox,.maskCell").show(),$(".matchCon .srcPath").show();var n=$(this).parent().siblings(".hdfsMap"),o=n.attr("path"),s=n.attr("data-source")?JSON.parse(n.attr("data-source")):"",r=n.attr("data-target")?JSON.parse(n.attr("data-target")):"";$(".matchCon .srcPath .path").html(o),$(".matchCon .matchExp").val(s.pathPattern||""),$(".matchCon .srcSet .radio").removeClass("cur").eq(s.srcFileHandleType?1==s.srcFileHandleType?0:1:0).addClass("cur"),$(".matchCon .leftZone").hide(),4==s.srcFileHandleType&&($(".matchCon .leftZone").show(),$('.matchCon .leftZone [path="'+s.srcFileMoveDir+'"]').parent().parent().click()),$(".matchCon .srcSet .moveDir").val(s.srcFileMoveDir||"").attr("title",s.srcFileMoveDir||""),$(".viewMatchType .radio").removeClass("cur").eq(+s.recursive||0).addClass("cur"),$(".mathRoute .tarFileName .radio").removeClass("cur").eq(3==s.tarRenameType?1:0).addClass("cur"),$(".mathRoute .tarFileName .suffix").val(s.tarRenameFormat||1);var l=+r.tarFileHandleType||4;$(".mathRoute .tarRename .radio").removeClass("cur"),$('.mathRoute .tarRename .radio[data-val="'+l+'"]').addClass("cur")}}),$(".suffixRoute").blur(function(){var e=$(this).val().trim();if(e.match(/\s+/g)||e.match(/\\/g))return $(".suffixRoute").addClass("redWord"),!1;$(".suffixRoute").removeClass("redWord")}),$(".keep").on("click",function(){"all"==$(this).attr("field")?0==$("#uploadSite").val()&&l():0==$("#uploadSite").val()&&f()}),$(".srcSet, .tarDir, .viewMatchType, .sameNameAct").on("click","label",function(){if(1==$(this).find(".radio.cur").length)return!1;$(this).parent().find(".radio.cur").removeClass("cur"),$(this).find(".radio").addClass("cur"),1==$(this).find(".moveDir").length?$(".matchMainCon .leftZone").show():1==$(this).parents(".srcSet").length&&$(".matchMainCon .leftZone").hide()}),$(".preView").on("click",function(){var e=$(".matchCon .matchExp").val(),t=2==$(".matchCon .viewMatchType .radio.cur").data("val"),a=$(".srcPath .path").text()||"";if("all"===$(".keep").attr("field")){var i=[];$(".createTab .checkOneLab.checkStatus").map(function(e,t){i.push($(t).parents(".hdfsTr").find(".hdfs span").attr("title"))}),a=i.join(",")}if(!e)return MsgTip("",common_js_lang["ftp.info.enterPattern"],"info"),!1;var n=$(this),o={dir:a,pattern:e,ftpId:g.sourceId,recursive:t,type:1};if(n.attr("data-tag")!==JSON.stringify(o)){var s=setTimeout(function(){$(".delayTip").show()},2e3);$.ajax({url:"repo/ftp/files",data:o,success:function(e){if(200==e.code){var t=[],a={dir:"",data:[]},i=e.model.length;e.model.map(function(e,n){if(e.directory)n==i-1&&""!=a.dir&&t.push(a);else{var o=e.path.split("/"),s=o.slice(0,-1).join("/"),r=o.slice(-1).join("/");s!=a.dir&&(a.dir&&(t.push(a),a={dir:"",data:[]}),a.dir=s,a.data=[]),a.data.push(r),n==i-1&&""!=a.dir&&t.push(a)}}),n.attr("data-tag",JSON.stringify(o)),$(".matchCon .abView").html(template("template/preView",{data:t})).show()}else ErrTip(e.i18nMsg.title,e.i18nMsg.detail,e.msg)},complete:function(){clearTimeout(s),$(".delayTip").hide()}})}else $(".matchCon .abView").show()}),$(".abView").on("click",".main h4",function(){var e=$(this).attr("data-index");$('.fileList[data-index="'+e+'"]').slideToggle(),$(this).find(".toggle").html("-"==$(this).find(".toggle").html()?"+":"-")}),$(".abView").on("click",".head .cancel",function(){$(".abView").hide()}),$("body").on("click",".turnOn",function(){var e=$(this);e.hide().siblings(".turnOff").show(),e.parent().siblings(".allMeun").hide()}),$("body").on("click",".turnOff",function(){var e=$(this),t=$(this).parent().attr("data-base");parseInt($(this).parent().parent().css("text-indent"));if(0==$(this).parent().siblings(".allMeun").length){if(e.hasClass("got"))return!1;e.addClass("got"),p($("#connId").val(),e,t)}else e.parent().siblings(".allMeun").show(),e.hide().siblings(".turnOn").show()}),$("body").on("click",".routeLabel",function(){$(this).parents(".allMeun").find(".routeLabel.rCheckIcon").removeClass("rCheckIcon"),$(this).addClass("rCheckIcon");var e=$(this).siblings(".oneRoute").attr("data-base"),t=$(".defaultRoute");$(this).parents(".menuZone").hasClass("hdfsMoveDir")&&(t=$(".matchCon .moveDir")),t.val(e).attr("title",e)}),$(".startImport").click(function(){var e=cronExport.cronExec($(".group-type .cur").index(),!0);if(!e.cronParam||-1==[0,1,2].indexOf(+e.periodType))return $(this).prop("disabled",!1),$(".delayTip").css({display:"none"}),!1;var t=$(".configTask .taskName").val().trim(),a=$(".configTask .taskDes").val().trim(),i=$("#userApp").val(),n=$("#connId").val(),o=g.sourceId,s=2==$(".confType .radio.cur").attr("data-val"),r={pid:i,jobName:t,note:a,toType:8,fromId:o,toId:n,periodType:e.periodType,cronExpression:e.cronParam,startTimeStr:e.startTimeStr||"",endTimeStr:e.endTimeStr||""},l=[],c=[];$(".tabCheckOne").each(function(){var e=$(this).parents(".hdfsTr").find(".hdfsMap"),t={};t.ftpId=o,t.filePath=e.attr("path"),t.size=e.attr("size"),t.usePattern=s,(e.attr("directory")||"")&&(t.directory="1"==e.attr("directory"));var a={};if(a.hid=n,a.fileName=e.attr("title"),a.tarFileHandleType=e.attr("tarFileHandleType"),s){var i=JSON.parse(e.attr("data-source")),r=JSON.parse(e.attr("data-target"));i.tarRenameFormat=["","_yyyyMMdd","_yyyyMMdd_HHmmss"][+i.tarRenameFormat],$.extend(t,i),$.extend(a,r)}l.push(t),c.push(a)}),r.fromJson=JSON.stringify(l),r.toHdfsJson=JSON.stringify(c),u(r)}),$(".startManage").click(function(){$("#dTaskName").val().trim(),$(".taskDescribe").val();var e=[],t=[];$(".tabCheckOne").each(function(){var a={};a.ftpId=$(".dbZone").attr("id"),a.filePath=$(this).parent().parent().siblings(".hdfsMap").attr("path"),a.size=$(this).parent().parent().siblings(".hdfsMap").attr("size"),e.push(a);var i={};i.hid=$("#connId").val(),i.fileName=$(this).parent().parent().siblings(".hdfsMap").html(),t.push(i)}),e=JSON.stringify(e),t=JSON.stringify(t),u($("#userApp").val())})}function eventBind(){window.onbeforeunload=function(){if($(".taskName").val().trim()||$(".mapTaskMsg .taskDescribe").val().trim()||$(".mapTaskMsg .ipSite").val().trim()||$(".mapTaskMsg .portVal").val().trim()||$(".mapTaskMsg .userName").val().trim()||$(".mapTaskMsg .password").val().trim())return common_js_lang["common.info.leavePage"]},$(".tabCheckAll").click(function(){if(0!=$(".addContentZone").children().length){var e=$(this).prop("checked");$(".hdfsTr .tabCheck").prop("checked",e),e?($(this).parent("label").addClass("checkStatus"),$(".hdfsTr .tabCheck").parent("label").addClass("checkStatus")):($(this).parent("label").removeClass("checkStatus"),$(".hdfsTr .tabCheck").parent("label").removeClass("checkStatus"))}}),$("body").on("click",".hdfsTr .tabCheck",function(){var e=!0;$(".hdfsTr .tabCheck").each(function(){0==$(this).prop("checked")&&(e=!1),e?$(".tabCheckAll").prop("checked",!0):$(".tabCheckAll").prop("checked",!1)})}),$("body").on("click",".tabCheckOne",function(){$(this).prop("checked")?$(this).parent("label").addClass("checkStatus"):$(this).parent("label").removeClass("checkStatus");var e=!0;$(".tabCheckOne").each(function(){0==$(this).prop("checked")&&(e=!1),e?($(".tabCheckAll").prop("checked",!0),$(".tabCheckAll").parent("label").addClass("checkStatus")):($(".tabCheckAll").prop("checked",!1),$(".tabCheckAll").parent("label").removeClass("checkStatus"))})}),$(".CancelBtn").click(function(){location.href="./"}),$(".createCancel").click(function(){$(".maskCell").hide(),$(".createTabTip").hide()}),$(".closeMap").click(function(){$(".suffixRoute").removeClass("redWord"),$(".hdfsBox,.maskCell").hide()}),$(".cancelKeep").click(function(){$(".suffixRoute").removeClass("redWord"),$(".hdfsBox,.maskCell").hide()}),$(".createCancel").click(function(){$(".maskCell").hide(),$(".createTabTip").hide()}),$(".password").on("copy paste",function(e){e.preventDefault()}),$("#pointLeft,#pointRight").on("mouseenter",function(){$(this).children(".lost").hide().siblings(".select").show()}).on("mouseleave",function(){$(this).children(".lost").show().siblings(".select").hide()})}function init(e){businessFn(e),eventBind()}function copyEdit(){for(var e=$.Deferred(),t={urlObj:{}},a=location.search.replace(/^\?|\?$/g,"").split("&"),i=0,n=a.length;i<n;i++){var o=a[i].split("=");t.urlObj[o[0]]=o[1]||""}return t.urlObj.copy&&t.urlObj.id>0?($(".delayTip").show(),$.ajax({url:"job/detail?jobId="+t.urlObj.id,success:function(t){if(200!=t.code)return ErrTip(t.i18nMsg.title,t.i18nMsg.detail,t.msg),void e.reject();t.model.jobName=(t.model.jobName+"_copy").slice(0,60);var a="";t.model.fromObject||(a+=common_js_lang["conf.info.srcNull"]),t.model.toObject||(a+=(a?"<br>":"")+common_js_lang["conf.info.tarNull"]),a&&MsgTip("info",a,5e3),e.resolve(t.model)},error:function(){e.reject()},complete:function(){$(".delayTip").hide()}})):e.reject(),e.promise()}$.when(copyEdit()).then(function(e){init(e)}).fail(function(){init("")});