function getUsers(a){a||!globalParam.allUserOption?$.fn.ajaxAPI({url:"job/users",data:{pids:a||""},callback:function(e){var t='<option value="">'+common_js_lang["manage.info.allOwner"]+"</option>";e.model.map(function(a){t+='<option value="'+a.id+'">'+a.userName+"</option>"}),$("#taskUser").html(t),!a&&(globalParam.allUserOption=t)}}):$("#taskUser").html(globalParam.allUserOption)}function list(){var a=+globalParam.listSendData.pageNo||1;a<1&&(a=1),globalParam.listSendData.pageNo=a,$.fn.ajaxAPI({url:"job/list",data:globalParam.listSendData,callback:function(e){if(e.model.totalPage&&e.model.totalPage<a)return globalParam.listSendData.pageNo=e.model.totalPage,void list();var t=Date.now();e.model.data=e.model.data.map(function(a){return a.endTime&&a.endTime<t&&(a.isEnd=!0),a.groupName=a.fromObject?globalParam.dbtype[a.fromObject.dbType]:common_js_lang[a.groupName],a.periodStr=common_js_lang[a.periodStr],a}),$(".listCon .list").html(template("template/taskTable",e.model)),$(".listCon .list .pager").bootpag({total:e.model.totalPage,page:e.model.currentPage,maxVisible:10,leaps:!1,firstLastUse:!0,prev:"<i>〈</i>",next:"<i>〉</i>",first:"<i>《</i>",last:"<i>》</i>"}).off().on("page",function(a,e){globalParam.listSendData.pageNo=e,list()})}})}template.helper("dateFormat",function(a,e){var t={M:(a=new Date(a)).getMonth()+1,d:a.getDate(),h:a.getHours(),m:a.getMinutes(),s:a.getSeconds(),q:Math.floor((a.getMonth()+3)/3),S:a.getMilliseconds()};return e=e.replace(/([yMdhmsqS])+/g,function(e,n){var l=t[n];return void 0!==l?(e.length>1&&(l=(l="0"+l).substr(l.length-2)),l):"y"===n?(a.getFullYear()+"").substr(4-e.length):e})});var datepickerLang="zh"==common_i18n_lang?"zh-cn":"en";$("#startDate").on("click",function(){WdatePicker({readOnly:!0,lang:datepickerLang,isShowClear:!1,maxDate:"#F{$dp.$D('endDate')}"})}),$("#endDate").on("click",function(){WdatePicker({readOnly:!0,lang:datepickerLang,isShowClear:!1,minDate:"#F{$dp.$D('startDate')}"})});var tmpParam={listSendData:{pageNo:1,pageSize:10,groups:"1,2,4,5,6,7,8,9,10,11,12"},allUserOption:"",dbtype:{38:"MySQL",52:"AliMySQL",56:"AwsMySQL",4:"Oracle",60:"AwsOracle",40:"SQL Server",53:"AliSQLServer",57:"AwsSQLServer",44:"DB2",24:"PostgreSQL",54:"AliPostgreSQL",58:"AwsPostgreSQL"}};$.extend(globalParam,tmpParam),getUsers(),list(),$(".act").on("click",".query",function(){var a=$("#taskId").val().trim(),e=$("#taskName").val().trim(),t=$("#taskStatus").val().trim(),n=$("#startDate").val().trim(),l=$("#endDate").val().trim(),i=$("#userApp").val(),o=($("#taskUser").val()||"").trim();if(""==a||a.match(/^[0-9]+$/)){if(""!=a){if((a=+a)<=0)return MsgTip("",common_js_lang["manage.info.taskIdInfo"],"info"),!1;$("#taskId").val(a)}globalParam.listSendData={pageNo:1,pageSize:10,id:a,jobName:e,status:t,startTimeStr:n,endTimeStr:l,userId:o,groups:"1,2,4,5,6,7,8,9,10,11,12",pids:i},i||delete globalParam.listSendData.pids,list()}else MsgTip("",common_js_lang["manage.info.taskIdInfo"],"info")}),$("body").on("change","#userApp",function(){var a=$(this).val();$(".search-form .myTask i").removeClass("checked"),getUsers(a)}),$("body").on("keyup",".search input",function(a){13==a.keyCode&&$(".act .query").click()}),$(".act").on("click",".reset",function(){$(".search-form input, .search-form select").val("").prop("checked",!1),$(".search-form select").change()}),$(".myTask").on("click",function(){var a=$(this).find("i");if(a.hasClass("checked")){a.removeClass("checked");e=""}else var e=a.addClass("checked").data("id");$("#taskUser").val(e)}),$("#taskUser").on("change",function(){$(this).val()==$(".myTask i").data("id")?$(".myTask i").addClass("checked"):$(".myTask i").removeClass("checked")}),$(".list").on("click",".enable",function(){var a=$(this).parent().data("id");$(this);$.fn.ajaxAPI({url:"job/enable",type:"post",contentType:"application/x-www-form-urlencoded",data:{id:a},callback:function(a){MsgTip({title:"SUCCESS",text:common_js_lang["manage.info.taskEnable"],type:"success",timer:2e3}),list()}})}),$(".list").on("click",".disable",function(){var a=$(this).parent().data("id");$(this);$.fn.ajaxAPI({url:"job/disable",type:"post",contentType:"application/x-www-form-urlencoded",data:{id:a,once:!1},callback:function(a){MsgTip({title:"SUCCESS",text:common_js_lang["manage.info.taskDisable"],type:"success",timer:2e3}),list()}})}),$(".list").on("click",".del",function(){var a=$(this).parent().data("id");$(this);swal({title:"",text:common_js_lang["manage.info.isDelTask"]+"["+a+"]?",type:"info",showCancelButton:!0},function(){$.fn.ajaxAPI({url:"job/delete",type:"post",contentType:"application/x-www-form-urlencoded",data:{id:a},callback:function(a){MsgTip({title:"SUCCESS",text:common_js_lang["manage.info.delSucc"],type:"success",timer:2e3}),$(".list tbody tr").length<=1&&(globalParam.listSendData.pageNo=globalParam.listSendData.pageNo-1||1),list()}})})}),$(".list").on("click",".edit",function(){1==$(this).siblings(".enable").length?location.href=$(this).data("href"):MsgTip("",common_js_lang["manage.info.editNote"],"info")}),$(".list").on("click",".copy",function(){location.href=$(this).data("href")});