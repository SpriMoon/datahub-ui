$(function(){function e(){function e(){var e={};return e.flag=!1,e.msg="",""==$("#dTaskName").val()?(e.flag=!0,e.msg=common_js_lang["local.info.taskNameNone"],e):$("#userApp").val()?""==$(".accKey").val()?(e.flag=!0,e.msg=common_js_lang["s3.info.accekey"],e):$(".accKey").hasClass("redWord")?(e.flag=!0,e.msg=common_js_lang["s3.info.accKey"],e):""==$(".secKey").val()?(e.flag=!0,e.msg=common_js_lang["s3.info.scrtKey"],e):$("#connId").val()?e:(e.flag=!0,e.msg=common_js_lang["db.info.tarConn"],e):(e.flag=!0,e.msg=common_js_lang["s3.info.noneApp"],e)}function t(e){$.ajax({url:"repo/s3/save",type:"post",data:{accessKey:$(".accKey").val(),secretKey:$(".secKey").val(),region:$("#Regions").val(),pid:$("#userApp").val()},success:function(t){0==t.code?(e.reject(),ErrTip(t.i18nMsg.title,t.i18nMsg.detail,t.msg)):200==t.code?($(".dbZone").attr("id",t.model.id),a(t.model.id,e)):-1==t.code&&(e.reject(),m.ajaxFail())}}).fail(function(){$(".delayTip").hide()})}function a(e,t){$.ajax({url:"repo/s3/buckets",type:"post",data:{s3Id:e},success:function(e){0==e.code?(t.reject(),MsgTip("",common_js_lang["s3.info.s3Fail"],"info")):200==e.code?($(".dbZone").html(template("template/amazons3Bucket",{data:e.model})),t.resolve()):-1==e.code&&(t.reject(),m.ajaxFail())}})}function n(e,t,a,n,i,s,l){var c=setTimeout(function(){$(".loadingTip").show()},2e3);i.prop("disabled",!0),$.ajax({url:"repo/s3/bucket/objects",data:{s3Id:e,bucketName:t,parent:l},type:"post",success:function(e){if(-1==e.code)m.ajaxFail();else if(200!=e.code)ErrTip(e.i18nMsg.title,e.i18nMsg.detail,e.msg);else{$('<ul style="margin-left:'+s+'px" class="oneMeun childUl tabList tabList'+a+'"></ul>');var l={};l.field=a,l.preIndent=s,l.value=e.model,l.bucket=t;var c=+(i.parent().css("padding-left").slice(0,-2)||0)+18;n.append(template("template/child",{data:l,pad:c})),i.hide(),i.siblings("img").show()}},complete:function(){i.prop("disabled",!1),clearTimeout(c),$(".loadingTip").hide()}})}function i(){var e=[];return $(".oneTabLi").each(function(){if($(this).children(".oneResult").hasClass("tabcheck")){var t=$(this),a=!0;if($(".hdfsTr").each(function(){t.attr("field")==$(this).attr("field")&&(a=!1)}),a){var n={};n.fileName=t.children(".oneResult").children(".aTabName").html(),n.path=t.children(".oneResult").children(".aTabName").attr("path"),n.size=t.children(".oneResult").children(".tabSize").attr("size"),n.bucket=$(this).attr("bucket"),n.field=t.attr("field"),e.push(n)}}}),e}function s(){var e=!1;return $(".tabCheckOne").each(function(){$(this).prop("checked")&&(e=!0)}),e}function l(){s()?($(".hdfsBox,.maskCell").show(),$(".hdfsBox .suffixShow").hide(),$(".keep").attr("field","all"),$(".routeLabel.rCheckIcon").removeClass("rCheckIcon").children("input").prop("checked",!1),$(".defaultRoute").val("").attr("title","")):MsgTip("",common_js_lang["dump.info.selectTask"],"info")}function c(e){var t=e.parent().parent();t.show(),t.siblings(".oneRoute").children(".turnOn").show(),t.siblings(".oneRoute").children(".turnOff").hide(),t.hasClass("firstM")||c(t)}function o(){var e=$(".defaultRoute").val()||"";""!=e?$.ajax({url:"hdfs/dir/access",data:{hdfsId:$("#connId").val(),dir:e,pid:$("#userApp").val()},success:function(t){-1!=t.code?200==t.code?("/"==e&&(e=""),$(".hdfsMap").each(function(){if($(this).parent().children().eq(0).children("label").children(".tabCheckOne").prop("checked")){var t=$(this).siblings(".hdfs").children(".parseName").html(),a="";t=t.slice(0,60),a=(e+"/"+t).replace(/\/+/g,"/"),$(this).html(a).attr("title",a).attr("route",$(".defaultRoute").val()).attr("file",t).parents(".hdfsTr").find(".tabCheckOne").click()}}),$(".maskCell,.hdfsBox").hide(),$(".defaultRoute").val("").attr("title","")):ErrTip(t.i18nMsg.title,t.i18nMsg.detail,t.msg):m.ajaxFail()}}):MsgTip("",common_js_lang["db.info.batchDir"],"info")}function r(){if($(".defaultRoute").val()&&$(".suffixRoute").val().trim()&&"OK"==$(".suffixRoute").attr("name")){if($(".suffixRoute").val().trim().match(/\s+/g))return MsgTip("",common_js_lang["local.info.fileName"],"info"),$(".suffixRoute").addClass("redWord"),!1;if($(".suffixRoute").val().trim().match(/\\/g))return MsgTip("",common_js_lang["local.info.fileName"],"info"),!1;var e=$(".suffixRoute").val().trim();e=e.slice(0,60),$.ajax({url:"hdfs/dir/access",data:{hdfsId:$("#connId").val(),dir:$(".defaultRoute").val(),pid:$("#userApp").val()},success:function(t){if(-1!=t.code)if(200==t.code){var a=$(".keep").attr("num");if("/"!==$(".defaultRoute").val())n=$(".defaultRoute").val()+"/"+e;else var n="/"+e;n=n.replace(/\/+/g,"/"),$(".newTr").each(function(){$(this).attr("field")==a&&($(this).children(".hdfsMap").html(n).attr("title",n),$(this).children(".hdfsMap").attr("route",$(".defaultRoute").val()).attr("file",e),$(".maskCell,.hdfsBox").hide(),$(".defaultRoute").val("").attr("title",""),$(".suffixRoute").val(""))})}else ErrTip(t.i18nMsg.title,t.i18nMsg.detail,t.msg);else m.ajaxFail()}})}else{if($(".defaultRoute").val()&&$(".suffixRoute").val().trim()&&"NO"==$(".suffixRoute").attr("name"))return MsgTip("",common_js_lang["local.info.fileName"],"info"),!1;""!=$(".defaultRoute").val()&&""!=$(".suffixRoute").val()||MsgTip("",common_js_lang["s3.info.dir"],"info")}}function h(e){$.ajax({url:"hdfs/dir/home",data:{hid:$("#connId").val(),pid:$("#userApp").val()},success:function(t){if(200==t.code&&t.model.length>0){$(".thisRoute.startThis").html(t.model).parent().attr("data-base",t.model),$(".thisRoute.startThis").parent().find(".turnOff").show(),$(".thisRoute.startThis").parent().find(".turnOn").hide(),$(".firstM .startLi").children(".allMeun")&&$(".firstM .startLi").children(".allMeun").remove();var a=$(".routeStart .turnOff");if(a)a.siblings(".thisRoute").html(),parseInt(a.parent().parent().css("text-indent"));$(".FileNext").attr("connId",f.connId),$(".addContentZone").empty(),$(".checkAllLab").removeClass("checkStatus").children("input").attr("checked",!1),e.resolve()}else-1==t.code?(e.reject(),m.ajaxFail()):(e.reject(),ErrTip(t.i18nMsg.title,t.i18nMsg.detail,t.msg))},error:function(){e.reject()}})}function d(){var e=$("#userApp").val(),t=globalParam.commonLinkType.hdfs,a="db/list",n="";t==globalParam.commonLinkType.hdfs?a="hdfs/list":n=4,e&&$.ajax({url:a+"?pid="+e+"&groups="+n,success:function(e){var a='<option value="" disabled>'+common_js_lang["db.info.selectLink"]+"</option>";t==globalParam.commonLinkType.hdfs?adminConfigData.hdfs.id&&(a+='<option value="'+adminConfigData.hdfs.id+'">'+adminConfigData.hdfs.connName+"</option>"):adminConfigData.hive.id&&(a+='<option value="'+adminConfigData.hive.id+'">'+adminConfigData.hive.connName+"</option>"),e.model.data.map(function(e){a+='<option value="'+e.id+'">'+e.connName+"</option>"}),$("#connId").html(a).val("").select2()}}).fail(function(){MsgTip("","get connection error","info"),$("#connId").html("")})}function u(e,t,a,n){var i=setTimeout(function(){$(".delayTip").show()},2e3);$.ajax({url:"hdfs/dir/list",type:"post",data:{base:a,hid:e,pid:$("#userApp").val()},success:function(e){if(200==e.code)if(e.model.length){t.children(".turnOn").show(),t.children(".turnOff").hide();for(var n=e.model,i=$("<ul class='allMeun'></ul>"),s=a.length,l=0;l<n.length;l++){var c=$("<li class='newRoute'><label class='routeLabel'><input type='checkbox' class='routeChoiceBtn' name='route'/></label><h5 class='oneRoute' data-base='"+n[l]+"'><img class='turnOn' src='resources/images/routeOn.png'/><img class='turnOff' src='resources/images/routeOff.png'/><span class='thisRoute' title='"+n[l].slice(s)+"'>"+n[l].slice(s)+"</span></h5></li>");c.css("padding-left","20px"),i.append(c)}c&&c.length>0&&t.parent().siblings().length<=1&&(t.parent().parent().append(i),t.attr("field")?t.hide().siblings(".turnOn").show():t.parent().siblings().length>0?t.hide().siblings(".turnOn").show():t.hide().siblings(".turnOn").hide())}else t.parent().attr("status","ok"),t.hide(),t.siblings(".turnOn").hide();else-1==e.code?m.ajaxFail():ErrTip(e.i18nMsg.title,e.i18nMsg.detail,e.msg)},complete:function(){t.removeClass("got"),clearTimeout(i),$(".delayTip").hide()}})}function p(e,t,a,n,i){$.ajax({url:"job/s3/save",type:"post",data:{toType:8,pid:e,jobName:t,note:a,fromId:$(".dbZone").attr("id"),toId:$("#connId").val(),fromJson:n,toHdfsJson:i},success:function(e){200==e.code?(window.onbeforeunload=function(){},location.href="./success"):-1==e.code?m.ajaxFail():ErrTip(e.i18nMsg.title,e.i18nMsg.detail,e.msg)}})}var f={},m=($("#connId").val(),{fileSize:function(e){return e<1024?(e||0)+"bytes":e<1048576?(e/1024).toFixed(2)+"KB":e?(e/1024/1024).toFixed(2)+"MB":"--"},reg:function(e){var t=/([^\/]+)$/g;return e=(e=e.replace(/\\/g,"/")).replace(t,"d$1"),RegExp.$1},ajaxFail:function(){return swal({title:"",text:common_js_lang["manage.info.timeout"],type:"info",showCancelButton:!0,confirmButtonText:common_js_lang["manage.info.newdow"],cancelButtonText:common_js_lang["manage.info.tologin"]},function(e){e?window.open("./","_blank"):location.href="./"}),!1}});$.ajax({url:"repo/s3/regions",success:function(e){if(200==e.code){for(var t="",a=0;a<e.model.length;a++)t+="<option value="+e.model[a].name+">"+e.model[a].alias+"</option>";$("#Regions").append(t).select2()}else 0==e.code&&MsgTip("",common_js_lang["s3.info.regionFail"],"info")}}),$(".FileNext").click(function(){if(e().flag)MsgTip("",e().msg,"info");else{$(".delayTip").show();var a=$.Deferred(),n=$.Deferred();f.regions==$("#Regions").val()&&f.accKey==$(".accKey").val()&&f.secKey==$(".secKey").val()?a.resolve():(t(a),$(".addContentZone").empty(),$(".tabCheckAll").prop("checked",!1).parent().removeClass("checkStatus")),f.connId!=$(".FileNext").attr("connId")||void 0===$(".FileNext").attr("connId")||f.app!=$("#userApp").val()||void 0===f.app?(f.app=$("#userApp").val(),$.when(a).done(function(){h(n)})):n.resolve(),$.when(a,n).done(function(){$(".uploadFile").hide(),$(".choiceRoute").show(),$(".delayTip").hide()}).fail(function(){$(".delayTip").hide()})}}),$(".accKey").blur(function(){$(this).val().trim().match(/\s+/g)?$(this).addClass("redWord"):$(this).removeClass("redWord")}),$(".prevBtn").click(function(){$(".uploadFile").show(),$(".choiceRoute").hide(),f.regions=$("#Regions").val(),f.accKey=$(".accKey").val().trim(),f.secKey=$(".secKey").val().trim()}),template.helper("fileSize",function(e){return e<1024?(e||0)+"bytes":e<1048576?(e/1024).toFixed(2)+"KB":(e/1024/1024).toFixed(2)+"MB"}),template.helper("fileSize",function(e){return e<1024?(e||0)+"bytes":e<1048576?(e/1024).toFixed(2)+"KB":(e/1024/1024).toFixed(2)+"MB"}),$("body").on("click",".slideUp",function(){if($(this).parent(".oneResult").siblings(".childUl").length)$(this).parent(".oneResult").siblings(".childUl").show(),$(this).hide().siblings(".slideDown").show();else{var e=$(".dbZone").attr("id"),t=$(this).siblings(".aDbName").attr("bucketName")||$(this).siblings(".aDbName").attr("title"),a=$(this).siblings(".aDbName").attr("path")||"",i=$(this).parent().parent(".oneDataLi").attr("field"),s=$(this).parent().parent(".oneDataLi"),l=parseInt($(this).parent().parent(".oneDataLi").css("margin-left"))+18;n(e,t,i,s,$(this),l,a)}}),$("body").on("click",".slideDown",function(){$(this).hide().siblings(".slideUp").show(),$(this).parent(".oneResult").siblings(".childUl").hide()}),$("body").on("click",".oneTabLi",function(){$(this).children(".oneResult").toggleClass("tabcheck")}),$("#pointRight").on("click",function(){var e=i();if(!(e.length+$(".newTr").length<=1e3)&&$(".newTr"))return MsgTip("",common_js_lang["s3.info.limit1000"].replace(/\[x\]/,"["+i().length+"]").replace(/\[y\]/,"["+$(".newTr").length+"]"),"info"),!1;if(e.length&&($(".addContentZone").append(template("template/hdfsTr",{data:e})),$(".tabCheckAll").prop("checked",!1).parent("label").removeClass("checkStatus"),$(".oneResult.tabcheck").removeClass("tabcheck")),"Microsoft Internet Explorer"==navigator.appName&&"9."==navigator.appVersion.match(/9./i)){window.screen.width;$(".createTab").each(function(){$(this).children(".newTr").each(function(){$(this).children().eq(0).css("width","6%"),$(this).children().eq(3).css("text-align","center"),$(this).children().eq(1).children(".parseName").css("max-width","100px")})})}}),$("#pointLeft").click(function(){$(".tabCheckOne").each(function(){$(this).prop("checked")&&($(this).parent().parent().parent().parent().children().length,$(this).parent().parent().parent().remove(),0==$(".newTr").length&&($(".tabCheckAll").prop("checked",!1),$(".tabCheckAll").parent("label").removeClass("checkStatus")))})}),$(".allConfigure").click(function(){0==$(".addContentZone").children().length?MsgTip("",common_js_lang["s3.info.noneConfig"],"info"):1==$("#uploadSite").val()||l()}),$("body").on("click",".oneConfigure",function(){if($(".keep").attr({num:$(this).parent().parent().attr("field"),field:"one"}),$(".suffixRoute").attr("name","OK"),1==$("#uploadSite").val());else{$(".hdfsBox,.maskCell").show(),$(".hdfsBox .suffixShow").show();var e=$(this).parent().siblings(".hdfsMap").attr("route"),t=$(this).parent().siblings(".hdfsMap").attr("file"),a={};e?($(".defaultRoute").val(e).attr("title",e),$(".routeLabel").each(function(){$(this).siblings(".oneRoute").attr("data-base")==e?($(this).addClass("rCheckIcon").children("input").prop("checked",!0),a=$(this)):$(this).removeClass("rCheckIcon").children("input").prop("checked",!1)}),c(a)):($(".routeLabel.rCheckIcon").removeClass("rCheckIcon").children("input").prop("checked",!1),$(".defaultRoute").val("").attr("title","")),t?$(".suffixRoute").val(t):$(".suffixRoute").val($(this).parent().siblings(".hdfs").children(".parseName").html().substr(0,99))}}),$(".suffixRoute").blur(function(){var e=$(this).val().trim();if(e.match(/\s+/g)||e.match(/\\/g))return $(".suffixRoute").addClass("redWord"),!1;$(".suffixRoute").removeClass("redWord")}),$(".keep").on("click",function(){"all"==$(this).attr("field")?1==$("#uploadSite").val()||o():1==$("#uploadSite").val()||r()}),d(),$("#connId").change(function(){var e=$(this).val();f.connId=e}),$("#userApp").change(function(){d()}),$("body").on("click",".turnOn",function(){var e=$(this);e.hide().siblings(".turnOff").show(),e.parent().siblings(".allMeun").hide()}),$("body").on("click",".turnOff",function(){var e=$(this),t=$(this).parent().attr("data-base");parseInt($(this).parent().parent().css("text-indent"));if(0==$(this).parent().siblings(".allMeun").length){if(e.hasClass("got"))return!1;e.addClass("got"),u($("#connId").val(),e,t)}else e.parent().siblings(".allMeun").show(),e.hide().siblings(".turnOn").show()}),$("body").on("click",".routeLabel",function(){$(".routeLabel").each(function(){$(this).removeClass("rCheckIcon")}),$(this).addClass("rCheckIcon");var e=$(this).siblings(".oneRoute").attr("data-base");$(".defaultRoute").val(e).attr("title",e)}),$(".startImport").click(function(){if($(".tabCheckOne").length<=0)return MsgTip("",common_js_lang["db.info.confTar"],"info"),!1;if(1==$("#uploadSite").val());else{var e=!1;$(".tabCheckOne").each(function(){""==$(this).parent().parent().siblings(".hdfsMap").html()&&(e=!0)}),e?MsgTip("",common_js_lang["s3.info.configParam"],"info"):($(".maskCell").show(),$(".createTabTip").show(),$(".createTabTip .tipCon").hide(),$(".createTabTip .successTip").hide(),$(".createTabTip .bBtnZone").hide(),$(".createTabTip .newFail").hide())}}),$(".startManage").click(function(){var e=$("#dTaskName").val(),t=$(".taskDescribe").val();if(1==$("#uploadSite").val());else{var a=[],n=[];$(".tabCheckOne").each(function(){var e={};e.hid=$("#connId").val(),e.fileName=$(this).parent().parent().siblings(".hdfsMap").html(),n.push(e);var t={};t.s3Id=$(".dbZone").attr("id"),t.bucketName=$(this).parent().parent().siblings(".hdfsMap").attr("bucket"),t.key=$(this).parent().parent().siblings(".hdfsMap").attr("key"),t.size=$(this).parent().parent().siblings(".hdfsMap").attr("size"),a.push(t)}),a=JSON.stringify(a),n=JSON.stringify(n),p($("#userApp").val(),e,t,a,n)}})}function t(){var e=[];$(".dbZone").scroll(function(){$(this).scrollLeft()>Math.max.apply(null,e)&&$(".firstUl").width()<1300&&e.push($(this).scrollLeft())}),window.onbeforeunload=function(){if($("#dTaskName").val().trim()||$(".taskDescribe").val().trim()||$(".accKey").val().trim()||$(".secKey").val().trim())return common_js_lang["common.info.leavePage"]},$(".tabCheckAll").click(function(){if(0==$(".addContentZone").children().length)MsgTip("","Empty","info");else{var e=$(this).prop("checked");$(".tabCheck").prop("checked",e),e?($(this).parent("label").addClass("checkStatus"),$(".tabCheck").parent("label").addClass("checkStatus")):($(this).parent("label").removeClass("checkStatus"),$(".tabCheck").parent("label").removeClass("checkStatus"))}}),$("body").on("click",".tabCheck",function(){var e=!0;$(".tabCheck").each(function(){0==$(this).prop("checked")&&(e=!1),e?$(".tabCheckAll").prop("checked",!0):$(".tabCheckAll").prop("checked",!1)})}),$("body").on("click",".fileCheck",function(){var e=$(this).prop("checked"),t=$(this).attr("field");$(".tabCheckOne"+t).prop("checked",e),e?($(this).parent("label").addClass("checkStatus"),$(".tabCheckOne"+t).parent("label").addClass("checkStatus")):($(this).parent("label").removeClass("checkStatus"),$(".tabCheckOne"+t).parent("label").removeClass("checkStatus"))}),$("body").on("click",".tabCheckOne",function(){var e=$(this).attr("field"),t=!0;$(this).prop("checked")?$(this).parent("label").addClass("checkStatus"):$(this).parent("label").removeClass("checkStatus"),$(".tabCheckOne"+e).each(function(){0==$(this).prop("checked")&&(t=!1),t?($(".fileCheck"+e).prop("checked",!0),$(".fileCheck"+e).parent("label").addClass("checkStatus")):($(".fileCheck"+e).prop("checked",!1),$(".fileCheck"+e).parent("label").removeClass("checkStatus"))})}),$("body").on("click",".tabCheckOne",function(){var e=!0;$(".tabCheckOne").each(function(){0==$(this).prop("checked")&&(e=!1),e?($(".tabCheckAll").prop("checked",!0),$(".tabCheckAll").parent("label").addClass("checkStatus")):($(".tabCheckAll").prop("checked",!1),$(".tabCheckAll").parent("label").removeClass("checkStatus"))})}),$("body").on("click",".rFileCheck",function(){var e=!0;$(this).prop("checked")?$(this).parent("label").addClass("checkStatus"):$(this).parent("label").removeClass("checkStatus"),$(".fileCheck").each(function(){0==$(this).prop("checked")&&(e=!1),e?($(".tabCheckAll").prop("checked",!0),$(".tabCheckAll").parent("label").addClass("checkStatus")):($(".tabCheckAll").prop("checked",!1),$(".tabCheckAll").parent("label").removeClass("checkStatus"))})}),$("#uploadSite").change(function(){var e=$(this).val();$(".mapMethod").eq(e).show().siblings().hide()}),$("body").on("click",".acheck",function(){$(this).prop("checked")?($(this).parent().parent().addClass("tabcheck"),$(this).parent(".aLabel").addClass("checkStatus")):($(this).parent().parent().removeClass("tabcheck"),$(this).parent(".aLabel").removeClass("checkStatus"));var e=!0,t=!0,a=$(this).attr("field");$(".acheck").each(function(){0==$(this).prop("checked")&&(t=!1),t?($("#checkAllDb").prop("checked",!0),$(".checkAllDb").addClass("checkStatus")):($("#checkAllDb").prop("checked",!1),$(".checkAllDb").removeClass("checkStatus"))}),$(".check"+a).each(function(){0==$(this).prop("checked")&&(e=!1),e?($(".leftOneCheck"+a).prop("checked",!0).attr("request","Y"),$(".leftOneCheck"+a).parent(".fileCheck").siblings(".dbName").addClass("checkStatus")):($(".leftOneCheck"+a).prop("checked",!1),$(".leftOneCheck"+a).parent(".fileCheck").siblings(".dbName").removeClass("checkStatus"))})}),$(".closeMap").click(function(){$(".suffixRoute").removeClass("redWord"),$(".hdfsBox,.maskCell").hide()}),$(".cancel").click(function(){$(".hdfsBox,.maskCell").hide()}),$(".cancelKeep").click(function(){$(".suffixRoute").removeClass("redWord"),$(".hdfsBox,.maskCell").hide()}),$(".CancelBtn").click(function(){location.href="./"}),$(".createCancel").click(function(){$(".maskCell").hide(),$(".createTabTip").hide()}),$(".secKey").on("copy paste",function(e){}),$("#pointLeft,#pointRight").on("mouseenter",function(){$(this).children(".lost").hide().siblings(".select").show()}).on("mouseleave",function(){$(this).children(".lost").show().siblings(".select").hide()})}e(),t(),window.screen.availHeight<820?$(".contentBox .mathRoute .routeChoice").addClass("hdfsRouH"):window.screen.availHeight<820&&window.screen.availHeight>700?$(".contentBox .mathRoute .routeChoice").addClass("hdfsRouH"):window.screen.availHeight<760&&$(".contentBox").addClass("positionTrans")});