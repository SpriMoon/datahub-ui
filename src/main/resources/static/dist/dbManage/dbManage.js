function getDBList(a,e){0!=e?(a.groups=4,a.dbType=1==e?31:62):a.groups="1,2,3";var t=a,n=+a.pageNo||1;n<1&&(n=1),a.pageNo=n,$.fn.ajaxAPI({url:"db/list",data:a,callback:function(a){if(a.model.totalPage&&a.model.totalPage<n)return t.pageNo=a.model.totalPage,void getDBList(t,$("nav a.cur").index());a.model.data=a.model.data.map(function(a){return a.val=JSON.stringify(a),a}),$("#db-manage-list").html(template(e?"template/hiveList":"template/dbList",a.model)),$("#db-manage-list .pager").bootpag({total:a.model.totalPage,page:a.model.currentPage,maxVisible:10,leaps:!1,firstLastUse:!0,prev:"<i>〈</i>",next:"<i>〉</i>",first:"<i>《</i>",last:"<i>》</i>"}).off().on("page",function(a,e){globalParam.dbListParam.pageNo=e,$("#db-manage-list tbody").empty(),getDBList(globalParam.dbListParam,$("nav a.cur").index())})}})}function getHdfsList(a){var e=a,t=+a.pageNo||1;t<1&&(t=1),a.pageNo=t,$.fn.ajaxAPI({url:"hdfs/list",data:a,callback:function(a){if(a.model.totalPage&&a.model.totalPage<t)return e.pageNo=a.model.totalPage,void getHdfsList(e);a.model.data=a.model.data.map(function(a){return a.val=JSON.stringify(a),a}),$("#db-manage-list").html(template("template/hdfsList",a.model)),$("#db-manage-list .pager").bootpag({total:a.model.totalPage,page:a.model.currentPage,maxVisible:10,leaps:!1,firstLastUse:!0,prev:"<i>〈</i>",next:"<i>〉</i>",first:"<i>《</i>",last:"<i>》</i>"}).off().on("page",function(a,e){globalParam.hdfsListParam.pageNo=e,$("#db-manage-list tbody").empty(),getHdfsList(globalParam.hdfsListParam)})}})}function getFtpList(a){var e=a,t=+a.pageNo||1;t<1&&(t=1),a.pageNo=t,$.fn.ajaxAPI({url:"repo/ftp/list",data:a,callback:function(a){if(a.model.totalPage&&a.model.totalPage<t)return e.pageNo=a.model.totalPage,void getFtpList(e);a.model.data=a.model.data.map(function(a){return a.val=JSON.stringify(a),a}),$("#db-manage-list").html(template("template/ftpList",a.model)),$("#db-manage-list .pager").bootpag({total:a.model.totalPage,page:a.model.currentPage,maxVisible:10,leaps:!1,firstLastUse:!0,prev:"<i>〈</i>",next:"<i>〉</i>",first:"<i>《</i>",last:"<i>》</i>"}).off().on("page",function(a,e){globalParam.ftpListParam.pageNo=e,$("#db-manage-list tbody").empty(),getFtpList(globalParam.ftpListParam)})}})}function getUrlParam(a){var e=a.parents(".column");return{dbType:e.find('[data-key="dbType"]').val(),host:e.find('[data-key="host"]').val().trim(),port:e.find('[data-key="port"]').val().trim(),dbName:(e.find('[data-key="dbName"]').val()||"").trim(),hidDom:e.find('[data-key="hid"] option:selected'),mode:e.find('[data-key="mode"]').val()}}function getlinkUrl(a){if(1==a.mode){var e=$(".column.hive"),t=e.find('[data-key="zkhost"]'),n=e.find('[data-key="zkport"]'),o=e.find('[data-key="serviceDiscoveryMode"]').val(),l=e.find('[data-key="zooKeeperNamespace"]').val().trim(),i=[];return t.map(function(a,e){i.push($(e).val().trim()+":"+n.eq(a).val().trim())}),"jdbc:hive2://"+i.join(",")+"/;serviceDiscoveryMode="+o+";zooKeeperNamespace="+l}return a.dbType?[38,52,56].indexOf(+a.dbType)>-1?"jdbc:mysql://"+a.host+":"+a.port+"/"+a.dbName:[4,55,60].indexOf(+a.dbType)>-1?"jdbc:oracle:thin:@"+a.host+":"+a.port+":"+a.dbName:[40,53,57].indexOf(+a.dbType)>-1?"jdbc:sqlserver://"+a.host+":"+a.port+";DatabaseName="+a.dbName:44==a.dbType?"jdbc:db2://"+a.host+":"+a.port+"/"+a.dbName:[24,54,58].indexOf(+a.dbType)>-1?"jdbc:postgresql://"+a.host+":"+a.port+"/"+a.dbName:void 0:"hdfs"==$("#seltType").val()?"hdfs://"+a.host+":"+a.port:2==a.hidDom.attr("data-authType")?"jdbc:hive2://"+a.host+":"+a.port+"/;principal="+a.hidDom.attr("data-principal"):"jdbc:hive2://"+a.host+":"+a.port+"/"}function checkDbInfo(a){for(var e in a)if("id"!==e&&("connName"!==e||""!==a.connName)){if(["port","zkport"].indexOf(e)>-1&&!a[e].match(/^[1-9]\d*$/g))return{res:!1,key:e};if(""===a[e])return{res:!1,key:e}}return{res:!0}}function updateDbParamList(a){var e='<option value="0">'+common_js_lang["dbManage.option.param"]+"</option>";globalParam.dbParamObj={},a.map(function(a){e+='<option value="'+a.id+'" data-name="'+a.name+'" data-defValue="'+a.defValue+'">'+("zh"==common_i18n_lang?a.meaning:a.name)+"</option>",globalParam.dbParamObj[a.name]=a.id}),globalParam.dbConfigParamOption=e,$(".global-dbCon .paramList select").html(e);for(var t=$(".db-info .param .tr"),n=t.length,o=0;o<n;o++){var l=t.eq(o).find(".key input").val();if(t.eq(o).find(".key input").prop("readOnly",!1),l){var i=t.eq(o).find(".paramList select");globalParam.dbParamObj[l]&&(i.val(globalParam.dbParamObj[l]),t.eq(o).find(".key input").prop("readOnly",!0))}}}function checkUrl(a,e,t){var n={res:!1,tag:"e"};try{if(0==t.indexOf(a))return n.res=!0,n;if(!e.dbType)return n.tag="type","jdbc:hive2://"!==t.slice(0,13)?n:(n.tag="host",(l=(o=(t=t.substr(13)).split("/"))[0].split(":"))[0]!==e.host?n:(n.tag="port",l[1]=l.splice(1).join(":"),l[1]!==e.port?n:2==e.hidDom.attr("data-authType")?(n.tag="principal",-1==o.splice(1).join("/").indexOf(";principal=")?n:(n.res=!0,n)):(n.res=!0,n)));if([38,52,56].indexOf(+e.dbType)>-1)return n.tag="type","jdbc:mysql://"!==t.slice(0,13)?n:(n.tag="host",(l=(o=(t=t.substr(13)).split("/"))[0].split(":"))[0]!==e.host?n:(n.tag="port",l[1]=l.splice(1).join(":"),l[1]!==e.port?n:(n.tag="dbName",0!=o.splice(1).join("/").indexOf(e.dbName)?n:(n.res=!0,n))));if([4,55,60].indexOf(+e.dbType)>-1)return n.tag="type","jdbc:oracle:thin:@"!==t.slice(0,18)?n:(n.tag="host",(o=(t=t.substr(18)).split(":"))[0]!==e.host?n:(n.tag="port",o[1]!==e.port?n:(n.tag="dbName",0!=o.splice(2).join(":").indexOf(e.dbName)?n:(n.res=!0,n))));if([40,53,57].indexOf(+e.dbType)>-1)return n.tag="type","jdbc:sqlserver://"!==t.slice(0,17)?n:(n.tag="host",(l=(o=(t=t.substr(17)).split(";"))[0].split(":"))[0]!==e.host?n:(n.tag="port",l[1]=l.splice(1).join(":"),l[1]!==e.port?n:(o[1]=o.splice(1).join(";"),n.tag="dbName",0!=o[1].indexOf("DatabaseName="+e.dbName)?n:(n.res=!0,n))));if(44==e.dbType)return n.tag="type","jdbc:db2://"!==t.slice(0,11)?n:(n.tag="host",(l=(o=(t=t.substr(11)).split("/"))[0].split(":"))[0]!==e.host?n:(n.tag="port",l[1]=l.splice(1).join(":"),l[1]!==e.port?n:(o[1]=o.splice(1).join("/"),n.tag="dbName",0!=o[1].indexOf(e.dbName)?n:(n.res=!0,n))));if([24,54,58].indexOf(+e.dbType)>-1){if(n.tag="type","jdbc:postgresql://"!==t.slice(0,18))return n;n.tag="host";var o=(t=t.substr(18)).split("/"),l=o[0].split(":");return l[0]!==e.host?n:(n.tag="port",l[1]=l.splice(1).join(":"),l[1]!==e.port?n:(o[1]=o.splice(1).join("/"),n.tag="dbName",0!=o[1].indexOf(e.dbName)?n:(n.res=!0,n)))}}catch(a){}return n}function hdfsUpdate(a){var e=$(".global-dbCon .hdfs"),t={pid:$('.global-dbCon [data-key="pid"]').val()||"",authType:e.find(".authType .radio.cur").data("val")};if(!t.pid)return MsgTip("",common_js_lang["db.info.selectApp"],"info"),!1;var n=e.find(".authType .radio.cur").data("val");1==n?(["userName","coreSiteXml","hdfsSiteXml"].map(function(a){t[a]=e.find('[data-key="'+a+'"]').val().trim()}),t.connName=e.find('[data-key="connName"]').val().trim(),t.connName=t.connName||"hdfs_simple",e.find('[data-key="connName"]').val(t.connName)):(["principal","coreSiteXml","hdfsSiteXml","keytab","krb5Conf"].map(function(a){t[a]=e.find('[data-key="'+a+'"]').val().trim()}),t.connName=e.find('[data-key="connName"]').val().trim(),t.connName=t.connName||"hdfs_kerberos",e.find('[data-key="connName"]').val(t.connName));var o=checkDbInfo(t);if($(".global-dbCon input").removeClass("error"),!0!==o.res)return MsgTip("",common_js_lang["dbManage.info.hdfsParamErr"],"info"),!1;!a&&$(".global-dbCon .save").attr("data-id")&&(t.hid=$(".global-dbCon .save").attr("data-id"));var l=new FormData;l.append("delFlg",a?-1:0);for(k in t)l.append(k,t[k]);1==n?["coreSiteFile","hdfsSiteFile"].map(function(a){var t=e.find(".file."+a)[0].files[0];t&&l.append(a,t)}):["keytabFile","coreSiteFile","hdfsSiteFile","krb5File"].map(function(a){var t=e.find(".file."+a)[0].files[0];t&&l.append(a,t)}),$("#waitLoading").find("article").html(a?common_js_lang["dbManage.text.checkLink"]:common_js_lang["dbManage.text.saveLink"]).end().css({display:"block"}),$.ajax({url:a&&"hdfs/connect"||"hdfs/user/save",type:"post",contentType:!1,processData:!1,data:l,success:function(e){if(a){if(200!=e.code)return void $(".global-dbCon").find(".testRes").removeClass("right").addClass("err").html('<i class="fail"></i>'+common_js_lang["db.text.testFail"]+'<a class="showTip" data-info='+encodeURIComponent(JSON.stringify(e))+">"+common_js_lang["db.text.errTip"]+"</a>");$(".global-dbCon").find(".testRes").removeClass("err").addClass("right").html('<i class="suc"></i>'+common_js_lang["db.text.testSuc"])}else{if(200!=e.code)return void ErrTip(e.i18nMsg.title,e.i18nMsg.detail,e.msg);if(a)return void MsgTip({title:"SUCCESS",text:common_js_lang["dbManage.info.linkSucc"],type:"success",timer:2e3});MsgTip({title:"SUCCESS",text:common_js_lang["manage.title.succ"],type:"success",timer:2e3}),$(".global-dbCon, .global-mask").toggle(),2==$("nav a.cur").index()&&getHdfsList(globalParam.hdfsListParam)}},complete:function(a){$("#waitLoading").css({display:"none"})}})}function ftpUpdate(a){var e=$(".global-dbCon .ftp"),t={pid:$('.global-dbCon [data-key="pid"]').val()||"",delFlg:0};if(!t.pid)return MsgTip("",common_js_lang["db.info.selectApp"],"info"),!1;["host","port","protocol","userName","password","connName"].map(function(a){t[a]=e.find('[data-key="'+a+'"]').val().trim()}),t.connName=t.connName||["","FTP","SFTP"][t.protocol]+"_"+t.host+"_"+t.port,e.find('[data-key="connName"]').val(t.connName);var n=checkDbInfo(t);if($(".global-dbCon input").removeClass("error"),!0!==n.res)return MsgTip("",common_js_lang["dbManage.info.ftpParamErr"],"info"),!1;!a&&$(".global-dbCon .save").attr("data-id")&&(t.id=$(".global-dbCon .save").attr("data-id")),a&&($(".global-dbCon .save").attr("data-id")?t.oldpwd=e.find('[data-key="password"]').attr("data-pwd"):t.oldpwd=""),$("#waitLoading").find("article").html(a?common_js_lang["dbManage.text.checkLink"]:common_js_lang["dbManage.text.saveLink"]).end().css({display:"block"}),$.ajax({url:a&&"repo/ftp/connect"||"repo/ftp/save",type:"post",data:t,success:function(e){if(a){if(200!=e.code)return void $(".global-dbCon").find(".testRes").removeClass("right").addClass("err").html('<i class="fail"></i>'+common_js_lang["db.text.testFail"]+'<a class="showTip" data-info='+encodeURIComponent(JSON.stringify(e))+">"+common_js_lang["db.text.errTip"]+"</a>");$(".global-dbCon").find(".testRes").removeClass("err").addClass("right").html('<i class="suc"></i>'+common_js_lang["db.text.testSuc"])}else{if(200!=e.code)return void ErrTip(e.i18nMsg.title,e.i18nMsg.detail,e.msg);if(a)return void MsgTip({title:"SUCCESS",text:common_js_lang["dbManage.info.linkSucc"],type:"success",timer:2e3});MsgTip({title:"SUCCESS",text:common_js_lang["manage.title.succ"],type:"success",timer:2e3}),$(".global-dbCon, .global-mask").toggle(),4==$("nav a.cur").index()&&getFtpList(globalParam.ftpListParam)}},complete:function(a){$("#waitLoading").css({display:"none"})}})}function updateLink(a){$.ajax({url:"db/update",type:"post",contentType:"application/x-www-form-urlencoded",data:a,success:function(a){200==a.code?($(".global-dbCon, .global-mask").toggle(),MsgTip({title:"SUCCESS",text:common_js_lang["dbManage.info.updateSucc"],type:"success",timer:2e3}),getDBList(globalParam.dbListParam,$("nav a.cur").index())):ErrTip(a.i18nMsg.title,a.i18nMsg.detail,a.msg)},complete:function(){$("#waitLoading").css({display:"none"})}})}var tmpParam={dbListParam:{pageSize:10,pageNo:1,pid:"",dbType:""},hdfsListParam:{pageSize:10,pageNo:1},ftpListParam:{pageSize:10,pageNo:1},dbConfigParam:{},dbConfigParamOption:"",dbParamObj:{},hiveId:31,tmpParamHtml:"",defaultPort:{38:3306,52:3306,56:3306,4:1521,60:1521,40:1433,53:1433,57:1433,44:5e4,24:5432,54:5432,58:5432}};$.extend(globalParam,tmpParam),globalParam.tmpParamHtml+='<div class="tr thead clearfix"><div class="paramList">'+common_js_lang["dbManage.title.setParam"]+'</div><div class="key">'+common_js_lang["dbManage.title.nameParam"]+'</div><div class="val">'+common_js_lang["dbManage.title.val"]+'</div><div title="'+common_js_lang["clientList.option.del"]+'" class="act">'+common_js_lang["clientList.option.oper"]+"</div></div>";for(var i=0;i<5;i++)globalParam.tmpParamHtml+='<div class="tr clearfix '+(4==i?"last":"")+'"><div class="paramList"><select></select></div><div class="key"><input maxlength="30" type="text"></div><div class="val"><input maxlength="30" type="text"></div><div title="'+common_js_lang["clientList.option.del"]+'" class="act"><a><i class="del"></i></a></div></div>';$(".global-dbCon .tooltip").tipsy({fade:!0,gravity:"s",html:!0}),$("nav").on("click",'a:not(".cur")',function(){var a=$(this).index();$(this).addClass("cur").siblings().removeClass("cur"),$("#db-manage-list").empty(),globalParam.dbListParam.pageNo=1,globalParam.dbListParam.dbType="",[0,1,3].indexOf(a)>-1&&getDBList(globalParam.dbListParam,a),2==a&&getHdfsList(globalParam.hdfsListParam),4==a&&getFtpList(globalParam.ftpListParam)}),$("#userApp").on("change",function(a,e){if(!(["hive","spark"].indexOf($("#seltType"))>-1&&!e||!$(this).val())){var t=$(this).val();t&&$.ajax({url:"hdfs/list?pid="+t}).then(function(a){if(200==a.code){var t="";a.model.data.map(function(a){t+='<option value="'+a.id+'" data-authType="'+a.authType+'" data-principal="'+(a.principal||"")+'">'+a.connName+"</option>"}),$('.global-dbCon .hive [data-key="hid"]').val("").html(t),e&&$('.global-dbCon .hive [data-key="hid"]').val(e)}else ErrTip(a.i18nMsg.title,a.i18nMsg.detail,a.msg)})}}),$(".resource-type").on("change","#seltType",function(a,e){var t=$(this).val();$(".global-dbCon .column").addClass("hidden"),"spark"==t&&(t="hive"),$(".global-dbCon .column."+t).removeClass("hidden"),$(".tab span").eq(1).toggleClass("hidden",["hdfs","ftp"].indexOf(t)>-1),"hive"==t&&$("#userApp").trigger("change",e||0),$(".global-dbCon").find(".testRes").empty()}),$(".column.hdfs").on("click","label",function(){if(!$(this).find(".radio").hasClass("cur")){$(".column.hdfs label .radio").toggleClass("cur"),$(".column.hdfs .normal, .column.hdfs .kerberos").toggleClass("hidden");var a=$(this).find(".radio").data("val"),e=$('.column.hdfs [data-key="connName"]').val();2==a&&$('.column.hdfs [data-key="connName"]').attr("data-val1",e),1==a&&$('.column.hdfs [data-key="connName"]').attr("data-val2",e);var t=$('.column.hdfs [data-key="connName"]').attr("data-val"+a)||"";$('.column.hdfs [data-key="connName"]').val(t).removeClass("error")}}),$(".global-dbCon").on("click",".tab span",function(){if(!$(this).hasClass("cur")){if($(this).addClass("cur").siblings().removeClass("cur"),!([1].indexOf($(this).index())>-1)){$(".global-dbCon .param, .global-dbCon .newline").addClass("hidden"),$(".global-dbCon .columnTop").removeClass("hidden");var a=$("#seltType").val();return"spark"==a&&(a="hive"),$(".global-dbCon .column").addClass("hidden"),void $(".global-dbCon .column."+a).removeClass("hidden")}$(this).parents(".formCon").find(".column,.columnTop").addClass("hidden"),$(".global-dbCon .param, .global-dbCon .newline").removeClass("hidden");var e=$("#seltType").val();if(["hive","spark"].indexOf(e)>-1)t=globalParam.hiveId;else if(["hive","db"].indexOf(e)>-1){var t=$(".db-info [data-key='dbType']").val();[52,56].indexOf(+t)>-1&&(t=38),[53,57].indexOf(+t)>-1&&(t=40),"60"==t&&(t=4)}globalParam.dbConfigParam[t]||$.fn.ajaxAPI({url:"db/params",async:!1,data:{typeId:t},callback:function(a){globalParam.dbConfigParam[t]=a.model}}),updateDbParamList(globalParam.dbConfigParam[t])}}),getDBList(globalParam.dbListParam,0),$(".db-info").on("blur","input",function(){if(1!=$(this).parents(".column").find(".authType").length&&!$(this).parents(".column").hasClass("ftp")){var a=$(this).attr("data-key"),e=($(this).val()||"").trim(),t={};if(t[a]=e,"url"===a&&""===e){n=getUrlParam($(this));return $(this).parents(".column").find('[data-key="url"]').val(getlinkUrl(n)).removeClass("error"),!1}if(!0!==checkDbInfo(t).res)return $(this).addClass("error"),!1;if($(this).removeClass("error"),!$(this).parents(".column").hasClass("ftp")&&["host","port","dbName","zkhost","zkport","zooKeeperNamespace"].indexOf(a)>-1){var n=getUrlParam($(this)),o="";$(this).parents(".column").hasClass("hdfs")&&(o=".normal"),$(this).parents(".column").find(o+' [data-key="url"]').val(getlinkUrl(n)).removeClass("error")}}}),$(".db-info").on("change",'[data-key="dbType"]',function(){$(this).attr("data-key");var a=$(this).val();$('.column.db [data-key="port"]').val(globalParam.defaultPort[a]);var e=getUrlParam($(this));return $(this).parents(".column").find('[data-key="url"]').val(getlinkUrl(e)).removeClass("error"),!1}),$(".column.hive").on("change",'[data-key="mode"]',function(){"0"==$(this).val()?($(".column.hive").find(".mode").show(),$(".column.hive").find(".mode.ha").hide()):($(".column.hive").find(".mode").hide(),$(".column.hive").find(".mode.ha").show());var a=getUrlParam($(this));$(this).parents(".column").find('[data-key="url"]').val(getlinkUrl(a)).removeClass("error")}),$(".column.hive").on("click",".add",function(){var a=$(".column.hive").find(".ha.zk"),e=a.length,t=a.eq(e-1),n=t.clone();n.find(".add").removeClass("add").addClass("del").text(common_js_lang["clientList.option.del"]),t.after(n);var o=getUrlParam($(".column.hive").find('[data-key="mode"]'));$(".column.hive").find('[data-key="mode"]').parents(".column").find('[data-key="url"]').val(getlinkUrl(o)).removeClass("error")}),$(".column.hive").on("click",".del",function(){$(this).parent().remove();var a=getUrlParam($(".column.hive").find('[data-key="mode"]'));$(".column.hive").find('[data-key="mode"]').parents(".column").find('[data-key="url"]').val(getlinkUrl(a)).removeClass("error")}),$(".column.hive").on("change",'[data-key="hid"]',function(){var a=getUrlParam($(this));$(this).parents(".column").find('[data-key="url"]').val(getlinkUrl(a)).removeClass("error")}),$(".global-dbCon").on("focus",".last .key",function(){$(this).parent(".tr").removeClass("last"),$(this).parents(".param").append('<div class="tr clearfix last"><div class="paramList"><select>'+globalParam.dbConfigParamOption+'</select></div><div class="key"><input maxlength="30" type="text"></div><div class="val"><input maxlength="30" type="text"></div><div title="'+common_js_lang["clientList.option.del"]+'" class="act"><a><i class="del"></i></a></div></div>')}),$(".global-dbCon").on("click",".newline",function(){$(".global-dbCon .param").find(".tr.last").removeClass("last"),$(".global-dbCon .param").append('<div class="tr clearfix last"><div class="paramList"><select>'+globalParam.dbConfigParamOption+'</select></div><div class="key"><input maxlength="30" type="text"></div><div class="val"><input maxlength="30" type="text"></div><div title="'+common_js_lang["clientList.option.del"]+'" class="act"><a><i class="del"></i></a></div></div>')}),$(".global-dbCon").on("change",".paramList select",function(){if(+$(this).val()||0){var a=$(this).parents(".tr"),e=$(this).find("option:selected");a.find(".key input").val(e.data("name")).prop("readOnly",!0),a.find(".val input").val(e.data("defvalue"))}else(a=$(this).parents(".tr")).find(".key input").prop("readOnly",!1),a.find(".key input, .val input").val("")}),$(".global-dbCon").on("click",".param .del",function(){var a=$(this).parents(".tr"),e=a.parent();swal({title:"",text:common_js_lang["dbManage.info.delParam"],type:"info",showCancelButton:!0},function(){a.hasClass("last")?2==e.find(".tr").length?a.find("input").val(""):(a.remove(),e.find(".tr:last-child").addClass("last")):a.remove()})}),$(".global-dbCon").on("focus",".param .val input",function(){if(!$(this).parents(".tr").find(".key input").val().trim())return MsgTip("",common_js_lang["dbManage.info.paramName"],"info"),$(this).blur(),!1}),$(".global-dbCon").on("click",".btn-cancel, .cancel",function(){$(".global-dbCon, .global-mask").fadeOut()}),$(".global-dbCon").on("click",".save",function(){var a=$("#seltType").val();if("spark"==a&&(a="hive"),"hdfs"!=a)if("ftp"!=a){var e={pid:$('.global-dbCon [data-key="pid"]').val()};if(!e.pid)return MsgTip("",common_js_lang["db.info.selectApp"],"info"),!1;if("db"==$("#seltType").val())e.dbType=$(".global-dbCon ."+a+' [data-key="dbType"]').val(),e.host=$(".global-dbCon ."+a+' [data-key="host"]').val().trim(),e.port=$(".global-dbCon ."+a+' [data-key="port"]').val().trim(),e.dbName=$(".global-dbCon ."+a+' [data-key="dbName"]').val().trim(),e.userName=$(".global-dbCon ."+a+' [data-key="userName"]').val().trim(),e.password=($(".global-dbCon ."+a+' [data-key="password"]').val()||"").trim();else if(e.dbType="hive"==$("#seltType").val()?globalParam.hiveId:62,1==$(".global-dbCon ."+a+' [data-key="mode"]').val()){for(var t=$(".column.hive"),n=t.find('[data-key="zkhost"]'),o=t.find('[data-key="zkport"]'),l=t.find('[data-key="serviceDiscoveryMode"]').val(),i=t.find('[data-key="zooKeeperNamespace"]').val().trim(),d=[],s=0,r=n.length;s<r;s++){var m=n.eq(s).val().trim(),c=o.eq(s).val().trim();if(!m)return n.eq(s).addClass("error"),!1;if(!c.match(/^[1-9]\d*$/g))return o.eq(s).addClass("error"),!1;d.push(m+":"+c)}e.host=d.join(","),e.port=o.eq(0).val().trim(),e.serviceDiscoveryMode=l,e.zooKeeperNamespace=i,e.hid=$(".global-dbCon ."+a+' [data-key="hid"]').val()||"",e.userName=$(".global-dbCon ."+a+' [data-key="userName"]').val().trim()}else e.hid=$(".global-dbCon ."+a+' [data-key="hid"]').val()||"",e.host=$(".global-dbCon ."+a+' [data-key="host"]').val().trim(),e.port=$(".global-dbCon ."+a+' [data-key="port"]').val().trim(),e.userName=$(".global-dbCon ."+a+' [data-key="userName"]').val().trim();e.url=$(".global-dbCon ."+a+' [data-key="url"]').val().trim(),e.connName=$(".global-dbCon ."+a+' [data-key="connName"]').val().trim(),e.connName=e.connName||e.host+"_"+e.port+(e.dbName?"_"+e.dbName:""),$(".global-dbCon ."+a+' [data-key="connName"]').val(e.connName);var p=checkDbInfo(e);if($(".global-dbCon input").removeClass("error"),"db"!=a&&(e.password=($(".global-dbCon ."+a+' [data-key="password"]').val()||"").trim(),e.dbName=""),!0!==p.res)return $(".global-dbCon ."+a+' [data-key="'+p.key+'"]').addClass("error"),!1;var g=getUrlParam($(".global-dbCon ."+a+' [data-key="port"]'));if(!(p=checkUrl(getlinkUrl(g),g,e.url)).res)return MsgTip("",common_js_lang["dbManage.check."+p.tag],"info"),!1;for(var b=$('.global-dbCon .param .tr:not(".thead")'),f=b.length,v={},s=0;s<f;s++){var u=b.eq(s).find(".key input").val().trim(),h=b.eq(s).find(".val input").val().trim();if(!u&&h)return MsgTip("",common_js_lang["dbManage.info.nameNone"],"info"),!1;if(u){if(void 0!==v[u])return MsgTip("","["+u+"]"+common_js_lang["dbManage.info.sameKey"],"info"),!1;v[u]=h}}e.params=JSON.stringify(v),$("#waitLoading").find("article").html(common_js_lang["dbManage.text.saveLink"]).end().css({display:"block"});var y=$.Deferred();"db"!=$("#seltType").val()?$.ajax({url:"db/hive/check/cluster",data:{hiveHost:e.host,hdfsId:e.hid},success:function(a){if(-1==[-1,200].indexOf(a.code))return-2!=a.code?(ErrTip(a.i18nMsg.title,a.i18nMsg.detail,a.msg),void y.reject()):void swal({title:"",text:a.i18nMsg.detail,type:"info",confirmButtonText:common_js_lang["dbManage.btn.continue"],showCancelButton:!0},function(a){a?y.resolve():y.reject()});200==a.code&&y.resolve()},error:function(){y.reject()}}):y.resolve();var k=$(this);$.when(y).done(function(){k.attr("data-id")?(e.id=k.attr("data-id"),updateLink(e)):$.ajax({url:"db/add",type:"post",contentType:"application/x-www-form-urlencoded",data:e,success:function(a){200==a.code?(MsgTip({title:"SUCCESS",text:common_js_lang["dbManage.info.addSucc"],type:"success",timer:2e3}),$(".global-dbCon, .global-mask").toggle(),[0,1,3].indexOf(+$("nav a.cur").index())>-1&&getDBList(globalParam.dbListParam,$("nav a.cur").index())):ErrTip(a.i18nMsg.title,a.i18nMsg.detail,a.msg)},complete:function(a){$("#waitLoading").css({display:"none"})}})}).fail(function(){$("#waitLoading").css({display:"none"})})}else ftpUpdate();else hdfsUpdate()}),$(".testRes").on("click",".showTip",function(){var a=JSON.parse(decodeURIComponent($(this).attr("data-info")));ErrTip(a.i18nMsg.title,a.i18nMsg.detail,a.msg)}),$(".global-dbCon").on("click",".testConnect",function(){var a=$("#seltType").val();if("spark"==a&&(a="hive"),"hdfs"!=a)if("ftp"!=a){var e={pid:$('.global-dbCon [data-key="pid"]').val()};if(!e.pid)return MsgTip("",common_js_lang["db.info.selectApp"],"info"),!1;if("db"==$("#seltType").val())e.dbType=$(".global-dbCon ."+a+' [data-key="dbType"]').val(),e.host=$(".global-dbCon ."+a+' [data-key="host"]').val().trim(),e.port=$(".global-dbCon ."+a+' [data-key="port"]').val().trim(),e.dbName=$(".global-dbCon ."+a+' [data-key="dbName"]').val().trim(),e.userName=$(".global-dbCon ."+a+' [data-key="userName"]').val().trim(),e.password=($(".global-dbCon ."+a+' [data-key="password"]').val()||"").trim();else if(e.dbType="hive"==$("#seltType").val()?globalParam.hiveId:62,1==$(".global-dbCon ."+a+' [data-key="mode"]').val()){for(var t=$(".column.hive"),n=t.find('[data-key="zkhost"]'),o=t.find('[data-key="zkport"]'),l=t.find('[data-key="serviceDiscoveryMode"]').val(),i=t.find('[data-key="zooKeeperNamespace"]').val().trim(),d=[],s=0,r=n.length;s<r;s++){var m=n.eq(s).val().trim(),c=o.eq(s).val().trim();if(!m)return n.eq(s).addClass("error"),!1;if(!c.match(/^[1-9]\d*$/g))return o.eq(s).addClass("error"),!1;d.push(m+":"+c)}e.host=d.join(","),e.port=o.eq(0).val().trim(),e.serviceDiscoveryMode=l,e.zooKeeperNamespace=i,e.hid=$(".global-dbCon ."+a+' [data-key="hid"]').val()||"",e.userName=$(".global-dbCon ."+a+' [data-key="userName"]').val().trim()}else e.hid=$(".global-dbCon ."+a+' [data-key="hid"]').val()||"",e.host=$(".global-dbCon ."+a+' [data-key="host"]').val().trim(),e.port=$(".global-dbCon ."+a+' [data-key="port"]').val().trim(),e.userName=$(".global-dbCon ."+a+' [data-key="userName"]').val().trim();e.url=$(".global-dbCon ."+a+' [data-key="url"]').val().trim(),e.connName=$(".global-dbCon ."+a+' [data-key="connName"]').val().trim(),e.connName=e.connName||e.host+"_"+e.port+(e.dbName?"_"+e.dbName:""),$(".global-dbCon ."+a+' [data-key="connName"]').val(e.connName);var p=checkDbInfo(e);if($(".global-dbCon input").removeClass("error"),"db"!=a&&(e.password=($(".global-dbCon ."+a+' [data-key="password"]').val()||"").trim(),e.dbName=""),!0!==p.res)return $(".global-dbCon ."+a+' [data-key="'+p.key+'"]').addClass("error"),!1;var g=getUrlParam($(".global-dbCon ."+a+' [data-key="port"]'));if(!(p=checkUrl(getlinkUrl(g),g,e.url)).res)return MsgTip("",common_js_lang["dbManage.check."+p.tag],"info"),!1;for(var b=$('.global-dbCon .param .tr:not(".thead")'),f=b.length,v={},s=0;s<f;s++){var u=b.eq(s).find(".key input").val().trim(),h=b.eq(s).find(".val input").val().trim();if(!u&&h)return MsgTip("",common_js_lang["dbManage.info.nameNone"],"info"),!1;if(u){if(void 0!==v[u])return MsgTip("","["+u+"]"+common_js_lang["dbManage.info.sameKey"],"info"),!1;v[u]=h}}e.params=JSON.stringify(v);var y=$(".global-dbCon .save").attr("data-id")||"";e.oldpwd=y?$(".global-dbCon ."+a+' [data-key="password"]').attr("data-pwd"):"";var k=$(this);$("#waitLoading").find("article").html(common_js_lang["dbManage.text.checkLink"]).end().css({display:"block"});var C=$.Deferred();"db"!=$("#seltType").val()?$.ajax({url:"db/hive/check/cluster",data:{hiveHost:e.host,hdfsId:e.hid},success:function(a){if(-1==[-1,200].indexOf(a.code))return-2!=a.code?(ErrTip(a.i18nMsg.title,a.i18nMsg.detail,a.msg),void C.reject()):void swal({title:"",text:a.i18nMsg.detail,type:"info",confirmButtonText:common_js_lang["dbManage.btn.continue"],showCancelButton:!0},function(a){a?C.resolve():C.reject()});200==a.code&&C.resolve()},error:function(){C.reject()}}):C.resolve(),$.when(C).done(function(a){var t=k.parent();t.find(".testRes").empty(),$.ajax({url:"db/connect",type:"post",contentType:"application/x-www-form-urlencoded",data:e,success:function(a){200==a.code?t.find(".testRes").removeClass("err").addClass("right").html('<i class="suc"></i>'+common_js_lang["db.text.testSuc"]):t.find(".testRes").removeClass("right").addClass("err").html('<i class="fail"></i>'+common_js_lang["db.text.testFail"]+'<a class="showTip" data-info='+encodeURIComponent(JSON.stringify(a))+">"+common_js_lang["db.text.errTip"]+"</a>")},complete:function(){$("#waitLoading").css({display:"none"})}})}).fail(function(){$("#waitLoading").css({display:"none"})})}else ftpUpdate(!0);else hdfsUpdate(!0)}),$(".global-dbCon").on("change",".column.hdfs input:file",function(a){var e=$(this)[0].files[0].name;$(this).parents(".upload").find("> input").val(e).attr("title",e)}),$(".column.ftp").on("change",'[data-key="protocol"]',function(){1==$(this).val()?$('.column.ftp [data-key="port"]').val(21):$('.column.ftp [data-key="port"]').val(22)}),$(".innerCon nav").on("click",".add-link",function(){$(".global-dbCon h4 .title").html(common_js_lang["dbManage.title.newRes"]),$(".global-dbCon input").val("").removeClass("error"),$('.db.column [data-key="dbType"]').change(),$(".db-info .save").attr("data-id",""),$('.column.hdfs [data-key="connName"]').attr("data-val1","").attr("data-val2",""),$(".global-dbCon #seltType").prop("disabled",!1),$('.global-dbCon .param .tr:not(".thead")').remove(),$(".global-dbCon .param").html(globalParam.tmpParamHtml),$(".global-dbCon .tab span").eq(0).click();var a=$("nav a.cur").data("type");$("#seltType").val(a).change(),$('.column.ftp [data-key="protocol"]').change(),$(".column.hive .ha.zk .del").parent().remove(),$(".global-dbCon, .global-mask").fadeIn(),$("#userApp").select2(),$(".global-dbCon").find(".testRes").empty()}),$(".db-manage").on("click","a.edit",function(){$(".global-dbCon input").val("").removeClass("error"),$(".column.hive .ha.zk .del").parent().remove(),$('.column.hdfs [data-key="connName"]').attr("data-val1","").attr("data-val2",""),$(".global-dbCon #seltType").prop("disabled",!0);var a=$(this).parents("tr").data("val"),e={id:a.id,pid:a.pid,hid:a.hid,authType:a.authType,password:a.password,userName:a.userName,host:a.host,port:a.port,dbType:a.dbType,dbName:a.dbName||"",url:a.url,connName:a.connName,keytab:a.keytab,principal:a.principal,coreSiteXml:a.coreSiteXml,hdfsSiteXml:a.hdfsSiteXml,krb5Conf:a.krb5Conf,protocol:a.protocol,ha:a.ha};if($(".columnTop #userApp").val(e.pid).select2(),e.authType){$(".global-dbCon #seltType").val("hdfs").change(),(n=$(".global-dbCon .column.hdfs")).find('.authType [data-val="'+e.authType+'"]').click();var t=["keytab","principal","connName","coreSiteXml","hdfsSiteXml","krb5Conf"];1==e.authType&&(t=["userName","connName","coreSiteXml","hdfsSiteXml"]);for(o in e)-1!=t.indexOf(o)&&n.find('[data-key="'+o+'"]').val(e[o]);["keytab","coreSiteXml","hdfsSiteXml","krb5Conf"].map(function(a){n.find('[data-key="'+a+'"]').attr("title",e[a])})}else if(e.protocol){$(".global-dbCon #seltType").val("ftp").change();n=$(".global-dbCon .column.ftp");["host","port","protocol","userName","password","connName"].map(function(a){n.find('[data-key="'+a+'"]').val(e[a])}),n.find('[data-key="password"]').attr("data-pwd",e.password)}else{if(e.dbType==globalParam.hiveId)$(".global-dbCon #seltType").val("hive").trigger("change",e.hid);else if(62==e.dbType)$(".global-dbCon #seltType").val("spark").trigger("change",e.hid);else{$(".global-dbCon #seltType").val("db").change();n=$(".global-dbCon .column.db")}if([globalParam.hiveId,62].indexOf(+e.dbType)>-1){var n=$(".global-dbCon .column.hive");e.ha?n.find('[data-key="mode"]').val("1").change():n.find('[data-key="mode"]').val("0").change()}if(e.ha){e.serviceDiscoveryMode=a.haParams.serviceDiscoveryMode||"",e.zooKeeperNamespace=a.haParams.zooKeeperNamespace||"";for(var o in e)["connName","url","userName","serviceDiscoveryMode","zooKeeperNamespace"].indexOf(o)>-1&&n.find('[data-key="'+o+'"]').val(e[o]);try{for(var l=e.host.split(","),i=l.length,d=0;d<i;d++){var s=l[d].split(":"),r=s.slice(0,-1).join(":"),m=s.slice(-1)[0];if(0!=d){var c=$(".column.hive").find(".ha.zk"),p=c.length,g=c.eq(p-1),b=g.clone();b.find(".add").removeClass("add").addClass("del").text(common_js_lang["clientList.option.del"]),b.find('[data-key="zkhost"]').val(r),b.find('[data-key="zkport"]').val(m),g.after(b)}else n.find('[data-key="zkhost"]').val(r),n.find('[data-key="zkport"]').val(m)}}catch(a){}}else{for(var o in e)["connName","url","host","port","dbName","userName","password","dbType"].indexOf(o)>-1&&n.find('[data-key="'+o+'"]').val(e[o]);n.find('[data-key="password"]').attr("data-pwd",e.password)}$('.global-dbCon .param .tr:not(".thead")').remove();var f=a.params,v=0;for(var o in f)v++;var u="";if(0==v)for(d=0;d<5;d++)u+='<div class="tr clearfix '+(4==d?"last":"")+'"><div class="paramList"><select></select></div><div class="key"><input maxlength="30" type="text"></div><div class="val"><input maxlength="30" type="text"></div><div title="'+common_js_lang["clientList.option.del"]+'" class="act"><a><i class="del"></i></a></div></div>';else for(o in f)u+='<div class="tr clearfix '+(0==--v?"last":"")+'"><div class="paramList"><select></select></div><div class="key"><input maxlength="30" type="text" value="'+o+'"></div><div class="val"><input maxlength="30" type="text" value="'+f[o]+'"></div><div title="'+common_js_lang["clientList.option.del"]+'" class="act"><a><i class="del"></i></a></div></div>';$(".global-dbCon .param .thead").after(u)}$(".global-dbCon h4 .title").html(common_js_lang["dbManage.title.resEdit"]),$(".global-dbCon .tab span").eq(0).click(),$(".global-dbCon .save").attr("data-id",e.id),$(".global-dbCon, .global-mask").fadeIn(),$("#userApp").select2(),$(".global-dbCon").find(".testRes").empty()}),$(".db-manage").on("click","a.del",function(){var a=$(this),e=a.parents("tr").attr("data-id"),t="";a.hasClass("db")||a.hasClass("hive")?(t+='<div class="tip">'+common_js_lang["dbManage.info.del2Task"]+":</div>",$.fn.ajaxAPI({url:"db/rely/jobs?dbId="+e,async:!1,callback:function(a){t+='<div class="tip">'+common_js_lang["dbManage.text.have"]+"["+a.model.length+"]"+common_js_lang["dbManage.text.task"]+"</div>",a.model.map(function(a){t+='<div class="tip-item">[id:'+a.id+" -> "+common_js_lang["dbManage.text.taskName"]+":"+a.jobName+"]</div>"})}})):a.hasClass("hdfs")?(t+='<div class="tip">'+common_js_lang["dbManage.info.del2hive"]+":</div>",$.fn.ajaxAPI({url:"hdfs/rely/hives?hdfsId="+e,async:!1,callback:function(a){t+='<div class="tip">'+common_js_lang["dbManage.text.have"]+"["+a.model.length+"]"+common_js_lang["dbManage.text.hiveMount"]+"</div>",a.model.map(function(a){t+='<div class="tip-item">[id:'+a.id+" -> "+common_js_lang["dbManage.option.connName"]+":"+a.connName+"]</div>"})}}),t+='<div class="tip">'+common_js_lang["dbManage.info.del2Task"]+":</div>",$.fn.ajaxAPI({url:"hdfs/rely/jobs?hdfsId="+e,async:!1,callback:function(a){t+='<div class="tip">'+common_js_lang["dbManage.text.have"]+"["+a.model.length+"]"+common_js_lang["dbManage.text.task"]+"</div>",a.model.map(function(a){t+='<div class="tip-item">[id:'+a.id+" -> "+common_js_lang["dbManage.text.taskName"]+":"+a.jobName+"]</div>"})}})):a.hasClass("ftp")&&(t+='<div class="tip">'+common_js_lang["dbManage.info.del2Task"]+":</div>",$.fn.ajaxAPI({url:"repo/ftp/rely/jobs?ftpId="+e,async:!1,callback:function(a){t+='<div class="tip">'+common_js_lang["dbManage.text.have"]+"["+a.model.length+"]"+common_js_lang["dbManage.text.task"]+"</div>",a.model.map(function(a){t+='<div class="tip-item">[id:'+a.id+" -> "+common_js_lang["dbManage.text.taskName"]+":"+a.jobName+"]</div>"})}})),swal({html:!0,title:"",text:common_js_lang["dbManage.info.isDelLink"]+" "+t,type:"info",showCancelButton:!0},function(){var t="db/delete",n={id:e};a.hasClass("hdfs")&&(t="hdfs/user/delete",n={hdfsId:e}),a.hasClass("ftp")&&(t="repo/ftp/delete",n={ftpId:e}),$.fn.ajaxAPI({url:t,type:"post",contentType:"application/x-www-form-urlencoded",data:n,callback:function(){MsgTip({title:"SUCCESS",text:common_js_lang["manage.info.delSucc"],type:"success",timer:2e3}),$("#db-manage-list tbody tr").length<=1&&(globalParam.dbListParam.pageNo=globalParam.dbListParam.pageNo-1||1,globalParam.hdfsListParam.pageNo=globalParam.hdfsListParam.pageNo-1||1,globalParam.ftpListParam.pageNo=globalParam.ftpListParam.pageNo-1||1)},complete:function(){[0,1,3].indexOf(+$("nav a.cur").index())>-1&&getDBList(globalParam.dbListParam,$("nav a.cur").index()),2==$("nav a.cur").index()&&getHdfsList(globalParam.hdfsListParam),4==$("nav a.cur").index()&&getFtpList(globalParam.ftpListParam)}})})});