function initAct(){if(globalParam.targetType!=globalParam.commonLinkType.hdfs){var a={mysql:common_js_lang["db.text.mysql"],oracle:common_js_lang["db.text.oracle"],db2:common_js_lang["db.text.db2"],mssql:common_js_lang["db.text.mssql"],psql:common_js_lang["db.text.psql"]},e={mysql:common_js_lang["db.text.Amysql"],oracle:common_js_lang["db.text.Aoracle"],db2:common_js_lang["db.text.Adb2"],mssql:common_js_lang["db.text.Amssql"],psql:common_js_lang["db.text.Apsql"]},t={38:"mysql",52:"mysql",56:"mysql",4:"oracle",60:"oracle",40:"mssql",53:"mssql",57:"mssql",44:"db2",24:"psql",54:"psql",58:"psql"},n=$('.choose-link [data-key="dbType"]').val(),l=1==globalParam.urlObj.type?a:e;$(".tip .dbtip span").html(l[t[n]]),$(".stepCon .item2 h3 i.tip").html(common_js_lang["db.note.tableNote"])}else $(".stepCon .item2 h3 i.tip").html(common_js_lang["db.note.hdfsNote"])}function getDBList(a){if(!$("#userApp").val())return!1;var e=a;$.fn.ajaxAPI({url:"db/list?pid="+$("#userApp").val(),data:a,callback:function(a){var t=[];a.model.data=a.model.data.map(function(a){return a.val=JSON.stringify(a),a.paramsVal=JSON.stringify(a.params),t.push(a),a}),globalParam.urlConnectList=a.model.data;var n='<option value="" disabled>'+common_js_lang["db.info.dbLinkErr"]+"</option>";n+=template("template/options",{data:t}),$(".source .linkList").html(n).val("").select2(),e.id&&$(".source .linkList").val(e.id).change()}})}function getUrlParam(a){var e=a.parents("ul");return{dbType:(e.find('[data-key="dbType"]').val()||"").trim(),host:(e.find('[data-key="host"]').val()||"").trim(),port:(e.find('[data-key="port"]').val()||"").trim(),dbName:(e.find('[data-key="dbName"]').val()||"").trim()}}function getlinkUrl(a){return[38,52,56].indexOf(+a.dbType)>-1?"jdbc:mysql://"+a.host+":"+a.port+"/"+a.dbName:[4,55,60].indexOf(+a.dbType)>-1?"jdbc:oracle:thin:@"+a.host+":"+a.port+":"+a.dbName:[40,53,57].indexOf(+a.dbType)>-1?"jdbc:sqlserver://"+a.host+":"+a.port+";DatabaseName="+a.dbName:44==a.dbType?"jdbc:db2://"+a.host+":"+a.port+"/"+a.dbName:[24,54,58].indexOf(+a.dbType)>-1?"jdbc:postgresql://"+a.host+":"+a.port+"/"+a.dbName:void 0}function checkDbInfo(a){for(var e in a)if("id"!==e&&("connName"!==e||""!==a.connName)){if("port"===e&&!a.port.match(/^[1-9][0-9]*$/g))return{res:!1,key:e};if(""===a[e])return{res:!1,key:e}}return{res:!0}}function getConnect(a,e){var t=$("#userApp").val(),n=$("#targetType").val(),l="db/list",e=e||31,i="";n==globalParam.commonLinkType.hdfs?l="hdfs/list":i=4,n==globalParam.commonLinkType.spark&&(e=62),n>globalParam.commonLinkType.spark&&(i=1),t&&$.fn.ajaxAPI({url:l+"?pid="+t+"&groups="+i+"&dbType="+e,callback:function(e){var t='<option value="" disabled>'+common_js_lang["db.info.selectLink"]+"</option>";n==globalParam.commonLinkType.hdfs&&adminConfigData.hdfs.id&&(t+='<option value="'+adminConfigData.hdfs.id+'" data-val="'+encodeURIComponent(JSON.stringify(adminConfigData.hdfs))+'">'+adminConfigData.hdfs.connName+"</option>"),n==globalParam.commonLinkType.hive&&adminConfigData.hive.id&&(t+='<option value="'+adminConfigData.hive.id+'" data-val="'+encodeURIComponent(JSON.stringify(adminConfigData.hive))+'">'+adminConfigData.hive.connName+"</option>"),e.model.data.map(function(a){t+='<option value="'+a.id+'" data-val="'+encodeURIComponent(JSON.stringify(a))+'">'+a.connName+"</option>"}),n==globalParam.commonLinkType.hdfs&&$('.upload-type .column.hive [data-key="hid"]').html(t).val("").find("option").eq(0).text(" "),a||$(".upload-type .connId").html(t).val("").select2().change(),a&&8==globalParam.editJobModel.toType&&n==globalParam.commonLinkType.hdfs&&$(".upload-type .connId").html(t).val(a).select2().change(),a&&[9,13].indexOf(+globalParam.editJobModel.toType)>-1&&n!=globalParam.commonLinkType.hdfs&&$(".upload-type .connId").html(t).val(a).select2().change(),a&&[9,13].indexOf(+globalParam.editJobModel.toType)>-1&&n==globalParam.commonLinkType.hdfs&&$(".upload-type .connId").val(a).select2().change(),a&&-1==[8,9,13].indexOf(+globalParam.editJobModel.toType)&&n>globalParam.commonLinkType.spark&&$(".upload-type .connId").html(t).val(a).select2().change()}})}function checkUrl(a,e,t){var n={res:!1,tag:"e"};try{if(0==t.indexOf(a))return n.res=!0,n;if([38,52,56].indexOf(+e.dbType)>-1)return n.tag="type","jdbc:mysql://"!==t.slice(0,13)?n:(n.tag="host",(i=(l=(t=t.substr(13)).split("/"))[0].split(":"))[0]!==e.host?n:(n.tag="port",i[1]=i.splice(1).join(":"),i[1]!==e.port?n:(n.tag="dbName",0!=l.splice(1).join("/").indexOf(e.dbName)?n:(n.res=!0,n))));if([4,55,60].indexOf(+e.dbType)>-1)return n.tag="type","jdbc:oracle:thin:@"!==t.slice(0,18)?n:(n.tag="host",(l=(t=t.substr(18)).split(":"))[0]!==e.host?n:(n.tag="port",l[1]!==e.port?n:(n.tag="dbName",0!=l.splice(2).join(":").indexOf(e.dbName)?n:(n.res=!0,n))));if([40,53,57].indexOf(+e.dbType)>-1)return n.tag="type","jdbc:sqlserver://"!==t.slice(0,17)?n:(n.tag="host",(i=(l=(t=t.substr(17)).split(";"))[0].split(":"))[0]!==e.host?n:(n.tag="port",i[1]=i.splice(1).join(":"),i[1]!==e.port?n:(l[1]=l.splice(1).join(";"),n.tag="dbName",0!=l[1].indexOf("DatabaseName="+e.dbName)?n:(n.res=!0,n))));if(44==e.dbType)return n.tag="type","jdbc:db2://"!==t.slice(0,11)?n:(n.tag="host",(i=(l=(t=t.substr(11)).split("/"))[0].split(":"))[0]!==e.host?n:(n.tag="port",i[1]=i.splice(1).join(":"),i[1]!==e.port?n:(l[1]=l.splice(1).join("/"),n.tag="dbName",0!=l[1].indexOf(e.dbName)?n:(n.res=!0,n))));if([24,54,58].indexOf(+e.dbType)>-1){if(n.tag="type","jdbc:postgresql://"!==t.slice(0,18))return n;n.tag="host";var l=(t=t.substr(18)).split("/"),i=l[0].split(":");return i[0]!==e.host?n:(n.tag="port",i[1]=i.splice(1).join(":"),i[1]!==e.port?n:(l[1]=l.splice(1).join("/"),n.tag="dbName",0!=l[1].indexOf(e.dbName)?n:(n.res=!0,n)))}}catch(a){}return n}function testHdfsConnect(a,e){var t=new FormData;t.append("hid",a.id);var n=setTimeout(function(){0==$("#loadCon").length&&$("body").append("<div id='loadCon' style='position:fixed;z-index:99 ;height:100%;width:100%;top:0;left:0; background:rgba(255,255,255, .3);'><div style='width:20%;margin:20% 40%;text-align:center;height:80px;line-height:80px;'><img src='resources/dist/images/loading.gif'></div></div>")},2e3);$.ajax({url:"hdfs/connect",type:"post",contentType:!1,processData:!1,data:t,success:function(a){200==a.code?e.find(".testRes").removeClass("err").addClass("right").html('<i class="suc"></i>'+common_js_lang["db.text.testSuc"]):e.find(".testRes").removeClass("right").addClass("err").html('<i class="fail"></i>'+common_js_lang["db.text.testFail"]+'<a class="showTip" data-info='+encodeURIComponent(JSON.stringify(a))+">"+common_js_lang["db.text.errTip"]+"</a>")},complete:function(a){clearInterval(n),$("#loadCon").remove()}})}function testDbConnect(a,e){if(-1==a.delFlg){var t=getUrlParam($('.item1 .source [data-key="port"]')),n=checkUrl(getlinkUrl(t),t,a.url);if(!n.res)return MsgTip("",common_js_lang["dbManage.check."+n.tag],"info"),!1}var l=setTimeout(function(){0==$("#loadCon").length&&$("body").append("<div id='loadCon' style='position:fixed;z-index:99 ;height:100%;width:100%;top:0;left:0; background:rgba(255,255,255, .3);'><div style='width:20%;margin:20% 40%;text-align:center;height:80px;line-height:80px;'><img src='resources/dist/images/loading.gif'></div></div>")},2e3);$.ajax({url:"db/connect",type:"post",contentType:"application/x-www-form-urlencoded",data:-1==a.delFlg?a:{id:a.id},success:function(a){200==a.code?e.find(".testRes").removeClass("err").addClass("right").html('<i class="suc"></i>'+common_js_lang["db.text.testSuc"]):e.find(".testRes").removeClass("right").addClass("err").html('<i class="fail"></i>'+common_js_lang["db.text.testFail"]+'<a class="showTip" data-info='+encodeURIComponent(JSON.stringify(a))+">"+common_js_lang["db.text.errTip"]+"</a>")},complete:function(a){clearInterval(l),$("#loadCon").remove()}})}function hdfsAuthToggle(a,e){var t=$(".upload-type .column.hdfs");t.find(".radio").removeClass("cur").eq(+a-1).addClass("cur"),t.find(".kerberos, .normal").addClass("hidden"),2==a?t.find(".kerberos").removeClass("hidden"):t.find(".normal").removeClass("hidden"),2==a&&e==adminConfigData.hdfs.id&&t.find(".admin").addClass("hidden")}function resetDestConn(a,e){if(a.authType){hdfsAuthToggle(a.authType,a.id);var t=["keytab","principal","connName","coreSiteXml","hdfsSiteXml","krb5Conf"];2!=a.authType&&(t=["userName","connName","coreSiteXml","hdfsSiteXml"]);for(var n in a)-1!=t.indexOf(n)&&e.find('[data-key="'+n+'"]').val(a[n]);if(3==a.authType){l=$("#userApp").val();common_project[l].proxyUser&&e.find('[data-key="userName"]').val(common_project[l].proxyUser)}}else if(a.hid){a.ha&&(a.host=a.host.split(",").map(function(a,e){return a.split(":")[0]}).join(","));for(var n in a)["connName","url","host","port","userName","password","hid"].indexOf(n)>-1&&e.find('[data-key="'+n+'"]').val(a[n]);e.find('[data-key="host"]').attr("title",a.host),e.find('[data-key="url"]').attr("title",a.url);var l=$("#userApp").val();a.id==adminConfigData.hive.id&&e.find('[data-key="userName"]').val(common_project[l].proxyUser),e.find('[data-key="hid"]').change()}else for(var n in a)["dbType","dbName","connName","url","host","port","userName","password"].indexOf(n)>-1&&e.find('[data-key="'+n+'"]').val(a[n])}function noDataShow(a,e){var t=a.find(".noData");3!=e&&t.length>0&&t.show(),3==e&&(1==t.length?t.hide():2==t.length&&t.eq(1).hide())}function srcSearch(){var a=($(".leftSide .keyword").val()||"").trim()||"";""===a?$(".leftSide .clear").css({display:"none"}):$(".leftSide .clear").css({display:"block"}),globalParam.batchTblMode=!1,$('.leftSide .tblSelected[data-batch="1"]').attr("data-batch",0),clearInterval(globalParam.searchParam.searchInterval),globalParam.searchParam.searchInterval=setTimeout(function(){globalParam.searchParam.keyword=a,globalParam.searchParam.checkedDbNum=0,globalParam.searchParam.tarNum=0,$(".leftSide .check.cur").removeClass("cur"),$(".leftSide li.cur").removeClass("cur");var e=$(".mtype .radio.cur").attr("data-val");if($('.tblList .getTbl:not(".got")').length<=10)for(var t=$(".tblList .getTbl"),n=0,l=t.length;n<l;n++)t.eq(n).hasClass("got")?matchKeyword(3==e?t.eq(n).siblings(".tbl, .view"):1==e?t.eq(n).siblings(".tbl"):t.eq(n).siblings(".view")):queryAndMatch(t.eq(n));else{if(globalParam.searchParam.isSearch)return;globalParam.searchParam.isSearch=!0,$.fn.ajaxAPI({url:"db/search?pid="+$("#userApp").val()+"&keyword=&mtype=1&dbId="+globalParam.sourceId,callback:function(a){var t=$(".tblList .getTbl");a.model.databases.map(function(a,n){if(!t.eq(n).hasClass("got")){t.eq(n).addClass("got");var l=[],i=[];a.tables.map(function(a){"TABLE"!==a.type?i.push(a):l.push(a)});var o=template("template/sourceTbl",{model:l,isChecked:!1});t.eq(n).siblings(".tbl").html(o);var r=template("template/sourceView",{model:i,isChecked:!1});t.eq(n).siblings(".view").html(r)}matchKeyword(3==e?t.eq(n).siblings(".tbl, .view"):1==e?t.eq(n).siblings(".tbl"):t.eq(n).siblings(".view"))})}})}},300)}function queryAndMatch(a){var e=a.parent(),t=e.data("schema")||"",n=e.data("catalog")||"",l={dbId:globalParam.sourceId};t&&(l.schema=t),n&&(l.catalog=n);$.fn.ajaxAPI({url:"db/table/tbls",data:l,callback:function(t){a.addClass("got").html("-");var n=[],l=[];t.model.map(function(a){"TABLE"!==a.type?l.push(a):n.push(a)});var i=$(".mtype .radio.cur").attr("data-val"),o=template("template/sourceTbl",{model:n,isChecked:!1});e.find(".tbl").html(o);var r=template("template/sourceView",{model:l,isChecked:!1});e.find(".view").html(r),matchKeyword(3==i?e.find(".tbl, .view"):2!=i?e.find(".tbl"):e.find(".view"))}})}function matchKeyword(a){var e=a.find("p"),t=0,n=RegExp("("+globalParam.searchParam.keyword+")","ig");if(""===globalParam.searchParam.keyword){a.slideUp().siblings(".getTbl").html("+");var l=a.parent().removeClass("hidden").find("> p");return l.html(l.text()),a.find("li").removeClass("hidden"),e.map(function(a,e){$(e).html($(e).text())}),void $(".leftSide .tblList > .noData").addClass("hidden")}var i=!1;n.test(a.parent().attr("data-dbname"))?(a.siblings("p").html(a.parent().attr("data-dbname").replace(n,'<span class="red">$1</span>')),a.find("li").removeClass("hidden"),i=!0):a.siblings("p").html(a.parent().attr("data-dbname"));for(var o=0,r=e.length;o<r;o++)i?e.eq(o).html(e.eq(o).text().replace(n,'<span class="red">$1</span>')):n.test(e.eq(o).text())?(e.eq(o).parent().removeClass("hidden"),e.eq(o).html(e.eq(o).text().replace(n,'<span class="red">$1</span>')),t++):e.eq(o).parent().addClass("hidden");0!=t||i?(a.slideDown().siblings(".getTbl").html("-"),a.parent().removeClass("hidden"),globalParam.searchParam.tarNum++):a.parent().addClass("hidden"),globalParam.searchParam.tarNum&&$(".leftSide .tblList > .noData").addClass("hidden"),globalParam.searchParam.checkedDbNum++,globalParam.searchParam.checkedDbNum!=$(".tblList .getTbl").length||globalParam.searchParam.tarNum||$(".leftSide .tblList > .noData").removeClass("hidden")}function resetConfigCon(a,e){$(".global-ConfigCon .configCon .configTab a").eq(0).click(),$(".global-ConfigCon .configCon .configTab a").eq(0).html([common_js_lang["local.option.getDir"],common_js_lang["db.title.scanSql"]][+(globalParam.targetType!=globalParam.commonLinkType.hdfs)]),$(".global-ConfigCon .synch .srcColumn").html(globalParam.columnsOption).select2(),globalParam.targetType==globalParam.commonLinkType.hdfs?hdfsConfig(a):[globalParam.commonLinkType.hive,globalParam.commonLinkType.spark].indexOf(globalParam.targetType)>-1?hiveConfig(a):dbConfig(a),filterModule.resetFilter(e,a)}function getDir(a,e){var t=""!=(a=a||"")?$('.dirDos [data-base="'+a+'"] > .ul'):$(".hdfsTab .dirDos > .ul");$.fn.ajaxAPI({url:e&&"hdfs/dir/home"||"hdfs/dir/list",data:{base:a,hid:globalParam.connId,pid:$("#userApp").val()},loadTime:""==a?0:2e3,callback:function(n){if(t.parent().find(".show").addClass("in"),t.fadeIn(),!e&&0==n.model.length)return t.siblings("p").find(".show").addClass("out"),!1;e&&(n.model=[n.model]);a.length;var l=template("template/hdfsDir",{dir:n.model,len:a.length});t.html(l)},complete:function(){t.parent().find(".show").removeClass("got")}})}function hdfsConfig(a){void 0===a.replaceEnter&&(a.replaceEnter=!0,a.replacement=" "),$(".global-ConfigCon .hdfsTab .isReplace .checkbox").toggleClass("cur",a.replaceEnter);var e=""==a.replacement?common_js_lang["db.info.emptyString"]:""==a.replacement.trim()?a.replacement.match(/\s/g).length+common_js_lang["db.text.space"]:a.replacement;if($(".global-ConfigCon .hdfsTab .replacementCon .val").text(e).attr("data-val",a.replacement).prop("disabled",!a.replaceEnter),a.tarName)var t=a.tarDir||"",n=a.tarName||"";else{n="";if(t=a.fileName||""){n=t.split("/").slice(-1).join("/");t=t.split("/").slice(0,-1).join("/")||t.match(/\//g)&&"/"}}if($(".global-ConfigCon .hdfsTab p .check").removeClass("cur"),$(".global-ConfigCon .hdfsTab p .show").removeClass("in"),$(".global-ConfigCon .hdfsTab .ul:not(:first-child)").css({display:"none"}),$(".global-ConfigCon .hdfsTab .selectedDir").val(t).attr("title",t),$(".global-ConfigCon .hdfsTab .fileName").val(n),t){var l=$('.global-ConfigCon .hdfsTab [data-base="'+t+'"]');1==l.length&&(l.find(">p .check").addClass("cur"),l.parents(".ul").fadeIn().siblings("p").find(".show").addClass("in"))}}function saveParamSwitch(){switch(globalParam.targetType){case globalParam.commonLinkType.hive:return saveHiveParam();case globalParam.commonLinkType.hdfs:return saveHdfsParam();case globalParam.commonLinkType.spark:return saveHiveParam();default:return saveDbParam()}}function hiveConfig(a){var e=$(".global-ConfigCon");void 0===a.replaceEnter&&(a.replaceEnter=!0,a.replacement=" "),e.find(".dbTab .isReplace .checkbox").toggleClass("cur",a.replaceEnter);var t=""==a.replacement?common_js_lang["db.info.emptyString"]:""==a.replacement.trim()?a.replacement.match(/\s/g).length+common_js_lang["db.text.space"]:a.replacement;e.find(".dbTab .replacementCon .val").text(t).attr("data-val",a.replacement).prop("disabled",!a.replaceEnter),globalParam.targetType>globalParam.commonLinkType.spark?e.find(".hive .tableType").hide():e.find(".hive .tableType").show(),e.find(".hive .tableType").val(a.tableType||(globalParam.targetType==globalParam.commonLinkType.hive?0:1)).prop("disabled",globalParam.targetType==globalParam.commonLinkType.spark||""!=a.ddl),e.find(".hive .infoline.last").hide(),e.find("#partitions").empty();var n=a.name||"",l=a.tableName||"";n?(e.find("#dbName").val()!=n||!a.ddl&&!a.createSql?(e.find("#dbName").val(n).select2(),hiveModule.getTables(a)):(e.find("#tableName").val(l).select2({tags:!0}),e.find("#tableName").val()!=l&&e.find("#tableName").append('<option value="'+l+'">'+l+"</option>").val(l).select2({tags:!0})),a.ddl&&(globalParam.targetType>globalParam.commonLinkType.spark||hiveModule.getPart(a.tableName,a.catalog,a.schema,a.partition),editor.doc.cm.setOption("readOnly",!0),editor.doc.setValue(a.ddl),e.find(".new-sql .CodeMirror").addClass("disabled")),a.createSql&&(editor.doc.cm.setOption("readOnly",!1),editor.doc.setValue(a.createSql),e.find(".new-sql .CodeMirror").removeClass("disabled"))):(e.find("#dbName").val("").select2(),e.find("#tableName").html('<option value="" disabled>'+common_js_lang["local.option.setTbl"]+"</option><option>"+l+"</option>").val(l).select2({tags:!0}),e.find(".hive .tableType").val(a.tableType||(globalParam.targetType==globalParam.commonLinkType.hive?0:1)).prop("disabled",!0),editor.doc.cm.setOption("readOnly",!0),editor.doc.setValue(""),e.find(".new-sql .CodeMirror").addClass("disabled"))}function hiveConfigModule(a){this.container=a.container,this.newType=a.newType||0,this.editor=4!=this.newType?editor:SQLeditor,this.event()}function saveHiveParam(){var a=$(".global-ConfigCon"),e=(a.find("#dbName").val()||"").trim(),t={},n=a.find("#partitions .item .filedVal"),l=a.find("#dbName option:selected"),i=l.attr("data-catalog")||"",o=l.attr("data-schema")||"",r=a.find("#tableName").val(),s=editor.doc.getValue()||"";if([e,r,s].indexOf("")>-1)return MsgTip("",common_js_lang["local.info.tblErr"],"info"),!1;var d="",c="";if(editor.doc.cm.isReadOnly())c=s;else{d=s,s=(s=s.substring(s.indexOf("TABLE")+"TABLE".length,s.indexOf("(")).trim()).replace(/\"|\'|`|\[|\]/g,"");try{var m=s.split(".");if(m[0]!=e||m[1]!=r)return MsgTip("",common_js_lang["db.info.sqlErr"],"info"),!1}catch(a){return MsgTip("",common_js_lang["db.info.sqlErr"],"info"),!1}}for(var p={},g=0,f=n.length;g<f;g++)p[n.eq(g).attr("data-type")]=n.eq(g).val().trim();n.length>0&&(t.partition=JSON.stringify(p)),t.dbId=globalParam.targetId,t.tableType=a.find(".hive .tableType").val(),t.createSql=d,t.ddl=c,t.tableName=r,t.catalog=i,t.schema=o,t.name=e;var b=a.find(".dbTab .isReplace .checkbox").hasClass("cur"),h="";return h=a.find(".dbTab .replacementCon .val").attr("data-val"),t.replaceEnter=b,t.replacement=h,t}function saveHdfsParam(){var a=$(".global-ConfigCon .hdfsTab .selectedDir").val().trim(),e=$(".global-ConfigCon .hdfsTab .fileName").val().trim();if(e=e.slice(0,60),!a||!e)return MsgTip("",common_js_lang["local.info.fileDir"],"info"),!1;if(e.match(/\s+|\\+/g))return MsgTip("",common_js_lang["local.info.fileName"],"info"),!1;var t=!1;return $.fn.ajaxAPI({url:"hdfs/dir/access",data:{hdfsId:globalParam.targetId,dir:a,pid:$("#userApp").val()},async:!1,callback:function(n){var l=$(".global-ConfigCon .hdfsTab .isReplace .checkbox").hasClass("cur"),i=$(".global-ConfigCon .hdfsTab .replacementCon .val").attr("data-val");t={fileName:(a+"/"+e).replace(/\/+/g,"/"),replaceEnter:l,replacement:i,hid:globalParam.targetId,tarDir:a,tarName:e}}}),t}function saveDbParam(){return saveHiveParam()}function dbConfig(a){hiveConfig(a)}function getType1Val(){globalParam.type1Val||$.fn.ajaxAPI({url:"master/words/list?type=1",callback:function(a){0!=a.model.length&&(globalParam.type1Val='<select class="type1Val"><option value="">('+common_js_lang["db.info.emptyString"]+")</option>",a.model.map(function(a){globalParam.type1Val+='<option title="'+("zh"==common_i18n_lang?a.name:a.content)+'" value="'+a.content+'">'+a.content+"</option>"}),globalParam.type1Val+="</select>")}})}function column2option(a){var e="";return a.map(function(a){var t=a.typeName;e+='<option data-obj="'+encodeURIComponent(JSON.stringify(a))+'" data-type="'+a.dataType+'" data-typeName="'+t+'">'+a.alias+"</option>"}),e}function getColumns(a){var e=a.dbId,t=a.catalog,n=a.schema,l=a.tableName,i=$.Deferred();if(globalParam.columnObjMap["param_"+e+"_"+t+"_"+n+"_"+l]){var o=column2option(globalParam.columnObjMap["param_"+e+"_"+t+"_"+n+"_"+l]);return i.resolve(o),i.promise()}return $.ajax({url:"db/table/columns",data:{dbId:e,catalog:t,schema:n,tableName:l},success:function(a){if(200!=a.code)return i.reject(),void ErrTip(a.i18nMsg.title,a.i18nMsg.detail,a.msg);globalParam.columnObjMap["param_"+e+"_"+t+"_"+n+"_"+l]=a.model;var o=column2option(a.model);i.resolve(o)},error:function(){i.reject()}}),i.promise()}function getSourceColumns(a,e){var t=a.siblings(".target-name").text(),n=a.parents("tr"),l=n.data("catalog"),i=n.data("schema"),o={dbId:globalParam.sourceId,catalog:l,schema:i,tableName:t};$.when(getColumns(o)).done(function(a){globalParam.columnsOption=a,e.resolve()}).fail(function(){e.reject()})}function filterConfigModule(){this.container=$(".global-ConfigCon .filterTab"),this.event()}function getColumnBatch(a){var e=$.Deferred(),t=JSON.parse(a.tablesJsonStr);return 0==t.length?e.resolve():($.ajax({url:"db/table/columns/batch",data:a,success:function(n){if(200!=n.code)return ErrTip(n.i18nMsg.title,n.i18nMsg.detail,n.msg),void e.reject();var l=null;n.model.map(function(e,n){200==e.code?t[n].ddl?globalParam.columnObjMap["param_"+t[n].ddl]=e.model:globalParam.columnObjMap["param_"+a.dbId+"_"+t[n].catalog+"_"+t[n].schema+"_"+t[n].tableName]=e.model:l=e}),l&&(ErrTip(l.i18nMsg.title,l.i18nMsg.detail,l.msg),e.reject()),e.resolve()},error:function(){e.reject()}}),e.promise())}function checkHdfs(a){var e=a.fileName||"";return!(!e||e.split("/").length<=1)}function sqlEdiotrModule(){this.editorContainer=$(".item2 .rightSide.sqlQuery"),this.configContainer=$(".item2 .config.sqlQuery"),this.globalConfig=$(".global-ConfigCon"),this.event()}function sqlModuleReset(){if(!(globalParam.jobId<=0)&&3==jobOtherParams.srcType){SQLEditor.setValue(jobOtherParams.fromList[0].sql);var a=8==globalParam.editJobModel.toType?jobOtherParams.toHdfsList[0]:[9,13].indexOf(+globalParam.editJobModel.toType)>-1?jobOtherParams.toHiveList[0]:jobOtherParams.toDbList[0];if(8==globalParam.editJobModel.toType){var e=a.fileName.split("/").slice(0,-1).join("/")||"/",t=a.fileName.split("/").slice(-1)[0];$(".config.sqlQuery .selectedDir").val(e).attr("title",e),$(".config.sqlQuery .fileName").val(t)}else{if(a.partition){var n={};a.partition.split(",").map(function(a){var e=a.split("=");n[e[0]]=e[1].replace(/^\'|\'$/g,"")}),a.partition=JSON.stringify(n)}a.sql=jobOtherParams.fromList[0].sql,$(".config.sqlQuery .tableType").val(a.tableType);var l=$(".config.sqlQuery .tableType option:selected").text();a.format=l,globalParam.targetId=a.dbId,sqlEdiotrModule.reset(a)}}}function columnMapModule(){this.container=$(".stepCon .item.item3"),this.event()}function columnSelectFormat(a){var e=function(a){var e=$(a.element);if(!e.attr("data-typeName"))return"("+common_js_lang["db.info.emptyString"]+")";var t=JSON.parse(decodeURIComponent(e.attr("data-obj"))).pk?'<i class="pk-icon"></i>':"";return $('<div class="columnInfo" title="'+e.text()+" "+e.attr("data-typeName")+'"><span>'+t+e.text()+"</span><span>"+e.attr("data-typeName")+"</span></div>")};a.select2({templateResult:function(a){return e(a)},templateSelection:function(a){return e(a)}})}var editor=CodeMirror.fromTextArea($(".global-ConfigCon .new-sql textarea")[0],{lineNumbers:!0}),SQLeditor=CodeMirror.fromTextArea($(".sqlQuery.config .new-sql textarea")[0],{lineNumbers:!0}),filterEditor=CodeMirror.fromTextArea($(".filterTab textarea")[0],{lineNumbers:!0}),SQLEditor=ace.edit("SQLEditor");SQLEditor.session.setMode("ace/mode/sql"),SQLEditor.setTheme("ace/theme/sqlserver"),SQLEditor.setOptions({enableBasicAutocompletion:!0,enableSnippets:!0,enableLiveAutocompletion:!0}),$(".sqlQuery").on("click",".format",function(){var a=SQLEditor.getValue();SQLEditor.setValue(sqlFormatter.format(a))});var JSFilter=ace.edit("JSFilter");JSFilter.session.setMode("ace/mode/javascript"),JSFilter.setTheme("ace/theme/sqlserver"),JSFilter.setOptions({enableBasicAutocompletion:!0,enableSnippets:!0,enableLiveAutocompletion:!0});var tmpParam={jobId:0,editJobModel:{},dbConfigParam:{},dbConfigParamOption:"",dbParamObj:{},sourceId:"",targetId:"",sourceDb:{},targetType:0,groupNo:0,urlConnectList:{},curTableList:[],curHiveParam:{},columnsOption:"",filtersOption:"",fromJson:[],toHdfsJson:[],toHiveJson:[],toDbJson:[],linkSource2type:{1:[38,4,40,44,24],2:[52,53,55,54],3:[56,57,60,58]},urlObj:{},tmpAppId:0,type1Val:"",connId:0,tmpDbParam:{},editTmpDbParam:{},searchParam:{searchInterval:"",keyword:"",checkedDbNum:0,tarNum:0,isSearch:!1},batchTblMode:!1,columnObjMap:{},curTableColumnsMap:[]};$.extend(globalParam,tmpParam);try{for(var urlParam=location.search.replace(/^\?|\?$/g,"").split("&"),i=0,len=urlParam.length;i<len;i++){var obj=urlParam[i].split("=");globalParam.urlObj[obj[0]]=obj[1]||""}var urlType=globalParam.urlObj.type||1;globalParam.groupNo=[2,6,7][+urlType-1],1!=urlType&&$(".source #dbType option").map(function(a,e){var t=+$(e).val();t>0&&-1==globalParam.linkSource2type[urlType+""].indexOf(t)&&$(e).css({display:"none"})});var urlTitle=[common_js_lang["db.title.dbMigrate"],common_js_lang["db.title.aliMigrate"],common_js_lang["db.title.amazonMigrate"]][+urlType-1];$(document).attr("title",urlTitle),$("h2.title span.titleType").html(urlTitle),globalParam.urlObj.dbtype&&$("#dbType").val(globalParam.urlObj.dbtype+""),globalParam.urlObj.dbtype;var id=globalParam.urlObj.id||0;if(id<=0)throw"";$.fn.ajaxAPI({url:"job/detail?jobId="+id,async:!1,callback:function(a){if(globalParam.urlObj.copy&&(a.model.jobName=(a.model.jobName+"_copy").slice(0,60)),$(".configTask .taskName").val(a.model.jobName),$(".configTask .taskDes").val(a.model.note),a.model.pid&&$("#userApp").val(a.model.pid).select2(),JSON.parse(a.model.otherParams).fromList){if(globalParam.jobId=id,globalParam.editJobModel=a.model,!a.model.fromId)return;a.model.fromObject&&(-1==a.model.fromObject.delFlg&&$.extend(globalParam.editTmpDbParam,a.model.fromObject),1==globalParam.urlObj.type&&(globalParam.urlObj.dbtype=a.model.fromObject.dbType)),globalParam.urlObj.dbtype}var e="";a.model.fromObject||(e+=common_js_lang["conf.info.srcNull"]),a.model.toObject||(e+=(e?"<br>":"")+common_js_lang["conf.info.tarNull"]),e&&MsgTip("info",e,5e3)}})}catch(a){}$(".url-info").on("change",".linkList",function(){if(!$(this).val())return!1;var a=JSON.parse($(this).find("option:selected").attr("data-val")),e=$(this).parents(".choose-link");e.find('[data-key="dbType"]').val(a.dbType),e.find('[data-key="host"]').val(a.host),e.find('[data-key="port"]').val(a.port),e.find('[data-key="dbName"]').val(a.dbName),e.find('[data-key="userName"]').val(a.userName),e.find('[data-key="password"]').val(a.password),e.find('[data-key="url"]').val(a.url),e.find('[data-key="connName"]').val(a.connName)}),$(".item1").on("change",".connType",function(){var a=$(this).val(),e=globalParam.urlObj.type||1;1==a?($(".item1 .source .type1show").show(),$(".item1 .source input").prop("disabled",!0).val("").removeClass("error"),1!=e&&$(".item1 .source #dbType").val("").prop("disabled",!0),$(".source .linkList").select2()):($(".item1 .source .linkList").val("").select2(),$(".item1 .source .type1show").hide(),$(".item1 .source input").prop("disabled",!1).val("").removeClass("error"),$('.item1 .source [data-key="connName"]').prop("disabled",!0),1!=e&&$(".item1 .source #dbType").val("").prop("disabled",!1))});var jobOtherParams="";globalParam.jobId>0?(jobOtherParams=JSON.parse(globalParam.editJobModel.otherParams),getDBList({pageSize:1e3,pageNo:1,groups:globalParam.urlObj.type,dbType:globalParam.urlObj.dbtype,id:-1==globalParam.editTmpDbParam.delFlg?0:jobOtherParams.fromList[0].id}),getConnect(globalParam.editJobModel.toId)):(getDBList({pageSize:1e3,pageNo:1,groups:globalParam.urlObj.type,dbType:globalParam.urlObj.dbtype}),getConnect()),$("body").on("click","button.index",function(){window.location.href="./"}),$("#userApp").change(function(){getDBList({pageSize:1e3,pageNo:1,groups:globalParam.urlObj.type,dbType:globalParam.urlObj.dbtype});var a=$(".item1 .choose-link");1==a.find(".connType").val()&&(a.find('[data-key="dbType"]').val(globalParam.urlObj.dbtype||""),["host","port","dbName","userName","password","url","connName"].map(function(e){a.find('[data-key="'+e+'"]').val("")})),getConnect(),$(".upload-type").find(".column").find("input,select").val("")}),$(".item1 .source").on("blur","input",function(){var a=$(this).attr("data-key"),e=($(this).val()||"").trim(),t={};if(t[a]=e,"url"===a&&""===e){i=getUrlParam($(this));return $(this).val(getlinkUrl(i)).removeClass("error"),!1}if(!0!==checkDbInfo(t).res)return $(this).addClass("error"),!1;if($(this).removeClass("error"),2==$(".source .connType").val()&&["host","port","dbName"].indexOf(a)>-1){var n=$(".source.formCon"),l="TMP_"+(n.find('[data-key="host"]').val()||"").trim()+"_"+(n.find('[data-key="port"]').val()||"").trim()+"_"+(n.find('[data-key="dbName"]').val()||"").trim();$('.source [data-key="connName"]').val(l)}if(["host","port","dbName"].indexOf(a)>-1){var i=getUrlParam($(this));$(this).parents("ul").find('[data-key="url"]').val(getlinkUrl(i))}}),$(".upload-type").on("change",".typeCon #targetType",function(a,e){var t=$(this).val();if(t){getConnect(e,t>globalParam.commonLinkType.spark?t:"");var n=$(this).parents(".upload-type").find(".column").addClass("hidden");n.find("input,select").val("").attr("title",""),[globalParam.commonLinkType.hive,globalParam.commonLinkType.spark].indexOf(t)>-1?n.siblings(".hive").removeClass("hidden"):[globalParam.commonLinkType.hdfs].indexOf(t)>-1?n.siblings(".hdfs").removeClass("hidden"):n.siblings(".db").removeClass("hidden")}}),$(".upload-type").on("change",".connId",function(){try{var a=JSON.parse(decodeURIComponent($(this).find("option:selected").attr("data-val")))}catch(a){return}if(!a.id)return!1;var e=$(".upload-type #targetType").val();resetDestConn(a,[globalParam.commonLinkType.hive,globalParam.commonLinkType.spark].indexOf(e)>-1?$(".upload-type .column.hive"):e==globalParam.commonLinkType.hdfs?$(".upload-type .column.hdfs"):$(".upload-type .column.db"))}),$(".testConnect").on("click",function(){var a=1==$(this).parents(".source").length;if($(this).parent().find(".testRes").empty(),a)if(1==$(".source .connType").val()){if((n=$(".linkList").val()||0)<=0)return void MsgTip("",common_js_lang["db.info.selectSavedLink"],"info");testDbConnect({pid:$("#userApp").val(),id:n},$(this).parent())}else{if(globalParam.jobId>0)return void testDbConnect({pid:$("#userApp").val(),id:globalParam.editJobModel.fromId},$(this).parent());var e={};if(["connName","url","host","port","dbName","userName","password","dbType"].map(function(a){e[a]=($('.source [data-key="'+a+'"]').val()||"").trim()}),!checkDbInfo(e).res)return MsgTip("",common_js_lang["db.info.completeParam"],"info"),!1;e.connName=e.connName||"TMP_"+e.host+"_"+e.port+"_"+e.dbName,$('.source [data-key="connName"]').val(e.connName),e.pid=$("#userApp").val(),e.delFlg=-1,testDbConnect(e,$(this).parent())}else{var t=$("#targetType").val(),n=$(".typeCon .connId").val();if(!n)return void MsgTip("",common_js_lang["db.info.tarConn"],"info");try{l=JSON.parse(decodeURIComponent($(".upload-type .connId").find("option:selected").attr("data-val")))}catch(a){var l={}}t!=globalParam.commonLinkType.hdfs&&testDbConnect(l,$(this).parent()),t==globalParam.commonLinkType.hdfs&&testHdfsConnect(l,$(this).parent())}}),$(".connType, .linkList, .target-type, .connId").change(function(){var a=$(this).parents(".source");0==a.length&&(a=$(this).parents(".upload-type")),a.find(".testRes").empty()}),$(".testRes").on("click",".showTip",function(){var a=JSON.parse(decodeURIComponent($(this).attr("data-info")));ErrTip(a.i18nMsg.title,a.i18nMsg.detail,a.msg)}),globalParam.jobId<=0||(-1==globalParam.editTmpDbParam.delFlg&&($(".source .connType").val("2").change(),["connName","url","host","port","dbName","userName","password","dbType"].map(function(a){"password"==a&&(globalParam.editTmpDbParam[a]="******"),$('.source [data-key="'+a+'"]').val(globalParam.editTmpDbParam[a]).prop("disabled",!0)})),8==globalParam.editJobModel.toType?globalParam.targetType=globalParam.commonLinkType.hdfs:9==globalParam.editJobModel.toType?($(".typeCon #targetType").val(globalParam.commonLinkType.hive).trigger("change",globalParam.editJobModel.toId),globalParam.targetType=globalParam.commonLinkType.hive):13==globalParam.editJobModel.toType?($(".typeCon #targetType").val(globalParam.commonLinkType.spark).trigger("change",globalParam.editJobModel.toId),globalParam.targetType=globalParam.commonLinkType.spark):(globalParam.editJobModel.toObject&&(globalParam.targetType=globalParam.editJobModel.toObject.dbType),$(".typeCon #targetType").val(globalParam.targetType).trigger("change",globalParam.editJobModel.toId)),$("#userApp, .item1 .connType, .item1 .linkList, .item1 #targetType, .item1 .connId").prop("disabled",!0)),$(".url-info").on("click",".connect",function(){function a(a){var e='<option value="" disabled>'+common_js_lang["local.option.getDb"]+"</option>";a.databases.map(function(a){e+='<option data-catalog="'+(a.catalog||"")+'" data-schema="'+(a.schema||"")+'">'+a.name+"</option>"}),$(".global-ConfigCon #dbName, #batch-dbName, .item2 .config.sqlQuery #dbName").html(e).val("").removeClass("error").select2();var i='<option value="" disabled>'+common_js_lang["local.option.setTbl"]+"</option>";$(".item2 .config.sqlQuery #tableName").html(i).val("").select2({tags:!0}),a.databases&&a.databases.length<=0&&MsgTip("info",common_js_lang["dump.info.dbNone"]),globalParam.targetType=l,globalParam.connId=n,globalParam.targetId=globalParam.connId,globalParam.tmpAppId=t}var e=($(".item1 .taskName").val()||"").trim();($(".item1 .taskDes").val()||"").trim();if(e){var t=$("#userApp").val()||0;if(t){var n=$(".typeCon .connId").val(),l=$(".typeCon #targetType").val();if(n<=0)return MsgTip("",common_js_lang["db.info.tarConn"],"info"),!1;var i=l!=globalParam.targetType,o=n!=globalParam.connId,r=t!=globalParam.tmpAppId,s=$(".source .connType").val();if(1==s){if(!$(".source .linkList").val())return MsgTip("",common_js_lang["db.info.sourceLink"],"info"),!1;var d=JSON.parse($(".source .linkList").find("option:selected").attr("data-val")),c=d.id!=globalParam.sourceId}else{var m={},c=!1;if(["connName","url","host","port","dbName","userName","password","dbType"].map(function(a){m[a]=($('.source [data-key="'+a+'"]').val()||"").trim(),globalParam.tmpDbParam[a]==m[a]||(c=!0)}),!checkDbInfo(m).res)return MsgTip("",common_js_lang["db.info.completeParam"],"info"),!1;m.pid=$("#userApp").val(),globalParam.tmpDbParam.pid==m.pid||(c=!0),$.extend(globalParam.tmpDbParam,m)}$("#globalLoadCon").css({display:"block"}),$(".global-ConfigCon .hdfsTab").addClass("hidden"),$(".global-ConfigCon .dbTab").removeClass("hidden"),$(".global-batch .hdfsTab").addClass("hidden"),$(".global-batch .dbTab").removeClass("hidden"),l==globalParam.commonLinkType.hdfs&&($(".global-ConfigCon .dbTab").addClass("hidden"),$(".global-ConfigCon .hdfsTab").removeClass("hidden"),$(".global-batch .dbTab").addClass("hidden"),$(".global-batch .hdfsTab").removeClass("hidden"));var p=function(a,e){globalParam.jobId>0||!a&&!e||(a&&(globalParam.searchParam.isSearch=!1,$(".leftSide .keyword").val(""),$(".leftSide .clear").css({display:"none"})),$(".rightSide.targetPath h4 b").html("(0)"),$(".mtype .radio.cur").attr("data-val")<3?$(".rightSide .target-item").html('<tr class="noDataTr"><td colspan="4" class="tableNoData"><img src="resources/dist/images/noData.png">'+common_js_lang["manage.title.noData"]+"</td></tr>"):globalParam.targetType!=globalParam.commonLinkType.hdfs?(SQLEditor.setValue(""),$(".rightSide.sqlQuery .preshow").hide(),$(".config.sqlQuery #dbName").val("").select2(),$(".config.sqlQuery #tableName").val("").select2({tags:!0}),$(".config.sqlQuery #partitions").empty().parent().hide(),SQLeditor.doc.setValue("")):(SQLEditor.setValue(""),$(".rightSide.sqlQuery .preshow").hide(),$(".config.sqlQuery .selectedDir").val(""),$(".config.sqlQuery .fileName").val("")))},g=$.Deferred(),f=$.Deferred();if(i||o||r)if(l!=globalParam.commonLinkType.hdfs)$(".config.sqlQuery .tableType").val(l==globalParam.commonLinkType.spark?1:0).prop("disabled",!0),SQLeditor.doc.setValue(""),editor.doc.cm.setOption("readOnly",!0),globalParam.dbList["db_"+n]?(a(globalParam.dbList["db_"+n]),f.resolve(!0)):$.ajax({url:"db/dbs?id="+n+"&pid="+$("#userApp").val(),success:function(e){if(200!=e.code)return f.reject(),ErrTip(e.i18nMsg.title,e.i18nMsg.detail,e.msg),!1;globalParam.dbList["db_"+n]=e.model,a(globalParam.dbList["db_"+n]),f.resolve(!0)},error:function(){f.reject()}});else{var b=$(".hdfsTab .dirDos > .ul");$.ajax({url:"hdfs/dir/home",data:{hid:n,pid:$("#userApp").val()},success:function(a){if(200!=a.code)return f.reject(),ErrTip(a.i18nMsg.title,a.i18nMsg.detail,a.msg),!1;a.model=[a.model];var e=template("template/hdfsDir",{dir:a.model,len:0});b.html(e),globalParam.targetType=l,globalParam.connId=n,globalParam.targetId=globalParam.connId,globalParam.tmpAppId=t,f.resolve(!0)},error:function(){f.reject()}})}else f.resolve();!function(){function a(){if(globalParam.dbList["db_"+e]){globalParam.sourceId=e;var a=template("template/sourceDb",globalParam.dbList["db_"+e]);return $(".item2 .leftSide .tblList > .ul").html(a),void g.resolve(!0)}$.ajax({url:"db/dbs?id="+e+"&pid="+$("#userApp").val(),success:function(a){if(200!=a.code)return globalParam.sourceId=0,g.reject(),void ErrTip(a.i18nMsg.title,a.i18nMsg.detail,a.msg);globalParam.dbList["db_"+e]=a.model,globalParam.sourceId=e;var t=template("template/sourceDb",globalParam.dbList["db_"+e]);$(".item2 .leftSide .tblList > .ul").html(t),g.resolve(!0)},error:function(){g.reject()}})}if(c||!globalParam.sourceId){var e=0;1!=s?$.when(function(){var a=$.Deferred();return globalParam.jobId>0?(e=globalParam.editJobModel.fromId,a.resolve(),a.promise()):($.ajax({url:"db/tmp/save",contentType:"application/x-www-form-urlencoded",type:"post",data:m,success:function(t){if(200!=t.code)return a.reject(),void ErrTip(t.i18nMsg.title,t.i18nMsg.detail,t.msg);e=t.model.id,globalParam.sourceId=e,a.resolve()},error:function(){a.reject()}}),a.promise())}()).done(function(){a()}).fail(function(){g.reject()}):(e=d.id,a())}else g.resolve()}(),$.when(g,f).done(function(a,e){p(a,e),$(".leftSide .allSelected").removeClass("cur");var t=$(".mtype .radio.cur").attr("data-val");t<3?($(".item2 .sqlQuery").hide(),$(".item2 .transfer, .item2 .targetPath").show(),$(".rightSide thead").html(template("template/thead",{isDb:l!=globalParam.commonLinkType.hdfs,type:t}))):($(".item2 .transfer, .item2 .targetPath").hide(),$(".item2 .sqlQuery").show(),$(".item2 .config.sqlQuery .tab").hide(),globalParam.targetType!=globalParam.commonLinkType.hdfs?$(".item2 .config.sqlQuery .tab.hive").show():$(".item2 .config.sqlQuery .tab.hdfs").show()),globalParam.targetType>globalParam.commonLinkType.spark?$(".hive .formatLine").hide():$(".hive .tableType").show(),$(".stepCon").animate({"margin-left":"-100%"},250,function(){$(".stepCon .item.item1, .stepCon .item.item3").height("200"),$(".stepCon .item.item2").height("auto")}),$(".processCon .itemCon").removeClass("cur").eq(1).addClass("cur"),$("html, body").animate({scrollTop:0},200),initAct()}).always(function(){$("#globalLoadCon").css({display:"none"})})}else MsgTip("",common_js_lang["dbManage.title.setApp"],"info")}else MsgTip("",common_js_lang["local.info.taskNameNone"],"info")}),$(".item2.item").on("click",".mtype label",function(){if(!$(this).find(".radio").hasClass("cur")){var a=$(this),e=$(".mtype .radio.cur").attr("data-val"),t=$(this).find(".radio").attr("data-val"),n=1==t?1:2,l=function(){a.parent().find(".radio").removeClass("cur"),a.find(".radio").addClass("cur"),$(".leftSide .tbl, .leftSide .view").hide(),$(".leftSide .keyword").val(""),$(".leftSide .clear").css({display:"none"}),globalParam.searchParam.keyword="",$(".leftSide .check.cur").removeClass("cur"),$(".leftSide li.cur").removeClass("cur"),(1==n?$(".tblList .tbl"):$(".tblList .view")).map(function(a,e){matchKeyword($(e))}),$(".leftSide .tblList").scrollTop(0),$(".leftSide .tblList .db-item").map(function(a,e){noDataShow($(e),t)}),3!=t?($(".item2 .sqlQuery").hide(),$(".item2 .transfer, .item2 .targetPath").show(),$(".leftSide").removeClass("mtype3"),$(".rightSide thead").html(template("template/thead",{type:n,isDb:globalParam.targetType!=globalParam.commonLinkType.hdfs})),$(".rightSide .target-item").empty(),$(".rightSide.targetPath h4 b").html("(0)"),$(".rightSide .target-item").append('<tr class="noDataTr"><td colspan="4" class="tableNoData"><img src="resources/dist/images/noData.png">'+common_js_lang["manage.title.noData"]+"</td></tr>")):($(".item2 .transfer, .item2 .targetPath").hide(),$(".leftSide").addClass("mtype3"),$(".item2 .config.sqlQuery .tab").hide(),globalParam.targetType!=globalParam.commonLinkType.hdfs?$(".item2 .config.sqlQuery .tab.hive").show():$(".item2 .config.sqlQuery .tab.hdfs").show(),$(".item2 .sqlQuery").show())};3!=e&&$(".rightSide .target-item .config").length<=0||3==e&&!SQLEditor.getValue().trim()?l():swal({title:"",text:common_js_lang["db.option.mtype"],type:"info",showCancelButton:!0},function(){l()})}}),$(".leftSide").on("click",".tblList .getTbl",function(){var a=$(this).parent(),e=a.data("schema")||"",t=a.data("catalog")||"",n=$(".mtype .radio.cur").attr("data-val");if($(this).hasClass("got")){var l=3==n?a.find(".tbl, .view"):2!=n?a.find(".tbl"):a.find(".view");"none"==l.css("display")?(l.slideDown(),$(this).html("-")):(l.slideUp(),$(this).html("+"))}else{var i={dbId:globalParam.sourceId};e&&(i.schema=e),t&&(i.catalog=t);var o=$(this).siblings(".dbSelected").hasClass("cur");$.fn.ajaxAPI({url:"db/table/tbls",data:i,callback:function(e){a.find(".getTbl").addClass("got").html("-");var t=[],n=[];e.model.map(function(a){"TABLE"!==a.type?n.push(a):t.push(a)});var l=$(".mtype .radio.cur").attr("data-val"),i=template("template/sourceTbl",{model:t,isChecked:o});a.find(".tbl").html(i);var r=template("template/sourceView",{model:n,isChecked:o});if(a.find(".view").html(r),3==l)return noDataShow(a,3),void a.find(".tbl, .view").slideDown();2!=l?a.find(".tbl").slideDown():a.find(".view").slideDown()}})}}),$(".leftSide").on("click",".dbSelected",function(){if(3==$(".mtype .radio.cur").attr("data-val"))return!1;$(this).toggleClass("cur");var a=$(".mtype .radio.cur").attr("data-val"),e=$(this).siblings(".getTbl").hasClass("got"),t=2!=a?$(this).siblings(".tbl"):$(this).siblings(".view"),n=$(this).hasClass("cur");e?(t.find('li:not(".hidden, .noData")').toggleClass("cur",n),t.find('li:not(".hidden, .noData") .check').toggleClass("cur",n),"none"==t.css("display")&&(t.slideDown(),$(this).siblings(".getTbl").html("-"))):$(this).siblings(".getTbl").click();var l=$('.tblList li:not(".hidden") .dbSelected').length==$('.tblList li:not(".hidden") .dbSelected.cur').length;return $(".leftSide .allSelected").toggleClass("cur",l),!1}),$(".leftSide").on("click",".db-item > p",function(){$(this).siblings(".check").click()}),$(".leftSide").on("click",".tblSelected",function(a,e){var t=$(".mtype .radio.cur").attr("data-val");if(3==t){var n="select * from `"+$(this).parents(".db-item").attr("data-dbname")+"`.`"+$(this).siblings("p").attr("title")+"`";return SQLEditor.setValue(n),!1}if(a.ctrlKey||e){if(!globalParam.batchTblMode)return globalParam.batchTblMode=!0,$(this).attr("data-batch",1),!1;var l=$('.leftSide .tblSelected[data-batch="1"]');if(l.parents(".db-item").attr("data-dbname")!==$(this).parents(".db-item").attr("data-dbname"))return globalParam.batchTblMode=!1,$('.leftSide .tblSelected[data-batch="1"]').attr("data-batch",0),!1;for(var i=+l.siblings("b").text(),o=+$(this).siblings("b").text(),r=2!=t?$(this).parents(".tbl").find("li"):$(this).parents(".view").find("li"),s=i>o?o:i,d=i>o?i:o,c=s;c<=d;c++)r.eq(c-1).hasClass("hidden")||(r.eq(c-1).addClass("cur"),r.eq(c-1).find(".check").addClass("cur"));globalParam.batchTblMode=!1,$('.leftSide .tblSelected[data-batch="1"]').attr("data-batch",0);p=(r=2!=t?$(this).parents(".tbl"):$(this).parents(".view")).find('li:not(".hidden")').length;r.find(".check.cur").length==p?r.siblings(".dbSelected").addClass("cur"):r.siblings(".dbSelected").removeClass("cur");g=(p=$('.tblList li:not(".hidden") .dbSelected').length)==$('.tblList li:not(".hidden") .dbSelected.cur').length;return $(".leftSide .allSelected").toggleClass("cur",g),!1}globalParam.batchTblMode=!1,$('.leftSide .tblSelected[data-batch="1"]').attr("data-batch",0),$(this).toggleClass("cur");var m=$(this).hasClass("cur");$(this).parent().toggleClass("cur",m);var p=(r=2!=t?$(this).parents(".tbl"):$(this).parents(".view")).find('li:not(".hidden")').length;r.find(".check.cur").length==p?r.siblings(".dbSelected").addClass("cur"):r.siblings(".dbSelected").removeClass("cur");var g=(p=$('.tblList li:not(".hidden") .dbSelected').length)==$('.tblList li:not(".hidden") .dbSelected.cur').length;return $(".leftSide .allSelected").toggleClass("cur",g),!1}),$(".leftSide").on("click",".tbl li, .view li",function(a){$(this).find(".check").trigger("click",a.ctrlKey)}),$(".leftSide").on("click",".allSelected",function(){$(this).toggleClass("cur");var a=$(this).hasClass("cur");return $('.tblList li:not(".hidden") .dbSelected').toggleClass("cur",!a),$('.tblList li:not(".hidden") .getTbl:not(".got")').length<=10?$('.tblList li:not(".hidden") .dbSelected').click():$.fn.ajaxAPI({url:"db/search?pid="+$("#userApp").val()+"&keyword=&mtype=1&dbId="+globalParam.sourceId,callback:function(a){var e=$('.tblList li:not(".hidden") .getTbl:not(".got")');a.model.databases.map(function(a,t){if(!e.eq(t).hasClass("got")){e.eq(t).addClass("got");var n=[],l=[];a.tables.map(function(a){"TABLE"!==a.type?l.push(a):n.push(a)});var i=template("template/sourceTbl",{model:n,isChecked:!1});e.eq(t).siblings(".tbl").css({display:"none"}).html(i);var o=template("template/sourceView",{model:l,isChecked:!1});e.eq(t).siblings(".view").css({display:"none"}).html(o)}}),$('.tblList li:not(".hidden") .dbSelected').click()}}),!1}),function(){if(!(globalParam.jobId<=0)&&(jobOtherParams.srcType>1&&$(".mtype .radio").removeClass("cur").eq(+jobOtherParams.srcType-1).addClass("cur"),3!=jobOtherParams.srcType)){$(".rightSide .target-item").empty();for(var a=jobOtherParams.fromList.length,e=8==globalParam.editJobModel.toType?jobOtherParams.toHdfsList:[9,13].indexOf(+globalParam.editJobModel.toType)>-1?jobOtherParams.toHiveList:jobOtherParams.toDbList,t=0;t<a;t++){var n=jobOtherParams.fromList[t].name,l=jobOtherParams.fromList[t].catalog,i=jobOtherParams.fromList[t].schema,o=jobOtherParams.fromList[t].whereSql;if(e[t].partition){m={};(c=e[t].partition.split(",")).map(function(a){var e=a.split("=");m[e[0]]=e[1].replace(/^\'|\'$/g,"")}),e[t].partition=JSON.stringify(m)}try{p=JSON.parse(jobOtherParams.fromList[t].synchColumnMap)}catch(a){p={}}for(var r=1,s=[{tbl:jobOtherParams.fromList[t].tableName,target:e[t],param:JSON.stringify(e[t]),filter:JSON.stringify({whereSql:o||"",tarColumn:p.tagSynchColumn?p.tagSynchColumn:"",srcColumn:p.srcSynchColumn?p.srcSynchColumn:"",dataTbl:JSON.stringify({catalog:e[t].catalog||"",schema:e[t].schema||"",tableName:e[t].tableName,dbId:globalParam.toId})})}],d=t+1;d<a&&jobOtherParams.fromList[d].name==n;d++){if(r++,e[d].partition){var c=e[d].partition.split(","),m={};c.map(function(a){var e=a.split("=");m[e[0]]=e[1].replace(/^\'|\'$/g,"")}),e[d].partition=JSON.stringify(m)}try{p=JSON.parse(jobOtherParams.fromList[d].synchColumnMap)}catch(a){var p={}}s.push({tbl:jobOtherParams.fromList[d].tableName,target:e[d],param:JSON.stringify(e[d]),filter:JSON.stringify({whereSql:jobOtherParams.fromList[d].whereSql||"",tarColumn:p.tagSynchColumn?p.tagSynchColumn:"",srcColumn:p.srcSynchColumn?p.srcSynchColumn:"",dataTbl:JSON.stringify({catalog:e[d].catalog||"",schema:e[d].schema||"",tableName:e[d].tableName,dbId:globalParam.toId})})})}t=d-1;var g={catalog:l,schema:i,dbName:n,count:r,tbls:s,isDb:0};8!=globalParam.editJobModel.toType&&(g.isDb=1,g.srcType=jobOtherParams.srcType),$(".rightSide .target-item").append(template("template/targetTbl",g))}$(".rightSide h4 b").html("("+e.length+")")}}(),$(".leftSide").on("input",".keyword",srcSearch),$(".leftSide").on("click",".clear",function(){$(".leftSide .keyword").val(""),srcSearch()}),$(".leftSide").on("keyup",".keyword",function(a){13!=a.which||srcSearch()}),$(".leftSide").on("click",".query",srcSearch),$(".transfer").on("click",".move-right",function(){var a=1==$(".mtype").find(".radio.cur").attr("data-val")?"tbl":"view";if(!($('.leftSide .tblList li:not(".hidden") .'+a+" .tblSelected.cur").length<=0)){var e=$('.leftSide .tblList .db-item:not(".hidden")'),t=$(".rightSide .target-item");t.parent().find(".check").removeClass("cur");for(var n=0,l=e.length;n<l;n++){var i=e.eq(n),o=i.find("."+a+' li:not(".hidden") .tblSelected.cur'),r=o.length;if(0!=r){var s=i.data("catalog"),d=i.data("schema"),c=i.data("dbname"),m={catalog:s,schema:d,dbName:c,count:r,tbls:[]},p=t.find('.target-path[data-name="'+c+'"]');if(p.length>0){for(var g=0,f=0;f<r;f++){var b=o.eq(f).siblings("p").text();0==t.find('[data-name="'+c+'"][data-tbl="'+b+'"]').length&&((u={}).tbl=b,u.param=globalParam.targetType!=globalParam.commonLinkType.hdfs?JSON.stringify({tableName:u.tbl}):JSON.stringify({fileName:u.tbl+".txt",tarName:u.tbl+".txt"}),m.tbls.push(u),g++)}m.isDb=globalParam.targetType!=globalParam.commonLinkType.hdfs,m.isDb&&(m.srcType=$(".mtype .radio.cur").attr("data-val"));var h=$(template("template/targetTbl",m)).siblings('tr:not(".target-path")');t.find('[data-name="'+c+'"]').slice(-1).after(h),p.find("b").html(+p.find("b").html()+g)}else{for(f=0;f<r;f++){var u={};u.tbl=o.eq(f).siblings("p").text(),u.param=globalParam.targetType!=globalParam.commonLinkType.hdfs?JSON.stringify({tableName:u.tbl}):JSON.stringify({fileName:u.tbl+".txt",tarName:u.tbl+".txt"}),m.tbls.push(u)}m.isDb=globalParam.targetType!=globalParam.commonLinkType.hdfs,m.isDb&&(m.srcType=$(".mtype .radio.cur").attr("data-val")),$(".rightSide .target-item").append(template("template/targetTbl",m))}}}$(".leftSide .tbl li, .leftSide i.check.cur").removeClass("cur"),$(".rightSide h4 b").html("("+$(".target-item .target-name").length+")"),$('.rightSide .target-item tr:not(".noDataTr")').length>0&&$(".rightSide .target-item .noDataTr").remove()}}),$(".transfer").on("click",".move-left",function(){$(".rightSide .target-item .check.cur").parents("tr").remove(),$(".rightSide .allSelected").removeClass("cur");for(var a=$(".rightSide .target-item .target-path"),e=0,t=0,n=a.length;t<n;t++){var l=a.eq(t).data("name"),i=$('.rightSide .target-item [data-name="'+l+'"]:not(".target-path")').length;a.eq(t).find("td b").html(i),e+=i}$(".rightSide h4 b").html("("+e+")"),0==$(".rightSide .target-item tr").length&&$(".rightSide .target-item").append('<tr class="noDataTr"><td colspan="4" class="tableNoData"><img src="resources/dist/images/noData.png">'+common_js_lang["manage.title.noData"]+"</td></tr>")}),$(".rightSide").on("click",".batch",function(){$(".rightSide .target-item .target-tbl.cur").length<=0?MsgTip("",common_js_lang["db.info.tarEmpty"],"info"):(globalParam.targetType==globalParam.commonLinkType.hdfs?($(".global-batch").removeClass("fixed"),$(".global-batch .hdfsTab p .check").removeClass("cur"),$(".global-batch .hdfsTab p .show").removeClass("in"),$(".global-batch .hdfsTab .ul:not(:first-child)").css({display:"none"}),$(".global-batch .hdfsTab .selectedDir").val("").attr("title",""),$(".global-batch .hdfsTab").removeClass("hidden"),$(".global-batch .dbTab").addClass("hidden"),$(".global-batch .replace-tag .tip").removeClass("hidden")):($(".global-batch").addClass("fixed"),$(".global-batch .hdfsTab").addClass("hidden"),$(".global-batch .dbTab").removeClass("hidden"),$(".global-batch #batch-dbName").val("").select2(),$(".global-batch .replace-tag .tip").addClass("hidden")),$(".global-batch .isReplace .checkbox").addClass("cur"),$(".global-batch .replacementCon .val").text("1"+common_js_lang["db.text.space"]).attr("data-val"," ").prop("disabled",!1),$(".global-mask, .global-batch").fadeIn())}),$.fn.replaceComponent=function(){function a(a,e,t){t.removeClass("show"),t.find(".val").text(a).attr("data-val",e)}var e=$(this);$("body").on("click",".replacementCon .val",function(){var a=$(this).parent();if(a.hasClass("show"))a.removeClass("show");else{for(var e=$(this).attr("data-val")||"",t=a.find(".item").removeClass("cur"),n=!1,l=0,i=t.length;l<i;l++)if(t.eq(l).attr("data-val")==e){t.eq(l).addClass("cur"),n=!0;break}n?a.find(".inputReplacement").val(""):a.find(".inputReplacement").val(e),a.addClass("show")}}),$("body").on("click",".replacementCon .item",function(){return a($(this).text(),$(this).attr("data-val")||"",$(this).parents(".replacementCon")),!1}),$("body").on("click",".replacementCon button",function(){var e=$(this).siblings(".inputReplacement").val()||"";return a(""===e?common_js_lang["db.info.emptyString"]:""===e.trim()?e.match(/\s/g).length+common_js_lang["db.text.space"]:e,e,$(this).parents(".replacementCon")),!1}),$("body").on("keyup",".replacementCon .inputReplacement",function(e){if(13==e.which){var t=e.target.value||"";return a(""===t?common_js_lang["db.info.emptyString"]:""===t.trim()?t.match(/\s/g).length+common_js_lang["db.text.space"]:t,t,$(this).parents(".replacementCon")),!1}}),$("body").on("click",function(a){e.hasClass("show")&&1!=$(a.target).parents(".replacementCon").length&&1!=$(a.target).parent(".replacementCon").length&&$(a.target)!=e[0]&&e.removeClass("show")})},$(".replacementCon").replaceComponent(),$(".global-batch, .global-ConfigCon").on("click",".isReplace .checkbox",function(){$(this).toggleClass("cur"),$(this).parent().find(".val").prop("disabled",!$(this).hasClass("cur"))});var hoverInterval=0;$(".global-batch .dbTab strong, .new-sql strong").hover(function(){var a=$(this);hoverInterval=setTimeout(function(){a.find(".tip").css({display:"block"})},300)},function(){clearInterval(hoverInterval),$(this).find(".tip").css({display:"none"})}),$(".global-batch").on("click",".btn-item",function(){function a(){if(C>=P)return $("#waitLoading").css({display:"none"}),b?void ErrTip(u,h,common_js_lang["loading.info.confInfo"].replace(/\[x\]/,v).replace(/\[y\]/,y)+"\n"+b,"info"):(MsgTip({text:common_js_lang["loading.info.allConf"],type:"success"}),void $(".global-batch, .global-mask").fadeOut());var n=JSON.stringify(c.slice(C,C+100)),l=C+100<=P?100:P-C,d=JSON.stringify(m.slice(C,C+100));$.ajax({url:"db/table/ddl/batch",type:"post",contentType:"application/x-www-form-urlencoded",data:{fromId:globalParam.sourceId,toId:globalParam.targetId,pid:$("#userApp").val(),fromTablesJson:n,toTablesJson:d},success:function(n){if(200!=n.code)y+=l,u||(u=n.i18nMsg.title),h||(h=n.i18nMsg.detail),b+=n.msg+".\n";else{var d={text:"0",orc:"1",parquet:"2",rcfile:"3",sequencefile:"4"};n.model.map(function(a,n){var l=c[n+C].index;if(200!=a.code)return y++,u||(u=a.i18nMsg.title),h||(h=a.i18nMsg.detail),void(b+="["+c[n+C].tableName+"]:"+a.msg+".\n ");if(a.model.mppTable&&globalParam.targetType==globalParam.commonLinkType.hive)return y++,void(b+="["+c[n+C].tableName+"]:"+common_js_lang["db.tip.hivexspark"]+".\n ");if(!a.model.mppTable&&globalParam.targetType==globalParam.commonLinkType.spark)return y++,void(b+="["+c[n+C].tableName+"]:"+common_js_lang["db.tip.sparkxhive"]+".\n ");v++;var m=d[a.model.format]||0,p=s.eq(l).parent();p.attr("data-param",JSON.stringify({createSql:"new"==a.msg?a.model.ddl:"",ddl:"show"==a.msg?a.model.ddl:"",name:i,tableName:c[n+C].tableName,catalog:r,schema:o,dbId:globalParam.targetId,replaceEnter:e,replacement:t,tableType:m})),p.siblings(".db").html(i),p.find(".check").click()})}$("#waitLoading").find("article .detail").html(common_js_lang["loading.info.confInfo"].replace(/\[x\]/,v).replace(/\[y\]/,y)),C+=100,a()}})}var e=$(".global-batch .isReplace .checkbox").hasClass("cur"),t=$(".global-batch .replacementCon .val").attr("data-val");if(globalParam.targetType==globalParam.commonLinkType.hdfs){var n=$(".global-batch .hdfsTab .selectedDir").val().trim();if(!n)return void MsgTip("",common_js_lang["db.info.batchDir"],"info");$.fn.ajaxAPI({url:"hdfs/dir/access",data:{hdfsId:globalParam.targetId,dir:n,pid:$("#userApp").val()},callback:function(a){for(var l=$(".rightSide .target-item .target-tbl.cur"),i=l.length,o=0;o<i;o++){var r=l.eq(o).parent().text()+".txt";(r=r.slice(0,60)).match(/\s+|\\+/g)?(l.eq(o).parent().attr("data-param",JSON.stringify({replaceEnter:e,replacement:t})),l.eq(o).parent().siblings(".fileName").html("")):(l.eq(o).parent().attr("data-param",JSON.stringify({replaceEnter:e,replacement:t,fileName:(n+"/"+r).replace(/\/+/g,"/"),hid:globalParam.targetId,tarDir:n,tarName:r})),l.eq(o).parent().siblings(".fileName").html((n+"/"+r).replace(/\/+/g,"/")).attr("title",(n+"/"+r).replace(/\/+/g,"/")),l.eq(o).click())}$(".global-mask, .global-batch").fadeOut()}})}else{var l=$("#batch-dbName option:selected"),i=l.val()||"",o=l.data("schema")||"",r=l.data("catalog")||"";if(!i)return void MsgTip("info",common_js_lang["client.info.noDb"]);for(var s=$(".rightSide .target-item .target-tbl.cur"),d=s.length,c=[],m=[],p=0;p<d;p++){var g=s.eq(p).parent().text();if(g.match(/^[0-9A-Za-z]\w*$/g)){var f=s.eq(p).parents("tr");c.push({catalog:f.attr("data-catalog")||"",schema:f.attr("data-schema")||"",tableName:g,index:p}),m.push({catalog:r,schema:o,tableName:g,tableType:globalParam.targetType!=globalParam.commonLinkType.spark?0:1})}else s.eq(p).parent().attr("data-param",JSON.stringify({name:i,catalog:r,schema:o,hid:globalParam.targetId,replaceEnter:e,replacement:t})),s.eq(p).parent().siblings(".db").html(i),s.eq(p).parent().siblings(".tbl").html("")}if(c.length<=0)return $(".global-mask, .global-batch").fadeOut(),void $("#waitLoading").css({display:"none"});$("#waitLoading").find("article").html("<p>"+common_js_lang["loading.info.batchConf"].replace(/\[x\]/,c.length)+'</p><p class="detail"></p>').end().css({display:"block"});var b="",h="",u="",v=0,y=0,C=0,P=c.length;a()}}),$(".global-batch").on("click",".btn-cancel, h4 .cancel",function(){$(".global-mask, .global-batch").fadeOut()}),$(".rightSide").on("click",".target-item .config",function(){$(this).addClass("active");var a=$.Deferred(),e=setTimeout(function(){$("#globalLoadCon").css({display:"block"})},200);getSourceColumns($(this),a),getType1Val();var t=$(this).siblings(".target-name"),n=t.attr("data-param")?JSON.parse(t.attr("data-param")):{},l=t.attr("data-filter")?JSON.parse(t.attr("data-filter")):{};$.when(a).then(function(){window.clearInterval(e),$("#globalLoadCon").css({display:"none"}),resetConfigCon(n,l)}).fail(function(){$("#globalLoadCon").css({display:"none"})}),$(".global-mask, .global-ConfigCon").fadeIn(),editor.refresh()}),$(".rightSide").on("click",".allSelected",function(){$(this).toggleClass("cur");var a=$(this).hasClass("cur");$(".rightSide .target-db, .rightSide .target-tbl").toggleClass("cur",a)}),$(".rightSide").on("click",".target-db",function(){$(this).toggleClass("cur");var a=$(this).hasClass("cur"),e=$(this).parents(".target-path").data("name");$('.rightSide [data-name="'+e+'"] .check').toggleClass("cur",a),$(".rightSide .target-db").length==$(".rightSide .target-db.cur").length?$(".rightSide .allSelected").addClass("cur"):$(".rightSide .allSelected").removeClass("cur")}),$(".rightSide").on("click",".target-tbl",function(){$(this).toggleClass("cur");var a=$(this).parents("tr").data("name"),e=$('.rightSide [data-name="'+a+'"] .target-tbl').length==$('.rightSide [data-name="'+a+'"] .target-tbl.cur').length;$('.rightSide [data-name="'+a+'"] .target-db').toggleClass("cur",e);var t=$(".rightSide .target-tbl").length==$(".rightSide .target-tbl.cur").length;$(".rightSide .allSelected").toggleClass("cur",t)}),$(".global-ConfigCon").on("click",".btn-item",function(){var a=saveParamSwitch();if(!a)return!1;if(3!=$(".mtype .radio.cur").data("val")){var e=filterModule.saveFilterParam();if(!e)return!1;if(e.srcColumn){var t=$(".global-ConfigCon #dbName option:selected"),n=t.attr("data-catalog")||"",l=t.attr("data-schema")||"";if(e.dataTbl!==JSON.stringify({catalog:n,schema:l,tableName:a.tableName}))return MsgTip("",common_js_lang["db.info.synchColumn"],"info"),!1}var i=$(".rightSide .target-item .config.active").removeClass("active");i.siblings(".target-name").attr("data-param",JSON.stringify(a)).attr("data-filter",JSON.stringify(e)),globalParam.targetType==globalParam.commonLinkType.hdfs?i.siblings(".fileName").html(a.fileName).attr("title",a.fileName):(i.siblings(".db").html(a.name),i.siblings(".tbl").html(a.tableName)),$(".global-mask, .global-ConfigCon").fadeOut()}else sqlEdiotrModule.sqlSaveHdfs(a)}),$(".global-ConfigCon").on("click",".btn-cancel, .cancel",function(){$(".global-mask, .global-ConfigCon").fadeOut(),$(".rightSide .target-item .config.active").removeClass("active")}),$(".hdfsTab").on("click","li p .show",function(){if(0==$(this).parent().siblings("ul").find("li").length){if($(this).hasClass("got"))return!1;$(this).addClass("got"),getDir($(this).parents("li").data("base"))}else $(this).toggleClass("in"),$(this).parent().siblings("ul").toggle()}),$(".hdfsTab").on("click","li p .check",function(){if(!$(this).hasClass("cur")){$(".hdfsTab li p .check").removeClass("cur"),$(this).addClass("cur");var a=$(this).parents("li").data("base");$(".hdfsTab .selectedDir").val(a).attr("title",a)}}),hiveConfigModule.prototype={event:function(){var a=this;a.container.on("change","#dbName",function(){var e=a.getParam();e.name&&a.getTables(e)}),a.container.on("change","#tableName",function(){var e=a.getParam();if(e.name&&e.tableName)return e.tableName.match(/^[0-9A-Za-z]\w*$/g)?void a.getDdlAct(e,a.newType):(MsgTip("",common_js_lang["db.info.tableName"],"info"),a.container.find("#tableName").val("").select2({tags:!0}),!1)}),a.container.on("change",".tableType",function(){var e=a.getParam();if(e.name&&e.tableName)return e.tableName.match(/^[0-9A-Za-z]\w*$/g)?void a.getDdlAct(e,a.newType):(MsgTip("",common_js_lang["db.info.tableName"],"info"),a.container.find("#tableName").val("").select2({tags:!0}),!1)})},getParam:function(){var a=this,e=a.container.find("#dbName option:selected"),t={dbId:globalParam.targetId,name:e.val(),catalog:e.attr("data-catalog")||"",schema:e.attr("data-schema")||"",tableName:a.container.find("#tableName").val(),tableType:a.container.find(".tableType").val(),pid:$("#userApp").val(),fromId:globalParam.sourceId,toId:globalParam.targetId};if(0==a.newType){t.toTablesJson=JSON.stringify([{catalog:t.catalog,schema:t.schema,tableName:t.tableName,tableType:t.tableType}]);var n=$(".rightSide .target-item .config.active").parent(),l=n.data("catalog"),i=n.data("schema"),o=$(".rightSide .target-item .config.active").siblings(".target-name").text();return t.fromTablesJson=JSON.stringify([{catalog:l,schema:i,tableName:o}]),t}var r=SQLEditor.getValue().replace(/\n+/g," ").trim();return t.sql=r,t.format=a.container.find(".tableType option:selected").text(),t},getTables:function(a){var e=this;$("#globalLoadCon").show(),$.when(globalParam.promiseFunc.getTables(a)).then(function(){e.container.find(".hive .infoline.last").hide(),e.container.find("#partitions").empty();var t=globalParam.tblModel["tbl_"+a.dbId+"_"+a.catalog+"_"+a.schema],n='<option value="" disabled>'+common_js_lang["local.option.setTbl"]+"</option>";if(t.map(function(a){n+='<option data-name="'+a.name+'">'+a.name+"</option>"}),e.container.find("#tableName").html(n),!a.tableName){if(t.length<=0)return e.container.find("#tableName").val("").select2({tags:!0}),MsgTip("",common_js_lang["local.option.setTbl"]),$("#globalLoadCon").hide(),!1;var l=t[0].name;e.container.find("#tableName").val(l).select2({tags:!0}),a.tableName=l}if(!a.tableName.match(/^[0-9A-Za-z]\w*$/g))return e.container.find("#tableName").val("").select2({tags:!0}),MsgTip("",common_js_lang["db.info.tableName"],"info"),$("#globalLoadCon").hide(),!1;e.container.find("#tableName").val(a.tableName).select2({tags:!0}),e.container.find("#tableName").val()!=a.tableName&&e.container.find("#tableName").append("<option>"+a.tableName+"</option>").val(a.tableName).select2({tags:!0}),a.tableName?a.ddl||a.createSql?$("#globalLoadCon").hide():e.getDdlAct(a,e.newType):(e.editor.doc.cm.setOption("readOnly","nocursor"),e.editor.doc.setValue(""),e.container.find(".new-sql .CodeMirror").addClass("disabled"),e.container.find("#tableName").val("").select2({tags:!0}),$("#globalLoadCon").hide())}).fail(function(){$("#globalLoadCon").hide()})},getDdlAct:function(a,e){var t=this;$("#globalLoadCon").show();var n=$.Deferred();$.when(globalParam.promiseFunc.getDdl(a,e)).then(function(e){if(e.mppTable&&globalParam.targetType==globalParam.commonLinkType.hive)return t.editor.doc.setValue(""),n.reject(),void MsgTip("info",common_js_lang["db.tip.hivexspark"]);if(!e.mppTable&&globalParam.targetType==globalParam.commonLinkType.spark)return t.editor.doc.setValue(""),n.reject(),void MsgTip("info",common_js_lang["db.tip.sparkxhive"]);if(t.editor.doc.setValue(e.ddl),e.isShow){t.editor.doc.cm.setOption("readOnly","nocursor"),t.container.find(".new-sql .CodeMirror").addClass("disabled");l={text:"0",orc:"1",parquet:"2",rcfile:"3",sequencefile:"4"};t.container.find(".tableType").val(l[e.format]||(globalParam.targetType==globalParam.commonLinkType.hive?0:1)).prop("disabled",!0),globalParam.targetType>globalParam.commonLinkType.spark?n.resolve():t.getPart(a.tableName,a.catalog,a.schema,a.partition||"",n)}else{t.editor.doc.cm.setOption("readOnly",!1),t.container.find(".new-sql .CodeMirror").removeClass("disabled");var l={text:"0",orc:"1",parquet:"2",rcfile:"3",sequencefile:"4"};t.container.find(".tableType").val(l[e.format]||(globalParam.targetType==globalParam.commonLinkType.hive?0:1)).prop("disabled",globalParam.targetType==globalParam.commonLinkType.spark||!1),t.container.find("#partitions").empty(),t.container.find(".hive .infoline.last").hide(),n.resolve()}}).fail(function(){t.container.find("#tableName").val("").select2({tags:!0}),t.editor.doc.setValue(""),t.editor.doc.cm.setOption("readOnly","nocursor"),t.container.find(".new-sql .CodeMirror").addClass("disabled"),t.container.find(".new-sql .tableType").val(0).prop("disabled",!0),n.reject()}),$.when(n).always(function(){$("#globalLoadCon").hide()})},getPart:function(a,e,t,n,l){var i=this;$.when(globalParam.promiseFunc.getPart({dbId:globalParam.targetId,tableName:a,catalog:e,schema:t})).then(function(a){i.partitionShow(a,n),l&&l.resolve()}).fail(function(){l&&l.reject()})},partitionShow:function(a,e){var t=this;if(t.container.find("#partitions").empty(),a&&0!=a.length){if(this.container.find(".hive .infoline.last").css({display:"block"}),a.map(function(a,e){var n="";n+='<div class="item"><input type="text" class="filedName" value="'+a.name+'" disabled><label>=</label><select class="select2 filedVal selVal" data-type="'+a.name+'" id="Part_level_'+e+'">',a.parts.map(function(a){n+='<option value="'+a.value+'" title="'+a.name+'">'+a.value+"</option>"}),n+=globalParam.columnValOption+"</select></div>",t.container.find("#partitions").append(n),t.container.find("#partitions #Part_level_"+e).select2({placeholder:"value",tags:!0})}),e){var n=JSON.parse(e);for(var l in n)1==t.container.find("#partitions").find('[data-type="'+l+'"]').find('[value="'+n[l]+'"]').length?t.container.find("#partitions").find('[data-type="'+l+'"]').val(n[l]).trigger("change"):t.container.find("#partitions").find('[data-type="'+l+'"]').prepend('<option value="'+n[l]+'">'+n[l]+"</option>").val(n[l]).change()}}else this.container.find(".hive .infoline.last").css({display:"none"})}};var hiveModule=new hiveConfigModule({container:$(".global-ConfigCon")}),sqlHiveModule=new hiveConfigModule({container:$(".item2 .config.sqlQuery"),newType:4});$(".global-ConfigCon").on("click",".configTab a",function(){if(!$(this).hasClass("cur")){$(this).addClass("cur").siblings().removeClass("cur");var a=$(this).index(),e=globalParam.targetType==globalParam.commonLinkType.hdfs?"hdfsTab":"dbTab";if(0==a)$(".global-ConfigCon .filterTab").addClass("hidden"),$(".global-ConfigCon ."+e).removeClass("hidden");else{if(globalParam.targetType==globalParam.commonLinkType.hdfs)return $(".global-ConfigCon .filterTab").removeClass("hidden"),$(".global-ConfigCon ."+e).addClass("hidden"),$(".global-ConfigCon .filterType").find("label").eq(1).hide(),void filterEditor.refresh();$(".global-ConfigCon .filterType").find("label").eq(1).show();var t=$(".global-ConfigCon #dbName option:selected"),n=t.attr("data-catalog")||"",l=t.attr("data-schema")||"",i=$(".global-ConfigCon #tableName").val()||"";if(t.val()){if(editor.doc.cm.isReadOnly()){if($(this).attr("data-tbl")!==JSON.stringify({catalog:n,schema:l,tableName:i})){var o=$(this);$("#globalLoadCon").css({display:"block"}),$.when(getColumns({dbId:globalParam.targetId,catalog:n,schema:l,tableName:i})).done(function(a){$(".synch .tarColumn").html(a).select2(),o.attr("data-tbl",JSON.stringify({catalog:n,schema:l,tableName:i}))}).always(function(){$("#globalLoadCon").css({display:"none"})})}}else if($(this).attr("data-tbl")!==JSON.stringify({catalog:n,schema:l,tableName:i})){$(this).attr("data-tbl",JSON.stringify({catalog:n,schema:l,tableName:i}));var r=$(".synch .srcColumn").html();$(".synch .tarColumn").html(r).select2()}}else $(this).attr("data-tbl",""),$(".synch .tarColumn").html("").select2();$(".global-ConfigCon .filterTab").removeClass("hidden"),$(".global-ConfigCon ."+e).addClass("hidden")}$(".synch .srcColumn").select2(),$(".synch .tarColumn").select2(),filterEditor.refresh()}}),filterConfigModule.prototype={event:function(){this.getFilterList();var a=this;a.container.on("click",".filter-list .add-filter, .act .add",function(){var e='<input type="text" maxlength="30">',t=$(globalParam.columnsOption).attr("data-type");-1==[-7,-6,-5,2,3,4,5,6,8].indexOf(+t)&&(e=globalParam.type1Val);var n='<div class="flex-item filter-item"><span class="item"><select  class="filter-column">'+globalParam.columnsOption+'</select></span><span class="item"><select  class="filter-relate">'+globalParam.filtersOption+'</select></span><span class="item">'+e+'</span><span class="item"><select class="filter-logic"><option>AND</option><option>OR</option><option>AND NOT</option><option>OR NOT</option></select></span><span class="item act"><i class="add"></i><i class="del"></i></span></div>';a.container.find(".filter-list .noData").hide();var l=a.container.find(".filter-list").append(n).find(".filter-item:last-child");l.find("select").select2(),l.find(".type1Val").select2({tags:!0}),a.getFilterSql()}),a.container.on("change",".filter-item select",function(){a.getFilterSql()}),a.container.on("blur",".filter-item input",function(){a.getFilterSql()}),a.container.on("change",".filter-item .filter-relate",function(e,t){a.conditionChange($(this),t)}),a.container.on("change",".filter-item .filter-column",function(){a.input2select($(this))}),a.container.on("click",".filter-item .del",function(){$(this).parents(".filter-item").remove(),a.getFilterSql(),0==a.container.find(".filter-list .filter-item").length&&a.container.find(".filter-list .noData").show()}),a.container.on("click",".editSql label",function(){var e=1==$(this).find(".switch.cur").length;$(this).find(".switch").toggleClass("cur"),filterEditor.doc.cm.setOption("readOnly",!!e&&"nocursor"),e?(a.container.find(".filter-list").show(),a.container.find(".CodeMirror").addClass("disabled")):(a.container.find(".filter-list").hide(),a.container.find(".CodeMirror").removeClass("disabled"))}),a.container.on("click",".filterType label",function(){1!=$(this).find(".radio.cur").length&&($(this).parent().find(".radio").toggleClass("cur"),1==$(this).find(".radio.cur").attr("data-val")?(a.container.find(".filterSynch").hide(),a.container.find(".filterWhere").show(),filterEditor.refresh()):(a.container.find(".filterWhere").hide(),a.container.find(".filterSynch").show(),a.container.find(".synch .srcColumn").select2(),a.container.find(".synch .tarColumn").select2()))})},getFilterSql:function(){for(var a=this.container.find(".filter-item"),e="",t=0,n=a.length;t<n;t++){var l=a.eq(t),i=l.find(".filter-column option:selected"),o=i.val(),r=i.data("type"),s=l.find(".filter-relate option:selected"),d=s.data("content"),c=s.data("type"),m=l.find(".filter-logic").val(),p=1==l.find("input").length?l.find("input").val()||"":l.find(".type1Val").val()||"";if(0==c)e+=" "+o+" "+d;else if(1==c)d.match(/\{1\}/g)?e+=" "+o+" "+d.replace(/\{1\}/g,p):(-1==[-7,-6,-5,2,3,4,5,6,8].indexOf(+r)?p="'"+p+"'":(p=parseInt(p)||0,1==l.find("input").length?l.find("input").val(p):l.find(".type1Val").find("option:selected").text(p).end().select2()),e+=" "+o+" "+d+" "+p);else if(9==c)-1==[-7,-6,-5,2,3,4,5,6,8].indexOf(+r)?p=(p=p.split(",").map(function(a){return"'"+a+"'"})).join(","):(p=(p=p.split(",").map(function(a){return parseInt(a)||0})).join(","),1==l.find("input").length?l.find("input").val(p):l.find(".type1Val").find("option:selected").text(p).end().select2()),e+=" "+o+" "+d.replace(/\{1\}/g,p);else{var g=p.split(","),f=0;-1==[-7,-6,-5,2,3,4,5,6,8].indexOf(+r)?(f=1,void 0===g[0]&&(g[0]=""),void 0===g[1]&&(g[1]="")):(g[0]=parseInt(g[0])||0,g[1]=parseInt(g[1])||0),p=g[0]+","+g[1],1==l.find("input").length?l.find("input").val(p):l.find(".type1Val").find("option:selected").text(p).end().select2(),e+=" "+o+" "+(d=(d=d.replace(/\{1\}/g,1==f?"'"+g[0]+"'":g[0])).replace(/\{2\}/g,1==f?"'"+g[1]+"'":g[1]))}t<n-1&&(e+=" \n"+m)}return e&&(e="where "+e),filterEditor.doc.setValue(e),e},input2select:function(a,e){var t=a.parents(".filter-item"),n=t.find(".filter-column"),l=t.find(".filter-relate").find("option:selected").data("type"),i=n.find("option:selected").data("type");if(-1==[-7,-6,-5,2,3,4,5,6,8].indexOf(+i)&&1==l)0==t.find(".type1Val").length&&((o=t.find("input").parent()).html(globalParam.type1Val),e?(0==t.find(".type1Val").find('[value="'+e+'"]').length&&t.find(".type1Val").append('<option value="'+e+'">'+e+"</option>"),t.find(".type1Val").val(e).select2({tags:!0})):t.find(".type1Val").select2({tags:!0}));else if(1==t.find(".type1Val").length){var o=t.find(".type1Val").parent();o.html('<input type="text" maxlength="30">')}},conditionChange:function(a,e){this.input2select(a,e);var t=a.find("option:selected"),n=(t.data("content"),t.data("type"));n>1?a.parents(".filter-item").find("input").attr("placeholder",common_js_lang["db.text.seq"]).prop("disabled",!1):0==n?a.parents(".filter-item").find("input").val("").prop("disabled",!0):a.parents(".filter-item").find("input").attr("placeholder","").prop("disabled",!1)},getFilterList:function(){$.fn.ajaxAPI({url:"master/words/list?type=2",callback:function(a){var e="";a.model.map(function(a){e+='<option data-content="'+a.content+'" data-type="'+a.subType1+'">'+("zh"==common_i18n_lang?a.name:a.content)+"</option>"}),globalParam.filtersOption=e}})},saveFilterList:function(){for(var a=this.container.find(".filter-item"),e=a.length,t=[],n=0;n<e;n++){var l=a.eq(n).find(".filter-column").val(),i=a.eq(n).find(".filter-relate").val(),o=1==a.eq(n).find("input").length?a.eq(n).find("input").val():a.eq(n).find(".type1Val").val(),r=a.eq(n).find(".filter-logic").val();t.push({column:l,relate:i,input:o,logic:r})}return t},saveFilterParam:function(){var a=this,e={};if(1==this.container.find(".filterType .radio.cur").attr("data-val")){if(0==this.container.find(".editSql .switch.cur").length&&(e.filter=this.saveFilterList()),e.whereSql=(filterEditor.doc.getValue()||"").trim(),!e.whereSql&&1==this.container.find(".editSql .switch.cur").length)return MsgTip("info",common_js_lang["db.info.sqlEmpty"]),!1}else{if(e.srcColumn=this.container.find(".synch .srcColumn").val(),e.tarColumn=this.container.find(".synch .tarColumn").val(),!e.srcColumn||!e.tarColumn)return MsgTip("info",common_js_lang["db.tip.columnEmpty"]),!1;e.srcColumn=JSON.parse(decodeURIComponent(a.container.find(".synch .srcColumn option:selected").attr("data-obj"))),e.tarColumn=JSON.parse(decodeURIComponent(a.container.find(".synch .tarColumn option:selected").attr("data-obj"))),e.dataTbl=$(".configTab a").eq(1).attr("data-tbl")}return e},resetFilter:function(a,e){if(this.container.find(".filterType .radio").removeClass("cur").eq(0).addClass("cur"),this.container.find(".editSql .switch.cur").removeClass("cur"),this.container.find(".filterSynch").hide(),this.container.find(".filterWhere").show().find(".filter-list").show().find(".filter-item").remove().end().find(".noData").show(),this.container.find(".CodeMirror").addClass("disabled"),filterEditor.doc.cm.setOption("readOnly","nocursor"),filterEditor.doc.setValue(a.whereSql||""),a.whereSql)if(a.filter){this.container.find(".filterWhere .noData").hide();for(var t=a.filter||[],n=t.length,l=0;l<n;l++){var i=$('<div class="flex-item filter-item"><span class="item"><select  class="filter-column">'+globalParam.columnsOption+'</select></span><span class="item"><select  class="filter-relate">'+globalParam.filtersOption+'</select></span><span class="item"><input type="text" value="'+t[l].input+'"></span><span class="item"><select class="filter-logic"><option>AND</option><option>OR</option><option>AND NOT</option><option>OR NOT</option></select></span><span class="item act"><i class="add"></i><i class="del"></i></span></div>');i.find(".filter-column").val(t[l].column).end().find(".filter-relate").val(t[l].relate).end().find(".filter-logic").val(t[l].logic);var o=this.container.find(".filter-list").append(i).find(".filter-item:last-child");o.find("select").select2(),o.find(".type1Val").select2({tags:!0}),filterModule.conditionChange(o.find(".filter-relate"),t[l].input)}}else this.container.find(".editSql .switch").addClass("cur"),this.container.find(".filter-list").hide(),this.container.find(".CodeMirror").removeClass("disabled"),filterEditor.doc.cm.setOption("readOnly",!1);if(a.srcColumn){this.container.find(".filterType .radio").removeClass("cur").eq(1).addClass("cur"),this.container.find(".filterWhere").hide(),this.container.find(".filterSynch").show(),this.container.find(".synch .srcColumn").val(a.srcColumn.alias).select2();var r=!1;if($(".configTab a").eq(1).attr("data-tbl")!=a.dataTbl&&(r=!0,$(".configTab a").eq(1).attr("data-tbl",a.dataTbl)),e.createSql){if(r){var s=$(".synch .srcColumn").html();this.container.find(".synch .tarColumn").html(s).val(a.tarColumn.alias)}else this.container.find(".synch .tarColumn").val(a.tarColumn.alias);this.container.find(".synch .tarColumn").val()!=a.tarColumn&&this.container.find(".synch .tarColumn").append("<option>"+a.tarColumn+"</option>").val(a.tarColumn.alias),this.container.find(".synch .tarColumn").select2()}else if(r){var d=JSON.parse(a.dataTbl),c=this;$("#globalLoadCon").css({display:"block"}),$.when(getColumns({dbId:globalParam.targetId,catalog:d.catalog,schema:d.schema,tableName:d.tableName})).done(function(e){c.container.find(".synch .tarColumn").html(e).val(a.tarColumn.alias).select2()}).always(function(){$("#globalLoadCon").css({display:"none"})})}else this.container.find(".synch .tarColumn").val(a.tarColumn.alias).select2()}}};var filterModule=new filterConfigModule;$(".item2").on("click",".act .btn-cancel",function(){$(".stepCon").animate({"margin-left":"0"},250,function(){$(".stepCon .item.item2, .stepCon .item.item3").height("200"),$(".stepCon .item.item1").height("auto")}),$(".processCon .itemCon").removeClass("cur").eq(0).addClass("cur"),$("html, body").animate({scrollTop:0},200)}),$(".item2").on("click",".act .btn-item",function(){function a(){function a(a,e){$.ajax({url:"db/table/exist2",data:a,success:function(t){return 200!=t.code?(e.reject(),ErrTip(t.i18nMsg.title,t.i18nMsg.detail,t.msg),!1):t.model?void e.resolve():(e.reject(),MsgTip("",common_js_lang["db.text.db"]+"["+a.name+"] "+l+"["+a.tableName+"] "+common_js_lang["db.text.notInSrc"],"info"),!1)},error:function(){e.reject()}})}function e(){if(n>=t)b.resolve();else{i=n+100>t?t-n:100;for(var l=[],o=0;o<i;o++)l[o]=$.Deferred(),a(f[o+n],l[o]);$.when.apply($,l).then(function(){n+=100,e()}).fail(function(){b.reject()})}}var t=f.length,n=0,i=0;e()}var e=$(".mtype .radio.cur").data("val");if(3!=e){var t=$(".rightSide .target-item .target-name"),n=t.length;if(n<=0)return MsgTip("",common_js_lang["db.info.confTar"],"info"),!1;var l=1==e?common_js_lang["db.text.tbl"]:common_js_lang["db.text.view"],i=[],o=[],r=[],s=[],d=[],c=[],m=$.Deferred(),p=[],g=$.Deferred(),f=[],b=$.Deferred();$("#waitLoading").find("article").html("<p>"+common_js_lang["db.text.checkWait"]+'</p><p class="detail"></p>').end().css({display:"block"});for(var h=0;h<n;h++){var u=t.eq(h).attr("data-param")?JSON.parse(t.eq(h).attr("data-param")):{},v=t.eq(h).attr("data-filter")?JSON.parse(t.eq(h).attr("data-filter")):{},y=t.eq(h).parent().attr("data-name"),C=t.eq(h).text(),P=t.eq(h).parent().attr("data-catalog"),T=t.eq(h).parent().attr("data-schema");if([globalParam.commonLinkType.hdfs,globalParam.commonLinkType.spark].indexOf(globalParam.targetType)>-1&&u.ddl&&!u.partition){var k=globalParam.partitionsData["catalog"+u.catalog+"_schema"+u.schema+"_"+u.tableName];if(k&&k.length>0)return MsgTip("",l+"["+u.tableName+"] "+common_js_lang["local.info.hiveParam"]+"\n","info"),!1;k||p.push(u)}if(globalParam.targetType==globalParam.commonLinkType.hdfs){if(!checkHdfs(u))return $("#waitLoading").hide(),MsgTip("",common_js_lang["db.text.db"]+"["+y+"] "+common_js_lang["db.text.tbl"]+"["+C+"] "+common_js_lang["dbManage.info.hdfsParamErr"]),!1;i[h]={id:globalParam.sourceId,name:y,catalog:P,schema:T,tableName:C,whereSql:v.whereSql||""},o[h]=u}else if(-1==[globalParam.commonLinkType.hive,globalParam.commonLinkType.spark].indexOf(globalParam.targetType)){if(!u.name||!u.tableName||!u.createSql&&!u.catalog&&!u.schema)return $("#waitLoading").hide(),MsgTip("",common_js_lang["db.text.db"]+"["+y+"] "+l+"["+C+"] "+common_js_lang["local.info.hiveParam"],"info"),!1;i[h]={id:globalParam.sourceId,name:y,catalog:P,schema:T,tableName:C,synchColumnMap:{srcSynchColumn:v.srcColumn||"",tagSynchColumn:v.tarColumn||""},whereSql:v.whereSql||""},globalParam.columnObjMap["param_"+globalParam.sourceId+"_"+P+"_"+T+"_"+C]||d.push({catalog:P,schema:T,tableName:C}),s[h]=u,u.createSql?c.push({ddl:u.createSql,tableName:u.tableName,catalog:u.catalog,schema:u.schema}):globalParam.columnObjMap["param_"+u.dbId+"_"+u.catalog+"_"+u.schema+"_"+u.tableName]||c.push({catalog:u.catalog,schema:u.schema,tableName:u.tableName})}else{if(!u.name||!u.tableName||!u.createSql&&!u.catalog&&!u.schema)return $("#waitLoading").hide(),MsgTip("",common_js_lang["db.text.db"]+"["+y+"] "+l+"["+C+"] "+common_js_lang["local.info.hiveParam"],"info"),!1;i[h]={id:globalParam.sourceId,name:y,catalog:P,schema:T,tableName:C,synchColumnMap:{srcSynchColumn:v.srcColumn||"",tagSynchColumn:v.tarColumn||""},whereSql:v.whereSql||""},globalParam.columnObjMap["param_"+globalParam.sourceId+"_"+P+"_"+T+"_"+C]||d.push({catalog:P,schema:T,tableName:C}),r[h]=u,u.createSql?c.push({ddl:u.createSql,tableName:u.tableName,catalog:u.catalog,schema:u.schema}):globalParam.columnObjMap["param_"+u.dbId+"_"+u.catalog+"_"+u.schema+"_"+u.tableName]||c.push({catalog:u.catalog,schema:u.schema,tableName:u.tableName})}globalParam.jobId>0&&globalParam.targetType!=globalParam.commonLinkType.hdfs&&f.push({dbId:globalParam.sourceId,catalog:P,schema:T,tableName:C,name:y})}p.length<=0?g.resolve():$.ajax({url:"db/table/partitions/batch",data:{dbId:globalParam.targetId,pid:$("#userApp").val(),tablesJsonStr:JSON.stringify(p)},type:"post",success:function(a){var e="",t="",n="";return 200!=a.code?(ErrTip(a.i18nMsg.title,a.i18nMsg.detail,a.msg),void g.reject()):(a.model.map(function(a){if(200!=a.code)return t||(t=a.i18nMsg.title),n||(n=a.i18nMsg.detail),void(e+=a.msg+".\n");a.model&&a.model.partitions.length>0&&(e+=l+"["+a.model.name+"] "+common_js_lang["local.info.hiveParam"]+"\n")}),e?(ErrTip(t,n,e),void g.reject()):void g.resolve())},error:function(){g.reject()}}),$.when(g).then(function(){f.length<=0?b.resolve():a()}).fail(function(){$("#waitLoading").hide()}),$.when(b).done(function(){globalParam.targetType==globalParam.commonLinkType.hdfs||d.length<=0&&0==c.length?m.resolve():($("#waitLoading").find("article").html("<p>"+common_js_lang["db.tip.waitColumn"]+'</p><p class="detail"></p>').end().css({display:"block"}),$.when(getColumnBatch({dbId:globalParam.sourceId,tablesJsonStr:JSON.stringify(d)}),getColumnBatch({dbId:globalParam.targetId,tablesJsonStr:JSON.stringify(c)})).then(function(a){m.resolve()}).fail(function(){$("#waitLoading").hide()}))}).fail(function(){$("#waitLoading").hide()}),$.when(m).done(function(){if(globalParam.targetType!=globalParam.commonLinkType.hdfs){var a=[globalParam.commonLinkType.hive,globalParam.commonLinkType.spark].indexOf(globalParam.targetType)>-1?globalParam.toHiveJson:globalParam.toDbJson,e=[globalParam.commonLinkType.hive,globalParam.commonLinkType.spark].indexOf(globalParam.targetType)>-1?r:s;globalParam.curTableColumnsMap=columnMapObj.diffTableColumnsMap({fromJson:globalParam.fromJson,toJson:a},{fromJson:i,toJson:e}),columnMapObj.setSrcList(i,e),columnMapObj.container.find(".srcTbl li").eq(0).click()}globalParam.fromJson=i,globalParam.toHdfsJson=o,globalParam.toHiveJson=r,globalParam.toDbJson=s,globalParam.targetType!=globalParam.commonLinkType.hdfs?($(".stepCon").animate({"margin-left":"-200%"},250,function(){$(".stepCon .item.item1, .stepCon .item.item2").height("200"),$(".stepCon .item.item3").height("auto")}),$(".processCon .itemCon").removeClass("cur").eq(2).addClass("cur")):($(".stepCon").animate({"margin-left":"-300%"},250,function(){$(".stepCon .item.item1, .stepCon .item.item2, .stepCon .item.item3").height("200"),$(".stepCon .item.item4").height("auto")}),$(".processCon .itemCon").removeClass("cur").eq(3).addClass("cur")),$("html, body").animate({scrollTop:0},200)}).always(function(){$("#waitLoading").css({display:"none"})})}else globalParam.targetType==globalParam.commonLinkType.hdfs?sqlEdiotrModule.hdfsParamCheck():sqlEdiotrModule.hiveParamCheck()}),sqlEdiotrModule.prototype={event:function(){var a=this;this.editorContainer.on("click",".preView",function(){var e=SQLEditor.getValue().replace(/\n+/g," ").trim();if(""!=e){var t=$(this);t.prop("disabled",!0),$(".rightSide.sqlQuery .preshow").show(),$(".sqlQuery .fieldList").html('<div class="queryMask">'+common_js_lang["db.text.queryMask"]+"</div>"),$.when(a.sqlPreView({dbId:globalParam.sourceId,pid:$("#userApp").val(),sql:e})).then(function(a){$(".sqlQuery .fieldList").html(template("template/colFields",a.model))}).fail(function(){$(".rightSide.sqlQuery .preshow").hide()}).always(function(){t.prop("disabled",!1)})}else MsgTip("info",common_js_lang["db.info.sqlEmpty"])}),this.configContainer.on("click",".hdfs .scan",function(){var e=a.configContainer.find(".hdfs .selectedDir").val()||"",t=a.configContainer.find(".hdfs .fileName").val()||"";a.sqlHdfsConfig({tarDir:e,tarName:t})})},hiveParamCheck:function(){var a=[],e=[],t=[],n=SQLEditor.getValue().replace(/\n+/g," ").trim();if(""!=n){t.push({id:globalParam.sourceId,sql:n,mtype:3,tableName:"*"});var l=this.configContainer.find("#dbName option:selected"),i=l.attr("data-catalog")||"",o=l.attr("data-schema")||"",r=l.text(),s=this.configContainer.find("#tableName").val(),d=this.configContainer.find(".tableType").val(),c=this.savePart();if([r,s,n=SQLeditor.doc.getValue().trim()].indexOf("")>-1)MsgTip("info",common_js_lang["s3.info.configParam"]);else{var m={dbId:globalParam.targetId,name:r,catalog:i,schema:o,tableName:s,tableType:d};SQLeditor.doc.cm.isReadOnly()?m.ddl=n:m.createSql=n,c&&(m.partition=JSON.stringify(c)),[globalParam.commonLinkType.hive,globalParam.commonLinkType.spark].indexOf(globalParam.targetType)>-1?a.push(m):e.push(m);var p=this,g=$.Deferred(),f=m.ddl?{catalog:m.catalog,schema:m.schema,tableName:m.tableName}:{ddl:m.createSql,tableName:m.tableName};$("#waitLoading").find("article").html("<p>"+common_js_lang["db.tip.waitColumn"]+'</p><p class="detail"></p>').end().css({display:"block"}),$.when(p.getSqlColumn({dbId:globalParam.sourceId,sql:t[0].sql,pid:$("#userApp").val()}),getColumnBatch({dbId:globalParam.targetId,tablesJsonStr:JSON.stringify([f])})).then(function(a){g.resolve()}).fail(function(){$("#waitLoading").hide()}),$.when(g).done(function(){var n=[globalParam.commonLinkType.hive,globalParam.commonLinkType.spark].indexOf(globalParam.targetType)>-1?globalParam.toHiveJson:globalParam.toDbJson,l=[globalParam.commonLinkType.hive,globalParam.commonLinkType.spark].indexOf(globalParam.targetType)>-1?a:e;globalParam.curTableColumnsMap=columnMapObj.diffTableColumnsMap({fromJson:globalParam.fromJson,toJson:n},{fromJson:t,toJson:l}),columnMapObj.setSrcList(t,l),columnMapObj.container.find(".srcTbl li").eq(0).click(),globalParam.fromJson=t,globalParam.toHiveJson=a,globalParam.toDbJson=e,$(".stepCon").animate({"margin-left":"-200%"},250,function(){$(".stepCon .item.item1, .stepCon .item.item2").height("200"),$(".stepCon .item.item3").height("auto")}),$(".processCon .itemCon").removeClass("cur").eq(2).addClass("cur"),$("html, body").animate({scrollTop:0},200)}).always(function(){$("#waitLoading").css({display:"none"})})}}else MsgTip("info",common_js_lang["db.info.sqlEmpty"])},hdfsParamCheck:function(){var a=[],e=[],t=SQLEditor.getValue().replace(/\n+/g," ").trim();if(""!=t){e.push({id:globalParam.sourceId,sql:t});var n=this.configContainer.find(".hdfs .selectedDir").val().trim()||"",l=this.configContainer.find(".hdfs .fileName").val().trim()||"";if(l=l.slice(0,60),!n||!l)return MsgTip("",common_js_lang["local.info.fileDir"],"info"),!1;if(l.match(/\s+|\\+/g))return MsgTip("",common_js_lang["local.info.fileName"],"info"),!1;var i=(n+"/"+l).replace(/\/+/g,"/");a.push({hid:globalParam.targetId,fileName:i}),globalParam.fromJson=e,globalParam.toHdfsJson=a,$(".stepCon").animate({"margin-left":"-300%"},250,function(){$(".stepCon .item.item1, .stepCon .item.item2, .stepCon .item.item3").height("200"),$(".stepCon .item.item4").height("auto")}),$(".processCon .itemCon").removeClass("cur").eq(3).addClass("cur"),$("html, body").animate({scrollTop:0},200)}else MsgTip("info",common_js_lang["db.info.sqlEmpty"])},sqlHdfsConfig:function(a){if(this.globalConfig.find(".replace-tag").hide(),this.globalConfig.find(".configTab a").removeClass("cur").eq(1).hide(),this.globalConfig.show(),$(".global-mask").show(),a.tarName)var e=a.tarDir||"",t=a.tarName||"";else{t="";if(e=a.fileName||"")var t=e.split("/").slice(-1).join("/"),e=e.split("/").slice(0,-1).join("/")||e.match(/\//g)&&"/"}if(this.globalConfig.find(".hdfsTab p .check").removeClass("cur"),this.globalConfig.find(".hdfsTab p .show").removeClass("in"),this.globalConfig.find(".hdfsTab .ul:not(:first-child)").hide(),this.globalConfig.find(".hdfsTab .selectedDir").val(e).attr("title",e),this.globalConfig.find(".hdfsTab .fileName").val(t),e){var n=this.globalConfig.find('.hdfsTab [data-base="'+e+'"]');1==n.length&&(n.find(">p .check").addClass("cur"),n.parents(".ul").fadeIn().siblings("p").find(".show").addClass("in"))}},sqlSaveHdfs:function(a){this.configContainer.find(".hdfs .selectedDir").val(a.tarDir).attr("title",a.tarDir),this.configContainer.find(".hdfs .fileName").val(a.tarName),this.globalConfig.hide(),$(".global-mask").hide()},sqlPreView:function(a){var e=$.Deferred();return $.ajax({url:"db/sql/query",data:a,success:function(a){if(200!=a.code)return ErrTip(a.i18nMsg.title,a.i18nMsg.detail,a.msg),void e.reject();e.resolve(a)},error:function(){e.reject()}}),e.promise()},getSqlColumn:function(a){var e=$.Deferred();return $.ajax({url:"db/sql/cols",data:a,success:function(t){if(200!=t.code)return ErrTip(t.i18nMsg.title,t.i18nMsg.detail,t.msg),void e.reject();globalParam.columnObjMap["param_"+a.sql]||(globalParam.columnObjMap["param_"+a.sql]=t.model),e.resolve(t)},error:function(){e.reject()}}),e.promise()},savePart:function(){var a=this.configContainer.find("#partitions .filedVal"),e={};if(a.length<=0)return"";for(var t=0,n=a.length;t<n;t++)e[a.eq(t).attr("data-type")]=a.eq(t).val().trim();return e},reset:function(a){var e=this;$.when(globalParam.promiseFunc.getDb({id:a.dbId,pid:$("#userApp").val()})).then(function(t){var n='<option value="" disabled>'+common_js_lang["local.option.getDb"]+"</option>";t.databases.map(function(a){n+='<option data-catalog="'+a.catalog+'" data-schema="'+a.schema+'">'+a.name+"</option>"}),hiveModule.container.find("#dbName").html(n).val("").select2(),sqlHiveModule.container.find("#dbName").html(n).val("").select2(),$("#batch-dbName").html(n).val("").select2();common_js_lang["local.option.setTbl"];globalParam.connId=a.dbId,globalParam.targetId=a.dbId,globalParam.tmpAppId=$("#userApp").val(),e.configContainer.find("#dbName").val(a.name).select2()}),$.when(globalParam.promiseFunc.getTables(a)).then(function(t){var n='<option value="" disabled>'+common_js_lang["local.option.setTbl"]+"</option>";t.map(function(a){n+="<option>"+a+"</option>"}),e.configContainer.find("#tableName").html(n).val(a.tableName).select2({tags:!0})}),sqlHiveModule.getDdlAct(a,4)}};var sqlEdiotrModule=new sqlEdiotrModule;sqlModuleReset(),columnMapModule.prototype={event:function(){this.columnEvent(),this.dataDealEvent(),this.funcItemEvent()},columnEvent:function(){var a=this;a.container.on("click",".srcTbl li",function(){function e(){if(!t.hasClass("cur")){a.saveCurTblMap(a.container.find(".srcTbl .cur")),t.addClass("cur").siblings().removeClass("cur"),a.container.find(".dataDeal").hide();var e=JSON.parse(t.attr("data-source")),n=JSON.parse(t.attr("data-target")),l=3==e.mtype?globalParam.columnObjMap["param_"+e.sql]:globalParam.columnObjMap["param_"+e.id+"_"+e.catalog+"_"+e.schema+"_"+e.tableName],i=globalParam.columnObjMap["param_"+(n.createSql?n.createSql:n.dbId+"_"+n.catalog+"_"+n.schema+"_"+n.tableName)];a.setData(l,i),a.indexMapAct(),a.resetCurTblMap(t)}}var t=$(this),n=a.container.find(".column-list .item.cur").attr("columnsMap")||"";try{l=JSON.parse(n).funList.length>0}catch(a){var l=!1}!l&&"none"!==a.container.find(".dataDeal").css("display")&&a.container.find('.dataDeal .itemConfig .item-type:not(".src,.tar")').length>0?swal({title:"",text:common_js_lang["token.tip.saveAllConfig"],type:"info",showCancelButton:!0},function(t){t&&a.saveAllConfig()&&e(),t||e()}):e()}),a.container.on("click",".column-list .linkDeal, .column-list .right",function(){function e(){if(t.hasClass("cur"))t.removeClass("cur"),a.container.find(".dataDeal").hide();else{t.addClass("cur").siblings().removeClass("cur"),a.clearSvg();e=t.attr("columnsMap")||"";if(t.find(".linkDeal").hasClass("none"))t.find(".left select").val("").change(),a.container.find(".itemConfig").prepend(a.getItemDom("tar"));else if(e){var e=JSON.parse(e),n=a.container.find(".itemConfig");if(e.svgParam=e.svgParam||[],0==e.svgParam.length){a.container.find(".itemConfig").prepend(a.getItemDom("src")),a.container.find(".itemConfig").prepend(a.getItemDom("tar"));var l=a.container.find(".itemConfig .src .right"),i=a.container.find(".itemConfig .tar .left");a.linkPoint(l,i)}for(var o=0,r=e.svgParam.length;o<r;o++){var s=e.svgParam[o],d=s.tar,c=s.src,m=s.type,p=a.getItemDom(m).css({left:s.left+"px",top:s.top+"px"});if(n.prepend(p),-1==["src","tar"].indexOf(m)&&p.show().attr("data-param",JSON.stringify(e.funList[0])),d&&p.find(".point."+d.pos).addClass("link-target").attr("data-link-target",d.time),c){p.find(".point."+c.pos).addClass("link-source").attr("data-link-source",c.time);var l=p.find(".point.link-source"),i=n.find('.point.link-target[data-link-target="'+c.time+'"]');a.linkPoint(l,i,c.time)}}}else{a.container.find(".itemConfig").prepend(a.getItemDom("src")),a.container.find(".itemConfig").prepend(a.getItemDom("tar"));var l=a.container.find(".itemConfig .src .right"),i=a.container.find(".itemConfig .tar .left");a.linkPoint(l,i)}a.container.find(".dataDeal").show()}}var t=$(this).parent();a.container.find(".dataDeal .itemConfig .funcCon").hide();var n=a.container.find(".column-list .item.cur").attr("columnsMap")||"";try{l=JSON.parse(n).funList.length>0}catch(a){var l=!1}!l&&"none"!==a.container.find(".dataDeal").css("display")&&a.container.find('.dataDeal .itemConfig .item-type:not(".src,.tar")').length>0?swal({title:"",text:common_js_lang["token.tip.saveAllConfig"],type:"info",showCancelButton:!0},function(t){t&&a.saveAllConfig()&&e(),t||e()}):e()});var e="";a.container.on("select2:open",".column-list .src",function(a,t){e=$(this).val()}).on("change",".column-list .src",function(t,n){function l(){var e=i.find("option:selected"),t=(e.val()||"").trim(),n=i.parent().siblings(".linkDeal"),l=e.attr("data-typename"),o=i.parent().siblings(".right").find("span:last-child").text(),r=i.parents(".column-list .item");r.attr("columnsMap",""),r.hasClass("cur")&&(r.removeClass("cur"),a.container.find(".dataDeal").hide()),n.html(""),""===t?n.addClass("none"):l.toLowerCase()!=o.toLowerCase()?(n.removeClass("none half"),i.siblings(".select2").find(".columnInfo span").eq(1).addClass("red")):(n.removeClass("none half"),i.siblings(".select2").find(".columnInfo span").eq(1).removeClass("red"))}n=n||!1;var i=$(this),o=i.parents(".column-list .item").attr("columnsMap")||"";!n&&o?swal({title:"",text:common_js_lang["token.tip.changeSrc"],type:"info",showCancelButton:!0},function(a){a?l():i.val(e).columnSelectFormat()}):l()}),a.container.on("click",".topbar .empty",function(){swal({title:"",text:common_js_lang["token.tip.emptyConfig"],type:"info",showCancelButton:!0},function(){a.container.find(".column-list .src").val("").trigger("change",!0)})}),a.container.on("click",".topbar .name",function(){a.container.find(".column-list .item").map(function(a,e){var t=$(e).find(".right .name").text();$(e).find(".left select").val(t).change()})}),a.container.on("click",".topbar .index",function(){a.indexMapAct()})},dataDealEvent:function(){var a=this;a.container.on("click",".itemList .type",function(){$(this).hasClass("in")?($(this).removeClass("in"),$(this).siblings("ul").slideDown()):($(this).addClass("in"),$(this).siblings("ul").slideUp())});var e=null;$(".mapConfig-delete").on("mouseout",function(){$(this).hide(),e=null}),$(".mapConfig-delete").on("click",function(){$(this).hide(),a.deleteItem(e)}),a.container.on("contextmenu",".itemConfig .item-type, .itemConfig path",function(a){try{if(a.target.className.indexOf("src")>-1||a.target.className.indexOf("tar")>-1)return!1}catch(a){}return $(".mapConfig-delete").css({left:a.pageX-20+"px",top:a.pageY-10+"px"}).show(),e=$(this),!1}),a.container.on("mouseover",".itemConfig .item-type, .itemConfig path",function(){console.log("mouseover");var e=$(this);$("body").on("keyup",function(t){if(46==t.which){if(e.hasClass("src")||e.hasClass("tar"))return;a.deleteItem(e),console.log("del")}})}),a.container.on("mouseout",".itemConfig .item-type, .itemConfig path",function(a){$("body").off("keyup")}),a.container.on("click",".itemConfig",function(e){"svg"===e.target.nodeName.toLowerCase()&&a.container.find(".funcCon").hide()}),a.container.on("mousedown",".itemList .group [item-type]",function(e){$("body").addClass("drag");var t=a.getPageXPad(),n=a.getPageYPad(),l=$(this).attr("item-type"),i=a.container.find(".itemCon .item-type-"+l),o=e.pageX-t,r=e.pageY-n;i.css({left:o-50+"px",top:r-20+"px"}).show(),$(document).on("mousemove",function(a){o=a.pageX-t,r=a.pageY-n,i.css({left:o-50+"px",top:r-20+"px"})}),$(document).on("mouseup",function(e){$("body").removeClass("drag"),$(document).off();var t=a.getSvgScale();o-200-50<-50||r-20<10||r-20>t.y-20||o-200-50>t.x-50?i.hide():(i.css({left:o-200-50+"px",top:r-20+"px"}),a.container.find(".itemConfig").prepend(i.clone()),i.hide())})}),a.container.on("mousedown",".itemConfig .item-type",function(e){if(3==e.which)return!1;$("body").addClass("drag");var t=$(this),n=+t.css("left").slice(0,-2),l=+t.css("top").slice(0,-2),i=e.pageX,o=e.pageY,r=0;$(document).on("mousemove",function(e){var s=e.pageX-i,d=e.pageY-o,c=n+s,m=l+d,p=a.getSvgScale();c<-50&&(c=-50),c>p.x-50&&(c=p.x-50),m<10&&(m=10),m>p.y-20&&(m=p.y-20),t.css({left:c+"px",top:m+"px"}),r++;var g=t.find(".point.link-source"),f=t.find(".point.link-target");if(1==g.length){var b=g.attr("data-link-source"),h=a.container.find('.point.link-target[data-link-target="'+b+'"]'),u=a.container.find("path."+b),v=a.calcBezierPoints(a.getPointXY(g),a.getPointXY(h));u.attr("d","M"+v[0].x+","+v[0].y+" C"+v[1].x+" "+v[1].y+" "+v[2].x+" "+v[2].y+" "+v[3].x+" "+v[3].y)}if(1==f.length){var b=f.attr("data-link-target"),y=a.container.find('.point.link-source[data-link-source="'+b+'"]'),u=a.container.find("path."+b),v=a.calcBezierPoints(a.getPointXY(y),a.getPointXY(f));u.attr("d","M"+v[0].x+","+v[0].y+" C"+v[1].x+" "+v[1].y+" "+v[2].x+" "+v[2].y+" "+v[3].x+" "+v[3].y)}}),$(document).on("mouseup",function(e){if($("body").removeClass("drag"),r>3);else if(t.addClass("cur").siblings(".item-type").removeClass("cur"),!t.hasClass("src")&&!t.hasClass("tar")){var n=t.attr("class").split(" ")[1],l=a.container.find(".funcCon").show(),i=t.attr("data-param")?JSON.parse(t.attr("data-param")):"";a.resetItemParam(i,n),l.find("."+n).addClass("cur").siblings().removeClass("cur")}$(document).off()})}),a.container.on("mousedown",".itemConfig .item-type .point",function(e){if(1!=(i=$(this).parent()).find(".link-source").length&&!i.hasClass("tar")){$("body").addClass("drag");var t=Date.now(),n=a.container.find(".svgCon"),l=$(document.createElementNS("http://www.w3.org/2000/svg","path"));l.attr({stroke:"#ccc",fill:"transparent",class:t,"marker-end":"url(#markerArrow)"}),n.find("svg").append(l);var i=$(this),o=a.getPointXY(i),r=o.x,s=o.y,d=e.pageX,c=e.pageY;return i.parent().addClass("mousedown"),$(document).on("mousemove",function(a){l.attr("d","M"+r+","+s+" L"+(a.pageX-d+r)+","+(a.pageY-c+s))}),a.container.on("mouseover",".itemConfig .item-type",function(a){$(this).addClass("link")}).on("mouseout",".itemConfig .item-type",function(a){$(this).removeClass("link")}),$(document).on("mouseup",function(e){if($(e.target).hasClass("point")){var n=$(e.target).parent(),o=+n.attr("class").split(" ")[1].slice(-1)||0;if(1==n.find(".link-target").length||n.hasClass("src")||o>5)l.remove();else{var d=a.calcBezierPoints({x:r,y:s},a.getPointXY($(e.target)));l.attr("d","M"+r+","+s+" C"+d[1].x+" "+d[1].y+" "+d[2].x+" "+d[2].y+" "+d[3].x+" "+d[3].y),i.addClass("link-source").attr("data-link-source",t),$(e.target).addClass("link-target").attr("data-link-target",t)}}else l.remove();$("body").removeClass("drag"),a.container.find(".item-type.link").removeClass("link"),a.container.off("mouseover mouseout",".itemConfig .item-type"),i.parent().removeClass("mousedown"),$(document).off()}),!1}}),a.container.on("mousedown",".funcCon .cancel",function(e){a.container.find(".funcCon").hide()}),a.container.on("mousedown",".funcCon .save .btn-item",function(e){var t=a.container.find(".itemConfig .item-type.cur"),n=t.attr("class").split(" ")[1],l=a.saveItemParam(n);l&&(t.attr("data-param",JSON.stringify(l)),a.container.find(".funcCon").hide())}),a.container.on("click",".saveConfig span",function(){a.saveAllConfig()&&MsgTip("success",common_js_lang["token.tip.saveSucc"])})},deleteItem:function(a){var e=this;if(a.remove(),a.hasClass("item-type")){var t=a.find(".point.link-source"),n=a.find(".point.link-target");if(1==t.length){l=t.attr("data-link-source");e.container.find('.point.link-target[data-link-target="'+l+'"]').attr("data-link-target","").removeClass("link-target"),e.container.find("path."+l).remove()}if(1==n.length){l=n.attr("data-link-target");e.container.find('.point.link-source[data-link-source="'+l+'"]').attr("data-link-source","").removeClass("link-source"),e.container.find("path."+l).remove()}}else{var l=a.attr("class"),t=e.container.find('.point[data-link-source="'+l+'"]'),n=e.container.find('.point[data-link-target="'+l+'"]');t.attr("data-link-source","").removeClass("link-source"),n.attr("data-link-target","").removeClass("link-target")}},saveAllConfig:function(){for(var a=this,e=a.container.find(".itemConfig .item-type"),t=0,n=e.length;t<n;t++)if((o=e.eq(t)).hasClass("src")){if(o.find(".point.link-source").length<=0)return MsgTip("info",common_js_lang["token.tip.srcLinkErr"]),!1}else if(o.hasClass("tar")){if(o.find(".point.link-target").length<=0)return MsgTip("info",common_js_lang["token.tip.tarLinkErr"]),!1}else{m=o.attr("class").split(" ")[1];if("deal"==(p=a.typeMapInfo(m)).type){if(o.find(".point.link-source").length<=0||o.find(".point.link-target").length<=0)return MsgTip("info",common_js_lang["token.tip.handelFuncErr"]),!1}else if("add"==p.type&&o.find(".point.link-source").length<=0)return MsgTip("info",common_js_lang["token.tip.addFuncErr"]),!1}var l=a.container.find(".itemConfig .item-type.src"),i=(c=a.container.find(".itemConfig .item-type.tar")).find(".point.link-target").attr("data-link-target"),o=a.container.find('.itemConfig .point[data-link-source="'+i+'"]').parent();if(o.length<=0)return MsgTip("info",common_js_lang["token.tip.srcErr"]),!1;var r=[];if(r.push(a.getItemSvgParam(c)),o.hasClass("src"))var s="";else{if(!(s=o.attr("data-param")||""))return MsgTip("info",common_js_lang["token.tip.paramErr"]),!1;s=JSON.parse(s),r.push(a.getItemSvgParam(o))}r.push(a.getItemSvgParam(l));var d=a.container.find(".column-list .item.cur"),l=d.find(".left select"),c=d.find(".right");if(s){var m=s.type,p=a.typeMapInfo(m);d.find(".linkDeal").html('<span class="item-icon item-icon'+p.icon.slice(-1)+'"></span>')}else d.find(".linkDeal").html("");var g=""==l.val()?"":JSON.parse(decodeURIComponent(l.find("option:selected").attr("data-obj"))),f=JSON.parse(decodeURIComponent(c.attr("data-obj")));return d.attr("columnsMap",JSON.stringify({srcColumn:g,funList:s?[s]:[],tarColumn:f,svgParam:r})),!0},funcItemEvent:function(){var a=this.container.find(".dataDeal .funcCon");a.on("click",".item-type-replace a",function(){a.find(".item-type-replace tbody").append('<tr><td><input class="old" type="text"></td><td><input class="new" type="text"></td></tr>')}),a.on("click",".item-type-filterFunc label",function(){1!=$(this).find(".radio.cur").length&&($(this).parent().find(".radio").removeClass("cur"),$(this).find(".radio").addClass("cur"))})},getItemSvgParam:function(a){var e=a.attr("class").split(" ")[1],t=a.css("left").slice(0,-2),n=a.css("top").slice(0,-2),l=a.find(".point.link-target"),i=a.find(".point.link-source"),o={type:e,left:t,top:n};if(1==l.length){var r=l.attr("data-link-target"),s=l.attr("class").split(" ")[0];o.tar={time:r,pos:s}}if(1==i.length){var r=i.attr("data-link-source"),s=i.attr("class").split(" ")[0];o.src={time:r,pos:s}}return o},saveItemParam:function(a){if("item-type-replace"==a){for(var e=this.container.find(".dataDeal .funcCon").find(".item-type-replace tbody tr"),t=[],n=0,l=e.length;n<l;n++){var i=e.eq(n).find(".old").val()||"",o=e.eq(n).find(".new").val()||"";""!=i&&t.push({oldChar:i,newChar:o})}return t.length<=0?void MsgTip("info","请至少填写一对替换字符"):{type:"item-type-replace",name:"ReplaceString",params:t}}if("item-type-replaceEnter"==a)return{type:"item-type-replaceEnter",name:"ReplaceEnter",params:[{newChar:(s=this.container.find(".funcCon .item-type-replaceEnter")).find("select").val()}]};if("item-type-filterFunc"==a){var r=JSFilter.getValue();if(!r)return void MsgTip("info","请填写JavaScript语句");var s=this.container.find(".funcCon .item-type-filterFunc");return{type:"item-type-filterFunc",name:"JSValidate",params:[{js_codes:r,validate_method:s.find(".radio.cur").attr("data-val")}]}}},resetItemParam:function(a,e){if("item-type-replace"==e){var t=this.container.find(".dataDeal .funcCon");t.find(".item-type-replace tbody").empty();try{for(var n=0,l=a.params.length;n<l;n++){var i=$('<tr><td><input class="old" type="text"></td><td><input class="new" type="text"></td></tr>'),o=a.params[n].oldChar,r=a.params[n].newChar;i.find(".old").val(o).end().find(".new").val(r),t.find(".item-type-replace tbody").append(i)}}catch(a){}}else if("item-type-replaceEnter"==e){d=this.container.find(".funcCon .item-type-replaceEnter");try{d.find("select").val(a.params[0].newChar)}catch(a){}}else if("item-type-filterFunc"==e){var s="result = false; // init result \n if ( content ){ \n  // add filter code \n  result = true; \n }",d=this.container.find(".funcCon .item-type-filterFunc");try{var c=a.params[0].js_codes||s;JSFilter.setValue(c),d.find(".radio").eq(+a.params[0].validate_method-1).click()}catch(a){JSFilter.setValue(s),d.find(".radio").eq(0).click()}}},typeMapInfo:function(a){return{"item-type-filterFunc":{icon:"list-icon1",type:"deal"},"item-type-replace":{icon:"list-icon1",type:"deal"},"item-type-replaceEnter":{icon:"list-icon2",type:"deal"},"item-type-trim":{icon:"list-icon3",type:"deal"},"item-type-substr":{icon:"list-icon4",type:"deal"},"item-type-delChar":{icon:"list-icon5",type:"deal"},"item-type-timestamp":{icon:"list-icon6",type:"add"},"item-type-const":{icon:"list-icon7",type:"add"},"item-type-null":{icon:"list-icon8",type:"add"}}[a]},getItemDom:function(a){return this.container.find(".itemCon .item-type."+a).clone()},clearSvg:function(){this.container.find(".svgCon svg path[marker-end]").remove(),this.container.find(".itemConfig .item-type").remove()},linkPoint:function(a,e,t){t=t||Date.now();var n=this,l=n.container.find(".svgCon"),i=n.getPointXY(a),o=n.getPointXY(e),r=$(document.createElementNS("http://www.w3.org/2000/svg","path"));r.attr({stroke:"#ccc",fill:"transparent",class:t,"marker-end":"url(#markerArrow)"}),l.find("svg").append(r);var s=n.calcBezierPoints(i,o);r.attr("d","M"+s[0].x+","+s[0].y+" C"+s[1].x+" "+s[1].y+" "+s[2].x+" "+s[2].y+" "+s[3].x+" "+s[3].y),a.addClass("link-source").attr("data-link-source",t),e.addClass("link-target").attr("data-link-target",t)},calcBezierPoints:function(a,e,t,n){n=n||1,((t=t||0)>=.5||t<0)&&(t=0),n<=0&&(n=1);var l=a.x,i=a.y,o=e.x,r=e.y,s=Math.sqrt(Math.pow(l-o,2)+Math.pow(i-r,2))*n,d=o==l?null:(r-i)/(o-l),c=l+(o-l)*t,m=l+(o-l)*(1-t),p=i+(r-i)*t,g=i+(r-i)*(1-t);if(null===d)var f={x:c-s,y:p},b={x:m+s,y:g};else if(0==d)var f={x:c,y:p-s},b={x:m,y:g+s};else{var h=-1/d,u=Math.sqrt(Math.pow(s,2)/(1+Math.pow(-1/d,2))),f={x:c+u,y:p-Math.abs(h*u)},b={x:m-u,y:g+Math.abs(u*h)};d<0&&(f={x:c+u,y:p+Math.abs(h*u)},b={x:m-u,y:g-Math.abs(u*h)})}return[a,f,b,e]},getPointXY:function(a){var e=+a.parent().css("left").slice(0,-2),t=+a.parent().css("top").slice(0,-2);return{x:+a.css("left").slice(0,-2)+e+5,y:+a.css("top").slice(0,-2)+t+5}},getPageYPad:function(){return 591},getPageXPad:function(){return 20+(1==$("body.asideToggle").length?60:239)+220},getSvgScale:function(){var a=this.container.find(".itemConfig");return{x:a.width(),y:a.height()}},setSrcList:function(a,e){a=a.map(function(a,e){return a.params=JSON.stringify(a),a}),e=e.map(function(a,e){return a.params=JSON.stringify(a),a});var t=template("template/columnSrc",{src:a,tar:e});this.container.find(".srcTbl").html(t)},setData:function(a,e){this.srcModel=a,this.srcOptions=this.model2option(a),this.tarModel=e},addItem:function(a,e){var t=this,n=$('<div class="item"><div class="linkDeal"></div><div class="left"><select class="src"><option value=""></option>'+t.srcOptions+'</select></div><div class="right" title="'+e.name+" "+e.typeName+'" data-obj='+encodeURIComponent(JSON.stringify(e))+'><span class="name">'+(e.pk?'<i class="pk-icon"></i>':"")+e.name+'</span><span class="type">'+e.typeName+"</span></div></div>");n.find(".src").val(a.name),a||n.find(".linkDeal").addClass("none"),t.container.find(".column-list").append(n)},indexMapAct:function(){var a=this,e=a.srcModel.length;a.container.find(".column-list").empty();for(var t=0,n=a.tarModel.length;t<n;t++)a.addItem(t<e?a.srcModel[t]:"",a.tarModel[t]);a.container.find(".column-list select").columnSelectFormat(),a.container.find(".column-list .src").change()},saveIndexMap:function(a,e){for(var t=a.length,n=e.length,l=[],i=0,o=t>n?n:t;i<o;i++)e[i].typeName.toLowerCase()===a[i].typeName.toLowerCase()&&l.push({srcColumn:a[i],tarColumn:e[i],funList:[]});return l},model2option:function(a){var e="";return a.map(function(a){var t=a.typeName;e+='<option data-obj="'+encodeURIComponent(JSON.stringify(a))+'" data-type="'+a.dataType+'" data-typeName="'+t+'">'+a.name+"</option>"}),e},saveCurTblMap:function(a){var e=a.index();if(e>-1){for(var t=this.container.find(".column-list .item"),n=[],l=0,i=t.length;l<i;l++)if(!t.eq(l).find(".linkDeal").hasClass("none")){var o=t.eq(l).attr("columnsMap")||"";if(o)n.push(JSON.parse(o));else{var r=t.eq(l).find(".left select"),s=t.eq(l).find(".right");r=JSON.parse(decodeURIComponent(r.find("option:selected").attr("data-obj"))),s=JSON.parse(decodeURIComponent(s.attr("data-obj"))),n.push({srcColumn:r,tarColumn:s,funList:[]})}}globalParam.curTableColumnsMap[e]=n}},resetCurTblMap:function(a){var e=a.index(),t=0,n=this.container.find(".column-list .item");if(globalParam.curTableColumnsMap[e])for(var l=globalParam.curTableColumnsMap[e].length,i=0,o=n.length;i<o;i++){var r=n.eq(i).find(".right .name").text();if(t<l&&globalParam.curTableColumnsMap[e][t].tarColumn.name==r){var s=globalParam.curTableColumnsMap[e][t].srcColumn.name||"";if(n.eq(i).find(".left select").val(s).change(),""==s&&n.eq(i).find(".linkDeal").addClass("half"),globalParam.curTableColumnsMap[e][t].funList.length>0){var d=globalParam.curTableColumnsMap[e][t].funList[0].type.slice(-1);n.eq(i).find(".linkDeal").html('<span class="item-icon item-icon'+d+'"></span>')}n.eq(i).attr("columnsMap",JSON.stringify(globalParam.curTableColumnsMap[e][t])),t++}else!n.eq(i).find(".linkDeal").hasClass("none")&&n.eq(i).find(".left select").val("").change()}},getOutputColumnsMap:function(){var a=this,e=this.container.find(".srcTbl li");a.saveCurTblMap(a.container.find(".srcTbl .cur")),e.map(function(e,t){if(!globalParam.curTableColumnsMap[e]){var n=JSON.parse($(t).attr("data-source")),l=JSON.parse($(t).attr("data-target")),i=3==n.mtype?globalParam.columnObjMap["param_"+n.sql]:globalParam.columnObjMap["param_"+n.id+"_"+n.catalog+"_"+n.schema+"_"+n.tableName],o=globalParam.columnObjMap["param_"+(l.createSql?l.createSql:l.dbId+"_"+l.catalog+"_"+l.schema+"_"+l.tableName)];globalParam.curTableColumnsMap[e]=a.saveIndexMap(i,o)}})},diffTableColumnsMap:function(a,e){var t=a.fromJson,n=a.toJson,l=e.fromJson,i=e.toJson,o=[];if(+$(".mtype .radio.cur").attr("data-val")>2){try{JSON.stringify({id:l[0].id,sql:l[0].sql})===JSON.stringify({id:t[0].id,sql:t[0].sql})&&JSON.stringify({dbId:i[0].dbId,catalog:i[0].catalog,schema:i[0].schema,createSql:i[0].createSql||""})===JSON.stringify({dbId:n[0].dbId,catalog:n[0].catalog,schema:n[0].schema,createSql:n[0].createSql||""})&&(o[0]=globalParam.curTableColumnsMap[0])}catch(a){return o}return o}for(var r=0,s=l.length;r<s;r++){var d=l[r].id,c=l[r].catalog||"",m=l[r].schema||"",p=l[r].tableName,g=d+"_"+c+"_"+m+"_"+p;if(i[r].createSql)f=i[r].createSql;else var f=(d=i[r].dbId)+"_"+(c=i[r].catalog||"")+"_"+(m=i[r].schema||"")+"_"+(p=i[r].tableName);var b=function(a,e){for(var l=0,i=t.length;l<i;l++)if(!t[l].isFindDiff){var o=t[l].id,r=t[l].catalog||"",s=t[l].schema||"",d=t[l].tableName;if(a===o+"_"+r+"_"+s+"_"+d){if(t[l].isFindDiff=!0,n[l].createSql)c=n[l].createSql;else var c=(o=n[l].dbId)+"_"+(r=n[l].catalog||"")+"_"+(s=n[l].schema||"")+"_"+(d=n[l].tableName);return e===c?l:""}}return""}(g,f);o[r]=""!==b?globalParam.curTableColumnsMap[b]:""}return o},initColumnsMap:function(){globalParam.fromJson=jobOtherParams.fromList,[globalParam.commonLinkType.hive,globalParam.commonLinkType.spark].indexOf(globalParam.targetType)>-1?globalParam.toHiveJson=jobOtherParams.toHiveList:globalParam.toDbJson=jobOtherParams.toDbList,this.setSrcList(globalParam.fromJson,[globalParam.commonLinkType.hive,globalParam.commonLinkType.spark].indexOf(globalParam.targetType)>-1?globalParam.toHiveJson:globalParam.toDbJson),globalParam.fromJson.map(function(a,e){try{globalParam.curTableColumnsMap[e]=JSON.parse(a.outputColumnsMap)}catch(a){globalParam.curTableColumnsMap[e]=""}})}};var columnMapObj=new columnMapModule;globalParam.targetType!=globalParam.commonLinkType.hdfs&&globalParam.jobId>0&&columnMapObj.initColumnsMap(),$.fn.extend({columnSelectFormat:function(){columnSelectFormat(this)}}),$(".item3").on("click",".act .btn-cancel",function(){$(".processCon .itemCon").removeClass("cur").eq(1).addClass("cur"),$(".stepCon").animate({"margin-left":"-100%"},250,function(){$(".stepCon .item.item1, .stepCon .item.item3").height("200"),$(".stepCon .item.item2").height("auto")}),$("html, body").animate({scrollTop:0},200)}),$(".item3").on("click",".act .btn-item",function(){columnMapObj.getOutputColumnsMap(),$(".processCon .itemCon").removeClass("cur").eq(3).addClass("cur"),$(".stepCon").animate({"margin-left":"-300%"},250,function(){$(".stepCon .item.item1, .stepCon .item.item2, .stepCon .item.item3").height("200"),$(".stepCon .item.item4").height("auto")}),$("html, body").animate({scrollTop:0},200)}),$(".item4").on("click",".act .btn-cancel",function(){globalParam.targetType!=globalParam.commonLinkType.hdfs?($(".processCon .itemCon").removeClass("cur").eq(2).addClass("cur"),$(".stepCon").animate({"margin-left":"-200%"},250,function(){$(".stepCon .item.item1, .stepCon .item.item2").height("200"),$(".stepCon .item.item3").height("auto")})):($(".stepCon").animate({"margin-left":"-100%"},250,function(){$(".stepCon .item.item1, .stepCon .item.item3").height("200"),$(".stepCon .item.item2").height("auto")}),$(".processCon .itemCon").removeClass("cur").eq(1).addClass("cur")),$("html, body").animate({scrollTop:0},200)}),$(".item4").on("click",".act .btn-item",function(){function a(){if(y>=g)return f?(c.reject(),$("#waitLoading").css({display:"none"}),void ErrTip(h,b,common_js_lang["loading.info.newInfo"].replace(/\[x\]/,u).replace(/\[y\]/,v)+"\n"+f)):void c.resolve();var e=m.slice(y,y+100),t=y+100<=g?100:g-y;$.ajax({url:"db/table/create/batch",type:"post",data:{dbId:globalParam.targetId,pid:l,tablesJsonStr:JSON.stringify(e)},success:function(e){200!=e.code?(h||(h=e.i18nMsg.title),b||(b=e.i18nMsg.detail),f+=e.msg+"\n",v+=t):e.model.map(function(a,e){var t=m[e+y].index;if(200!=a.code)return v++,h||(h=a.i18nMsg.title),b||(b=a.i18nMsg.detail),void(f+="["+d[t].tableName+"]:"+a.msg+".\n");u++,d[t].ddl="",d[t].createSql="",d[t].tableName=a.model.tableName,d[t].catalog=a.model.catalog,d[t].schema=a.model.schema}),y+=100,$("#waitLoading").find("article .detail").html(common_js_lang["loading.info.newInfo"].replace(/\[x\]/,u).replace(/\[y\]/,v)),a()}})}function e(){$.fn.ajaxAPI({url:"job/db/save",type:"post",data:s,contentType:"application/x-www-form-urlencoded",callback:function(a){window.onbeforeunload=function(){},location.href="./success"},complete:function(){o.prop("disabled",!1)}})}var t=($(".item1 .taskName").val()||"").trim(),n=($(".item1 .taskDes").val()||"").trim();if(t){var l=$("#userApp").val()||0;if(l){var i=cronExport.cronExec($(".group-type .cur").index(),!0);if(!i.cronParam||-1==[0,1,2].indexOf(+i.periodType))return $("#globalLoadCon").css({display:"none"}),!1;var o=$(this);o.prop("disabled",!0),globalParam.targetType!=globalParam.commonLinkType.hdfs&&globalParam.fromJson.map(function(a,e){globalParam.fromJson[e].outputColumnsMap=globalParam.curTableColumnsMap[e]});var r=i,s={pid:l,jobName:t,note:n,mtype:$(".mtype .radio.cur").attr("data-val"),fromJson:JSON.stringify(globalParam.fromJson),periodType:r.periodType,fromId:globalParam.sourceId,toId:globalParam.targetId,cronExpression:r.cronParam,startTimeStr:r.startTimeStr||"",endTimeStr:r.endTimeStr||"",groupNo:globalParam.groupNo,toType:globalParam.targetType==globalParam.commonLinkType.hdfs?8:globalParam.targetType==globalParam.commonLinkType.hive?9:13};if(globalParam.linkSource2type[1].indexOf(+globalParam.targetType)>-1&&(s.toType=2),globalParam.linkSource2type[2].indexOf(+globalParam.targetType)>-1&&(s.toType=6),globalParam.linkSource2type[3].indexOf(+globalParam.targetType)>-1&&(s.toType=7),globalParam.jobId>0&&!globalParam.urlObj.copy&&(s.id=globalParam.jobId),globalParam.targetType==globalParam.commonLinkType.hdfs)s.toHdfsJson=JSON.stringify(globalParam.toHdfsJson);else{for(var d=[globalParam.commonLinkType.hive,globalParam.commonLinkType.spark].indexOf(globalParam.targetType)>-1?globalParam.toHiveJson:globalParam.toDbJson,c=$.Deferred(),m=[],p=0,g=d.length;p<g;p++)d[p].createSql&&(d[p].ddl=d[p].createSql,d[p].index=p,m.push(d[p]));if(m.length>=1){var f="",b="",h="",u=0,v=0,y=0,g=m.length;$("#waitLoading").find("article").html("<p>"+common_js_lang["loading.info.batchNew"].replace(/\[x\]/,g)+'</p><p class="detail"></p>').end().css({display:"block"}),a()}else c.resolve()}globalParam.targetType!=globalParam.commonLinkType.hdfs?$.when(c).then(function(){s.toHiveJson=JSON.stringify(globalParam.toHiveJson),s.toDbJson=JSON.stringify(globalParam.toDbJson),e()},function(){o.prop("disabled",!1)}):e()}else MsgTip("",common_js_lang["dbManage.title.setApp"],"info")}else MsgTip("",common_js_lang["client.info.taskNameErr"],"info")}),function(){if(!(globalParam.jobId<=0)){var a={cronParam:globalParam.editJobModel.cronExpression,startTime:globalParam.editJobModel.startTime,endTime:globalParam.editJobModel.endTime};cronExport.resetCron(a)}}(),window.onbeforeunload=function(){if($(".taskName").val().trim()||$(".taskDes").val().trim())return common_js_lang["common.info.leavePage"]};